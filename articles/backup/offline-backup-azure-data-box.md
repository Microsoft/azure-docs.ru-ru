---
title: Автономная архивация с помощью Azure Data Box
description: Узнайте, как использовать Azure Data Box для заполнения данных большого объема начальной архивации в автономном режиме от агента MARS до хранилища служб восстановления.
ms.topic: conceptual
ms.date: 1/27/2020
ms.openlocfilehash: e789b6c9f4ff2e8cd168e6b5c138d423911d4743
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96752589"
---
# <a name="azure-backup-offline-backup-by-using-azure-data-box"></a>Автономное резервное копирование с помощью Azure Data Box

Вы можете использовать [Azure Data Box](../databox/data-box-overview.md) , чтобы задать начальные резервные копии службы восстановления Microsoft Azure (без использования сети) для хранилища служб восстановления. Эта процедура помогает экономить время и ресурсы пропускной способности сети, которые в противном случае потреблялись бы при перемещении больших объемов данных резервных копий по сети с высокой задержкой. Это усовершенствование сейчас находится на этапе предварительной версии. Автономное резервное копирование с использованием Azure Data Box обеспечивает два весомых преимущества по сравнению с [автономным резервным копированием с использованием службы импорта и экспорта Azure](./backup-azure-backup-import-export.md):

- Нет необходимости в приобретении собственных дисков и соединителей, совместимых с Azure. в комплекте Azure Data Box поставляются диски, связанные с выбранным [номером SKU Data Box](https://azure.microsoft.com/services/databox/data/).
- Azure Backup (агент MARS) может напрямую записывать данные резервных копий на поддерживаемые номера SKU Azure Data Box. Такая возможность позволяет избежать подготовки расположения промежуточного хранения для исходных данных резервных копий. Кроме того, для форматирования и копирования этих данных на диски не требуются служебные программы.

## <a name="azure-data-box-with-the-mars-agent"></a>Azure Data Box с агентом MARS

В этой статье объясняется, как можно использовать Azure Data Box для заполнения данных большого объема начальной архивации в автономном режиме от агента MARS до хранилища служб восстановления.

## <a name="supported-platforms"></a>Поддерживаемые платформы

Процесс заполнения данных от агента MARS с помощью Azure Data Box поддерживается в следующих SKU Windows.

| **ОС**                                 | **SKU**                                                      |
| -------------------------------------- | ------------------------------------------------------------ |
| **Рабочая станция**                        |                                                              |
| Windows 10, 64-разрядная версия                     | Корпоративная, Профессиональная, Домашняя                                       |
| Windows 8.1, 64-разрядная версия                    | Корпоративная, Профессиональная                                             |
| Windows 8, 64-разрядная версия                      | Корпоративная, Профессиональная                                             |
| Windows 7, 64-разрядная версия                      | Максимальная, Корпоративная, Профессиональная, Домашняя расширенная, Домашняя базовая, Начальная |
| **Сервер**                             |                                                              |
| Windows Server 2019, 64-разрядная версия            | Standard, Datacenter, Essentials                            |
| Windows Server 2016, 64-разрядная версия            | Standard, Datacenter, Essentials                            |
| Windows Server 2012 R2, 64-разрядная версия         | Standard, Datacenter, Foundation                            |
| Windows Server 2012, 64-разрядная версия            | Datacenter, Foundation, Standard                            |
| Windows Storage Server 2016, 64-разрядная версия    | Standard, Workgroup                                         |
| Windows Storage Server 2012 R2, 64-разрядная версия | Standard, Workgroup, Essential                              |
| Windows Storage Server 2012, 64-разрядная версия    | Standard, Workgroup                                         |
| Windows Server 2008 R2 с пакетом обновления 1, 64-разрядная версия     | Standard, Enterprise, Datacenter, Foundation                |
| Windows Server 2008 с пакетом обновления 2 (SP2) 64        | Standard, Enterprise, Datacenter                            |

## <a name="backup-data-size-and-supported-data-box-skus"></a>Размер данных резервной копии и поддерживаемые номера SKU Data Box

| Размер данных резервной копии (после сжатия в режиме MARS) * на сервер | Поддерживаемый номер SKU Azure Data Box                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <= 7,2 ТБ                                                    | [Azure Data Box диск](../databox/data-box-disk-overview.md) |
| >7,2 ТБ и <= 80 ТБ * *                                      | [Azure Data Box (100 ТБ)](../databox/data-box-overview.md) |

* Стандартные коэффициенты сжатия зависят от 10% до 20%. <br>
* * Если вы планируете использовать более 80 ТБ начальных резервных копий данных для одного сервера MARS, обратитесь к [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com) .

>[!IMPORTANT]
>Начальные данные резервного копирования с одного сервера должны содержаться в одном Azure Data Boxном экземпляре или Azure Data Box диске и не могут совместно использоваться несколькими устройствами одного или разных номеров SKU. Но Azure Data Box устройство может содержать начальные резервные копии с нескольких серверов.

## <a name="prerequisites"></a>Предварительные условия

### <a name="azure-subscription-and-required-permissions"></a>Подписка Azure и необходимые разрешения

- Для этого процесса требуется подписка Azure.
- Для этого процесса требуется, чтобы пользователь, предназначенный для выполнения политики автономного резервного копирования, был владельцем подписки Azure.
- Задание Data Box и хранилище служб восстановления (в которых данные должны быть заполнены) должны находиться в одной и той же подписке.
- Рекомендуется, чтобы Целевая учетная запись хранения, связанная с заданием Azure Data Box и хранилищем служб восстановления, нав одном регионе. Однако это не обязательно.

### <a name="get-azure-powershell-370"></a>Получение Azure PowerShell 3.7.0

*Это наиболее важный обязательный компонент для процесса*. Перед установкой Azure PowerShell версии 3.7.0 выполните следующие проверки.

#### <a name="step-1-check-the-powershell-version"></a>Шаг 1. Проверка версии PowerShell

1. Откройте Windows PowerShell и выполните следующую команду:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

1. Если в выходных данных отображается версия выше 3.7.0, выполните шаг 2. В противном случае перейдите к шагу 3.

#### <a name="step-2-uninstall-the-powershell-version"></a>Шаг 2. Удаление версии PowerShell

Удалите текущую версию PowerShell.

1. Удалите зависимые модули, выполнив следующую команду в PowerShell:

    ```powershell
    foreach ($module in (Get-Module -ListAvailable AzureRM*).Name |Get-Unique)  { write-host "Removing Module $module" Uninstall-module $module }
    ```

2. Чтобы убедиться в успешном удалении всех зависимых модулей, выполните следующую команду:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

#### <a name="step-3-install-powershell-version-370"></a>Шаг 3. Установка PowerShell версии 3.7.0

Убедившись, что модули AzureRM отсутствуют, установите версию 3.7.0, используя один из следующих методов.

- На сайте GitHub используйте [эту ссылку](https://github.com/Azure/azure-powershell/releases/tag/v3.7.0-March2017).

Также вы можете:

- В окне PowerShell выполните следующую команду:

    ```powershell
    Install-Module -Name AzureRM -RequiredVersion 3.7.0
    ```

Azure PowerShell также можно было установить с помощью файла MSI. Чтобы удалить его, удалите его с помощью параметра **удаление программ** на панели управления.

### <a name="order-and-receive-the-data-box-device"></a>Заказ и получение устройства Data Box

Процесс автономного резервного копирования с использованием MARS и Azure Data Box требует, чтобы устройства Data Box были в состоянии доставки, прежде чем запускать автономное резервное копирование с помощью агента MARS. Чтобы заказать наиболее подходящий SKU для вашего требования, см. раздел [объем данных резервной копии и поддерживаемые Data Box номера SKU](#backup-data-size-and-supported-data-box-skus). Выполните действия, описанные в разделе [учебник. упорядочивание Azure Data Box диска](../databox/data-box-disk-deploy-ordered.md) для заказа и получения устройств Data Box.

> [!IMPORTANT]
> Не выбирайте *блобстораже* для **типа учетной записи**. Агенту MARS требуется учетная запись, которая поддерживает страничные BLOB-объекты, которые не поддерживаются при выборе *блобстораже* . Выберите **хранилище версии 2 (общее назначение версии 2)** в качестве **типа учетной записи** при создании целевой учетной записи хранения для задания Azure Data Box.

![Выбор типа учетной записи в сведениях об экземпляре](./media/offline-backup-azure-data-box/instance-details.png)

## <a name="install-and-set-up-the-mars-agent"></a>Установка и настройка агента MARS

1. Убедитесь, что удалены все предыдущие установки агента MARS.
1. Скачайте последнюю версию агента MARS с [этого веб-сайта](https://aka.ms/azurebackup_agent).
1. Запустите *MARSAgentInstaller.exe* и выполните *только* шаги по [установке и регистрации агента](./install-mars-agent.md#install-and-register-the-agent) в хранилище служб восстановления, в котором необходимо хранить резервные копии.

   > [!NOTE]
   > Хранилище служб восстановления должно находиться в той же подписке, что и задание Azure Data Box.

   После регистрации агента в хранилище служб восстановления выполните действия, описанные в следующих разделах.

## <a name="set-up-azure-data-box-devices"></a>Настройка устройств Azure Data Box

В зависимости от заказа Azure Data Box номера SKU выполните действия, описанные в соответствующих разделах ниже. В этом руководстве показано, как настроить и подготовить устройства Data Box для агента MARS, чтобы определить и переместить исходные данные резервной копии.

### <a name="set-up-azure-data-box-disks"></a>Настройка дисков Azure Data Box

Если вы заказали один или несколько Azure Data Box дисков (по 8 ТБ), выполните описанные здесь действия, чтобы [распаковать, подключить и разблокировать диск Data Box](../databox/data-box-disk-deploy-set-up.md).

>[!NOTE]
>Возможно, сервер с агентом MARS не имеет USB-порта. В этом случае можно подключить диск Azure Data Box к другому серверу или клиенту и предоставить корневой каталог устройства в качестве общей сетевой папки.

### <a name="set-up-azure-data-box"></a>Настройка Azure Data Box

Если вы разупорядочиваи экземпляр Azure Data Box (до 100 ТБ), выполните действия, описанные здесь, [чтобы настроить экземпляр Data Box](../databox/data-box-deploy-set-up.md).

#### <a name="mount-your-azure-data-box-instance-as-a-local-system"></a>Подключение экземпляра Azure Data Box в качестве локальной системы

Агент MARS работает в контексте локальной системы, поэтому для пути подключения, в котором подключен экземпляр Azure Data Box, необходимо предоставить такой же уровень привилегий.

Чтобы обеспечить возможность подключения устройства Data Box в качестве локальной системы с помощью протокола NFS, выполните следующие действия.

1. Включите клиент для функции NFS на сервере Windows, на котором установлен агент MARS. Укажите альтернативный исходный *WIM-файл: D: \саурцес\инсталл.Вим: 4*.
1. Скачайте PsExec со страницы [Sysinternals](/sysinternals/downloads/psexec) на сервер с установленным агентом MARS.
1. Откройте командную строку с повышенными привилегиями и выполните следующую команду с каталогом, который содержит *PSExec.exe* в качестве текущего каталога.

    ```cmd
    psexec.exe  -s  -i  cmd.exe
    ```

   Командное окно, которое открывается из-за предыдущей команды, находится в контексте локальной системы. Используйте это командное окно, чтобы выполнить действия по подключению общего ресурса страничного BLOB-объекта Azure в качестве сетевого диска на сервере Windows.
1. Выполните действия, описанные в подразделе [Подключение к Data Box](../databox/data-box-deploy-copy-data-via-nfs.md#connect-to-data-box) , чтобы подключить сервер с агентом Mars к устройству Data Box с помощью NFS. Выполните следующую команду в командной строке локальной системы, чтобы подключить общую папку BLOB-объектов Azure.

    ```cmd
    mount -o nolock \\<DeviceIPAddress>\<StorageAccountName_PageBlob X:  
    ```

   После подключения общей папки проверьте, есть ли у вас доступ к X: с сервера. Если вы можете, перейдите к следующему разделу этой статьи.

## <a name="transfer-initial-backup-data-to-azure-data-box-devices"></a>Перенос данных начального резервного копирования на устройства Azure Data Box

1. Откройте приложение **Microsoft Azure Backup** на сервере.
1. На панели **действия** выберите **Расписание архивации**.

    ![Выбор расписания архивации](./media/offline-backup-azure-data-box/schedule-backup.png)

1. Выполните действия, описанные в **мастере планирования резервного копирования**.

1. Добавьте элементы, нажав кнопку **Добавить элементы** . Учитывайте общий размер элементов в пределах [размера, поддерживаемого Azure Data Box номером SKU](#backup-data-size-and-supported-data-box-skus) , который был заказан и получен.

    ![Добавление элементов в резервную копию](./media/offline-backup-azure-data-box/add-items.png)

1. Выберите подходящее расписание архивации и политику хранения для **файлов и папок** и **состояния системы**. Состояние системы применимо только для серверов Windows, а не для клиентов Windows.
1. На странице **Выбор типа начального резервного копирования (файлы и папки)** мастера выберите параметр **переместить с помощью Microsoft Azure Data Box диски** и нажмите кнопку **Далее**.

    ![Выберите тип начальной архивации](./media/offline-backup-azure-data-box/initial-backup-type.png)

1. Войдите в Azure при появлении запроса с использованием учетных данных пользователя, имеющих доступ владельца в подписке Azure. После выполнения этой операции вы увидите страницу, похожую на эту.

    ![Создание ресурсов и применение необходимых разрешений](./media/offline-backup-azure-data-box/creating-resources.png)

   Затем агент MARS выбирает задания Data Box в подписке, которые находятся в состоянии доставлено.

    ![Получение Data Box заданий для идентификатора подписки](./media/offline-backup-azure-data-box/fetching-databox-jobs.png)

1. Выберите правильный порядок Data Box, для которого был распакован, подключен и разблокирован диск Data Box. Выберите **Далее**.

    ![Выбор Data Box заказов](./media/offline-backup-azure-data-box/select-databox-order.png)

1. На странице **обнаружение устройств Data Box** выберите пункт **обнаружить устройство** . Это действие выполняет проверку агента MARS для локально подключенных Azure Data Box дисков и обнаруживает их.

    ![Обнаружение устройств Data Box](./media/offline-backup-azure-data-box/databox-device-detection.png)

    Если вы подключаете экземпляр Azure Data Box в качестве общей сетевой папки (из-за недоступности портов USB или если вы заказали и подключились на устройство Data Box 100-ТБ), обнаружение завершается с ошибкой. Вы можете ввести сетевой путь к Data Box устройству.

    ![Введите сетевой путь](./media/offline-backup-azure-data-box/enter-network-path.png)

    >[!IMPORTANT]
    > Укажите сетевой путь к корневому каталогу диска Azure Data Box. Этот каталог должен содержать каталог по имени *PageBlob*.
    >
    >![Корневой каталог диска Azure Data Box](./media/offline-backup-azure-data-box/root-directory.png)
    >
    >Например, если путь к диску — `\\mydomain\myserver\disk1\` и *disk1* содержит каталог с именем *PageBlob*, путь, введенный на странице мастера агента Mars, будет иметь значение `\\mydomain\myserver\disk1\` .
    >
    >Если вы [настроили устройство Azure Data Box 100 ТБ](#set-up-azure-data-box-devices), введите `\\<DeviceIPAddress>\<StorageAccountName>_PageBlob` сетевой путь к устройству.

1. Нажмите кнопку **Далее** и на следующей странице нажмите кнопку **Готово** , чтобы сохранить резервную копию и политику хранения с конфигурацией автономной резервной копии с помощью Azure Data Box.

   На следующей странице подтверждается, что политика успешно сохранена.

    ![Политика успешно сохранена](./media/offline-backup-azure-data-box/policy-saved.png)

1. На предыдущей странице нажмите кнопку **Закрыть** .

1. Выберите **создать резервную копию** на панели **действия** консоли агента MARS. На странице мастера выберите **создать резервную копию** .

    ![Мастер создания моментальных копий](./media/offline-backup-azure-data-box/backup-now.png)

Агент MARS запускает резервное копирование данных, выбранных на устройство Azure Data Box. Этот процесс может занять от нескольких часов до нескольких дней. Количество времени зависит от количества файлов и скорости соединения между сервером с агентом MARS и Azure Data Box диском.

После завершения резервного копирования данных в агенте MARS появится страница, похожая на эту.

![Ход архивации показан](./media/offline-backup-azure-data-box/backup-progress.png)

## <a name="post-backup-steps"></a>Действия, выполняемые после резервного копирования

В этом разделе описаны действия, которые необходимо выполнить после успешного резервного копирования данных в Диск Azure Data Box.

- Выполните действия, описанные в этой статье, чтобы [отправить Azure Data Box диск в Azure](../databox/data-box-disk-deploy-picked-up.md). Если вы использовали устройство Azure Data Box 100 ТБ, выполните следующие действия, чтобы [Отправить устройство Azure Data Box в Azure](../databox/data-box-deploy-picked-up.md).

- [Отслеживание задания Data Box](../databox/data-box-disk-deploy-upload-verify.md) на портале Azure. После завершения задания Azure Data Box агент MARS автоматически переместит данные из учетной записи хранения в хранилище служб восстановления во время следующего запланированного резервного копирования. Затем задание резервного копирования отмечается как *Задание завершено* , если точка восстановления создана успешно.

    >[!NOTE]
    >Агент MARS запускает резервное копирование в запланированное время при создании политики. Эти задания помечают "ожидание завершения задания Azure Data Box" до момента завершения задания.

- После того как агент MARS успешно создаст точку восстановления, соответствующую первоначальной резервной копии, можно удалить учетную запись хранения или конкретное содержимое, связанное с заданием Azure Data Box.

## <a name="troubleshooting"></a>Устранение неполадок

Агент Службы восстановления Microsoft Azure (MARS) создает в клиенте приложение Azure Active Directory (Azure AD). Для этого приложения требуется сертификат для проверки подлинности, который создается и отправляется при настройке политики автономного заполнения. Для создания и передачи сертификата в приложение Azure AD используется Azure PowerShell.

### <a name="problem"></a>Проблема

При настройке автономного резервного копирования может возникнуть проблема из-за ошибки в командлете Azure PowerShell. Возможно, вам не удастся добавить несколько сертификатов в одно приложение Azure AD, созданное агентом MAB. Эта проблема повлияет на вас, если вы настроили политику автономного заполнения для того же или другого сервера.

### <a name="verify-if-the-problem-is-caused-by-this-specific-root-cause"></a>Проверьте, вызвана ли проблема конкретной основной причиной

Чтобы узнать, совпадает ли ваша проблема с описанной выше, выполните одно из следующих действий.

#### <a name="step-1-of-verification"></a>Шаг 1 проверки

Проверьте, отображается ли следующее сообщение об ошибке в консоли MAB при настройке автономной архивации.

![Не удалось создать политику автономного резервного копирования для текущей учетной записи Azure](./media/offline-backup-azure-data-box/unable-to-create-policy.png)

#### <a name="step-2-of-verification"></a>Шаг 2 проверки

1. Откройте папку **TEMP** в пути установки. Путь к папке temp по умолчанию — *C:\Program Files\Microsoft Azure Recovery Services ажент\темп*. Найдите файл *кбуикурр* и откройте его.

1. В файле *кбуикурр* прокрутите до последней строки и проверьте, совпадает ли проблема с одной из следующих сообщений об ошибке: `Unable to create an Azure AD application credential in customer's account. Exception: Update to existing credential with KeyId <some guid> is not allowed` .

### <a name="workaround"></a>Обходной путь

Чтобы устранить эту проблему, выполните следующие действия и повторите настройку политики.

#### <a name="step-1-of-workaround"></a>Шаг 1 из решения

Войдите в PowerShell, который отображается в пользовательском интерфейсе MAB, используя другую учетную запись с правами администратора в подписке, в которой будет создано задание Data Box.

#### <a name="step-2-of-workaround"></a>Шаг 2 решения

Если на другом сервере не настроено автономное заполнение, а другие серверы не зависят от `AzureOfflineBackup_<Azure User Id>` приложения, удалите это приложение. Выберите **портал Azure**  >  **Azure Active Directory**  >  **Регистрация приложений**.

>[!NOTE]
> Проверьте, `AzureOfflineBackup_<Azure User Id>` не настроено ли другое начальное заполнение в приложении, а также в случае, если другие серверы не зависят от этого приложения. Выберите **Параметры**  >  **ключи** в разделе **открытые ключи** . Не должны быть добавлены другие открытые ключи. Справочные сведения см. на следующем снимке экрана.
>
>![Открытые ключи](./media/offline-backup-azure-data-box/public-keys.png)

#### <a name="step-3"></a>Шаг 3

На сервере, который вы пытаетесь настроить для автономной архивации, выполните следующие действия.

1. Перейдите на вкладку **Управление сертификатом приложения**  >  **персональный** компьютер и найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>` .

2. Выберите сертификат, щелкните правой кнопкой мыши **все задачи** и выберите **Экспорт** без закрытого ключа в формате CER.

3. Перейдите в приложение автономного резервного копирования Azure, упомянутое на шаге 2. Выберите **Параметры**  >  **ключи**  >  **отправить открытый ключ**. Отправьте сертификат, экспортированный на предыдущем шаге.

    ![Отправить открытый ключ](./media/offline-backup-azure-data-box/upload-public-key.png)

4. На сервере откройте реестр, введя в окне выполнения команду " **regedit** ".

5. Перейдите вComputer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider реестра *.* Щелкните правой кнопкой мыши **клаудбаккуппровидер** и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>` .

    >[!NOTE]
    > Чтобы получить идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >- В PowerShell, подключенном к Azure, выполните команду `Get-AzureRmADUser -UserPrincipalName "Account Holder's email as defined in the portal"`.
    > - Перейдите по пути реестра `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup` с именем *куррентусерид*.

6. Щелкните правой кнопкой мыши строку, добавленную на предыдущем шаге, и выберите пункт **изменить**. В поле значение укажите отпечаток сертификата, экспортированного на шаге 2. Щелкните **ОК**.

7. Чтобы получить значение отпечатка, дважды щелкните сертификат. Перейдите на вкладку **сведения** и прокрутите вниз, пока не увидите поле отпечаток. Выберите **отпечаток** и скопируйте значение.

    ![Поле отпечатка сертификата](./media/offline-backup-azure-data-box/thumbprint-field.png)

## <a name="questions"></a>Вопросы

Для получения любых вопросов и уточнений о любых возникших проблемах обратитесь к [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com) .
