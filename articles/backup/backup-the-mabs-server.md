---
title: Резервное копирование сервера MABS
description: Узнайте, как создать резервную копию сервера Microsoft Azure Backup (MABS).
ms.topic: conceptual
ms.date: 09/24/2020
ms.openlocfilehash: 81a6ee005e15b1d7ab7b11a938b8ab14143818f4
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92172117"
---
# <a name="back-up-the-mabs-server"></a>Резервное копирование сервера MABS

Чтобы гарантировать возможность восстановления данных при сбое Microsoft Azure Backup Server (MABS), потребуется стратегия резервного копирования сервера MABS. Если резервная копия не создана, потребуется перестроить ее вручную после сбоя, и точки восстановления на диске не будут восстановлены. Резервное копирование базы данных MABS можно выполнить с помощью резервного копирования серверов MABS.

## <a name="back-up-the-mabs-database"></a>Резервное копирование базы данных MABS

В рамках стратегии резервного копирования MABS необходимо создать резервную копию базы данных MABS. База данных MABS называется DPMDB. Эта база данных содержит конфигурацию MABS вместе с данными о резервных копиях MABS. В случае аварии можно перестроить большую часть функциональных возможностей сервера MABS, используя последнюю резервную копию базы данных. Предполагая, что вы можете восстановить базу данных, резервные копии на ленте доступны и поддерживают все параметры групп защиты и расписания резервного копирования. Если диски пула носителей MABS не были затронуты сбоем, резервные копии на диске также можно использовать после перестроения. Существует несколько различных методов резервного копирования базы данных.

|Метод резервного копирования базы данных|Преимущества|Недостатки|
|--------------------------|--------------|-----------------|
|[Архивация в Azure](#back-up-to-azure)|<li>Легко настраивается и отслеживается в MABS.<li>Несколько расположений файлов резервной копии базы данных.<li>Облачное хранилище предлагает надежное решение для аварийного восстановления.<li>Исключительно безопасное хранилище для базы данных.<li>Поддерживает 120 точек восстановления в сети.|<li>Требуется учетная запись Azure и дополнительная конфигурация MABS. Требует некоторых затрат на хранилище Azure.<li> Для получения доступа к резервным копиям MABS, хранящимся в хранилище службы архивации Azure, требуется поддерживаемая версия системы на основе Windows Server с агентом Azure. Это не может быть другой сервер MABS.<li>Этот вариант не подходит, если база данных размещается локально и необходимо включить дополнительную защиту. <li>В этом случае требуется некоторое дополнительное время на подготовку и восстановление.|
|[Резервное копирование базы данных путем резервного копирования пула носителей MABS](#back-up-the-database-by-backing-up-the-mabs-storage-pool)|<li>Простые процедуры настройки и отслеживания.<li>Резервная копия хранится на дисках пула носителей MABS, и к ней легко получить доступ локально.<li>MABS Scheduled Backups поддерживает 512 быстрых полных резервных копий. Если резервное копирование выполняется ежечасно, вы получите 21 день полной защиты.|<li>Это не совсем приемлемый вариант для аварийного восстановления. Он находится в оперативном режиме, и восстановление может работать не так, как ожидалось, в случае сбоя сервера MABS или диска пула носителей.<li>Этот вариант не подходит, если база данных размещается локально и необходимо включить дополнительную защиту. <li>Некоторые подготовительные и специальные действия необходимы для получения доступа к точкам восстановления, если служба MABS или консоль не работают или не работают.|
|[Резервное копирование с помощью собственного резервного копирования SQL Server на локальный диск](#back-up-with-native-sql-server-backup-to-a-local-disk)|<li>Встроенные в SQL Server.<li>Резервная копия хранится на локальном диске, к которому легко получить доступ.<li>Выполнение резервного копирования можно запланировать так часто, как это необходимо.<li>Полностью не зависит от MABS.<li>Имеется возможность запланировать очистку файла резервной копии.|<li>Если только резервные копии не копируются в удаленное расположение, этот вариант не очень хорошо подходит для аварийного восстановления.<li>Требуется локальное хранилище для резервных копий, что может ограничить период хранения и частоту.|
|[Резервное копирование с помощью собственного резервного копирования SQL и MABS Protection в общую папку, защищенную MABS](#back-up-to-a-share-protected-by-mabs)|<li>Легко отслеживать в MABS.<li>Несколько расположений файлов резервной копии базы данных.<li>Простой доступ с любого компьютера Windows в сети.<li>Потенциально это наиболее быстрый способ восстановления.|<li>Поддерживает только 64 точки восстановления.<li>Это не совсем приемлемый вариант для аварийного восстановления сайта. Сбой диска пула носителей MABS Server или MABS может препятствовать восстановлению.<li>Не является параметром, если база данных MABS размещена локально и вы хотите включить дополнительную защиту. <li>Чтобы его настроить и протестировать, потребуется некоторая дополнительная подготовка.<li>Необходимо выполнить дополнительную подготовку и время восстановления, если сам сервер MABS не работает, а диски пула носителей MABS.|

- При создании резервной копии с помощью группы защиты MABS рекомендуется использовать для базы данных уникальную группу защиты.

    > [!NOTE]
    > Для целей восстановления установка MABS, которую необходимо восстановить с помощью базы данных MABS, должна совпадать с версией самой базы данных MABS.  Например, если восстанавливаемая база данных относится к установке MABS v3 с накопительным пакетом обновления 1, то на сервере MABS должна быть установлена та же версия с накопительным пакетом обновления 1. Это означает, что может потребоваться удалить и переустановить MABS с совместимой версией перед восстановлением базы данных.  Чтобы узнать версию базы данных, может потребоваться вручную подключить ее к имени временной базы данных. Затем необходимо выполнить SQL-запрос к базе данных, чтобы узнать основной и дополнительный номера версии и, соответственно, выяснить, какой последний накопительный пакет установлен.

- Чтобы проверить версию базы данных MABS, выполните следующие действия.

    1. Чтобы выполнить запрос, откройте SQL Management Studio, а затем подключитесь к экземпляру SQL Server, на котором выполняется база данных MABS.

    2. Выберите базу данных MABS, а затем запустите новый запрос.

    3. Вставьте в панель запроса следующий запрос SQL и запустите его:

        `Select distinct MajorVersionNumber,MinorVersionNumber ,BuildNumber, FileName FROM dbo.tbl\_AM\_AgentPatch order byMajorVersionNumber,MinorVersionNumber,BuildNumber`

    Если в результатах запроса ничего не возвращается или сервер MABS был обновлен с предыдущих версий, но после этого не был установлен новый накопительный пакет обновления, запись для основного, дополнительного для базовой установки MABS не будет. Чтобы проверить версии MABS, связанные с накопительными пакетами обновления, см. [список номеров сборок для MABS](https://social.technet.microsoft.com/wiki/contents/articles/36381.microsoft-azure-backup-server-list-of-build-numbers.aspx).

### <a name="back-up-to-azure"></a>Резервное копирование в Azure

1. Прежде чем начать, необходимо выполнить сценарий для получения пути к точке подключения тома реплики MABS, чтобы узнать, какая точка восстановления содержит резервную копию MABS. Это необходимо сделать после начальной репликации с помощью службы архивации Azure. В скрипт замените на `dplsqlservername%` имя экземпляра SQL Server, на котором размещена база данных MABS.

    ```SQL
    Select ag.NetbiosName as ServerName,ds.DataSourceName,vol.MountPointPath
    from tbl_IM_DataSource as ds
    join tbl_PRM_LogicalReplica as lr on ds.DataSourceId=lr.DataSourceId
    join tbl_AM_Server as ag on ds.ServerId=ag.ServerId
    join tbl_SPM_Volume as vol on lr.PhysicalReplicaId=vol.VolumeSetID
    and vol.Usage =1
    and lr.Validity in (1,2)
    where ds.datasourcename like '%dpmdb%'
    and servername like '%dpmsqlservername%' --netbios name of server hosting DPMDB
    ```

    Убедитесь, что у вас есть секретный код, указанный при установке агента служб восстановления Azure, и сервер MABS был зарегистрирован в хранилище Azure Backup. Этот секретный код необходим для восстановления резервной копии.

2. Создайте хранилище службы архивации Azure, скачайте файл установки агента службы архивации Azure и учетные данные хранилища. Запустите файл установки, чтобы установить агент на сервере MABS и использовать учетные данные хранилища для регистрации сервера MABS в хранилище. [Подробнее](backup-azure-microsoft-azure-backup.md).

3. После настройки хранилища Настройте группу защиты MABS, содержащую базу данных MABS. Выберите этот пункт для резервного копирования на диск и в Azure.

#### <a name="recover-the-mabs-database-from-azure"></a>Восстановление базы данных MABS из Azure

Вы можете восстановить базу данных из Azure с помощью любого сервера MABS, зарегистрированного в хранилище Azure Backup, следующим образом.

1. В консоли MABS выберите **Восстановление**  >  **добавить внешний MABS**.

2. Укажите учетные данные хранилища (Скачайте из хранилища Azure Backup). Учтите, что учетные данные действительны только в течение двух дней.

3. В поле **выберите Внешние MABS для восстановления** выберите сервер MABS, для которого необходимо восстановить базу данных, введите парольную фразу для шифрования и нажмите кнопку **ОК.**

4. Выберите нужную точку восстановления в списке доступных точек. Выберите **очистить внешние MABS** , чтобы вернуться к локальному представлению MABS.

## <a name="back-up-the-mabs-database-to-mabs-storage-pool"></a>Резервное копирование базы данных MABS в пул носителей MABS

> [!NOTE]  
> Этот параметр применим для MABS с Современное хранилище резервных копий.

1. В консоли MABS выберите **Защита**  >  **создать группу защиты**.
2. На странице **Выбор типа группы защиты** выберите **Серверы**.
3. На странице **Выбор членов группы** выберите **база данных DPM**. Разверните сервер MABS и выберите DPMDB.
4. На странице **Выбор метода защиты данных** выберите вариант **краткосрочной защиты с использованием диска**. Укажите параметры политики краткосрочной защиты.
5. После начальной репликации базы данных MABS выполните следующий скрипт SQL:

```SQL
select AG.NetbiosName, DS.DatasourceName, V.AccessPath, LR.PhysicalReplicaId from tbl_IM_DataSource DS
join tbl_PRM_LogicalReplica as LR
on DS.DataSourceId = LR.DataSourceId
join tbl_AM_Server as AG
on DS.ServerId=AG.ServerId
join tbl_PRM_ReplicaVolume RV
on RV.ReplicaId = LR.PhysicalReplicaId
join tbl_STM_Volume V
on RV.StorageId = V.StorageId
where datasourcename like N'%dpmdb%' and ds.ProtectedGroupId is not null
and LR.Validity in (1,2)
and AG.ServerName like N'%<dpmsqlservername>%' -- <dpmsqlservername> is a placeholder, put netbios name of server hosting DPMDB
```

### <a name="recover-mabs-database"></a>Восстановление базы данных MABS

Чтобы восстановить MABS с помощью той же самой базы данных, сначала восстановите базу MABS, а затем синхронизируйте ее с установленным MABS.

#### <a name="use-the-following-steps"></a>Выполните следующие шаги.

1. Откройте командную строку администратора и выполните команду `psexec.exe -s powershell.exe` , чтобы запустить окно PowerShell в контексте системы.
2. Выберите расположение, из которого необходимо восстановить базу данных:

#### <a name="to-copy-the-database-from-the-last-backup"></a>Чтобы скопировать базу данных из последней резервной копии:

1. Перейдите по пути VHD реплики `\<MABSServer FQDN\>\<PhysicalReplicaId\>\<PhysicalReplicaId\>` .
2. Подключите **disk0. VHDX** с помощью `mount-vhd disk0.vhdx` команды.
3. После подключения VHD реплики используйте, `mountvol.exe` чтобы назначить букву диска тому реплики, используя идентификатор физической реплики из выходных данных скрипта SQL. Пример: `mountvol X: \?\Volume{}\`

#### <a name="to-copy-the-database-from-a-previous-recovery-point"></a>Чтобы скопировать базу данных из предыдущей точки восстановления:

1. Перейдите в каталог контейнера DPMDB  `\<MABSServer FQDN\>\<PhysicalReplicaId\>` . Вы увидите несколько каталогов с уникальными идентификаторами GUID в соответствующих точках восстановления, сделанных для MABS DB. Другие каталоги представляют собой точку со СМОЛой или точкой восстановления.
2. Перейдите к любому соответствующему виртуальному жесткому диску, например, `\<MABSServer FQDN\>\<PhysicalReplicaId\>\<PITId\>` и подключите к нему **disk0. VHDX** с помощью `mount-vhd disk0.vhdx` команды.
3. После подключения VHD реплики используйте, `mountvol.exe` чтобы назначить букву диска тому реплики, используя идентификатор физической реплики из выходных данных скрипта SQL. Пример: `mountvol X: \?\Volume{}\`

   Все термины, отображаемые в угловых скобках на приведенных выше шагах, задают владельцев. Замените их соответствующими значениями следующим образом:
   - **Рефсволуме** — путь доступа из выходных данных СКРИПТа SQL
   - **МАБССЕРВЕР FQDN** — полное имя сервера MABS.
   - **Фисикалрепликаид** — идентификатор физической реплики из СКРИПТа SQL
   - **Питид** — идентификатор GUID, отличный от идентификатора физической реплики в каталоге контейнера.
4. Откройте еще одну административную командную строку и выполните `psexec.exe -s cmd.exe` команду, чтобы запустить командную строку в контексте системы.
5. Измените каталог на диск X: и перейдите к расположению файлов базы данных MABS.
6. Скопируйте их в расположение, в которое будет удобно выполнить восстановление. Выйдите из окна команды psexec после копирования.
7. Перейдите в окно PsExec PowerShell, открытое на шаге 1, перейдите к VHDX-файлу и отключите VHDX с помощью команды `dismount-vhd disk0.vhdx` .
8. После переустановки сервера MABS можно использовать восстановленный DPMDB для подключения к серверу MABS, выполнив `DPMSYNC-RESTOREDB` команду.
9. `DPMSYNC-SYNC`Однократное выполнение `DPMSYNC-RESTOREDB` завершается.

### <a name="back-up-the-database-by-backing-up-the-mabs-storage-pool"></a>Резервное копирование базы данных путем резервного копирования пула носителей MABS

> [!NOTE]
> Этот параметр применяется для MABS с устаревшим хранилищем.

Прежде чем начать, необходимо выполнить сценарий для получения пути к точке подключения тома реплики MABS, чтобы узнать, какая точка восстановления содержит резервную копию MABS. Это необходимо сделать после начальной репликации с помощью службы архивации Azure. В скрипт замените на `dplsqlservername%` имя экземпляра SQL Server, на котором размещена база данных MABS.

```SQL
Select ag.NetbiosName as ServerName,ds.DataSourceName,vol.MountPointPath
from tbl_IM_DataSource as ds
join tbl_PRM_LogicalReplica as lr on ds.DataSourceId=lr.DataSourceId
join tbl_AM_Server as ag on ds.ServerId=ag.ServerId
join tbl_SPM_Volume as vol on lr.PhysicalReplicaId=vol.VolumeSetID
and vol.Usage =1
and lr.Validity in (1,2)
where ds.datasourcename like '%dpmdb%'
and servername like '%dpmsqlservername%' --netbios name of server hosting DPMDB
```

1. В консоли MABS выберите **Защита**  >  **создать группу защиты**.

2. На странице **Выбор типа группы защиты** выберите **Серверы**.

3. На странице **Выбор членов группы** выберите базу данных MABS. Разверните элемент сервер MABS и выберите **DPMDB**.

4. На странице  **Выбор метода защиты данных** выберите вариант **Краткосрочная защита с помощью диска**. Укажите параметры политики краткосрочной защиты. Для баз данных MABS рекомендуется использовать диапазон хранения в две недели.

#### <a name="recover-the-database"></a>Восстановление базы данных

Если сервер MABS по-прежнему работает и пул носителей не поврежден (например, проблемы со службой MABS или консолью), скопируйте базу данных из тома реплики или теневой копии следующим образом:

1. Выберите расположение для восстановления базы данных.

    - Если вы хотите скопировать базу данных из последней резервной копии, полученной непосредственно из тома реплики MABS, используйте **mountvol.exe** , чтобы назначить букву диска тому реплики с помощью идентификатора GUID из выходных данных скрипта SQL. Пример: `C:\Mountvol X: \\?\Volume{d7a4fd76\-a0a8\-11e2\-8fd3\-001c23cb7375}\`

    - Если необходимо скопировать базу данных из предыдущей точки восстановления (теневая копия), необходимо перечислить все теневые копии для реплики с помощью GUID тома из выходных данных скрипта SQL. Эта команда выводит список теневых копий для этого тома: `C:\>Vssadmin list shadows /for\=\\?\Volume{d7a4fd76-a0a8-11e2-8fd3-001c23cb7375}\` . Обратите внимание на время создания и идентификатор теневой копии, из которой нужно выполнить восстановление.

2. Затем используйте **diskshadow.exe** для подключения теневой копии к неиспользуемой букве диска X: с помощью идентификатора теневой копии, чтобы можно было скопировать файлы базы данных.

3. Откройте командную строку администратора и выполните команду `psexec.exe -s cmd.exe` , чтобы запустить командную строку в контексте системы, поэтому у вас есть разрешение на переход на том реплики (X:) и скопируйте файлы.

4. На диск X: и перейдите в расположение файлов базы данных MABS. Скопируйте их в расположение, в которое будет удобно выполнить восстановление. После завершения копирования укажите окно PsExec cmd и выполните **diskshadow.exe** и Unexpose диск X:.

5. Теперь можно восстановить файлы базы данных с помощью SQL Management Studio или путем запуска **DPMSYNC \- RESTOREDB**.

## <a name="back-up-with-native-sql-server-backup-to-a-local-disk"></a>Резервное копирование с помощью собственного резервного копирования SQL Server на локальный диск

Вы можете создать резервную копию базы данных MABS на локальном диске с собственной SQL Server резервной копией независимо от MABS.

- Ознакомьтесь с [обзором](/sql/relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases) резервного копирования SQL Server.

- Получите [дополнительные сведения](/sql/relational-databases/backup-restore/sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service) о резервном копировании данных SQL Server в облако.

## <a name="back-up-to-a-share-protected-by-mabs"></a>Резервное копирование в общую папку, защищенную MABS

Этот параметр резервного копирования использует собственный SQL для резервного копирования базы данных MABS в общую папку, защищает общий ресурс с помощью MABS и использует предыдущие версии Windows VSS для упрощения восстановления.

### <a name="before-you-start"></a>Перед началом работы

1. На SQL Server создайте папку на диске с достаточным свободным местом для хранения одной копии резервной копии. Например, `C:\MABSBACKUP`.

1. Предоставьте доступ к этой папке. Например, предоставьте общий доступ к `C:\MABSBACKUP` папке как *DPMBACKUP*.

1. Скопируйте и вставьте приведенную ниже команду OSQL в блокнот и сохраните ее в файл с именем `C:\MABSACKUP\bkupdb.cmd` . Убедитесь, что расширение txt отсутствует. Измените SQL_Instance_name и DPMDB_NAME в соответствии с именем экземпляра и DPMDB, используемым сервером MABS.

    ```SQL
    OSQL -E -S localhost\SQL_INSTANCE_NAME -Q "BACKUP DATABASE DPMDB_NAME TO DISK='C:\DPMBACKUP\dpmdb.bak' WITH FORMAT"
    ```

1. В Блокноте откройте файл **ScriptingConfig.xml** , расположенный в `C:\Program Files\Microsoft System Center\DPM\DPM\Scripting` папке на сервере MABS.

1. Измените **ScriptingConfig.xml** и измените имя **источника =** на букву диска, содержащую папку или общий ресурс папку dpmdbbackup. Измените запись PreBackupScript на полный путь и имя **BkUpDB. cmd** , сохраненные на шаге 3.

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <ScriptConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="https://schemas.microsoft.com/2003/dls/ScriptingConfig.xsd">
    <DatasourceScriptConfig DataSourceName="C:">
    <PreBackupScript>C:\MABSDBBACKUP\bkupdb.cmd</PreBackupScript>
    <TimeOut>120</TimeOut>
    </DatasourceScriptConfig>
    </ScriptConfiguration>
    ```

1. Сохраните изменения в **ScriptingConfig.xml**.

1. Включите защиту папки К:\МАБСБАККУП или `\sqlservername\MABSBACKUP` общей папки с помощью MABS и дождитесь создания начальной реплики. В результате выполнения сценария, выполняемого перед резервным копированием, в папке К:\МАБСБАККУП должен быть **DPMDB. bak** , который был скопирован в реплику MABS.

1. Если вы не включаете самостоятельное восстановление, вам потребуются дополнительные действия для предоставления общего доступа к папке МАБСБАККУП в реплике:

    1. В консоли MABS > **Защита**, перейдите к источнику данных мабсбаккуп и выберите его. В разделе сведения выберите **щелкните, чтобы просмотреть сведения** о ссылке на путь реплики и скопировать путь в Блокнот. Удалите исходный путь и сохраните конечный путь. Путь должен выглядеть следующим образом: `C:\Program Files\Microsoft System Center\DPM\DPM\Volumes\Replica\File System\vol_c9aea05f-31e6-45e5-880c-92ce5fba0a58\454d81a0-0d9d-4e07-9617-d49e3f2aa5de\Full\DPMBACKUP` .

    2. Предоставьте общий доступ к этому пути, используя имя общего ресурса **мабссервернаме-DPMDB**. Можно использовать указанную ниже команду Net Share из административной командной строки.

        ```cmd
        Net Share MABSSERVERNAME-dpmdb="C:\Program Files\Microsoft System Center\DPM\DPM\Volumes\Replica\File System\vol_c9aea05f-31e6-45e5-880c-92ce5fba0a58\454d81a0-0d9d-4e07-9617-d49e3f2aa5de\Full\DPMBACKUP"
        ```

### <a name="configure-the-backup"></a>Настройка резервного копирования

Можно создать резервную копию базы данных MABS так же, как любую другую базу данных SQL Server, используя SQL Server собственную резервную копию.

- Ознакомьтесь с [обзором](/sql/relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases) резервного копирования SQL Server.

- Получите [дополнительные сведения](/sql/relational-databases/backup-restore/sql-server-backup-and-restore-with-microsoft-azure-blob-storage-service) о резервном копировании данных SQL Server в облако.

### <a name="recover-the-mabs-database"></a>Восстановление базы данных MABS

1. Подключитесь к `\\MABSServer\MABSSERVERNAME-dpmdb` общему ресурсу с помощью проводника с любого компьютера Windows.

2. Щелкните правой кнопкой мыши файл **DPMDB. bak** , чтобы просмотреть свойства. На вкладке **Предыдущие версии** присутствуют все резервные копии, которые можно выбрать и скопировать. Также существует последняя резервная копия, которая по-прежнему находится в папке К:\МАБСБАККУП, которая также легко доступна.

3. Если необходимо переместить диск пула носителей MABS, подключенный к сети SAN, на другой сервер для чтения с тома реплики или переустановить Windows для чтения локально подключенных дисков, необходимо заранее знать путь к точке подключения тома реплики MABS или GUID тома, чтобы узнать, какой том содержит резервную копию базы данных. Можно использовать приведенный ниже скрипт SQL для извлечения этой информации в любое время после начальной защиты, но перед тем, как будет нужно выполнить восстановление. Замените на `%dpmsqlservername%` имя SQL Server, на котором размещена база данных.

    ```sql
    Select ag.NetbiosName as
    ServerName,ds.DataSourceName,vol.MountPointPath,vol.GuidName
    from tbl_IM_DataSource as ds
    join tbl_PRM_LogicalReplica as lr on ds.DataSourceId=lr.DataSourceId
    join tbl_AM_Server as ag on ds.ServerId=ag.ServerId
    join tbl_SPM_Volume as vol on lr.PhysicalReplicaId=vol.VolumeSetID
    and vol.Usage =1
    and lr.Validity in (1,2)
    where ds.datasourcename like '%C:\%' -- volume drive letter for DPMBACKUP
    and servername like '%dpmsqlservername%' --netbios name of server hosting DPMDB

    ```

4. Если необходимо выполнить восстановление после перемещения дисков пула носителей MABS или перестроения сервера MABS:

    1. У вас есть GUID тома, поэтому этот том должен быть подключен к другому серверу Windows Server или после перестроения сервера MABS. Используйте **mountvol.exe** , чтобы назначить ему букву диска с помощью GUID тома из выходных данных скрипта SQL: `C:\Mountvol X: \\?\Volume{d7a4fd76-a0a8-11e2-8fd3-001c23cb7375}\` .

    2. Повторно предоставьте общий доступ к папке МАБСБАККУП на томе реплики, используя букву диска и часть пути реплики, представляющую структуру папки.

        ```cmd
        net share SERVERNAME-DPMDB="X:\454d81a0-0d9d-4e07-9617-d49e3f2aa5de\Full\DPMBACKUP"
        ```

    3. Подключитесь к `\\SERVERNAME\MABSSERVERNAME-dpmdb` общему ресурсу с помощью проводника с любого компьютера Windows.

    4. Щелкните правой кнопкой мыши файл **DPMDB. bak** , чтобы просмотреть свойства. На вкладке **Предыдущие версии** присутствуют все резервные копии, которые можно выбрать и скопировать.

## <a name="using-dpmsync"></a>Использование DPMSync

**Dpmsync** — это программа командной строки, которая позволяет синхронизировать базу данных MABS с состоянием дисков в пуле носителей и установленных агентах защиты. DpmSync восстанавливает базу данных MABS, синхронизирует базу данных MABS с репликами в пуле носителей, восстанавливает базу данных отчетов и перераспределяет недостающие реплики.

### <a name="parameters"></a>Параметры

| Параметр      | Описание:    |
|----------------|-----------------------------|
| **-RestoreDb**                       | Восстанавливает базу данных MABS из указанного расположения.|
| **-Sync**                            | Синхронизирует восстановленные базы данных. После восстановления баз данных необходимо запустить **dpmsync – sync** . После запуска **dpmsync — sync** некоторые реплики по-прежнему могут быть помечены как отсутствующие. |
| **-DbLoc** *расположение*                | Определяет расположение резервной копии базы данных MABS.|
| **-InstanceName** <br/>*сохраняет*     | Экземпляр, в котором необходимо восстановить DPMDB.|
| **-ReallocateReplica**         | Повторно выделяет место для всех отсутствующих томов реплик без синхронизации. |
| **-DataCopied**                      | Показывает, что завершена загрузка данных во вновь выделенные тома реплик. Это относится только к клиентским компьютерам. |

**Пример 1.** Чтобы восстановить базу данных MABS с локального носителя резервных копий на сервере MABS, выполните следующую команду:

```cmd
DpmSync –RestoreDb -DbLoc G:\DPM\Backups\2005\November\DPMDB.bak
```

После восстановления базы данных MABS для синхронизации баз данных выполните следующую команду:

```cmd
DpmSync -Sync
```

После восстановления и синхронизации базы данных MABS и перед восстановлением реплики выполните следующую команду, чтобы перераспределить место на диске для реплики:

```cmd
DpmSync -ReallocateReplica
```

**Пример 2:** Чтобы восстановить базу данных MABS из удаленной базы данных, выполните следующую команду на удаленном компьютере:

```cmd
DpmSync –RestoreDb -DbLoc G:\DPM\Backups\2005\November\DPMDB.bak –InstanceName contoso\ms$dpm
```

После восстановления базы данных MABS для синхронизации баз данных выполните следующую команду на сервере MABS:

```cmd
DpmSync -Sync
```

После восстановления и синхронизации базы данных MABS и перед восстановлением реплики выполните следующую команду на сервере MABS, чтобы перераспределить место на диске для реплики:

```cmd
DpmSync -ReallocateReplica
```

## <a name="next-steps"></a>Дальнейшие действия

- [Матрица поддержки MABS](backup-support-matrix-mabs-dpm.md)
- [ВОПРОСЫ И ОТВЕТЫ ПО MABS](backup-azure-dpm-azure-server-faq.md)