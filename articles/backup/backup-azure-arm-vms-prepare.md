---
title: Резервное копирование виртуальных машин Azure в хранилище Служб восстановления
description: Описание резервного копирования виртуальных машин Azure в хранилище Служб восстановления с помощью Azure Backup
ms.topic: conceptual
ms.date: 07/28/2020
ms.openlocfilehash: f6fe2f629742e15e62dfc13106e92623a4b45add
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92172743"
---
# <a name="back-up-azure-vms-in-a-recovery-services-vault"></a>Резервное копирование виртуальных машин Azure в хранилище Служб восстановления

В этой статье описывается, как выполнять резервное копирование виртуальных машин Azure в хранилище Служб восстановления с помощью службы [Azure Backup](backup-overview.md).

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
>
> * Подготовка виртуальных машин Azure.
> * создание хранилища;
> * Обнаружение виртуальных машин и настройка политики резервного копирования.
> * Включение резервного копирования для виртуальных машин Azure.
> * Выполнение начального резервного копирования.

> [!NOTE]
> В этой статье описывается, как настроить хранилище и выбрать виртуальные машины для резервного копирования. Этот способ удобен, если вы хотите создать резервные копии нескольких виртуальных машин. Кроме того, можно [выполнить резервное копирование одной виртуальной машины Azure](backup-azure-vms-first-look-arm.md) непосредственно из параметров виртуальной машины.

## <a name="before-you-start"></a>Перед началом работы

* [Ознакомьтесь](backup-architecture.md#architecture-built-in-azure-vm-backup) с архитектурой резервного копирования виртуальной машины Azure.
* [Узнайте о](backup-azure-vms-introduction.md) резервном копировании виртуальных машин Azure и расширении резервного копирования.
* [Перед настройкой резервного копирования ознакомьтесь с таблицей поддержки](backup-support-matrix-iaas.md).

Кроме того, в некоторых случаях может потребоваться несколько действий:

* **Установить агент виртуальной машины**. Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure Marketplace, агент установлен и запущен. Если вы создаете пользовательскую виртуальную машину или выполняете миграцию локального компьютера, может потребоваться [установить агент вручную](#install-the-vm-agent).

[!INCLUDE [backup-center.md](../../includes/backup-center.md)]

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

### <a name="modify-storage-replication"></a>Изменение репликации хранилища

По умолчанию в хранилищах используется [геоизбыточное хранилище (GRS)](../storage/common/storage-redundancy.md#geo-redundant-storage).

* Если хранилище является основным механизмом резервного копирования, рекомендуется использовать GRS.
* Для более дешевого варианта можно использовать [локально избыточное хранилище (LRS)](../storage/common/storage-redundancy.md#locally-redundant-storage) .
* [Хранилище, избыточное между зонами (ZRS),](../storage/common/storage-redundancy.md#zone-redundant-storage) реплицирует данные в [зоны доступности](../availability-zones/az-overview.md#availability-zones), гарантируя расположение и устойчивость данных в пределах одного региона.

Измените тип репликации хранилища следующим образом.

1. В новом хранилище выберите **Свойства** в разделе **Параметры** .
2. В окне **Свойства** в разделе **Конфигурация архивации** выберите **Обновить**.
3. Выберите тип репликации хранилища и нажмите кнопку **сохранить**.

      ![Настройка конфигурации для нового хранилища](./media/backup-azure-arm-vms-prepare/full-blade.png)

> [!NOTE]
   > Вы не можете изменить тип репликации хранилища, когда хранилище уже настроено и содержит элементы для резервного копирования. Если вы хотите это сделать, необходимо создавать хранилище повторно.

## <a name="apply-a-backup-policy"></a>Добавление политики резервного копирования

Настройте политику резервного копирования для хранилища.

1. В разделе " **Обзор** " хранилища выберите **+ Backup (+ резервная копия** ).

   ![Кнопка "Архивация"](./media/backup-azure-arm-vms-prepare/backup-button.png)

1. В разделе **Цель резервного копирования** > **Где выполняется рабочая нагрузка?** выберите **Azure**. В раскрывающемся списке **Что необходимо архивировать?** выберите **Виртуальная машина** >  **ОК**. При этом расширение виртуальной машины зарегистрируется в хранилище.

   ![Области "Архивация" и "Цель резервного копирования"](./media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

1. В области **Политика архивации** выберите политику, которую вы хотите связать с хранилищем.
    * Политика по умолчанию создает резервную копию виртуальной машины один раз в день. Ежедневные резервные копии хранятся в течение 30 дней. Моментальные снимки восстановления хранятся в течение двух дней.

      ![Политика резервного копирования по умолчанию](./media/backup-azure-arm-vms-prepare/default-policy.png)

    * Если вы не хотите использовать политику по умолчанию, выберите **Создать новую** и создайте настраиваемую политику, как описано ниже.

1. В разделе **Виртуальные машины** щелкните **Добавить**.

      ![Добавить виртуальные машины](./media/backup-azure-arm-vms-prepare/add-virtual-machines.png)

1. Откроется область **Выбор виртуальных машин**. Выберите виртуальные машины, для которых необходимо создать резервную копию с помощью политики. Нажмите кнопку **ОК**.

   * Выбранные виртуальные машины проверены.
   * Виртуальные машины можно выбрать только в том же регионе, что и хранилище.
   * Архивация виртуальных машин может выполняться только в одном хранилище.

     ![Область "Выбор виртуальных машин"](./media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

    >[!NOTE]
    > Все виртуальные машины в том же регионе и подписке, что и хранилище, доступны для настройки резервного копирования. При настройке резервного копирования можно перейти к имени виртуальной машины и ее группе ресурсов, даже если у вас нет необходимых разрешений на этих виртуальных машинах. Если виртуальная машина находится в обратимо удаленном состоянии, она не будет отображаться в этом списке. Если необходимо повторно защитить виртуальную машину, необходимо дождаться истечения периода обратимого удаления или отменить удаление виртуальной машины из списка обратимого удаления. Дополнительные сведения см. [в статье обратимое удаление для виртуальных машин](soft-delete-virtual-machines.md#soft-delete-for-vms-using-azure-portal).

1. В разделе **Архивация** выберите **Включить резервное копирование**. При этом в хранилище и на виртуальных машинах развертывается политика и устанавливается расширение архивации на агенте ВМ на виртуальной машине Azure.

После включения резервного копирования

* Расширение резервного копирования устанавливается службой Azure Backup независимо от того, запущена ли виртуальная машина.
* Начальное резервное копирование запускается в соответствии с расписанием резервного копирования.
* При выполнении резервного копирования обратите внимание на следующее.
  * Виртуальная машина, которая работает, имеет наибольшую шансы на запись точки восстановления, соответствующей приложению.
  * Однако, даже если виртуальная машина отключена, она архивируется. Такая виртуальная машина называется автономной виртуальной машиной. В этом случае точка восстановления будет отказоустойчивой.
* Для резервного копирования виртуальных машин Azure явное исходящее подключение не требуется.

### <a name="create-a-custom-policy"></a>Создание настраиваемой политики

Если вы выбрали создание новой политики резервного копирования, заполните параметры политики.

1. В поле **Имя политики** укажите понятное имя.
2. В поле **Расписание резервного копирования** укажите, когда следует выполнять резервное копирование. Для виртуальных машин Azure можно создавать ежедневное или еженедельное резервное копирование.
3. В поле **Мгновенное восстановление** укажите, как долго следует хранить моментальные снимки локально для мгновенного восстановления.
    * При восстановлении резервные копии дисков виртуальных машин копируются из хранилища по сети в место хранения для восстановления. С помощью мгновенного восстановления можно использовать локально сохраненные моментальные снимки, созданные во время задания резервного копирования, не дожидаясь передачи данных резервного копирования в хранилище.
    * Моментальные снимки для мгновенного восстановления можно хранить от 1 до 5 дней. Значение по умолчанию — 2 дня.
4. В поле **Диапазон хранения** укажите, как долго нужно хранить точки ежедневного или еженедельного резервного копирования.
5. При **хранении ежемесячной точки резервного копирования** и **хранения точки ежегодного резервного копирования** укажите, следует ли хранить ежемесячные или еженедельные резервные копии ежедневно или ежегодно.
6. Нажмите кнопку **ОК** , чтобы сохранить политику.

    ![Новая политика резервного копирования](./media/backup-azure-arm-vms-prepare/new-policy.png)

> [!NOTE]
   > Azure Backup не поддерживает настройку автоматического перехода на летнее время для резервных копий виртуальных машин Azure. При возникновении изменений во времени необходимо вручную изменить политики резервного копирования.

## <a name="trigger-the-initial-backup"></a>Активация начального резервного копирования

Начальное резервное копирование будет выполняться в соответствии с расписанием, но его можно запустить немедленно, как показано ниже.

1. В меню хранилище выберите пункт **архивные элементы**.
2. В списке **элементы архивации** выберите **Виртуальная машина Azure**.
3. В списке **архивные элементы** щелкните многоточие (...).
4. Выберите **архивацию сейчас**.
5. В окне **Создать резервную копию** используйте элементы управления "Календарь", чтобы выбрать последний день, до которого должна храниться точка восстановления. Нажмите кнопку **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.

## <a name="verify-backup-job-status"></a>Проверка состояния задания Backup

Задание резервного копирования для каждой резервной копии виртуальной машины состоит из двух частей: этап **моментального снимка**, за которым следует этап **Передачи данных в хранилище**.<br/>
Этап создания моментального снимка гарантирует доступность точки восстановления, хранящейся вместе с дисками, для **мгновенного восстановления**. Она доступна не более пяти дней в зависимости от срока хранения моментальных снимков, заданного пользователем. При переносе данных в хранилище создается точка восстановления для долгосрочного хранения. Перенос данных в хранилище начинается только после завершения этапа создания моментального снимка.

  ![Состояние задания Backup](./media/backup-azure-arm-vms-prepare/backup-job-status.png)

В серверной части есть две **подзадачи** , одна для задания фонового копирования, которую можно проверить на панели сведения о **задании резервного копирования** , как указано ниже:

  ![Подзадачи состояния задания резервного копирования](./media/backup-azure-arm-vms-prepare/backup-job-phase.png)

Этап **Передача данных в хранилище** может занять несколько дней в зависимости от размера дисков, количества операций обработки на диск и ряда других факторов.

Состояние задания может различаться в зависимости от следующих сценариев.

**Моментальный снимок** | **Передача данных в хранилище** | **Состояние задания**
--- | --- | ---
Завершено | Выполняется | Выполняется
Завершено | Пропущено | Завершено
Завершено | Завершено | Завершено
Завершено | Ошибка | Выполнено с предупреждениями
Ошибка | Ошибка | Ошибка

Теперь с использованием этой возможности для одной и той же виртуальной машины две резервные копии могут создаваться параллельно, но на одном этапе (моментальный снимок, передача данных в хранилище) может выполняться только одна подзадача. Поэтому в сценариях, где выполнение задания резервного копирования привело к сбою резервного копирования в следующий день, это будет невозможно с этой функцией разделения. В последующих днях резервные копии моментального снимка могут быть завершены, а при **переносе данных в хранилище** пропускается, если задание резервного копирования на более ранний день находится в состоянии выполняется.
Добавочная точка восстановления, созданная в хранилище, будет записывать все изменения из последней точки восстановления, созданной в хранилище. На пользователя не влияет никаких затрат.

## <a name="optional-steps"></a>Другие возможные шаги

### <a name="install-the-vm-agent"></a>Установка агента виртуальной машины

Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure Marketplace, агент установлен и запущен. Если вы создаете пользовательскую виртуальную машину или выполняете миграцию локального компьютера, может потребоваться установить агент вручную, как показано в таблице.

**Виртуальная машина** | **Сведения**
--- | ---
**Windows** | 1. [Скачайте и установите](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) MSI-файл агента.<br/><br/> 2. Требуется установка с разрешениями администратора на компьютере.<br/><br/> 3. Проверьте установку. В папке *C:\WindowsAzure\Packages* на виртуальной машине щелкните правой кнопкой мыши файл **WaAppAgent.exe** > **Свойства**. На вкладке **Сведения** в строке **Версия продукта** должна быть указана версия 2.6.1198.718 или выше.<br/><br/> Если вам нужно обновить агент, убедитесь, что операции резервного копирования не выполняются, и [переустановите агент](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).
**Linux** | Установите, используя RPM- или DEB-пакеты из репозитория пакетов дистрибутива. Это предпочтительный способ установки и обновления агента Linux для Azure. Все [поставщики поддерживаемых дистрибутивов](../virtual-machines/linux/endorsed-distros.md) встраивают пакет агента Linux для Azure в свои образы и репозитории. Агент можно найти в [GitHub](https://github.com/Azure/WALinuxAgent), но мы не рекомендуем устанавливать его оттуда.<br/><br/> Если вам нужно обновить агент, убедитесь, что операции резервного копирования не выполняются, и обновите двоичные файлы.

## <a name="next-steps"></a>Дальнейшие действия

* Устраните проблемы с [агентами виртуальной машины Azure](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) или [резервным копированием виртуальных машин Azure](backup-azure-vms-troubleshoot.md).
* [Восстановите](backup-azure-arm-restore-vms.md) виртуальные машины Azure.