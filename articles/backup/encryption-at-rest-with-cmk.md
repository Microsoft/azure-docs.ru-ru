---
title: Шифрование данных резервных копий с помощью управляемых клиентом ключей
description: Узнайте, как Azure Backup позволяет шифровать данные резервных копий с помощью ключей, управляемых клиентом (CMK).
ms.topic: conceptual
ms.date: 07/08/2020
ms.openlocfilehash: d5daa88475e3becde6e513391c555471f80396c5
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98735866"
---
# <a name="encryption-of-backup-data-using-customer-managed-keys"></a>Шифрование данных резервных копий с помощью управляемых клиентом ключей

Azure Backup позволяет зашифровать данные резервных копий с помощью управляемых клиентом ключей (CMK) вместо использования ключей, управляемых платформой, которые включены по умолчанию. Ключи, используемые для шифрования данных резервных копий, должны храниться в [Azure Key Vault](../key-vault/index.yml).

Ключ шифрования, используемый для шифрования резервных копий, может отличаться от используемого для источника. Данные защищаются с помощью ключа шифрования данных на основе AES 256 (DEK), который, в свою очередь, защищен с помощью ключей (KEK). Это дает полный контроль над данными и ключами. Чтобы разрешить шифрование, необходимо предоставить хранилищу служб восстановления доступ к ключу шифрования в Azure Key Vault. Ключ можно изменить как и при необходимости.

В этой статье рассматриваются следующие вопросы:

- Создание хранилища служб восстановления
- Настройка хранилища служб восстановления для шифрования данных резервных копий с помощью управляемых клиентом ключей
- Выполнение резервного копирования в хранилищах, зашифрованных с помощью управляемых клиентом ключей
- Восстановление данных из резервных копий

## <a name="before-you-start"></a>Перед началом работы

- Эта функция позволяет шифровать **только новые хранилища служб восстановления**. Все хранилища, содержащие зарегистрированные или регистрируемые в нем элементы, не поддерживаются.

- После включения для хранилища служб восстановления шифрование с помощью управляемых клиентом ключей не может быть возвращено к использованию ключей, управляемых платформой (по умолчанию). Ключи шифрования можно изменить в соответствии с вашими требованиями.

- Сейчас эта функция **не поддерживает резервное копирование с помощью агента Mars**, и вы не сможете использовать для этого хранилище, зашифрованное в CMK. Агент MARS использует шифрование на основе парольной фразы пользователя. Эта функция также не поддерживает резервное копирование классических виртуальных машин.

- Эта функция не связана с [шифрованием дисков Azure](../security/fundamentals/azure-disk-encryption-vms-vmss.md), которое использует шифрование дисков виртуальной машины на виртуальной машине с помощью BitLocker (для Windows) и DM-Crypt (для Linux).

- Хранилище служб восстановления может быть зашифровано только с помощью ключей, хранящихся в Azure Key Vault, расположенном в том **же регионе**. Кроме того, ключи должны быть только с **ключами RSA 2048** и должны находиться в состоянии **Enabled** .

- Перемещение CMK зашифрованного хранилища служб восстановления между группами ресурсов и подписками сейчас не поддерживается.

- Эту функцию можно настроить с помощью портал Azure и PowerShell.

    >[!NOTE]
    >Используйте команду AZ Module 5.3.0 или более позднюю, чтобы использовать управляемые пользователем ключи для резервного копирования в хранилище служб восстановления.

Если вы еще не создали и не настроили хранилище служб восстановления, то можете [прочитать здесь](backup-create-rs-vault.md).

## <a name="configuring-a-vault-to-encrypt-using-customer-managed-keys"></a>Настройка хранилища для шифрования с помощью управляемых клиентом ключей

Этот раздел включает следующие шаги.

1. Включение управляемого удостоверения для хранилища служб восстановления

1. Назначьте разрешения для хранилища, чтобы получить доступ к ключу шифрования в Azure Key Vault

1. Включение обратимого удаления и очистки защиты на Azure Key Vault

1. Назначение ключа шифрования хранилищу служб восстановления

Для достижения предполагаемых результатов необходимо, чтобы выполнены все эти действия в указанном выше порядке. Каждый шаг подробно описан ниже.

### <a name="enable-managed-identity-for-your-recovery-services-vault"></a>Включение управляемого удостоверения для хранилища служб восстановления

Azure Backup использует управляемое системой удостоверение, чтобы проверить подлинность хранилища служб восстановления для доступа к ключам шифрования, хранящимся в Azure Key Vault. Чтобы включить управляемое удостоверение для хранилища служб восстановления, выполните описанные ниже действия.

>[!NOTE]
>После включения управляемое удостоверение **не** должно быть отключено (даже временно). Отключение управляемого удостоверения может привести к несовместимости поведения.

**На портале:**

1. Перейдите к хранилищу служб восстановления — > **удостоверение**

    ![Параметры удостоверений](./media/encryption-at-rest-with-cmk/managed-identity.png)

1. Измените **состояние** на **вкл** и нажмите кнопку **сохранить**.

1. Создается идентификатор объекта, который является управляемым системой удостоверением хранилища.

**С помощью PowerShell:**

Используйте команду [Update-азрековерисервицесваулт](/powershell/module/az.recoveryservices/update-azrecoveryservicesvault) для включения управляемого удостоверения, назначенного системой для хранилища служб восстановления.

Пример.

```AzurePowerShell
$vault=Get-AzRecoveryServicesVault -ResourceGroupName "testrg" -Name "testvault"

Update-AzRecoveryServicesVault -IdentityType SystemAssigned -VaultId $vault.ID

$vault.Identity | fl
```

Выходные данные:

```output
PrincipalId : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
TenantId    : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Type        : SystemAssigned
```

### <a name="assign-permissions-to-the-recovery-services-vault-to-access-the-encryption-key-in-the-azure-key-vault"></a>Назначьте разрешения для хранилища служб восстановления, чтобы получить доступ к ключу шифрования в Azure Key Vault

Теперь необходимо предоставить хранилищу служб восстановления доступ к Azure Key Vault, содержащей ключ шифрования. Это можно сделать, разрешая управляемому удостоверению хранилища служб восстановления доступ к Key Vault.

**На портале**:

1. Перейдите к **политикам доступа** Azure Key Vault->. Продолжайте и **Добавляйте политики доступа**.

    ![Добавление политик доступа](./media/encryption-at-rest-with-cmk/access-policies.png)

1. В **разделе Основные разрешения** выберите операции **получения**, **перечисления**, **распаковки ключа** и **переноса ключей** . Здесь задаются действия с ключом, который будет разрешен.

    ![Назначение разрешений для ключа](./media/encryption-at-rest-with-cmk/key-permissions.png)

1. Перейдите к разделу **Выбор субъекта** и найдите хранилище в поле поиска, используя его имя или управляемое удостоверение. После его отображения выберите хранилище и нажмите **кнопку Выбрать** в нижней части панели.

    ![Выбор субъекта](./media/encryption-at-rest-with-cmk/select-principal.png)

1. После этого нажмите кнопку **Добавить** , чтобы добавить новую политику доступа.

1. Нажмите кнопку **сохранить** , чтобы сохранить изменения, внесенные в политику доступа Azure Key Vault.

**С помощью PowerShell**:

Используйте команду [Set-азрековерисервицесваултпроперти](/powershell/module/az.recoveryservices/set-azrecoveryservicesvaultproperty) , чтобы включить шифрование с помощью управляемых клиентом ключей и назначить или обновить используемый ключ шифрования.

Пример.

```azurepowershell
$keyVault = Get-AzKeyVault -VaultName "testkeyvault" -ResourceGroupName "testrg" 
$key = Get-AzKeyVaultKey -VaultName $keyVault -Name "testkey" 
Set-AzRecoveryServicesVaultProperty -EncryptionKeyId $key.ID -KeyVaultSubscriptionId "xxxx-yyyy-zzzz"  -VaultId $vault.ID


$enc=Get-AzRecoveryServicesVaultProperty -VaultId $vault.ID
$enc.encryptionProperties | fl
```

Выходные данные:

```output
EncryptionAtRestType          : CustomerManaged
KeyUri                        : testkey
SubscriptionId                : xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx 
LastUpdateStatus              : Succeeded
InfrastructureEncryptionState : Disabled
```

### <a name="enable-soft-delete-and-purge-protection-on-the-azure-key-vault"></a>Включение обратимого удаления и очистки защиты на Azure Key Vault

Необходимо **включить обратимое удаление и очистку** для Azure Key Vault, в которой хранится ключ шифрования. Это можно сделать в пользовательском интерфейсе Azure Key Vault, как показано ниже. (Кроме того, эти свойства можно задать при создании Key Vault). Подробнее об этих Key Vault свойствах см. [здесь](../key-vault/general/soft-delete-overview.md).

![Включение обратимого удаления и защиты от очистки](./media/encryption-at-rest-with-cmk/soft-delete-purge-protection.png)

Вы также можете включить обратимое удаление и очистку с помощью PowerShell, выполнив следующие действия:

1. Войдите в учетную запись Azure.

    ```azurepowershell
    Login-AzAccount
    ```

1. Выберите подписку, которая содержит ваше хранилище.

    ```azurepowershell
    Set-AzContext -SubscriptionId SubscriptionId
    ```

1. Включение обратимого удаления

    ```azurepowershell
    ($resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "AzureKeyVaultName").ResourceId).Properties | Add-Member -MemberType "NoteProperty" -Name "enableSoftDelete" -Value "true"
    ```

    ```azurepowershell
    Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
    ```

1. Включить защиту от очистки

    ```azurepowershell
    ($resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "AzureKeyVaultName").ResourceId).Properties | Add-Member -MemberType "NoteProperty" -Name "enablePurgeProtection" -Value "true"
    ```

    ```azurepowershell
    Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
    ```

### <a name="assign-encryption-key-to-the-rs-vault"></a>Назначение ключа шифрования хранилищу RS

>[!NOTE]
> Прежде чем продолжить, убедитесь в следующем:
>
> - Все описанные выше действия успешно выполнены:
>   - Управляемое удостоверение хранилища служб восстановления включено, и ему назначены необходимые разрешения
>   - Azure Key Vault с поддержкой обратимого удаления и включения защиты
> - Хранилище служб восстановления, для которого требуется включить шифрование CMK, **не** имеет защищенных или зарегистрированных элементов.

После того как эти сведения будут гарантированы, продолжите выбор ключа шифрования для своего хранилища.

Чтобы назначить ключ, сделайте следующее:

1. Перейдите к хранилищу служб восстановления — > **Свойства** .

    ![Параметры шифрования.](./media/encryption-at-rest-with-cmk/encryption-settings.png)

1. Выберите **Обновить** в разделе **Параметры шифрования**.

1. В области Параметры шифрования выберите **использовать собственный ключ** и продолжайте указывать ключ одним из следующих способов. **Убедитесь, что ключ, который вы хотите использовать, является ключом RSA 2048, который находится в включенном состоянии.**

    1. Введите **универсальный код ресурса (URI) ключа** , с которым необходимо зашифровать данные в этом хранилище служб восстановления. Также необходимо указать подписку, в которой содержится Azure Key Vault (который содержит этот ключ). Этот URI ключа можно получить из соответствующего ключа в Azure Key Vault. Убедитесь, что URI ключа скопирован правильно. Рекомендуется использовать кнопку **Копировать в буфер обмена** , поставляемую с идентификатором ключа.

        >[!NOTE]
        >При указании ключа шифрования с помощью URI ключа автоматическое вращение ключа не выполняется. Поэтому обновление ключей необходимо выполнить вручную, указав новый ключ при необходимости.

        ![Введите URI ключа](./media/encryption-at-rest-with-cmk/key-uri.png)

    1. Найдите и выберите ключ из Key Vault на панели выбора ключа.

        >[!NOTE]
        >При указании ключа шифрования с помощью области выбора ключа будет выполняться автоматический поворот ключа при включении новой версии ключа.

        ![Выбор ключа из хранилища ключей](./media/encryption-at-rest-with-cmk/key-vault.png)

1. Щелкните **Сохранить**.

1. **Отслеживание хода выполнения и состояния обновления ключа шифрования**. Вы можете отслеживать ход выполнения и состояние назначения ключа шифрования с помощью представления **задания резервного копирования** на левой панели навигации. Состояние должно скоро изменится на **завершено**. Теперь ваше хранилище будет шифровать все данные с указанным ключом в качестве KEK.

    ![Состояние завершено](./media/encryption-at-rest-with-cmk/status-succeeded.png)

    Обновления ключа шифрования также регистрируются в журнале действий хранилища.

    ![Журнал действий](./media/encryption-at-rest-with-cmk/activity-log.png)

>[!NOTE]
> Этот процесс остается прежним, если вы хотите обновить или изменить ключ шифрования. Если вы хотите обновить и использовать ключ из другого Key Vault (отличного от используемого в данный момент), убедитесь в том, что:
>
> - Key Vault находится в том же регионе, что и хранилище служб восстановления
>
> - В хранилище ключей включена защита с обратимым удалением и очисткой.
>
> - Хранилище служб восстановления имеет необходимые разрешения для доступа к Key Vault.

## <a name="backing-up-to-a-vault-encrypted-with-customer-managed-keys"></a>Резервное копирование в хранилище, зашифрованное с помощью управляемых клиентом ключей

Прежде чем перейти к настройке защиты, мы настоятельно рекомендуем обеспечить соблюдение следующего контрольного списка. Это важно, так как после настройки элемента для резервного копирования (или попытки его настройки) в хранилище, не являющемся CMK, шифрование с использованием управляемых клиентом ключей не может быть включено на нем и будет продолжать использовать ключи, управляемые платформой.

>[!IMPORTANT]
> Прежде чем перейти к настройке защиты, необходимо **успешно** выполнить следующие действия.
>
>1. Хранилище резервных копий создано
>1. Включено управляемое удостоверение, назначенное системой для хранилища архивации
>1. Назначены разрешения в хранилище архивации для доступа к ключам шифрования из Key Vault
>1. Включение обратимого удаления и очистки защиты для Key Vault
>1. Назначен допустимый ключ шифрования для резервного хранилища
>
>Если все указанные выше действия подтверждены, только затем продолжайте настройку резервного копирования.

Процесс настройки и выполнения резервного копирования в хранилище служб восстановления, зашифрованном с помощью управляемых клиентом ключей, аналогичен тому же, что и в хранилище, использующем ключи, управляемые платформой, **без каких-либо изменений в интерфейсе**. Это справедливо для [резервного копирования виртуальных машин Azure](./quick-backup-vm-portal.md) , а также для резервного копирования рабочих нагрузок, выполняемых внутри виртуальной машины (например, [SAP HANA](./tutorial-backup-sap-hana-db.md), [SQL Server](./tutorial-sql-backup.md) баз данных).

## <a name="restoring-data-from-backup"></a>Восстановление данных из резервной копии

### <a name="vm-backup"></a>Резервное копирование виртуальной машины

Данные, хранящиеся в хранилище служб восстановления, можно восстановить в соответствии с описанными [здесь](./backup-azure-arm-restore-vms.md)действиями. При восстановлении из хранилища служб восстановления, зашифрованного с помощью управляемых клиентом ключей, можно выбрать шифрование восстановленных данных с помощью набора шифрования диска (DES).

#### <a name="restoring-vm--disk"></a>Восстановление виртуальной машины или диска

1. При восстановлении диска или виртуальной машины из точки восстановления "моментальный снимок" восстановленные данные будут зашифрованы с помощью алгоритма DES, используемого для шифрования дисков исходной виртуальной машины.

1. При восстановлении диска или виртуальной машины из точки восстановления с типом восстановления "хранилище" можно выбрать, чтобы восстановленные данные были зашифрованы с помощью DES, заданного во время восстановления. Кроме того, можно продолжить восстановление данных без указания DES. в этом случае они будут шифроваться с помощью ключей, управляемых корпорацией Майкрософт.

После завершения восстановления можно зашифровать восстановленный диск или виртуальную машину, независимо от выбора, сделанного при запуске восстановления.

![Точки восстановления](./media/encryption-at-rest-with-cmk/restore-points.png)

#### <a name="select-a-disk-encryption-set-while-restoring-from-vault-recovery-point"></a>Выберите набор шифрования дисков при восстановлении из точки восстановления хранилища

**На портале**:

Набор шифрования дисков указывается в разделе Параметры шифрования на панели восстановление, как показано ниже.

1. На странице **Шифрование дисков с помощью ключа** выберите **Да**.

1. В раскрывающемся списке выберите алгоритм DES, который вы хотите использовать для восстановленных дисков. **Убедитесь, что у вас есть доступ к DES.**

>[!NOTE]
>Возможность выбора алгоритма DES во время восстановления недоступна, если восстанавливается виртуальная машина, использующая шифрование дисков Azure.

![Шифрование диска с помощью ключа](./media/encryption-at-rest-with-cmk/encrypt-disk-using-your-key.png)

**С помощью PowerShell**:

Используйте команду [Get-азрековерисервицесбаккупитем](/powershell/module/az.recoveryservices/get-azrecoveryservicesbackupitem) с параметром [ `-DiskEncryptionSetId <string>` ], чтобы [указать алгоритм DES](/powershell/module/az.compute/get-azdiskencryptionset) , используемый для шифрования восстановленного диска. Дополнительные сведения о восстановлении дисков из резервной копии виртуальных машин см. в [этой статье](./backup-azure-vms-automation.md#restore-an-azure-vm).

Пример.

```azurepowershell
$namedContainer = Get-AzRecoveryServicesBackupContainer  -ContainerType "AzureVM" -Status "Registered" -FriendlyName "V2VM" -VaultId $vault.ID
$backupitem = Get-AzRecoveryServicesBackupItem -Container $namedContainer  -WorkloadType "AzureVM" -VaultId $vault.ID
$startDate = (Get-Date).AddDays(-7)
$endDate = Get-Date
$rp = Get-AzRecoveryServicesBackupRecoveryPoint -Item $backupitem -StartDate $startdate.ToUniversalTime() -EndDate $enddate.ToUniversalTime() -VaultId $vault.ID
$restorejob = Restore-AzRecoveryServicesBackupItem -RecoveryPoint $rp[0] -StorageAccountName "DestAccount" -StorageAccountResourceGroupName "DestRG" -TargetResourceGroupName "DestRGforManagedDisks" -DiskEncryptionSetId “testdes1” -VaultId $vault.ID
```

#### <a name="restoring-files"></a>Восстановление файлов

При восстановлении файлов восстановленные данные будут зашифрованы с помощью ключа, используемого для шифрования целевого расположения.

### <a name="restoring-sap-hanasql-databases-in-azure-vms"></a>Восстановление баз данных SAP HANA и SQL на виртуальных машинах Azure

При восстановлении из резервной копии SAP HANA или базы данных SQL, работающей на виртуальной машине Azure, восстановленные данные будут зашифрованы с помощью ключа шифрования, используемого в целевом расположении хранилища. Это может быть ключ, управляемый клиентом, или управляемый платформой ключ, используемый для шифрования дисков виртуальной машины.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="can-i-encrypt-an-existing-backup-vault-with-customer-managed-keys"></a>Можно ли зашифровать существующее резервное хранилище с помощью управляемых клиентом ключей?

Нет, шифрование CMK можно включить только для новых хранилищ. Поэтому хранилище никогда не должно иметь защищенных элементов. На самом деле, перед включением шифрования с помощью управляемых клиентом ключей никаких попыток защиты любых элементов в хранилище необходимо сделать.

### <a name="i-tried-to-protect-an-item-to-my-vault-but-it-failed-and-the-vault-still-doesnt-contain-any-items-protected-to-it-can-i-enable-cmk-encryption-for-this-vault"></a>Я попытался защитить элемент в моем хранилище, но это не удалось, и хранилище по-прежнему не содержит элементов, защищенных для него. Можно ли включить шифрование CMK для этого хранилища?

Нет, хранилище не должно иметь никаких попыток защиты элементов в прошлом.

### <a name="i-have-a-vault-thats-using-cmk-encryption-can-i-later-revert-to-encryption-using-platform-managed-keys-even-if-i-have-backup-items-protected-to-the-vault"></a>У меня есть хранилище, в котором используется шифрование CMK. Можно ли позже вернуться к шифрованию с помощью ключей, управляемых платформой, даже если у меня есть элементы резервного копирования, защищенные в хранилище?

Нет, после включения шифрования CMK не может быть отменено для использования ключей, управляемых платформой. Вы можете изменить ключи, используемые в соответствии с вашими требованиями.

### <a name="does-cmk-encryption-for-azure-backup-also-apply-to-azure-site-recovery"></a>Применяется ли шифрование CMK для Azure Backup Azure Site Recovery?

Нет, в этой статье рассматривается шифрование только данных резервных копий. Для Azure Site Recovery необходимо задать свойство отдельно, как доступно в службе.

### <a name="i-missed-one-of-the-steps-in-this-article-and-went-on-to-protect-my-data-source-can-i-still-use-cmk-encryption"></a>Я пропустил один из шагов, описанных в этой статье, и приходился защищать источник данных. Можно ли по-прежнему использовать шифрование CMK?

Не выполнив действия, описанные в статье, и продолжение защиты элементов может привести к тому, что хранилище не сможет использовать шифрование с помощью управляемых клиентом ключей. Поэтому рекомендуется ознакомиться с [этим контрольным списком](#backing-up-to-a-vault-encrypted-with-customer-managed-keys) перед тем, как перейти к защите элементов.

### <a name="does-using-cmk-encryption-add-to-the-cost-of-my-backups"></a>Использует ли CMK-Encryption добавление к стоимости резервных копий?

Использование шифрования CMK для резервного копирования не влечет за собой никаких дополнительных затрат. Однако вы можете продолжать взимать затраты на использование Azure Key Vault, где хранится ваш ключ.

## <a name="next-steps"></a>Следующие шаги

- [Общие сведения о средствах безопасности в Azure Backup](security-overview.md)