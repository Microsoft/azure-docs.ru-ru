---
title: восстановление состояния системы в Windows Server
description: Пошаговое описание восстановления состояния системы Windows Server из резервной копии в Azure.
ms.topic: conceptual
ms.date: 06/30/2020
ms.openlocfilehash: 4ef23d6ff16c263e310304cc240c2090751640b1
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97008475"
---
# <a name="restore-system-state-to-windows-server"></a>Восстановление состояния системы в Windows Server

В этой статье описано, как восстановить резервные копии состояния системы Windows Server из хранилища служб восстановления Azure. Чтобы восстановить состояние системы, необходимо создать резервную копию состояния системы (созданную с помощью инструкций в разделе [резервное копирование состояния системы](backup-azure-system-state.md#back-up-windows-server-system-state)) и убедиться, что установлена [последняя версия агента службы восстановления Microsoft Azure (MARS)](https://aka.ms/azurebackup_agent). Восстановление данных состояния системы Windows Server из хранилища службы восстановления Azure состоит из двух этапов:

1. Восстановление состояния системы в виде файлов из службы Azure Backup. При восстановлении состояния системы в виде файлов из службы Azure Backup вы можете:
   * восстановить состояние системы на тот же сервер, где создавались резервные копии;
   * восстановить файл состояния системы на другой сервер.

2. Примените восстановленные файлы состояния системы к Windows Server с помощью служебной программы cистема архивации данных Windows Server.

## <a name="recover-system-state-files-to-the-same-server"></a>Восстановление файлов состояния системы на том же сервере

Здесь описывается, как откатить конфигурацию Windows Server до предыдущего состояния. Откат конфигурации сервера к известному ранее стабильному состоянию может быть очень важен. На следующих шагах восстанавливается состояние системы сервера из хранилища служб восстановления.

1. Откройте оснастку **Microsoft Azure Backup**. Если вы не знаете, куда была установлена оснастка, найдите на компьютере или сервере службу **Microsoft Azure Backup**.

    Классическое приложение должны быть в результатах поиска.

2. Выберите **Восстановить данные**, чтобы запустить мастер.

    ![Восстановить данные](./media/backup-azure-restore-windows-server/recover.png)

3. Чтобы восстановить данные на тот же сервер или компьютер, в области **Начало работы** выберите **этот сервер ( `<server name>` )** и нажмите кнопку **Далее**.

    ![Выберите этот параметр сервера, чтобы восстановить данные на тот же компьютер](./media/backup-azure-restore-system-state/samemachine.png)

4. На панели **Выбор режима восстановления** выберите **состояние системы** , а затем нажмите кнопку **Далее**.

    ![Обзор файлов](./media/backup-azure-restore-system-state/recover-type-selection.png)

5. В календаре в области **Выбор тома и даты** выберите точку восстановления.

    Можно восстановить данные на любой момент времени. Даты **полужирным** шрифтом означают доступность по крайней мере одной точки восстановления. Если после выбора даты доступно несколько точек восстановления, выберите конкретную точку восстановления из раскрывающегося меню **Время**.

    ![Том и дата](./media/backup-azure-restore-system-state/select-date.png)

6. После выбора точки восстановления для восстановления нажмите кнопку **Далее**.

    Служба архивации Azure подключит локальную точку восстановления и использует ее в качестве тома для восстановления.

7. На следующей панели укажите место назначения для восстановленных файлов состояния системы. Затем нажмите кнопку **Обзор** , чтобы открыть проводник Windows и найти нужные файлы и папки. Параметр **Создавать копии, чтобы иметь обе версии** создает копии отдельных файлов в имеющемся архиве файлов состояния системы вместо создания копии всего архива состояния системы.

    ![Варианты восстановления](./media/backup-azure-restore-system-state/recover-as-files.png)

8. Проверьте сведения о восстановлении в области **подтверждения** и нажмите кнопку **восстановить**.

   ![Выберите восстановить, чтобы подтвердить действие восстановления.](./media/backup-azure-restore-system-state/confirm-recovery.png)

9. Скопируйте каталог *WindowsImageBackup* в место назначения восстановления на некритический том сервера. Обычно том ОС Windows является критическим томом.

10. После успешного восстановления выполните действия, описанные в разделе [применение восстановленного состояния системы на сервере Windows](#apply-restored-system-state-on-a-windows-server), чтобы завершить процесс восстановления состояния системы.

## <a name="recover-system-state-files-to-an-alternate-server"></a>Восстановление файлов состояния системы на другой сервер

Если Windows Server поврежден или недоступен и требуется вернуть его в стабильное состояние путем восстановления состояния системы Windows Server, его можно восстановить с другого сервера. Выполните следующие действия для восстановления состояния системы на отдельном сервере.  

Ниже приведена терминология, используемая в этих действиях:

* *Исходный компьютер* — исходный компьютер, с которого была создана резервная копия, которая в данный момент недоступна.
* *Целевой компьютер* — компьютер, на который восстанавливаются данные.
* *Пример хранилища* — хранилище служб восстановления, в котором зарегистрирован *Исходный компьютер* и *целевой компьютер* .

> [!NOTE]
> Резервные копии, созданные с одного компьютера, невозможно восстановить на компьютер под управлением более ранней версии операционной системы. Например, резервные копии, созданные на компьютере с Windows Server 2016, нельзя восстановить на Windows Server 2012 R2. Однако обратное возможно. Резервные копии Windows Server 2012 R2 можно использовать для восстановления Windows Server 2016.
>

1. Откройте оснастку **Microsoft Azure Backup** на *целевом компьютере*.
2. Убедитесь, что *целевой компьютер* и *Исходный компьютер* зарегистрированы в одном хранилище служб восстановления.
3. Выберите **восстановить данные** , чтобы запустить рабочий процесс.
4. Выберите **Другой сервер**

    ![Другой сервер](./media/backup-azure-restore-system-state/anotherserver.png)

5. Укажите файл с учетными данными хранилища, который соответствует *примеру хранилища*. Если файл учетных данных хранилища является недопустимым (или срок его действия истек), Скачайте новый файл учетных данных хранилища из *примера хранилища* на портал Azure. После указания файла с учетными данными отобразится связанное хранилище служб восстановления.

6. В области "Выбор резервного сервера" из списка компьютеров выберите *исходный компьютер*.
7. На панели Выбор режима восстановления выберите **состояние системы** и нажмите кнопку **Далее**.

    ![Поиск](./media/backup-azure-restore-system-state/recover-type-selection.png)

8. В календаре в области **Выбор тома и даты** выберите точку восстановления. Можно восстановить данные на любой момент времени. Даты **полужирным** шрифтом означают доступность по крайней мере одной точки восстановления. Если после выбора даты доступно несколько точек восстановления, выберите конкретную точку восстановления из раскрывающегося меню **Время**.

    ![Поиск элементов](./media/backup-azure-restore-system-state/select-date.png)

9. После выбора точки восстановления для восстановления нажмите кнопку **Далее**.

10. В области **Выбор режима восстановления состояния системы** укажите назначение, в котором должны восстанавливаться файлы состояния системы, а затем нажмите кнопку **Далее**.

    ![Encryption](./media/backup-azure-restore-system-state/recover-as-files.png)

    Параметр **Создавать копии, чтобы иметь обе версии** создает копии отдельных файлов в имеющемся архиве файлов состояния системы вместо создания копии всего архива состояния системы.

11. Проверьте сведения о восстановлении на панели подтверждения и нажмите кнопку **восстановить**.

    ![Нажмите кнопку восстановить, чтобы подтвердить процесс восстановления.](./media/backup-azure-restore-system-state/confirm-recovery.png)

12. Скопируйте каталог *WindowsImageBackup* на некритический том сервера (например, D:\). Обычно том ОС Windows является критическим томом.

13. Чтобы завершить процесс восстановления, используйте следующий раздел, чтобы [применить восстановленные файлы состояния системы в Windows Server](#apply-restored-system-state-on-a-windows-server).

## <a name="apply-restored-system-state-on-a-windows-server"></a>Применение восстановленного состояния системы в Windows Server

После восстановления состояния системы в виде файлов с помощью агента служб восстановления Azure используйте служебную программу cистема архивации данных Windows Server для применения восстановленного состояния системы к Windows Server. Служебная программа системы архивации данных Windows Server уже доступна на сервере. На следующих шагах описывается, как применить восстановленное состояние системы.

1. Откройте оснастку cистема архивации данных Windows Server. Если вы не знаете, куда была установлена оснастка, найдите на компьютере или сервере **систему архивации данных Windows Server**.

    Классическое приложение появится в результатах поиска. Если он не отображается или при открытии приложения возникают ошибки, необходимо установить **Cистема архивации данных Windows Server компоненты** и зависимые компоненты, которые доступны в **мастере добавления компонентов** в **Диспетчер сервера**.

1. В оснастке выберите **Локальная архивация**.

    ![Выбор локальной резервной копии для восстановления отсюда](./media/backup-azure-restore-system-state/win-server-backup-local-backup.png)

1. В локальной консоли архивации на **панели действия** выберите **восстановить** , чтобы открыть мастер восстановления.

1. Выберите параметр **резервная копия, сохраненная в другом расположении**, и нажмите кнопку **Далее**.

   ![Выберите восстановление на другой сервер](./media/backup-azure-restore-system-state/backup-stored-in-diff-location.png)

1. При указании типа расположения выберите **Удаленная общая папка**, если резервная копия состояния системы была восстановлена на другой сервер. Если состояние системы было восстановлено локально, выберите **Локальные диски**.

    ![Выберите, следует ли выполнять восстановление из локального сервера или другого](./media/backup-azure-restore-system-state/ss-recovery-remote-shared-folder.png)

1. Введите путь к каталогу *WindowsImageBackup* или выберите локальный диск, содержащий этот каталог (например, д:\виндовсимажебаккуп), восстановленный в ходе восстановления файлов состояния системы с помощью агента служб восстановления Azure, и нажмите кнопку **Далее**.

    ![Путь к общему файлу](./media/backup-azure-restore-system-state/ss-recovery-remote-folder.png)

1. Выберите версию состояния системы, которую требуется восстановить, и нажмите кнопку **Далее**.

1. На панели Выбор типа восстановления выберите **состояние системы** и нажмите кнопку **Далее**.

1. В качестве расположения восстановления состояния системы выберите **исходное расположение** и нажмите кнопку **Далее**.

    При восстановлении контроллера домена вы увидите следующий дополнительный параметр:

    ![Расположение для восстановления состояния системы](./media/backup-azure-restore-system-state/location-for-system-state-recovery.png)

    >[!NOTE]
    >Выберите параметр "выполнить полномочное восстановление файлов Active Directory", если вы явно предполагали принудительное восстановление всех данных Active Directory.

1. Проверьте сведения о подтверждении, проверьте параметры перезагрузки и нажмите кнопку **восстановить** , чтобы применить восстановленные файлы состояния системы.

    ![Запуск восстановленных файлов состояния системы](./media/backup-azure-restore-system-state/launch-ss-recovery.png)

    >[!NOTE]
    >Не выбирайте параметр **автоматически перезагружать сервер** при выполнении восстановления в режиме DSRM.

1. После успешного завершения восстановления необходимо перезапустить сервер в нормальном режиме. Откройте командную строку и введите следующую команду: `bcdedit /deletevalue safeboot`
1. Перезагрузите сервер.

## <a name="special-considerations-for-system-state-recovery-on-a-domain-controller"></a>Особые рекомендации по восстановлению состояния системы на контроллере домена

Резервная копия состояния системы включает данные Active Directory. Выполните следующие действия для восстановления предыдущего состояния доменных служб Active Directory (AD DS). Этот тип восстановления может быть выполнен в двух сценариях:

* Восстановление всех данных Active Directory, если в лесу отсутствуют действующие контроллеры домена
* Восстановление части данных Active Directory, если эти объекты были удалены или повреждены

В этой статье рассматривается только первый сценарий, в котором вызывается восстановление нонаусоративе AD DS и полномочное восстановление папки SYSVOL.  Если необходимо выполнить второй сценарий (где контроллеры домена все еще работают, но необходимо восстановить определенные объекты AD), см. [эти инструкции](https://support.microsoft.com/help/840001/how-to-restore-deleted-user-accounts-and-their-group-memberships-in-ac).

1. Выполните действия, описанные в этой статье, чтобы [восстановить файлы состояния системы на альтернативном сервере](#recover-system-state-files-to-an-alternate-server).
1. Используйте следующие команды для перезагрузки сервера в *режиме восстановления служб каталогов*. В командной строке с повышенными привилегиями:

    ```cmd
    Bcdedit /set safeboot dsrepair
    Shutdown /r /t 0
    ```

1. Чтобы восстановить Active Directory в ходе восстановления состояния системы, можно выбрать один из двух методов.

    * Следуйте приведенным выше инструкциям, чтобы [применить восстановленное состояние системы в Windows Server](#apply-restored-system-state-on-a-windows-server) с помощью служебной программы Cистема архивации данных Windows Server.

        >[!NOTE]
        >Если вы восстанавливаете все данные Active Directory (и в лесу отсутствуют действующие контроллеры домена), на шаге 9 выше убедитесь в том, что выбран параметр **выполнить полномочное восстановление файлов Active Directory**.

    * С помощью служебной программы [Wbadmin](/windows-server/administration/windows-commands/wbadmin-start-systemstaterecovery) выполните восстановление из командной строки.

        Вам потребуется идентификатор версии резервной копии, которую вы хотите использовать. Список идентификаторов версий можно получить, выполнив следующую команду:

        ```cmd
        wbadmin get versions -backuptarget <servername\sharename>
        ```

        Затем используйте этот идентификатор версии для выполнения восстановления.

        Например, чтобы выполнить [Восстановление нонаусоративе AD DS и полномочное восстановление папки SYSVOL](/windows-server/identity/ad-ds/manage/ad-forest-recovery-nonauthoritative-restore) с помощью резервной копии с 04/30/2020 в 9:00 AM, которая хранится в общем ресурсе `\\servername\share` для `server01` , введите:

        ```cmd
        wbadmin start systemstaterecovery -version:04/30/2020-09:00 -backupTarget:\\servername\share -machine:server01 -authsysvol
        ```

1. После успешного завершения восстановления необходимо перезапустить сервер в обычном режиме. Откройте командную строку и введите следующую команду: `bcdedit /deletevalue safeboot`
1. Перезагрузите сервер.

Дополнительные сведения см. в разделе [резервное копирование и восстановление Active Directory контроллеры домена](active-directory-backup-restore.md).

## <a name="troubleshoot-failed-system-state-restore"></a>Устранение неполадок при сбое восстановления состояния системы

Если предыдущий процесс применения состояния системы не завершается успешно, используйте среду восстановления Windows (Win RE) для восстановления Windows Server. На следующих шагах описывается, как восстанавливать с помощью Win RE. Используйте этот параметр, только если Windows Server не загружается нормально после восстановления состояния системы. Будьте осторожны, следующий процесс стирает все несистемные данные.

1. Загрузите Windows Server в среде восстановления Windows (Win RE).

2. Выберите "Устранение неполадок" из трех доступных вариантов.

    ![Выберите Устранение неполадок](./media/backup-azure-restore-system-state/winre-1.png)

3. На экране **Дополнительные параметры** выберите **Командная строка** и укажите имя администратора сервера и пароль.

   ![Выбор командной строки](./media/backup-azure-restore-system-state/winre-2.png)

4. Укажите имя администратора сервера и пароль.

    ![Ввод пароля](./media/backup-azure-restore-system-state/winre-3.png)

5. При открытии командной строки с правами администратора выполните следующую команду, чтобы получить версии резервного копирования состояния системы.

    ```cmd
    Wbadmin get versions -backuptarget:<Volume where WindowsImageBackup folder is copied>:
    ```

    ![Получение версий резервных копий состояния системы](./media/backup-azure-restore-system-state/winre-4.png)

6. Выполните следующую команду, чтобы получить все тома, которые доступны в резервной копии.

    ```cmd
    Wbadmin get items -version:<copy version from above step> -backuptarget:<Backup volume>
    ```

    ![Получить все доступные тома](./media/backup-azure-restore-system-state/winre-5.png)

7. Следующая команда восстанавливает все тома, которые являются частью резервной копии состояния системы. Обратите внимание, что этот шаг восстанавливает только критические тома, которые являются частью состояния системы. Все несистемные данные удаляются.

    ```cmd
    Wbadmin start recovery -items:C: -itemtype:Volume -version:<Backupversion> -backuptarget:<backup target volume>
    ```

     ![Восстановить все тома](./media/backup-azure-restore-system-state/winre-6.png)

## <a name="next-steps"></a>Дальнейшие действия

* Теперь после восстановления файлов и папок можно [управлять резервными копиями](backup-azure-manage-windows-server.md).
