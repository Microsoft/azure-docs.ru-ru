---
title: Устранение неполадок SQL Server резервной копии базы данных
description: Сведения об устранении неполадок резервного копирования баз данных SQL Server на виртуальных машинах Azure с помощью службы Azure Backup.
ms.topic: troubleshooting
ms.date: 06/18/2019
ms.openlocfilehash: d702959be70716f0c2bc85920bdb7aa3e061aff1
ms.sourcegitcommit: f7084d3d80c4bc8e69b9eb05dfd30e8e195994d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2020
ms.locfileid: "97733949"
---
# <a name="troubleshoot-sql-server-database-backup-by-using-azure-backup"></a>Устранение неполадок SQL Server резервного копирования базы данных с помощью Azure Backup

В этой статье содержатся сведения об устранении неполадок SQL Server баз данных, работающих на виртуальных машинах Azure.

Дополнительные сведения о процессе резервного копирования и ограничениях см. [в статье о SQL Server резервного копирования на виртуальных машинах Azure](sql-support-matrix.md#feature-considerations-and-limitations).

## <a name="sql-server-permissions"></a>разрешения SQL Server

Чтобы настроить защиту для SQL Serverной базы данных на виртуальной машине, необходимо установить расширение **азуребаккупвиндовсворклоад** на этой виртуальной машине. Если вы получаете ошибку **усереррорсклносисадминмембершип**, это означает, что у вашего экземпляра SQL Server нет необходимых разрешений для резервного копирования. Чтобы устранить эту ошибку, выполните действия, описанные в разделе [Настройка разрешений виртуальной машины](backup-azure-sql-database.md#set-vm-permissions).

## <a name="troubleshoot-discover-and-configure-issues"></a>Устранение неполадок обнаружения и настройки

После создания и настройки хранилища служб восстановления обнаружение баз данных и Настройка резервного копирования выполняется в два этапа.<br>

![Цель резервного копирования — SQL Server на виртуальной машине Azure](./media/backup-azure-sql-database/sql.png)

Если в конфигурации резервного копирования виртуальная машина SQL и ее экземпляры не отображаются в **баз данных обнаружения на виртуальных машинах** и **Настройка резервного копирования** (см. выше), убедитесь в том, что:

### <a name="step-1-discovery-dbs-in-vms"></a>Шаг 1. Обнаружение баз данных в виртуальных машинах

- Если виртуальная машина не указана в списке обнаруженных виртуальных машин и не зарегистрирована для резервного копирования SQL в другом хранилище, выполните действия по [обнаружению SQL Server архивации](./backup-sql-server-database-azure-vms.md#discover-sql-server-databases) .

### <a name="step-2-configure-backup"></a>Шаг 2. Настройка резервного копирования

- Если хранилище, в котором виртуальная машина SQL зарегистрировано в том же хранилище, которое используется для защиты баз данных, следуйте инструкциям по [настройке резервного копирования](./backup-sql-server-database-azure-vms.md#configure-backup) .

Если виртуальная машина SQL должна быть зарегистрирована в новом хранилище, она должна быть отменена из старого хранилища.  Для отмены регистрации виртуальной машины SQL из хранилища необходимо, чтобы все защищенные источники данных были защищены от защиты, а затем можно будет удалить резервные копии данных. Удаление данных из резервной копии является обратимой операцией.  После того как вы проверили и предоставили все меры предосторожности для отмены регистрации виртуальной машины SQL, зарегистрируйте эту же виртуальную машину с новым хранилищем и повторите операцию резервного копирования.

## <a name="troubleshoot-backup-and-recovery-issues"></a>Устранение проблем с резервным копированием и восстановлением  

Иногда в операциях резервного копирования и восстановления могут возникать случайные сбои, или эти операции могут зависнуть. Это может быть вызвано антивирусной программой на виртуальной машине. Рекомендуется выполнить следующие действия.

1. Исключите следующие папки из антивирусного сканирования:

    `C:\Program Files\Azure Workload Backup` `C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.WorkloadBackup.AzureBackupWindowsWorkload`

    Замените на `C:\` букву *systemdrive*.

1. Исключите следующие три процесса, запущенные на виртуальной машине, из антивирусного сканирования:

    - IaasWLPluginSvc.exe
    - IaaSWorkloadCoordinatorService.exe
    - TriggerExtensionJob.exe

1. SQL также предлагает некоторые рекомендации по работе с антивирусными программами. Дополнительные сведения см. в [этой статье](https://support.microsoft.com/help/309422/choosing-antivirus-software-for-computers-that-run-sql-server) .

## <a name="faulty-instance-in-a-vm-with-multiple-sql-server-instances"></a>Неисправный экземпляр в виртуальной машине с несколькими экземплярами SQL Server

Восстановление на виртуальную машину SQL можно выполнить, только если все экземпляры SQL Server, работающие на виртуальной машине, зарегистрированы в работоспособном состоянии. Если один или несколько экземпляров являются неисправными, виртуальная машина не будет отображаться как цель восстановления. Это может быть причиной, по которой виртуальная машина с несколькими экземплярами может не отображаться в раскрывающемся списке "сервер" во время операции восстановления.

Вы можете проверить "готовность резервного копирования" всех экземпляров SQL на виртуальной машине в разделе **Настройка резервного копирования**:

![Проверка готовности к резервному копированию](./media/backup-sql-server-azure-troubleshoot/backup-readiness.png)

Если вы хотите активировать восстановление в работоспособных экземплярах SQL, выполните следующие действия.

1. Войдите на виртуальную машину SQL и перейдите по адресу `C:\Program Files\Azure Workload Backup\bin` .
1. Создайте файл JSON с именем `ExtensionSettingsOverrides.json` (если он еще не существует). Если этот файл уже существует на виртуальной машине, продолжайте использовать его.
1. Добавьте следующее содержимое в файл JSON и сохраните файл:

    ```json
    {
                  "<ExistingKey1>":"<ExistingValue1>",
                    …………………………………………………… ,
              "whitelistedInstancesForInquiry": "FaultyInstance_1,FaultyInstance_2"
            }
            
            Sample content:        
            { 
              "whitelistedInstancesForInquiry": "CRPPA,CRPPB "
            }

    ```

1. Запустите операцию повторного **обнаружения баз данных** на затронутом сервере из портал Azure (то же место, где можно просмотреть готовность к резервному копированию). Виртуальная машина начнет отображаться как Целевая для операций восстановления.

    ![Повторное обнаружение баз данных](./media/backup-sql-server-azure-troubleshoot/rediscover-dbs.png)

1. Удалите запись *вхителистединстанцесфоринкуири* из ExtensionSettingsOverrides.jsв файле после завершения операции восстановления.

## <a name="error-messages"></a>Сообщения об ошибках

### <a name="backup-type-unsupported"></a>Неподдерживаемый тип резервного копирования

| Статус | Описание | Возможные причины | Рекомендованное действие |
|---|---|---|---|
| Предупреждение | Текущие параметры этой базы данных не поддерживают определенные типы резервных копий, существующие в связанной политике. | <li>В базе данных Master может быть выполнена только операция полного резервного копирования базы данных. Разностное резервное копирование и резервное копирование журналов транзакций невозможны. </li> <li>Любая база данных в простой модели восстановления не допускает резервного копирования журналов транзакций.</li> | Измените параметры базы данных, чтобы поддерживались все типы резервных копий в политике. Или измените текущую политику так, чтобы она включала только поддерживаемые типы резервного копирования. В противном случае неподдерживаемые типы резервного копирования будут пропущены во время запланированного резервного копирования, или задание резервного копирования завершится сбоем для резервного копирования по требованию.

### <a name="usererrorsqlpodoesnotsupportbackuptype"></a>UserErrorSQLPODoesNotSupportBackupType

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| This SQL database does not support the requested backup type. (Эта база данных SQL не поддерживает запрашиваемый тип резервного копирования.) | Возникает, когда модель восстановления базы данных не разрешает запрашиваемый тип резервного копирования. Ошибка может произойти в следующих ситуациях: <br/><ul><li>База данных, использующая простую модель восстановления, не допускает резервное копирование журналов.</li><li>Разностные и резервные копии журналов не допускаются для базы данных master.</li></ul>Дополнительные сведения см. в документации по [моделям восстановления SQL Server](/sql/relational-databases/backup-restore/recovery-models-sql-server) . | Если резервная копия журнала для базы данных в простой модели восстановления завершается сбоем, попробуйте один из следующих вариантов.<ul><li>Если база данных находится в режиме простого восстановления, отключите резервные копии журналов.</li><li>Используйте [документацию по SQL Server](/sql/relational-databases/backup-restore/view-or-change-the-recovery-model-of-a-database-sql-server) , чтобы изменить модель восстановления базы данных на полную или с неполным протоколированием. </li><li> Если вы не хотите изменять модель восстановления, и у вас есть стандартная политика резервного копирования нескольких баз данных, которую нельзя изменить, игнорируйте ошибку. Полные и разностные резервные копии будут работать по расписанию. Резервные копии журналов будут пропущены, что ожидаемо в этом случае.</li></ul>Если это база данных master и вы настроили разностную или резервную копию журналов, выполните одно из следующих действий.<ul><li>Используйте портал, чтобы изменить расписание политики резервного копирования для базы данных master на Full.</li><li>Если у вас есть стандартная политика резервного копирования нескольких баз данных, которую нельзя изменить, игнорируйте ошибку. Ваше полное резервное копирование будет работать по расписанию. Разностное резервное копирование или резервное копирование журналов не произойдет, что ожидаемо в этом случае.</li></ul> |
| Operation canceled as a conflicting operation was already running on the same database. (Операция отменена, так как конфликтная операция уже выполняется в одной базе данных.) | См. [запись блога об ограничениях резервного копирования и восстановления](https://deep.data.blog/2008/12/30/concurrency-of-full-differential-and-log-backups-on-the-same-database/) , которые выполняются параллельно.| [Используйте SQL Server Management Studio (SSMS) для наблюдения за заданиями резервного копирования](manage-monitor-sql-database-backup.md). После сбоя конфликтующей операции Перезапустите операцию.|

### <a name="usererrorsqlpodoesnotexist"></a>UserErrorSQLPODoesNotExist

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| SQL database does not exist. (База данных SQL не существует.) | База данных была либо удалена, либо переименована. | Проверьте, не была ли база данных случайно удалена или переименована.<br/><br/> Если база данных была случайно удалена, чтобы продолжить резервное копирование, восстановите базу данных в ее исходном расположении.<br/><br/> Если вы удалили базу данных и не хотите создавать дальнейшие резервные копии, в хранилище служб восстановления выберите пункт **отменить резервное копирование** с **сохранением данных резервного копирования** или **Удаление данных резервных копий**. Дополнительные сведения см. в статье [Управление и мониторинг резервных копий SQL Server баз данных](manage-monitor-sql-database-backup.md).

### <a name="usererrorsqllsnvalidationfailure"></a>UserErrorSQLLSNValidationFailure

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Log chain is broken. (Цепочка журналов прерывается.) | Резервное копирование базы данных или виртуальной машины осуществляется с помощью другого решения резервного копирования, которое усекает цепочку журналов.|<ul><li>Проверьте, используется ли другое решение или скрипт резервного копирования. В этом случае остановите резервное копирование. </li><li>Если резервная копия журнала была создана по запросу, активируйте полную резервную копию для запуска новой цепочки журналов. Для запланированных резервных копий журналов никаких действий не требуется, так как служба Azure Backup автоматически запустит полную архивацию для устранения этой проблемы.</li>|

### <a name="usererroropeningsqlconnection"></a>UserErrorOpeningSQLConnection

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Azure Backup is not able to connect to the SQL instance. (Azure Backup не может подключиться к экземпляру SQL.) | Azure Backup не удается подключиться к экземпляру SQL Server. | Используйте дополнительные сведения в меню портал Azure ошибок, чтобы сократить количество основных причин. Дополнительные сведения см. в статье [Устранение неполадок при соединении с компонентом SQL Server Database Engine](/sql/database-engine/configure-windows/troubleshoot-connecting-to-the-sql-server-database-engine).<br/><ul><li>Если параметры SQL по умолчанию не разрешают удаленные подключения, измените параметры. Сведения об изменении параметров см. в следующих статьях:<ul><li>[MSSQLSERVER_-1](/sql/relational-databases/errors-events/mssqlserver-1-database-engine-error)</li><li>[MSSQLSERVER_2](/sql/relational-databases/errors-events/mssqlserver-2-database-engine-error)</li><li>[MSSQLSERVER_53](/sql/relational-databases/errors-events/mssqlserver-53-database-engine-error)</li></ul></li></ul><ul><li>Если имеются проблемы с входом, воспользуйтесь следующими ссылками, чтобы исправить их:<ul><li>[MSSQLSERVER_18456](/sql/relational-databases/errors-events/mssqlserver-18456-database-engine-error)</li><li>[MSSQLSERVER_18452](/sql/relational-databases/errors-events/mssqlserver-18452-database-engine-error)</li></ul></li></ul> |

### <a name="usererrorparentfullbackupmissing"></a>UserErrorParentFullBackupMissing

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| First full backup is missing for this data source. (Полная резервная копия отсутствует для этого источника данных.) | Полная резервная копия для базы данных отсутствует. Журналы и разностные резервные копии являются родительскими для полной резервной копии, поэтому перед активацией разностных резервных копий или архивации журналов обязательно создайте полные резервные копии. | Активация полной резервной копии по запросу.   |

### <a name="usererrorbackupfailedastransactionlogisfull"></a>UserErrorBackupFailedAsTransactionLogIsFull

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Невозможно выполнить резервное копирование, так как журнал транзакций для источника данных заполнен. | Пространство журнала транзакций базы данных заполнено. | Чтобы устранить эту проблему, обратитесь к [документации по SQL Server](/sql/relational-databases/errors-events/mssqlserver-9002-database-engine-error). |

### <a name="usererrorcannotrestoreexistingdbwithoutforceoverwrite"></a>UserErrorCannotRestoreExistingDBWithoutForceOverwrite

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Database with same name already exists at the target location (База данных с тем же именем уже существует в целевом расположении) | Целевое назначение восстановления уже содержит базу данных с тем же именем.  | <ul><li>Измените имя целевой базы данных.</li><li>Или используйте параметр Force overwrite на странице восстановление.</li> |

### <a name="usererrorrestorefaileddatabasecannotbeofflined"></a>UserErrorRestoreFailedDatabaseCannotBeOfflined

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Restore failed as the database could not be brought offline. (Не удалось выполнить восстановление, так как база данных не может быть отключена.) | Пока выполняется восстановление, Целевая база данных должна быть переведена в режим «вне сети». Azure Backup не может перевести эти данные в автономный режим. | Используйте дополнительные сведения в меню портал Azure ошибок, чтобы сократить количество основных причин. Дополнительные сведения см. в [документации по SQL Server](/sql/relational-databases/backup-restore/restore-a-database-backup-using-ssms). |

### <a name="wlextgenericiofaultusererror"></a>влекстженериЦиофаултусереррор

|Сообщение об ошибке |Возможные причины  |Рекомендуемое действие  |
|---------|---------|---------|
|Во время операции произошла ошибка ввода-вывода. Проверьте общие ошибки ввода-вывода на виртуальной машине.   |   Разрешения на доступ или ограничение пространства на целевом объекте.       |  Проверьте наличие общих ошибок ввода-вывода на виртуальной машине. Убедитесь, что целевой диск или сетевая папка на компьютере: <li> имеет разрешение на чтение и запись для учетной записи NT AUTHORITY\SYSTEM на компьютере. <li> имеет достаточно места для успешного завершения операции.<br> Дополнительные сведения см. в разделе [RESTORE as Files](restore-sql-database-azure-vm.md#restore-as-files).
       |

### <a name="usererrorcannotfindservercertificatewiththumbprint"></a>UserErrorCannotFindServerCertificateWithThumbprint

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Cannot find the server certificate with thumbprint on the target. (Не удается найти сертификат сервера с отпечатком на целевом сервере.) | У базы данных master в целевом экземпляре отсутствует допустимый отпечаток шифрования. | Импортируйте допустимый отпечаток сертификата, используемый в экземпляре источника, в целевой экземпляр. |

### <a name="usererrorrestorenotpossiblebecauselogbackupcontainsbulkloggedchanges"></a>UserErrorRestoreNotPossibleBecauseLogBackupContainsBulkLoggedChanges

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Резервная копия журналов, используемая для восстановления, содержит сведения об изменениях, зафиксированные в режиме неполного протоколирования. Его нельзя использовать для завершения в произвольный момент времени в соответствии с рекомендациями SQL. | Если база данных находится в режиме восстановления с незавершенным протоколированием, данные между незавершенной транзакцией и следующей транзакцией журнала восстановить нельзя. | Выберите другой момент времени для восстановления. [Подробнее.](/sql/relational-databases/backup-restore/recovery-models-sql-server)

### <a name="fabricsvcbackuppreferencecheckfailedusererror"></a>FabricSvcBackupPreferenceCheckFailedUserError

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Backup preference for SQL Always On Availability Group cannot be met as some nodes of the Availability Group are not registered. (Требование резервного копирования для группы доступности SQL Always On не может быть выполнено, поскольку некоторые узлы группы доступности не зарегистрированы.) | Узлы, необходимые для выполнения резервного копирования, не зарегистрированы или недостижимы. | <ul><li>Убедитесь, что все узлы, необходимые для выполнения резервного копирования этой базы данных, зарегистрированы и работоспособны, а затем повторите операцию.</li><li>Измените параметры резервного копирования для группы доступности SQL Server Always On.</li></ul> |

### <a name="vmnotinrunningstateusererror"></a>VMNotInRunningStateUserError

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| SQL server VM is either shutdown and not accessible to Azure Backup service. (Виртуальная машина SQL server либо отключена, либо недоступна службе Azure Backup.) | Виртуальная машина завершает работу. | Убедитесь, что экземпляр SQL Server работает. |

### <a name="guestagentstatusunavailableusererror"></a>GuestAgentStatusUnavailableUserError

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Служба Azure Backup использует гостевой агент виртуальной машины Azure VM для выполнения резервного копирования, но агент недоступен на целевом сервере. | Гостевой агент не включен или является неработоспособным. | [Установите гостевой агент виртуальной машины](../virtual-machines/extensions/agent-windows.md) вручную. |

### <a name="autoprotectioncancelledornotvalid"></a>AutoProtectionCancelledOrNotValid

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
| Намерение автоматической защиты было удалено или больше не действительно. | При включении автоматической защиты на экземпляре SQL Server настройте задания **резервного копирования** для всех баз данных в этом экземпляре. Если отключить автоматическую защиту при выполнении заданий, **текущие** задания будут отменены и отобразится этот код ошибки. | Снова включите автоматическую защиту, чтобы защитить все оставшиеся базы данных. |

### <a name="clouddosabsolutelimitreached"></a>клауддосабсолутелимитреачед

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
Операция заблокирована, так как достигнуто максимально допустимое количество операций в 24 часа. | Если достигнуто максимально допустимое ограничение для операции в течение 24 часов, отображается эта ошибка. <br> Например, если достигнуто предельное число заданий резервного копирования, которые могут активироваться в день, и вы пытаетесь настроить резервное копирование для нового элемента, вы увидите эту ошибку. | Как правило, повторная попытка выполнения операции через 24 часа разрешает эту проблему. Однако если проблему не удается устранить, обратитесь за помощью в службу поддержки Майкрософт.

### <a name="clouddosabsolutelimitreachedwithretry"></a>клауддосабсолутелимитреачедвисретри

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
Операция заблокирована, так как хранилище достигло максимального предела для таких операций, разрешенных в течение 24 часов. | Если достигнуто максимально допустимое ограничение для операции в течение 24 часов, отображается эта ошибка. Эта ошибка обычно возникает при наличии крупномасштабных операций, таких как изменение политики или автоматическая защита. В отличие от Клауддосабсолутелимитреачед, для разрешения этого состояния не нужно ничего делать. На самом деле Azure Backup служба будет пытаться выполнить внутренние операции для всех рассматриваемых элементов.<br> Например, если имеется большое количество источников данных, защищенных с помощью политики, и вы пытаетесь изменить эту политику, будет активирована Настройка заданий защиты для каждого из защищенных элементов и иногда может достигнуть максимально допустимое количество таких операций в день.| Служба Azure Backup автоматически попытается выполнить эту операцию через 24 часа.

### <a name="usererrorvminternetconnectivityissue"></a>UserErrorVMInternetConnectivityIssue

| Сообщение об ошибке | Возможные причины | Рекомендованное действие |
|---|---|---|
Виртуальной машине не удается связаться со службой Azure Backup из-за проблем с подключением к Интернету. | Виртуальной машине требуется исходящее подключение к службам Azure Backup, службе хранилища Azure или службам Azure Active Directory.| — Если для ограничения подключения используется NSG, то следует использовать тег службы *AzureBackup* , чтобы разрешить исходящий доступ к Azure Backup службе, а также к службам Azure AD (*AzureActiveDirectory*) и службе хранилища Azure (*хранилище*). Чтобы предоставить доступ, выполните следующие [действия](./backup-sql-server-database-azure-vms.md#nsg-tags) .<br>— Убедитесь, что DNS разрешает конечные точки Azure.<br>— Убедитесь, что виртуальная машина находится за подсистемой балансировки нагрузки, блокирующей доступ к Интернету. При назначении общедоступного IP-адреса виртуальным машинам обнаружение будет работать.<br>— Убедитесь в отсутствии брандмауэра, антивирусного и прокси-сервера, блокирующих вызовы указанных выше трех целевых служб.

## <a name="re-registration-failures"></a>Сбои повторной регистрации

Перед запуском операции повторной регистрации проверьте наличие одного или нескольких следующих признаков.

- Все операции (такие как резервное копирование, восстановление и Настройка резервного копирования) на виртуальной машине завершаются с помощью одного из следующих кодов ошибок: **ворклоадекстенсионнотреачабле**, **усереррорворклоадекстенсионнотинсталлед**, **ворклоадекстенсионнотпресент**, **WorkloadExtensionDidntDequeueMsg**.
- Если в области **Backup Status** (Состояние резервного копирования) для элемента резервного копирования отображается **Недоступно**, исключите все остальные причины, которые могут привести к тому же состоянию:

  - Отсутствует разрешение на выполнение операций, связанных с резервным копированием на виртуальной машине.
  - Завершение работы виртуальной машины, поэтому архивация не может быть выполнена.
  - Проблемы с сетью.

   ![Повторная регистрация виртуальной машины](./media/backup-azure-sql-database/re-register-vm.png)

- В случае Always On группы доступности резервные копии запускаются с ошибкой после изменения настроек резервного копирования или после отработки отказа.

Эти признаки могут возникнуть по одной или нескольким из следующих причин:

- Расширение удалено из портала.
- Расширение удалено с помощью **панели управления** на виртуальной машине в разделе **Удаление или изменение программы**.
- Восстановлено предыдущее состояние виртуальной машины с помощью восстановления с диска на месте.
- Виртуальная машина была выключена в течение длительного периода, поэтому срок действия конфигурации расширения на ней истек.
- Виртуальная машина была удалена, а затем была создана другая виртуальная машина с тем же именем и в той же группе ресурсов, что и удаленная виртуальная машина.
- Один из узлов группы доступности не получил полную конфигурацию архивации. Это может произойти при регистрации группы доступности в хранилище или при добавлении нового узла.

В предыдущих сценариях рекомендуется активировать повторную регистрацию на виртуальной машине. Инструкции по выполнению этой задачи в PowerShell см. [здесь](./backup-azure-sql-automation.md#enable-backup) .

## <a name="size-limit-for-files"></a>Ограничение размера файлов

Общий размер строк файлов зависит не только от количества файлов, но и от их имен и путей. Для каждого файла базы данных получите логическое имя файла и физический путь. Этот запрос SQL можно использовать:

```sql
SELECT mf.name AS LogicalName, Physical_Name AS Location FROM sys.master_files mf
               INNER JOIN sys.databases db ON db.database_id = mf.database_id
               WHERE db.name = N'<Database Name>'"
```

Теперь расположите их в следующем формате:

```json
[{"path":"<Location>","logicalName":"<LogicalName>","isDir":false},{"path":"<Location>","logicalName":"<LogicalName>","isDir":false}]}
```

Приведем пример:

```json
[{"path":"F:\\Data\\TestDB12.mdf","logicalName":"TestDB12","isDir":false},{"path":"F:\\Log\\TestDB12_log.ldf","logicalName":"TestDB12_log","isDir":false}]}
```

Если размер строки содержимого превышает 20 000 байт, файлы базы данных хранятся по-разному. Во время восстановления вы не сможете задать путь к целевому файлу для восстановления. Файлы будут восстановлены до пути SQL по умолчанию, предоставленного SQL Server.

### <a name="override-the-default-target-restore-file-path"></a>Переопределение пути к файлу восстановления целевого объекта по умолчанию

Путь к целевому файлу восстановления можно переопределить во время операции восстановления, разместив JSON-файл, содержащий сопоставление файла базы данных с целевым путем восстановления. Создайте `database_name.json` файл и поместите его в расположение `C:\Program Files\Azure Workload Backup\bin\plugins\SQL*` .

Содержимое файла должно быть в следующем формате:

```json
[
  {
    "Path": "<Restore_Path>",
    "LogicalName": "<LogicalName>",
    "IsDir": "false"
  },
  {
    "Path": "<Restore_Path>",
    "LogicalName": "LogicalName",
    "IsDir": "false"
  },  
]
```

Приведем пример:

```json
[
  {
   "Path": "F:\\Data\\testdb2_1546408741449456.mdf",
   "LogicalName": "testdb7",
   "IsDir": "false"
  },
  {
    "Path": "F:\\Log\\testdb2_log_1546408741449456.ldf",
    "LogicalName": "testdb7_log",
    "IsDir": "false"
  },  
]
```

В предыдущем содержимом можно получить логическое имя файла базы данных с помощью следующего запроса SQL:

```sql
SELECT mf.name AS LogicalName FROM sys.master_files mf
                INNER JOIN sys.databases db ON db.database_id = mf.database_id
                WHERE db.name = N'<Database Name>'"
```

Этот файл должен быть помещен перед запуском операции восстановления.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Azure Backup для виртуальных машин SQL Server (общедоступная Предварительная версия) см. в статье [Azure Backup для виртуальных машин SQL](../azure-sql/virtual-machines/windows/backup-restore.md#azbackup).
