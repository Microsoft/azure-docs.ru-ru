---
title: Мониторинг SQL Server баз данных на виртуальной машине Azure и управление ими
description: В этой статье описывается, как управлять и отслеживать SQL Server базы данных, работающие на виртуальной машине Azure.
ms.topic: conceptual
ms.date: 09/11/2019
ms.openlocfilehash: e37e6fc211b34b7e427b66db374a705faafd25f9
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97858744"
---
# <a name="manage-and-monitor-backed-up-sql-server-databases"></a>Мониторинг резервных копий баз данных SQL Server и управление ими

В этой статье описываются распространенные задачи по управлению и мониторингу SQL Server баз данных, работающих на виртуальной машине Azure, и резервное копирование в хранилище служб восстановления Azure Backup с помощью службы [Azure Backup](backup-overview.md) . Вы узнаете, как отслеживать задания и оповещения, прекращать и возобновлять защиту базы данных, выполнять задания резервного копирования и отменять регистрацию виртуальной машины из резервных копий.

Если вы еще не настроили резервные копии для баз данных SQL Server, см. статью [резервное копирование SQL Server баз данных на виртуальных машинах Azure](backup-azure-sql-database.md) .

## <a name="monitor-backup-jobs-in-the-portal"></a>Мониторинг заданий резервного копирования на портале

В Azure Backup отображаются все запланированные и выполняемые по запросу операции в разделе **задания резервного копирования** на портале, за исключением запланированных резервных копий журналов, так как они могут быть очень частыми. Задания, отображаемые на этом портале, включают обнаружение и регистрацию базы данных, настройку резервного копирования, а также операции резервного копирования и восстановления.

![Портал заданий резервного копирования](./media/backup-azure-sql-database/sql-backup-jobs-list.png)

Для получения дополнительных сведений о сценариях мониторинга перейдите к разделу [мониторинг в портал Azure](backup-azure-monitoring-built-in-monitor.md) и [мониторинг с помощью Azure Monitor](backup-azure-monitoring-use-azuremonitor.md).  

## <a name="view-backup-alerts"></a>Просмотр оповещений о резервном копировании

Так как резервные копии журналов создаются каждые 15 минут, мониторинг заданий резервного копирования может быть утомительным. Azure Backup упрощает мониторинг, отправляя оповещения по электронной почте. Оповещения по электронной почте:

- Оповещения о любых сбоях резервного копирования.
- Оповещения, объединенные на уровне базы данных по коду ошибки.
- Оповещения, отправляемые только для первого сбоя резервного копирования базы данных.

Для мониторинга предупреждений резервного копирования базы данных выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).

2. На панели мониторинга хранилища выберите **Оповещения резервного копирования**.

   ![Выбор "Оповещения, связанные с архивацией"](./media/backup-azure-sql-database/sql-backup-alerts-list.png)

## <a name="stop-protection-for-a-sql-server-database"></a>Остановка защиты базы данных SQL Server

Вы можете остановить создание резервных копий базы данных SQL Server двумя способами:

- остановить все будущие задания резервного копирования и удалить все точки восстановления;
- Завершите все будущие задания резервного копирования и оставьте точки восстановления без изменений.

Если вы решили сохранить точки восстановления, учитывайте следующие факторы:

- все точки восстановления навсегда остаются неизменными, и любая очистка прекращается одновременно с отключением защиты;
- вы будете оплачивать работу защищенного экземпляр и используемый объем хранилища; Дополнительные сведения см. на странице [Цены на Azure Backup](https://azure.microsoft.com/pricing/details/backup/).
- если вы удалите источник данных без остановки резервного копирования, новые операции резервного копирования будут завершаться сбоем. Срок действия старых точек восстановления истекает в соответствии с политикой, но самая последняя точка восстановления всегда будет сохраняться до тех пор, пока вы не завершите резервное копирование и не удалите данные.

Чтобы остановить защиту базы данных, выполните следующие действия.

1. На панели мониторинга хранилища выберите **Элементы архивации**.

2. В разделе **тип управления архивацией** выберите **SQL на виртуальной машине Azure**.

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

3. Выберите базу данных, для которой нужно остановить защиту.

    ![Выбор базы данных для остановки защиты](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

4. В меню базы данных выберите **Остановить архивацию**.

    ![Выбор "Остановить архивацию"](./media/backup-azure-sql-database/stop-db-button.png)

5. В меню **Остановить архивацию** выберите, следует ли сохранить или удалить данные. При желании можно указать причину или комментарий.

    ![Сохраняйте или удаляйте данные в меню "Отмена архивации"](./media/backup-azure-sql-database/stop-backup-button.png)

6. Выберите **Остановить архивацию**.

> [!NOTE]
>
>Дополнительные сведения о параметре Delete Data см. в разделе часто задаваемые вопросы ниже:
>
>- [Что произойдет с резервным копированием, если удалить базу данных из автоматически защищенного экземпляра?](faq-backup-sql-server.md#if-i-delete-a-database-from-an-autoprotected-instance-what-will-happen-to-the-backups)
>- [Что будет поведению при выполнении резервного копирования базы данных с автозащитой?](faq-backup-sql-server.md#if-i-change-the-name-of-the-database-after-it-has-been-protected-what-will-be-the-behavior)
>
>

## <a name="resume-protection-for-a-sql-database"></a>возобновление защиты базы данных SQL;

При отключении защиты для базы данных SQL при выборе варианта " **хранить данные резервной копии** " можно возобновить защиту. Если вы не храните данные резервной копии, вы не сможете возобновить защиту.

Чтобы возобновить защиту базы данных SQL, выполните следующие действия.

1. Откройте элемент архивации и выберите **Возобновить резервное копирование**.

    ![Выбор "Возобновить резервное копирование" для возобновления защиты базы данных](./media/backup-azure-sql-database/resume-backup-button.png)

2. В меню **Политика архивации** выберите политику и нажмите кнопку **Сохранить**.

## <a name="run-an-on-demand-backup"></a>Выполнение резервного копирования по запросу

Вы можете выполнить различные типы резервного копирования по требованию:

- Полное резервное копирование
- полная резервная копия (только копирование);
- Разностное резервное копирование
- Резервное копирование журналов

Хотя необходимо указать продолжительность хранения для полной резервной копии только для копирования, диапазон хранения для полной резервной копии по запросу будет автоматически установлен в 45 дней с текущего времени.

Дополнительные сведения см. в статье [SQL Server типы резервных копий](backup-architecture.md#sql-server-backup-types).

## <a name="modify-policy"></a>Изменение политики

Измените политику, чтобы изменить периодичность резервного копирования или диапазон хранения.

> [!NOTE]
> Все изменения периода хранения будут применены не только к новым точкам восстановления, но и ретроспективно ко всем старым точкам восстановления.

На панели мониторинга хранилища перейдите к разделу **Управление**  >  **политиками архивации** и выберите политику, которую нужно изменить.

  ![Управление политикой архивации](./media/backup-azure-sql-database/modify-backup-policy.png)

  ![Изменение политики архивации](./media/backup-azure-sql-database/modify-backup-policy-impact.png)

Изменение политики повлияет на все связанные элементы архивации и вызовет соответствующие задания **настройки защиты**.

### <a name="inconsistent-policy"></a>Несогласованная политика

В некоторых случаях операция изменения политики может привести к **несовместимости** версии политики для некоторых элементов резервного копирования. Это происходит, когда после запуска операции изменения политики соответствующее задание **настройки защиты** для элемента архивации выполняется со сбоем. В представлении элемента архивации он выглядит следующим образом.

  ![Несогласованная политика](./media/backup-azure-sql-database/inconsistent-policy.png)

Можно исправить версию политики для всех затронутых элементов одним щелчком мыши.

  ![Исправление несоответствия политики](./media/backup-azure-sql-database/fix-inconsistent-policy.png)

## <a name="unregister-a-sql-server-instance"></a>Отмена регистрации экземпляра SQL Server

Отмените регистрацию экземпляра SQL Server после отключения защиты, но перед удалением хранилища выполните следующие действия.

1. На панели мониторинга хранилища в разделе **Управление** выберите **Инфраструктура резервного копирования**.  

   ![Выбор "Инфраструктура резервного копирования"](./media/backup-azure-sql-database/backup-infrastructure-button.png)

2. В разделе **Серверы управления** выберите **Защищенные серверы**.

   ![Выбор "Защищенные серверы"](./media/backup-azure-sql-database/protected-servers.png)

3. В меню **Защищенные серверы** выберите сервер, для которого необходимо отменить регистрацию. Чтобы удалить хранилище, необходимо отменить регистрацию всех серверов.

4. Щелкните правой кнопкой мыши защищенный сервер и выберите отменить **регистрацию**.

   ![Выбор "Удалить"](./media/backup-azure-sql-database/delete-protected-server.jpg)

## <a name="re-register-extension-on-the-sql-server-vm"></a>Повторно зарегистрируйте расширение на виртуальной машине SQL Server

Иногда расширение рабочей нагрузки на виртуальной машине может затронуть одну причину или другую. В таких случаях все операции, запущенные на этой виртуальной машине, начнут давать сбой. Может потребоваться повторная регистрация расширения на виртуальной машине. Операция **повторной регистрации** переустанавливает модуль резервного копирования рабочей нагрузки на виртуальной машине для продолжения операций. Этот параметр можно найти в разделе **инфраструктура резервного копирования** в хранилище служб восстановления.

![Защищенные серверы в инфраструктуре резервного копирования](./media/backup-azure-sql-database/protected-servers-backup-infrastructure.png)

Используйте этот параметр с осторожностью. При запуске на виртуальной машине с уже работоспособным расширением эта операция приведет к перезапуску расширения. Это может привести к сбою всех выполняемых заданий. Перед активацией операции повторной регистрации проверьте наличие одного или нескольких [симптомов](backup-sql-server-azure-troubleshoot.md#re-registration-failures).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в статье [Устранение неполадок резервного копирования в SQL Server базе данных](backup-sql-server-azure-troubleshoot.md).
