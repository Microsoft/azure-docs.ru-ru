---
title: Настройка параметров диагностики хранилища в масштабе
description: Настройка параметров диагностики Log Analytics для всех хранилищ в заданной области с помощью политики Azure
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: 55461937381f7551c42714c835d4755ab65f175b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92171532"
---
# <a name="configure-vault-diagnostics-settings-at-scale"></a>Настройка параметров диагностики хранилища в масштабе

Решение для создания отчетов, предоставляемое Azure Backup, использует Log Analytics (LA). Для отправки данных любого хранилища в LA необходимо создать [параметр диагностики](./backup-azure-diagnostic-events.md) для этого хранилища.

Часто Добавление параметра диагностики вручную для каждого хранилища может оказаться громоздким заданием. Кроме того, для всех новых хранилищ также должны быть включены параметры диагностики, чтобы иметь возможность просматривать отчеты для этого хранилища.

Чтобы упростить создание параметров диагностики в масштабе (с LA в качестве места назначения), Azure Backup предоставляет встроенную [политику Azure](../governance/policy/index.yml). Эта политика добавляет параметр диагностики "Ла" ко всем хранилищам в заданной подписке или группе ресурсов. В следующих разделах приводятся инструкции по использованию этой политики.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии

* Политика может быть применена одновременно ко всем хранилищам служб восстановления в определенной подписке (или к группе ресурсов в подписке). Пользователь, которому назначена политика, должен иметь доступ **владельца** к подписке, которой назначена политика.

* Рабочая область LA, указанная пользователем (в которой будут отправляться диагностические данные), может находиться в другой подписке из хранилищ, которым назначена политика. Пользователь должен иметь доступ **читателя**, **участник** или **владелец** к подписке, в которой существует указанная La Рабочая область.

* Область группы управления в настоящее время не поддерживается.

* Встроенная политика в настоящее время недоступна в национальных облаках.

[!INCLUDE [backup-center.md](../../includes/backup-center.md)]

## <a name="assigning-the-built-in-policy-to-a-scope"></a>Назначение встроенной политики области

Чтобы назначить политику для хранилищ в требуемой области, выполните следующие действия:

1. Войдите в портал Azure и перейдите на панель мониторинга **политики** .
2. В меню слева выберите **определения** , чтобы получить список всех встроенных политик в ресурсах Azure.
3. Отфильтруйте список **категорий = резервное копирование**. Откройте политику с именем **[Предварительная версия]: Развертывание параметров диагностики для хранилища служб восстановления в log Analytics рабочей области для категорий конкретных ресурсов**.

    ![Панель определения политики](./media/backup-azure-policy-configure-diagnostics/policy-definition-blade.png)

4. Выберите имя политики. Вы будете перенаправлены к подробному определению этой политики.

    ![Подробное определение политики](./media/backup-azure-policy-configure-diagnostics/detailed-policy-definition.png)

5. Нажмите кнопку **назначить** в верхней части панели. Будет перенаправлен на область **Назначение политики** .

6. В разделе **Основные сведения** выберите три точки рядом с полем **область** . Откроется правая область контекста, где можно выбрать подписку для применения политики. При необходимости можно также выбрать группу ресурсов, чтобы политика была применена только к хранилищам в определенной группе ресурсов.

    ![Основы назначения политик](./media/backup-azure-policy-configure-diagnostics/policy-assignment-basics.png)

7. В разделе **Параметры** введите следующие сведения.

    * **Имя профиля** — имя, которое будет назначено параметрам диагностики, созданным политикой.
    * **Рабочая область log Analytics** — рабочая область log Analytics, с которой следует связать параметр диагностики. Данные диагностики всех хранилищ в области назначения политики будут отправлены в указанную Ла рабочую область.

    * **Имя тега исключения (необязательно) и значение тега исключения (необязательно)** . Вы можете исключить хранилища, содержащие определенное имя тега и значение из назначения политики. Например, если **не** требуется добавлять параметр диагностики в те хранилища, для которых в качестве тега "l" задано значение "Да", необходимо ввести "Test" в поле " **имя тега исключения** " и "Да" в поле " **значение тега исключения** ". Если какие-либо из этих двух полей (или оба) остались пустыми, политика будет применена ко всем соответствующим хранилищам независимо от того, какие теги они содержат.

    ![Параметры назначения политики](./media/backup-azure-policy-configure-diagnostics/policy-assignment-parameters.png)

8. **Создание задачи исправления** . После назначения политики области всем новым хранилищам, созданным в этой области, автоматически получаются настроенные параметры диагностики (в течение 30 минут с момента создания хранилища). Чтобы добавить параметр диагностики в существующие хранилища в области, можно запустить задачу исправления в момент назначения политики. Чтобы запустить задачу исправления, установите флажок **создать задачу исправления**.

    ![Исправление назначения политики](./media/backup-azure-policy-configure-diagnostics/policy-assignment-remediation.png)

9. Перейдите на вкладку **Просмотр и создание** и выберите **создать**.

## <a name="under-what-conditions-will-the-remediation-task-apply-to-a-vault"></a>При каких условиях задача исправления будет применена к хранилищу?

Задача исправления применяется к хранилищам, которые не соответствуют требованиям в соответствии с определением политики. Хранилище не соответствует требованиям, если оно удовлетворяет одному из следующих условий:

* Для хранилища отсутствует параметр диагностики.
* Параметры диагностики существуют для хранилища, но ни для одного из параметров не включены **все** события, относящиеся к ресурсам, с использованием La в качестве назначения, а также выбраны **ресурсы** , выбранные в переключателе.

Таким образом, даже если у пользователя есть хранилище с включенным событием установите azurebackupreport в режиме AzureDiagnostics (который поддерживается отчетами резервного копирования), задача по исправлению будет по-прежнему применяться к этому хранилищу, так как в [этом случае рекомендуется](./backup-azure-diagnostic-events.md#legacy-event)использовать режим, зависящий от ресурса, для создания параметров диагностики.

Кроме того, если у пользователя есть хранилище, в котором включено только подмножество шести событий конкретного ресурса, задача исправления будет применена к этому хранилищу, так как отчеты о резервном копировании будут работать, только если включены все шесть событий, связанных с ресурсами.

> [!NOTE]
>
> Если в хранилище имеется параметр диагностики с включенным **подмножеством категорий для определенных ресурсов** , настроенных для отправки данных в конкретную рабочую область, скажем "Workspace x", задача исправления завершится ошибкой (для этого хранилища), если конечная точка назначения, указанная в назначении **политики, совпадает с "рабочей** областью x".
>
>Это связано с тем, что если события, включенные двумя разными параметрами диагностики одного ресурса, **перекрываются** в некоторой форме, то параметры не могут иметь ту же La рабочую область, что и назначение. Вам потребуется вручную устранить эту ошибку, перейдя в соответствующее хранилище и настроив параметр диагностики, указав в качестве места назначения другую LA рабочую область.
>
> Обратите внимание, что задача исправления **не** будет завершаться ошибкой, если для параметра "Диагностика" в качестве назначения выбрана только установите azurebackupreport с параметром "Рабочая область X", так как в этом случае перекрытие между событиями, включенными существующим параметром, и событиями, включенными параметром, созданным задачей "исправление", не произойдет.

## <a name="next-steps"></a>Дальнейшие действия

* [Сведения об использовании отчетов резервного копирования](./configure-reports.md)
* [Дополнительные сведения о политике Azure](../governance/policy/index.yml)
* [Использование политики Azure для автоматического включения резервного копирования для всех виртуальных машин в области действия "предоставить"](./backup-azure-auto-enable-backup.md)
