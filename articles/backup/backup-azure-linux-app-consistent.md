---
title: Резервное копирование виртуальных машин Linux с постоянными приложениями
description: Создание согласованных с приложениями резервных копий виртуальных машин Linux в Azure. В этой статье объясняется настройка платформы сценариев для резервного копирования виртуальных машин Linux, развернутых в Azure. В этой статье также приведены сведения об устранении неполадок.
ms.topic: conceptual
ms.date: 01/12/2018
ms.openlocfilehash: 22053004026a2dd8976027359f11d50a5663b334
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "88999246"
---
# <a name="application-consistent-backup-of-azure-linux-vms"></a>Согласованное с приложениями резервное копирование виртуальных машин Linux в Azure

При создании резервных моментальных снимков виртуальных машин согласованность с приложениями означает, что приложения запускаются при загрузке виртуальных машин после восстановления. Можно себе представить, какое важное значение имеет согласованность с приложениями. Чтобы обеспечить согласованность с приложениями виртуальных машин Linux, можно использовать платформу сценариев предварительной и последующей обработки Linux для создания согласованных с приложениями резервных копий. Платформа сценариев предварительной и последующей обработки поддерживается только для виртуальных машин Linux, развернутых с помощью Azure Resource Manager. Сценарии для согласованности приложений не поддерживают Service Manager, развернутые виртуальными машинами или виртуальными машинами Windows.

## <a name="how-the-framework-works"></a>Принцип работы платформы

Эта платформа позволяет запускать пользовательские скрипты предварительного и последующего выполнения во время создания моментальных снимков виртуальной машины. Сценарии предварительной обработки запускаются непосредственно перед созданием моментального снимка виртуальной машины, а сценарии последующей обработки — сразу после создания такого снимка. Эти сценарии позволяют гибко управлять приложением и средой во время создания моментальных снимков виртуальной машины.

Сценарии предварительной обработки вызывают собственные API приложения, которые замораживают операции ввода вывода и высвобождают содержимое памяти на диск. Эти действия обеспечивают согласованность моментального снимка с приложениями. В сценариях последующей обработки для разморозки операций ввода-вывода используются собственные API приложений, которые позволяют возобновить нормальную работу приложения после создания моментального снимка виртуальной машины.

## <a name="steps-to-configure-pre-script-and-post-script"></a>Действия по настройке скриптов предварительного и последующего выполнения

1. Войдите как привилегированный пользователь на виртуальную машину Linux, резервную копию которой нужно создать.

2. Перейдите на сайт [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig), скачайте файл **VMSnapshotScriptPluginConfig.json** и скопируйте его в папку **/etc/azure** для всех виртуальных машин, резервные копии которых требуется создать. Если папка **/etc/azure** не существует, создайте ее.

3. Скопируйте сценарии предварительной и последующей обработки для приложения на все виртуальные машины, резервные копии которых нужно создать. Скрипты можно скопировать в любое расположение на виртуальной машине. Не забудьте обновить полный путь к файлам скрипта в **VMSnapshotScriptPluginConfig.js** файле.

4. Обеспечьте следующие разрешения для файлов.

   - **VMSnapshotScriptPluginConfig.js**: разрешение "600". Например, только у привилегированных пользователей есть разрешения на чтение и запись этого файла. Разрешений на выполнение нет ни у кого.

   - **Файл предварительного скрипта**: разрешение "700".  Только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла.

   - **После сценария** Разрешение "700". Только у привилегированных пользователей есть разрешения на чтение, запись и выполнение этого файла.

   > [!IMPORTANT]
   > Платформа предоставляет пользователям широкие возможности. Защитите платформу и убедитесь, что только у привилегированных пользователей есть доступ к важным JSON-файлам и файлам сценариев.
   > Если требования не выполнены, сценарий не будет запущен, что приведет к сбою файловой системы и созданию несогласованной резервной копии.
   >

5. Настройте **VMSnapshotScriptPluginConfig.js** , как описано здесь:
    - **pluginName** — оставьте значение без изменения. Иначе сценарии могут выполняться неправильно.

    - **preScriptLocation** — укажите полный путь к скрипту предварительного выполнения на архивируемой виртуальной машине.

    - **postScriptLocation** — укажите полный путь к скрипту последующего выполнения на архивируемой виртуальной машине.

    - **preScriptParams** — укажите необязательные параметры, которые должны передаваться в скрипт предварительного выполнения. Все параметры должны быть заключены в кавычки. При использовании нескольких параметров они разделяются точками.

    - **postScriptParams** — укажите необязательные параметры, которые должны передаваться в скрипт последующего выполнения. Все параметры должны быть заключены в кавычки. При использовании нескольких параметров они разделяются точками.

    - **preScriptNoOfRetries**: задает количество повторных попыток выполнения сценария, если перед завершением работы возникли какие-либо ошибки. Ноль означает только одну попытку и не повторять попытку в случае сбоя.

    - **postScriptNoOfRetries**: Задайте количество повторных попыток выполнения скрипта после возникновения ошибки перед завершением работы. Ноль означает только одну попытку и не повторять попытку в случае сбоя.

    - **timeoutInSeconds** — укажите отдельные значения времени ожидания для сценариев предварительной и последующей обработки (максимальное значение может быть 1800).

    - **continueBackupOnFailure**: задайте для этого параметра значение **true** , если требуется, чтобы Azure Backup переключаться на резервную копию с постоянным или аварийным завершением файловой системы в случае сбоя скрипта, выполняемого до или после сбоя. Если задано **значение false** , резервное копирование завершается сбоем, если произошел сбой сценария (за исключением случаев, когда имеется однодисковая виртуальная машина, которая возвращается к отказоустойчивому резервному копированию независимо от этого параметра). Если для параметра **continueBackupOnFailure** задано значение false, то при сбое резервного копирования будет предпринята попытка выполнить операцию резервного копирования на основе логики повторных попыток в службе (для определенного количества попыток).

    - **fsFreezeEnabled** — укажите, будет ли во время создания моментального снимка виртуальной машины Linux вызываться fsfreeze для обеспечения согласованности с файловой системой. Рекомендуется установить для этого параметра значение **true** , если приложение не зависит от отключения fsfreeze.

    - **Скриптсексекутионполлтимесекондс**: задайте время, в течение которого расширение должно находиться в спящем режиме между каждым опросом при выполнении скрипта. Например, если значение равно 2, расширение проверяет, выполнялось ли предварительное и обратное выполнение скрипта каждые 2 секунды. Минимальное и максимальное значения, которые он может принимать, — 1 и 5 соответственно. Значение должно быть строго целым числом.

6. Платформа скриптов теперь настроена. Если резервное копирование виртуальной машины уже настроено, следующая операция резервного копирования вызовет скрипты и активирует резервное копирование, согласованное с приложениями. Если резервная копия виртуальной машины не настроена, настройте ее с помощью [резервного копирования виртуальных машин Azure в хранилища служб восстановления.](./backup-azure-vms-first-look-arm.md)

## <a name="troubleshooting"></a>Устранение неполадок

Убедитесь, что при записи скриптов предварительного и последующего выполнения вы включили ведение соответствующих журналов. Так вы сможете просматривать и исправлять возможные ошибки, связанные с запуском скриптов. Если скрипты по-прежнему не удается запустить, см. таблицу ниже.

| Ошибка | Сообщение об ошибке | Рекомендуемое действие |
| ------------------------ | -------------- | ------------------ |
| Pre-ScriptExecutionFailed |Скрипт предварительного выполнения вернул ошибку, и резервная копия может быть несогласованной с приложениями.| Чтобы устранить проблему, проверьте соответствующие журналы ошибок.|  
|Post-ScriptExecutionFailed |Скрипт последующего выполнения вернул ошибку, которая может влиять на состояние приложения. |Чтобы устранить проблему, проверьте соответствующие журналы ошибок и состояние приложений. |
| Pre-ScriptNotFound |Сценарий предварительного выполнения не найден в расположении, указанном в файле конфигурации **VMSnapshotScriptPluginConfig.json**. |Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт предварительного выполнения находится в расположении, указанном в файле конфигурации.|
| Post-ScriptNotFound |Сценарий предварительного выполнения не найден в расположении, указанном в файле конфигурации **VMSnapshotScriptPluginConfig.json**. |Чтобы обеспечить согласованное с приложениями резервное копирование приложений, убедитесь, что скрипт последующего выполнения находится в расположении, указанном в файле конфигурации.|
| IncorrectPluginhostFile |Файл **Pluginhost**, который поставляется вместе с расширением VmSnapshotLinux, поврежден, поэтому скрипты предварительного и последующего выполнения не могут быть выполнены, а резервная копия будет несогласованной с приложениями.| Чтобы устранить проблему, удалите расширение **VmSnapshotLinux**. Оно будет автоматически переустановлено при следующем резервном копировании. |
| IncorrectJSONConfigFile | Файл **VMSnapshotScriptPluginConfig.json** является недопустимым, поэтому сценарии предварительного и последующего выполнения невозможно выполнить. Резервная копия будет несогласованной с приложениями. | Скачайте копию файла из репозитория [GitHub](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) и выполните повторную настройку. |
| InsufficientPermissionforPre-Script | Чтобы выполнить скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (то есть только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| InsufficientPermissionforPost-Script | Чтобы выполнить скрипты, привилегированный пользователь (root) должен быть владельцем файла, а сам файл должен иметь разрешения "700" (то есть только владелец имеет разрешения на его чтение, запись и выполнение). | Убедитесь, что владельцем файла скрипта является привилегированный пользователь (root) и что только владелец имеет разрешения на его чтение, запись и выполнение. |
| Pre-ScriptTimeout | Истекло время запуска скрипта предварительного выполнения для согласованного с приложениями резервного копирования. | Проверьте скрипт в файле **VMSnapshotScriptPluginConfig.json** (расположен в каталоге **/etc/azure**) и увеличьте время ожидания. |
| Post-ScriptTimeout | Истекло время запуска скрипта последующего выполнения для согласованного с приложениями резервного копирования. | Проверьте скрипт в файле **VMSnapshotScriptPluginConfig.json** (расположен в каталоге **/etc/azure**) и увеличьте время ожидания. |

## <a name="next-steps"></a>Дальнейшие действия

[Резервное копирование виртуальных машин Azure в хранилище служб восстановления](./backup-azure-vms-first-look-arm.md)
