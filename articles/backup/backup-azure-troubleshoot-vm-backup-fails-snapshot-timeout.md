---
title: Устранение проблем с агентами и расширениями
description: Симптомы, причины и способы устранения проблем в работе службы Azure Backup, связанных с агентом, расширением и дисками.
ms.topic: troubleshooting
ms.date: 07/05/2019
ms.service: backup
ms.openlocfilehash: 0313394ad149460f82c98c63cab95b922b4a3da2
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102519611"
---
# <a name="troubleshoot-azure-backup-failure-issues-with-the-agent-or-extension"></a>Устранение неполадок службы Azure Backup. Проблемы с агентом или расширением

В этой статье описано, как устранять ошибки службы Azure Backup, связанные с установлением связи с агентом виртуальной машины и расширением.

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="step-by-step-guide-to-troubleshoot-backup-failures"></a>Пошаговое руководств по устранению сбоев резервного копирования

Большинство распространенных сбоев резервного копирования можно устранить самостоятельно, следуя приведенным ниже инструкциям по устранению неполадок.

### <a name="step-1-check-azure-vm-health"></a>Шаг 1. Проверка работоспособности виртуальной машины Azure

- **Убедитесь, что состояние подготовки виртуальной машины Azure — "работает"**: Если [состояние подготовки виртуальной машины](../virtual-machines/states-billing.md) находится в состоянии " **остановлено/освобождено/Обновлено** ", это помешает операции резервного копирования. Откройте *портал Azure > виртуальная машина > обзор >* и проверьте состояние виртуальной машины, чтобы убедиться, что она **запущена**  , и повторите операцию резервного копирования.
- **Проверьте отложенные обновления ОС или перезагрузки**: Убедитесь, что на виртуальной машине нет ожидающих обновлений ОС или ожидающих перезагрузок.

### <a name="step-2-check-azure-vm-guest-agent-service-health"></a>Шаг 2. Проверка работоспособности службы гостевого агента виртуальной машины Azure

- **Убедитесь, что служба гостевого агента виртуальной машины Azure запущена и обновлена**:
  - На виртуальной машине Windows:
    - Перейдите в раздел **Services. msc** и убедитесь, что **Служба гостевого агента виртуальной машины Windows Azure** запущена. Кроме того, убедитесь, что установлена [Последняя версия](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) . Дополнительные сведения см. в статье [проблемы гостевого агента виртуальной машины Windows](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms).
    - Агент виртуальной машины Azure устанавливается по умолчанию на любой виртуальной машине Windows, развернутой из образа Azure Marketplace, с портала, PowerShell, интерфейса командной строки или шаблона Azure Resource Manager. [Установка агента вручную](../virtual-machines/extensions/agent-windows.md#manual-installation) может потребоваться при создании пользовательского образа виртуальной машины, развернутого в Azure.
    - Просмотрите матрицу поддержки, чтобы проверить, работает ли виртуальная машина в [поддерживаемой операционной системе Windows](backup-support-matrix-iaas.md#operating-system-support-windows).
  - На виртуальной машине Linux
    - Убедитесь, что служба гостевого агента виртуальной машины Azure запущена, выполнив команду `ps-e` . Кроме того, убедитесь, что установлена [Последняя версия](../virtual-machines/extensions/update-linux-agent.md) . Дополнительные сведения см. в статье [проблемы гостевого агента виртуальной машины Linux](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms).
    - Убедитесь, что [зависимости агента виртуальной машины Linux на системных пакетах](../virtual-machines/extensions/agent-linux.md#requirements) имеют поддерживаемую конфигурацию. Например: поддерживаемая версия Python — 2,6 и более поздние версии.
    - Просмотрите матрицу поддержки, чтобы проверить, работает ли виртуальная машина в [поддерживаемой операционной системе Linux.](backup-support-matrix-iaas.md#operating-system-support-linux)

### <a name="step-3-check-azure-vm-extension-health"></a>Шаг 3. Проверка работоспособности расширения виртуальной машины Azure

- **Убедитесь, что все расширения виртуальной машины Azure находятся в состоянии "выполнена подготовка"**. Если какое-либо расширение находится в состоянии сбоя, оно может помешать резервному копированию.
- *Откройте портал Azure > VM > Settings > extensions > Extensions Status* и убедитесь, что все расширения находятся в состоянии **успешной подготовки** .
- Убедитесь, что все [проблемы с расширением](../virtual-machines/extensions/overview.md#troubleshoot-extensions) разрешены, и повторите операцию резервного копирования.
- **Убедитесь, что системное приложение COM+** работает. Кроме того, **служба Координатор распределенных транзакций** должна работать как **учетная запись сетевой службы**. Выполните действия, описанные в этой статье, чтобы устранить неполадки [com+ и MSDTC](backup-azure-vms-troubleshoot.md#extensionsnapshotfailedcom--extensioninstallationfailedcom--extensioninstallationfailedmdtc---extension-installationoperation-failed-due-to-a-com-error).

### <a name="step-4-check-azure-backup-vm-extension-health"></a>Шаг 4. Проверка работоспособности Azure Backup расширения виртуальной машины

Azure Backup использует расширение моментальных снимков виртуальной машины для выполнения резервного копирования виртуальной машины Azure в соответствии с приложениями. Azure Backup установит расширение как часть первой запланированной архивации, активируемой после включения резервного копирования.

- **Убедитесь, что расширение VMSnapshot не находится в состоянии сбоя**. выполните действия, описанные в этом [разделе](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#usererrorvmprovisioningstatefailed---the-vm-is-in-failed-provisioning-state) , чтобы проверить и убедиться, что Azure Backupное расширение работоспособно.

- **Убедитесь, что антивирусная программа блокирует расширение**: некоторые антивирусные программы могут препятствовать выполнению расширений.
  
  На момент сбоя резервного копирования проверьте, есть ли записи журнала в ***Просмотр событий Журналы приложений** _ с _ *_ошибками в имени приложения: IaaSBcdrExtension.exe_* *. Если вы видите записи, это может быть то, что антивирусная программа, настроенная на виртуальной машине, будет ограничивать выполнение расширения резервного копирования. Выполните тест, исключив следующие каталоги в конфигурации антивирусной программы и повторите операцию резервного копирования.
  - `C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot`
  - `C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot`

- **Проверьте, требуется ли доступ к сети**: пакеты расширений загружаются из репозитория расширений службы хранилища Azure, а передачи состояния расширения публикуются в службе хранилища Azure. [Подробнее](../virtual-machines/extensions/features-windows.md#network-access).
  - Если вы используете неподдерживаемую версию агента, необходимо разрешить исходящий доступ к службе хранилища Azure в этом регионе с виртуальной машины.
  - Если вы заблокировали доступ к `168.63.129.16` с помощью гостевого брандмауэра или прокси-сервера, расширения будут завершаться сбоем независимо от указанного выше. Требуются порты 80, 443 и 32526, [Дополнительные сведения](../virtual-machines/extensions/features-windows.md#network-access).

- **Убедитесь, что на гостевой виртуальной машине включен DHCP**. это необходимо для получения адреса узла или структуры из DHCP, чтобы резервная копия виртуальных машин IaaS работала. Если вам нужен статический частный IP-адрес, следует настроить его с помощью портал Azure или PowerShell и убедиться, что параметр DHCP в виртуальной машине включен, дополнительные [сведения](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken).

- **Убедитесь, что служба модуля записи VSS запущена и работает**. чтобы [устранить неполадки модуля записи VSS](backup-azure-vms-troubleshoot.md#extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state), выполните следующие действия.
- Следуйте рекомендациям по **резервному копированию**. Ознакомьтесь с рекомендациями [по включению резервного копирования виртуальных машин Azure](backup-azure-vms-introduction.md#best-practices).
- **Ознакомьтесь с рекомендациями для зашифрованных дисков**. Если вы включаете резервное копирование для виртуальных машин с зашифрованным диском, убедитесь, что вы указали все необходимые разрешения. Дополнительные сведения см. в статье [резервное копирование и восстановление зашифрованной виртуальной машины Azure](backup-azure-vms-encryption.md).

## <a name="usererrorguestagentstatusunavailable---vm-agent-unable-to-communicate-with-azure-backup"></a><a name="UserErrorGuestAgentStatusUnavailable-vm-agent-unable-to-communicate-with-azure-backup"></a>UserErrorGuestAgentStatusUnavailable — агенту виртуальной машины не удается установить связь со службой Azure Backup

**Код ошибки**: усерерроргуестажентстатусунаваилабле <br>
**Сообщение об ошибке**: агенту виртуальной машины не удалось связаться с Azure Backup<br>

Возможно, агент виртуальной машины Azure остановлен, устарел, находится в нестабильном состоянии или не установлен. Эти состояния не позволяют службе Azure Backup запускать моментальные снимки.

- **Откройте портал Azure > виртуальные машины > параметры > панели свойства** > убедитесь, что **состояние** виртуальной машины **работает** и **состояние агента** — **Готово**. Если агент виртуальной машины остановлен или находится в нестабильном состоянии, перезапустите агент.<br>
  - Для виртуальных машин Windows выполните следующие [действия](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms) , чтобы перезапустить Гостевой агент.<br>
  - Для виртуальных машин Linux выполните следующие [действия](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms) , чтобы перезапустить Гостевой агент.
- **Откройте портал Azure > виртуальная машина > параметры > расширения** > убедитесь, что все расширения находятся в состоянии " **успех подготовки** ". В противном случае выполните следующие [действия](#usererrorvmprovisioningstatefailed---the-vm-is-in-failed-provisioning-state) , чтобы устранить проблему.

## <a name="guestagentsnapshottaskstatuserror---could-not-communicate-with-the-vm-agent-for-snapshot-status"></a>GuestAgentSnapshotTaskStatusError — не удалось запросить состояние моментального снимка в агенте виртуальной машины

**Код ошибки**: гуестажентснапшоттаскстатусеррор<br>
**Сообщение об ошибке**: "Не удалось запросить состояние моментального снимка в агенте виртуальной машины". <br>

После регистрации и планирования виртуальной машины для службы Azure Backup служба Backup запускает задание, связываясь с расширением резервного копирования виртуальной машины, чтобы создать моментальный снимок на момент времени. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  

**Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**.  

**Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**.

**Причина 3. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**.

**Причина 4. [Параметры конфигурации агента виртуальной машины не заданы (для виртуальных машин Linux)](#vm-agent-configuration-options-are-not-set-for-linux-vms)**

**Причина 5. [решение "Управление приложениями" блокирует IaaSBcdrExtension.exe](#application-control-solution-is-blocking-iaasbcdrextensionexe)**

## <a name="usererrorvmprovisioningstatefailed---the-vm-is-in-failed-provisioning-state"></a>UserErrorVmProvisioningStateFailed — виртуальная машина находится в состоянии сбоя подготовки

**Код ошибки**: усереррорвмпровисионингстатефаилед<br>
**Сообщение об ошибке**: виртуальная машина находится в состоянии "сбой подготовки"<br>

Эта ошибка возникает, когда один из ошибок расширения переводит виртуальную машину в состояние сбоя подготовки.<br>**Откройте портал Azure > VM > Settings > extensions > Extensions Status** и убедитесь, что все расширения находятся в состоянии **успешной подготовки** . Дополнительные сведения см. в разделе [Подготовка состояний](../virtual-machines/states-billing.md).

- Если какое-либо расширение находится в состоянии сбоя, оно может повлиять на резервное копирование. Убедитесь, что эти проблемы с расширением разрешены, и повторите операцию резервного копирования.
- Если состояние подготовки виртуальной машины находится в состоянии обновления, оно может повлиять на резервное копирование. Убедитесь, что оно работоспособно, и повторите операцию резервного копирования.

## <a name="usererrorrpcollectionlimitreached---the-restore-point-collection-max-limit-has-reached"></a>UserErrorRpCollectionLimitReached — достигнуто максимальное количество точек восстановления в коллекции

**Код ошибки**: UserErrorRpCollectionLimitReached. <br>
**Сообщение об ошибке**: "Достигнуто максимальное количество точек восстановления в коллекции". <br>

- Эта проблема может возникать, если блокировка группы ресурсов точки восстановления препятствует автоматической очистке точек восстановления.
- Эта ошибка также может произойти при активации нескольких операций резервного копирования в день. В настоящее время мы советуем использовать только одну резервную копию в день, так как точки мгновенного восстановления сохраняются в течение 1-5 дней в течение заданного срока хранения моментального снимка, и только 18 мгновенных RP могут быть связаны с виртуальной машиной в любой момент времени. <br>
- Число точек восстановления в коллекциях точек восстановления и группах ресурсов для виртуальной машины не может превышать 18. Чтобы создать новую точку восстановления, удалите существующие точки восстановления.

Рекомендуемое действие:<br>
Чтобы устранить эту проблему, удалите блокировку группы ресурсов виртуальной машины и повторите операцию активации очистки.
> [!NOTE]
> Служба Backup создает группу ресурсов, отличную от группы ресурсов виртуальной машины, для сохранения коллекции точек восстановления. Рекомендуется не блокировать группу ресурсов, созданную для использования службой архивации. Формат имени группы ресурсов, созданной службой резервного копирования: AzureBackupRG_ `<Geo>` _ `<number>` . Например: *AzureBackupRG_northeurope_1*

**Шаг 1. [Удаление блокировки с группы ресурсов точки восстановления](#remove_lock_from_the_recovery_point_resource_group)** <br>
**Шаг 2. [Очистка коллекции точек восстановления](#clean_up_restore_point_collection)**<br>

## <a name="usererrorkeyvaultpermissionsnotconfigured---backup-doesnt-have-sufficient-permissions-to-the-key-vault-for-backup-of-encrypted-vms"></a>UserErrorKeyvaultPermissionsNotConfigured — служба Backup не имеет достаточных разрешений на доступ к хранилищу ключей для резервного копирования зашифрованных виртуальных машин.

**Код ошибки**: UserErrorKeyvaultPermissionsNotConfigured. <br>
**Сообщение об ошибке**: "Служба архивации не имеет достаточных разрешений на доступ к хранилищу ключей для резервного копирования зашифрованных виртуальных машин". <br>

Для выполнения операции резервного копирования на зашифрованных виртуальных машинах необходимо иметь разрешения на доступ к хранилищу ключей. Разрешения можно задать с помощью [портал Azure](./backup-azure-vms-encryption.md) или [PowerShell](./backup-azure-vms-automation.md#enable-protection).

## <a name="extensionsnapshotfailednonetwork---snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a><a name="ExtensionSnapshotFailedNoNetwork-snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a>ExtensionSnapshotFailedNoNetwork — сбой операции моментального снимка из-за отсутствия сетевого подключения на виртуальной машине.

**Код ошибки**: екстенсионснапшотфаиледнонетворк<br>
**Сообщение об ошибке**: "Сбой операции моментального снимка, отсутствует сетевое подключение у виртуальной машины".<br>

После регистрации и планирования виртуальной машины для службы Azure Backup служба Backup запускает задание, связываясь с расширением резервного копирования виртуальной машины, чтобы создать моментальный снимок на момент времени. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие действия по устранению неполадок и повторите операцию:

**[Не удается получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  

## <a name="extensionoperationfailedformanageddisks---vmsnapshot-extension-operation-failed"></a><a name="ExtensionOperationFailed-vmsnapshot-extension-operation-failed"></a>ExtensionOperationFailedForManagedDisks — операция расширения VMSnapshot завершилась сбоем

**Код ошибки**: екстенсионоператионфаиледформанажеддискс <br>
**Сообщение об ошибке**: "Сбой в ходе работы расширения VMSnapshot".<br>

После регистрации и планирования виртуальной машины для службы Azure Backup служба Backup запускает задание, связываясь с расширением резервного копирования виртуальной машины, чтобы создать моментальный снимок на момент времени. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  
**Причина 1. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**.  
**Причина 2. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**.  
**Причина 3. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**.

## <a name="backupoperationfailed--backupoperationfailedv2---backup-fails-with-an-internal-error"></a>BackUpOperationFailed или BackUpOperationFailedV2 — сбой резервного копирования с внутренней ошибкой

**Код ошибки**: BackUpOperationFailed или BackUpOperationFailedV2. <br>
**Сообщение об ошибке**: "Произошла внутренняя ошибка службы Backup. Повторите операцию через несколько минут". <br>

После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  
**Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**.  
**Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**.  
**Причина 3. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**.  
**Причина 4. [служба архивации не имеет разрешения на удаление старых точек восстановления из-за блокировки группы ресурсов](#remove_lock_from_the_recovery_point_resource_group)**<br>

## <a name="usererrorunsupporteddisksize---the-configured-disk-sizes-is-currently-not-supported-by-azure-backup"></a>Усереррорунсуппортеддисксизе: настроенные размеры дисков в настоящее время не поддерживаются Azure Backup

**Код ошибки**. UserErrorUnsupportedDiskSize <br>
**Сообщение об ошибке**: настроенные размеры дисков в настоящее время не поддерживаются Azure Backup. <br>

Операция резервного копирования может завершиться ошибкой при резервном копировании виртуальной машины с размером диска более 32 ТБ. Кроме того, в настоящее время резервное копирование зашифрованных дисков размером более 4 ТБ не поддерживается. Убедитесь, что размер дисков меньше или равен поддерживаемому ограничению, путем разбиения дисков.

## <a name="usererrorbackupoperationinprogress---unable-to-initiate-backup-as-another-backup-operation-is-currently-in-progress"></a>UserErrorBackupOperationInProgress. Не удалось запустить резервное копирование, так как в настоящий момент выполняется другая операция резервного копирования.

**Код ошибки**: усереррорбаккупоператионинпрогресс <br>
**Сообщение об ошибке**: не удалось инициировать резервное копирование, так как в настоящее время выполняется другая операция резервного копирования<br>

Не удалось выполнить Последнее задание резервного копирования, так как выполняется уже существующее задание резервного копирования. Новое задание резервного копирования невозможно начать, пока не завершится текущее. Убедитесь в завершении текущей операции резервного копирования, прежде чем активировать или планировать другие операции резервного копирования. Чтобы проверить состояние заданий резервного копирования, выполните следующие действия.

1. Войдите в портал Azure, выберите **все службы**. Введите службы восстановления и выберите **хранилища служб восстановления**. После этого отобразится список хранилищ служб восстановления,
2. В списке хранилищ служб восстановления выберите хранилище, в котором настроена резервная копия.
3. В меню Панель мониторинга хранилища выберите **задания резервного копирования** , в котором отображаются все задания резервного копирования.
   - Если задание резервного копирования выполняется, дождитесь его завершения или отмените его.
     - Чтобы отменить задание резервного копирования, щелкните правой кнопкой мыши задание резервного копирования и выберите команду **Отмена** или используйте [PowerShell](/powershell/module/az.recoveryservices/stop-azrecoveryservicesbackupjob).
   - Если вы настроили резервную копию в другом хранилище, убедитесь, что в старом хранилище нет выполняющихся заданий резервного копирования. Если он существует, отмените задание резервного копирования.
     - Чтобы отменить задание резервного копирования, щелкните правой кнопкой мыши задание резервного копирования и выберите команду **Отмена** или используйте [PowerShell](/powershell/module/az.recoveryservices/stop-azrecoveryservicesbackupjob) .
4. Повторите операцию резервного копирования.

Если запланированная операция архивации занимает больше времени, конфликтует с следующей конфигурацией резервного копирования, ознакомьтесь [с рекомендациями,](backup-azure-vms-introduction.md#best-practices) [производительностью резервного копирования](backup-azure-vms-introduction.md#backup-performance)и [соображениями восстановления](backup-azure-vms-introduction.md#backup-and-restore-considerations).

## <a name="usererrorcrpreportedusererror---backup-failed-due-to-an-error-for-details-see-job-error-message-details"></a>UserErrorCrpReportedUserError — сбой службы Backup из-за ошибки. Дополнительные сведения см. в данных сообщения об ошибке задания

**Код ошибки**: усерерроркрпрепортедусереррор <br>
**Сообщение об ошибке**: сбой резервного копирования из-за ошибки. Дополнительные сведения см. в разделе сведения о сообщении об ошибке задания.

Эта ошибка появляется на виртуальной машине IaaS. Чтобы узнать причину проблемы, перейдите к параметрам хранилища служб восстановления. В разделе **мониторинг** выберите **задания резервного копирования** , чтобы отфильтровать и просмотреть состояние. Выберите пункт **ошибки** , чтобы проверить сведения о базовом сообщении об ошибке. Выполните дальнейшие действия в соответствии с рекомендациями на странице сведения об ошибке.

## <a name="usererrorbcmdatasourcenotpresent---backup-failed-this-virtual-machine-is-not-actively-protected-by-azure-backup"></a>Усереррорбкмдатасаурценотпресент — сбой резервного копирования: эта виртуальная машина не защищена (активно) с помощью Azure Backup

**Код ошибки**: усереррорбкмдатасаурценотпресент <br>
**Сообщение об ошибке**: сбой резервного копирования: эта виртуальная машина не защищена с помощью Azure Backup.

Убедитесь, что данная виртуальная машина активно (не находится в состоянии приостановки), защищенной Azure Backup. Чтобы преодолеть эту ошибку, убедитесь, что виртуальная машина активна, и повторите операцию.

## <a name="causes-and-solutions"></a>Причины и решения

### <a name="the-agent-is-installed-in-the-vm-but-its-unresponsive-for-windows-vms"></a><a name="the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a>Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)

#### <a name="solution-for-this-error"></a>Решение для этой ошибки

Возможно, агент виртуальной машины может быть поврежден или служба остановлена. Повторная установка агента виртуальной машины поможет получить последнюю версию и возобновить обмен данными со службой.

1. Определите, запущена ли служба гостевого агента Microsoft Azure в службах виртуальной машины (services.msc). Попробуйте перезапустить службу гостевого агента Microsoft Azure и запустите резервное копирование.
2. Если она не отображается в списке служб, на панели управления выберите **Программы и компоненты**, чтобы определить, установлена ли служба гостевого агента Microsoft Azure.
3. Если гостевой агент Microsoft Azure отображается в разделе **Программы и компоненты**, удалите его.
4. Скачайте и установите [последнюю версию файла MSI агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
5. Убедитесь, что службы гостевого агента Microsoft Azure отображаются в списке служб.
6. Выполните резервное копирование по запросу:
   - На портале выберите **Моментальная архивация**.

Кроме того, убедитесь, что [Microsoft .NET 4.5 установлен](/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed) на виртуальной машине. Компонент .NET 4.5 необходим для взаимодействия агента виртуальной машины со службой.

### <a name="the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a>Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)

#### <a name="solution"></a>Решение

Большая часть неполадок, связанных с агентом или расширением на виртуальных машинах Linux, вызваны проблемами с устаревшим агентом виртуальной машины. Чтобы устранить эту проблему, следуйте приведенным ниже общим рекомендациям.

1. Выполните указания по [обновлению агента виртуальной машины Linux ](../virtual-machines/extensions/update-linux-agent.md).

   > [!NOTE]
   > Мы *настоятельно рекомендуем* обновлять агент только посредством репозитория дистрибутивов. Не рекомендуется скачивать код агента непосредственно из GitHub и обновлять его. Если последняя версия агента для вашего дистрибутива недоступна, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по установке последней версии агента. Чтобы проверить наличие последней версии агента, перейдите на страницу [агента Linux для Microsoft Azure](https://github.com/Azure/WALinuxAgent/releases) в репозитории GitHub.

2. Убедитесь, что на виртуальной машине запущен агент Azure, выполнив команду `ps -e`.

   Если нужный процесс не запущен, выполните следующие команды для его перезапуска:

   - Для Ubuntu: `service walinuxagent start`.
   - Для других дистрибутивов: `service waagent start`.

3. [Настройте автоматический перезапуск агента](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).
4. Снова запустите резервное копирование для проверки. Если ошибка не исчезла, извлеките следующие журналы из виртуальной машины:

   - /var/lib/waagent/*.xml
   - /var/log/waagent.log
   - /var/log/azure/*

Если требуется подробное ведение журнала для waagent, выполните следующие действия.

1. В файле /etc/waagent.conf найдите такую строку: **Enable verbose logging (y|n)**.
2. Для параметра **Logs.Verbose** измените значение с *n* на *y*.
3. Сохраните изменения и перезапустите waagent, выполнив шаги, описанные выше в этом разделе.

### <a name="vm-agent-configuration-options-are-not-set-for-linux-vms"></a>Параметры конфигурации VM-Agent не заданы (для виртуальных машин Linux)

Файл конфигурации (/ etc/waagent.conf) определяет действия waagent. Для параметров файла конфигурации **Extensions. Enable** должно быть задано значение **y** и **подготовка.** для работы резервного копирования агент должен иметь значение **Авто** .
Полный список параметров файла конфигурации VM-Agent см. в разделе. <https://github.com/Azure/WALinuxAgent#configuration-file-options>

### <a name="application-control-solution-is-blocking-iaasbcdrextensionexe"></a>Решение "Управление приложениями" блокирует IaaSBcdrExtension.exe

Если вы используете [AppLocker](/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) (или другое решение для управления приложениями), а правила — на основе издателя или пути, они могут блокировать запуск исполняемого **IaaSBcdrExtension.exe** .

#### <a name="solution-to-this-issue"></a>Решение этой проблемы

Исключите `/var/lib` путь или **IaaSBcdrExtension.exe** исполняемый файл из AppLocker (или другого программного обеспечения для управления приложениями).

### <a name="the-snapshot-status-cant-be-retrieved-or-a-snapshot-cant-be-taken"></a><a name="the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a>Не удалось получить состояние моментального снимка или создать моментальный снимок

Архивация виртуальных машин зависит от команды создания моментального снимка в базовой учетной записи хранения. Сбой службы Backup может произойти, если она не имеет доступа к учетной записи хранения или выполнение задачи создания моментального снимка задерживается.

#### <a name="solution-for-this-issue"></a>Решение для этой проблемы

Сбой задачи создания снимка может быть вызван следующими условиями.

| Причина | Решение |
| --- | --- |
| Состояние виртуальной машины отображается неправильно из-за того, что ее работа была завершена в протоколе удаленного рабочего стола (RDP). | Когда вы завершаете работу виртуальной машины в RDP, проверьте, правильно ли отображается состояние виртуальной машины на портале. Если это не так, завершите работу виртуальной машины на портале с помощью команды **Завершение работы** на панели мониторинга виртуальной машины. |
| Виртуальная машина не может получить адрес узла или структуры по протоколу DHCP. | Чтобы архивация виртуальной машины IaaS работала, в гостевой учетной записи нужно включить протокол DHCP. Если виртуальная машина не может получить адрес узла или структуры в виде ответа DHCP 245, то она не сможет скачать или запустить какие-либо расширения. Если вам нужен статический частный IP-адрес, настройте его с помощью **портал Azure** или **PowerShell** и убедитесь, что в ВИРТУАЛЬНОЙ машине включен параметр DHCP. Дополнительные сведения о настройке статического IP-адреса с помощью PowerShell см. [здесь](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface) .

### <a name="remove-lock-from-the-recovery-point-resource-group"></a><a name="remove_lock_from_the_recovery_point_resource_group"></a>Удаление блокировки с группы ресурсов точки восстановления

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Перейдите к **параметру все ресурсы**, выберите группу ресурсов коллекция точек восстановления в следующем формате AzureBackupRG_ `<Geo>` _ `<number>` .
3. В разделе **Параметры** выберите **Блокировки**, чтобы отобразить блокировки.
4. Чтобы снять блокировку, нажмите кнопку с многоточием и выберите **Удалить**.

    ![Удаление блокировки](./media/backup-azure-arm-vms-prepare/delete-lock.png)

### <a name="clean-up-restore-point-collection"></a><a name="clean_up_restore_point_collection"></a> Очистка коллекции точек восстановления

После удаления блокировки точки восстановления нужно очистить.

Если удалить группу ресурсов виртуальной машины или саму виртуальную машину, моментальные снимки управляемых дисков будут оставаться активными и истечет срок их действия в соответствии с набором хранения. Чтобы удалить моментальные снимки мгновенного восстановления (если они больше не нужны), которые хранятся в коллекции точек восстановления, очистите коллекцию точек восстановления в соответствии с указанными ниже шагами.

Чтобы очистить точки восстановления, воспользуйтесь любым из этих методов:<br>

- [Очистка коллекции точек восстановления путем запуска резервного копирования по запросу](#clean-up-restore-point-collection-by-running-on-demand-backup)<br>
- [Очистка коллекции точек восстановления на портале Azure](#clean-up-restore-point-collection-from-azure-portal)<br>

#### <a name="clean-up-restore-point-collection-by-running-on-demand-backup"></a><a name="clean-up-restore-point-collection-by-running-on-demand-backup"></a>Очистка коллекции точек восстановления путем запуска резервного копирования по запросу

После удаления блокировки активируйте резервную копию по запросу. Это действие обеспечит автоматическую очистку точек восстановления. Эта операция по требованию должна завершаться сбоем в первый раз. Однако это обеспечит автоматическую очистку вместо удаления точек восстановления вручную. После очистки Следующая запланированная архивация должна завершиться.

> [!NOTE]
> Автоматическая очистка произойдет через несколько часов после запуска резервного копирования по запросу. Если запланированное резервное копирование по-прежнему дает сбой, попробуйте вручную удалить коллекцию точек восстановления, выполнив действия, перечисленные [здесь](#clean-up-restore-point-collection-from-azure-portal).

#### <a name="clean-up-restore-point-collection-from-azure-portal-br"></a><a name="clean-up-restore-point-collection-from-azure-portal"></a>Очистка коллекции точек восстановления на портале Azure <br>

Чтобы вручную очистить коллекцию точек восстановления, которая не очищается из-за блокировки группы ресурсов, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com/).
2. В меню **концентратора** выберите **все ресурсы**, выберите группу ресурсов в следующем формате AzureBackupRG_ `<Geo>` _, `<number>` где находится виртуальная машина.

    ![Выбор группы ресурсов](./media/backup-azure-arm-vms-prepare/resource-group.png)

3. Выберите Группа ресурсов. Откроется панель **Обзор** .
4. Выберите параметр **Показать скрытые типы**, чтобы отобразить все скрытые ресурсы. Выберите коллекции точек восстановления в следующем формате: AzureBackupRG_`<VMName>`_`<number>`.

    ![Выбор коллекции точек восстановления](./media/backup-azure-arm-vms-prepare/restore-point-collection.png)

5. Выберите **Удалить** , чтобы очистить коллекцию точек восстановления.
6. Повторите операцию резервного копирования.

> [!NOTE]
 >Если ресурс (коллекция RP) имеет большое количество точек восстановления, то их удаление с портала может завершиться сбоем и выполнить сбой. Это известная проблема CRP, в которой все точки восстановления не удаляются в указанном времени и время ожидания операции истекло. Однако операция удаления обычно выполняется после двух или трех попыток.
