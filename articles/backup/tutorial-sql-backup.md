---
title: Руководство. Резервное копирование баз данных SQL Server в Azure
description: В этом руководстве вы узнаете, как создавать резервные копии Базы данных SQL Server, запущенной на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup.
ms.topic: tutorial
ms.date: 06/18/2019
ms.openlocfilehash: 17a8472da2595c08cb198baaf853faf110a619fa
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "88612458"
---
# <a name="back-up-a-sql-server-database-in-an-azure-vm"></a>Резервное копирование Базы данных SQL Server на виртуальную машину Azure

В этом руководстве описано, как создавать резервные копии Базы данных SQL Server, запущенной на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
>
> * создание и настройка хранилища;
> * обнаружение баз данных и настройка резервного копирования;
> * настройка автоматической защиты для баз данных.
> * выполнение резервного копирования по требованию.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем создавать резервную копию базы данных SQL Server, проверьте следующие условия.

1. Определите или [создайте](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) хранилище Служб восстановления в том же регионе или месте, что и размещение виртуальной машины SQL Server.
2. [Проверьте разрешения виртуальной машины](backup-azure-sql-database.md#set-vm-permissions), необходимые для резервного копирования баз данных SQL.
3. Убедитесь, что виртуальная машина имеет [сетевое подключение](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
4. Убедитесь, что базы данных SQL Server именуются в соответствии с [рекомендациями по именованию](#verify-database-naming-guidelines-for-azure-backup) для Azure Backup.
5. Убедитесь, что у вас отсутствуют любые другие включенные средства резервного копирования базы данных. Отключите все другие резервные копии SQL Server перед настройкой этого сценария. Вы можете включить резервное копирование Azure для виртуальной машины Azure с помощью Azure Backup для базы данных SQL Server на виртуальной машине без конфликтов.

### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальной машине SQL Server требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам. Установите соединение, используя один из следующих вариантов:

* **Разрешение диапазонов IP-адресов центра обработки данных Azure**. Разрешите [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) при скачивании. Чтобы получить доступ к группе безопасности сети, используйте командлет **Set-AzureNetworkSecurityRule**.
* **Развертывание прокси-сервера HTTP для маршрутизации трафика.** Когда создается резервная копия базы данных SQL Server на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure Active Directory (Azure AD) для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Каждый вариант имеет преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются. <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure.
Использование прокси-сервера HTTP   | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере. <br/><br/> Единая точка доступа к виртуальным машинам через Интернет. <br/><br/> Не подвергается влиянию изменений IP-адресов Azure. | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера.

### <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

Azure Backup выполняет ряд операций при настройке резервного копирования для базы данных SQL Server:

* Добавляет расширение **AzureBackupWindowsWorkload**.
* Чтобы обнаруживать базы данных на виртуальной машине, Azure Backup создает учетную запись **NT SERVICE\AzureWLBackupPluginSvc**. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL.
* Azure Backup будет использовать учетную запись **NT AUTHORITY\SYSTEM** для обнаружения и запроса баз данных, поэтому эта учетная запись должна соответствовать общедоступному имени входа в SQL.

Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [выполните эти инструкции](backup-azure-sql-database.md#set-vm-permissions).

### <a name="verify-database-naming-guidelines-for-azure-backup"></a>Проверка правил именования базы данных Azure Backup

Избегайте следующих имен базы данных:

* начальный и конечный пробелы;
* конечный знак "!".
* закрывающая квадратная скобка "]".
* имена баз данных, начинающиеся с "F:\".

Мы поддерживаем присвоение псевдонимов для неподдерживаемых знаков в таблицах Azure, но мы также рекомендуем избегать их. [Подробнее](/rest/api/storageservices/understanding-the-table-service-data-model).

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Найдите базы данных на виртуальной машине.

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure** (по умолчанию).

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Время поиска зависит от числа незащищенных виртуальных машин в подписке.

   * После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   * Если виртуальные машины перечислены не так, как вы ожидали, проверьте наличие их резервной копии в хранилище.
   * Несколько виртуальных машин могут иметь одно имя, но они будут принадлежать к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Отслеживайте обнаружение баз данных в области **Уведомления**. В зависимости от количества баз данных на виртуальной машине выполнение задания может занять некоторое время. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения в фоновом режиме происходит следующее:

    * Azure Backup регистрирует виртуальную машину с помощью хранилища для резервного копирования рабочей нагрузки. Все базы данных зарегистрированной виртуальной машины могут быть сохранены только в этом хранилище.
    * Azure Backup устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. В базе данных SQL агент не устанавливается.
    * Azure Backup создает учетную запись службы **NT Service\AzureWLBackupPluginSvc**.
      * Все операции резервного копирования и восстановления используют учетную запись службы.
      * Учетной записи **NT Service\AzureWLBackupPluginSvc** необходимы разрешения sysadmin SQL. Все виртуальные машины SQL Server, созданные в Azure Marketplace, поставляются с установленным **SqlIaaSExtension**. Расширение **AzureBackupWindowsWorkload** использует **SQLIaaSExtension** для автоматического получения необходимых разрешений.
    * Если виртуальная машина не создана в marketplace, в ней не установлено **SqlIaaSExtension** и операция обнаружения завершается со сбоем и сообщением об ошибке **UserErrorSQLNoSysAdminMembership**. Следуйте [инструкциям](backup-azure-sql-database.md#set-vm-permissions), чтобы устранить эту проблему.

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

Настройте резервное копирование следующим образом:

1. В меню **Цель резервного копирования** выберите **Настройка архивации**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. Выберите **Настройка архивации**, появится область **Выбор элементов для архивации**. Отобразится список всех зарегистрированных доступных групп и изолированных серверов SQL Server. Разверните шеврон слева от записи, чтобы просмотреть все незащищенные базы данных в этом экземпляре или группе доступности Always On.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые нужно защитить, и нажмите кнопку **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Кроме того, вы можете включить автоматическую защиту всего экземпляра или группы доступности Always On, выбрав параметр **Вкл** из соответствующего раскрывающегося списка в столбце **AUTOPROTECT** (Автозащита). Функция автоматической защиты не только включает защиту для всех существующих баз данных за один раз, но также распространяется на все новые базы данных, которые будут добавлены к этому экземпляру или группе доступности в дальнейшем.  

4. Нажмите кнопку **ОК**, чтобы открыть область **Политика архивации**.

    ![Включить автоматическую защиту для группы доступности Always On](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В меню **Выбрать политику архивации** выберите политику и нажмите кнопку **ОК**.

   * Выбрать политику по умолчанию: HourlyLogBackup.
   * выбрать существующую политику резервного копирования, созданную ранее для SQL;
   * Определите новую политику на основе целевой точки восстановления (RPO) и периода хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В меню **Резервное копирование** щелкните **Включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. В области **Уведомления** портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
* При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
* Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
* [Сведения](backup-architecture.md#sql-server-backup-types) о разных типах политик резервного копирования.

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **Политики архивации** > **Добавить**.
2. В меню **Добавить** щелкните **SQL Server в виртуальной машине Azure**, чтобы определить тип политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В меню **Full Backup policy** (Политика полного резервного копирования) для параметра **Частота архивации** выберите **Ежедневно** или **Еженедельно**.

   * Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   * Вы должны выполнить полное резервное копирование, так как параметр **Полная резервная копия** нельзя отключить.
   * Щелкните **Полная резервная копия**, чтобы просмотреть политику.
   * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.
   * Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. По умолчанию для параметра **Диапазон хранения** выбраны все значения. Очистите любые нежелательные ограничения диапазона периода удержания, которые вы не хотите использовать, и установите соответствующие интервалы.

    * Минимальный период хранения для резервной копии любого типа (полная/разностная/журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром недельного хранения.
    * Месячный и годовой диапазоны хранения действуют аналогичным образом.

   ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    * Максимально в день можно активировать одну разностную резервную копию.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить с частотой не чаще каждые 15 минут и храниться до 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL**.
    * По умолчанию сжатие отключено.
    * В серверной части Azure Backup использует собственное сжатие резервных копий SQL.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.

## <a name="run-an-on-demand-backup"></a>Выполнение резервного копирования по запросу

1. В хранилище Служб восстановления выберите элементы резервного копирования.
2. Выберите "SQL на виртуальной машине Azure".
3. Щелкните базу данных правой кнопкой мыши и выберите "Создать резервную копию".
4. Выберите тип резервного копирования ("Полное/Разностное/Журнал/Копировать только полные") и сжатие ("Включено/Отключено").
5. Выберите "ОК", чтобы начать резервное копирование.
6. Отслеживайте задание резервного копирования. Для этого перейдите в хранилище Служб восстановления и выберите "Задания резервного копирования".

## <a name="next-steps"></a>Дальнейшие действия

Работая с этим руководством, мы использовали портал Azure для таких целей:

> [!div class="checklist"]
>
> * создание и настройка хранилища;
> * обнаружение баз данных и настройка резервного копирования;
> * настройка автоматической защиты для баз данных.
> * выполнение резервного копирования по требованию.

Перейдите к следующему руководству для восстановления виртуальной машины Azure с диска.

> [!div class="nextstepaction"]
> [Restore SQL Server databases on Azure VMs](./restore-sql-database-azure-vm.md) (Восстановление баз данных SQL Server на виртуальных машинах Azure)
