---
title: Устранение ошибок при резервном копировании виртуальных машин Azure
description: В этой статье описывается, как устранять ошибки, возникающие при резервном копировании и восстановлении виртуальных машин Azure.
ms.reviewer: srinathv
ms.topic: troubleshooting
ms.date: 08/30/2019
ms.openlocfilehash: 2cda13ea089ac08dff7c1ba5ca93ba56ab3c23cf
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97831556"
---
# <a name="troubleshooting-backup-failures-on-azure-virtual-machines"></a>Устранение ошибок резервного копирования на виртуальных машинах Azure

Для устранения неполадок, возникающих при использовании Azure Backup, можно использовать следующую информацию.

## <a name="backup"></a>Резервное копирование

В этом разделе рассматривается сбой операции резервного копирования виртуальной машины Azure.

### <a name="basic-troubleshooting"></a>Базовое устранение неполадок

* Убедитесь, что используется агент виртуальной машины (агент WA) [последней версии](./backup-azure-arm-vms-prepare.md#install-the-vm-agent).
* Убедитесь, что версия ОС виртуальной машины на базе Windows или Linux поддерживается — см. [матрицу поддержки резервного копирования виртуальных машин IaaS](./backup-support-matrix-iaas.md).
* Убедитесь, что другая служба архивации не запущена.
  * Чтобы не возникли проблемы с расширениями моментальных снимков, [удалите расширения, чтобы принудительно выполнить перезагрузку, и попробуйте выполнить резервное копирование еще раз](./backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md).
* Убедитесь, что виртуальная машина подключена к Интернету.
  * Убедитесь, что другая служба архивации не запущена.
* В `Services.msc` убедитесь, что **служба гостевого агента Windows** **запущена**. Если **служба гостевого агента Windows Azure** отсутствует, установите ее, как указано в статье [Резервное копирование виртуальных машин Azure в хранилище служб восстановления](./backup-azure-arm-vms-prepare.md#install-the-vm-agent).
* **Журнал событий** может показывать ошибки резервного копирования, которые относятся к другим продуктам резервного копирования, например системе архивации данных Windows Server, а также не Azure Backup. Чтобы определить, связан ли сбой с Azure Backup, выполните следующие действия.
  * Если в источнике события или в сообщении возникла ошибка, убедитесь, **что резервное** копирование виртуальной машины Azure IaaS выполнено успешно, и создана ли точка восстановления с требуемым типом моментального снимка.
  * Если Azure Backup работает, то ошибка, скорее всего, связана с другим решением резервного копирования.
  * Ниже приведен пример ошибки Просмотр событий 517, где Azure Backup работал нормально, но ошибка "cистема архивации данных Windows Server": ![ Cистема архивации данных Windows Server сбой](media/backup-azure-vms-troubleshoot/windows-server-backup-failing.png)
  * Если сбой произошел в Azure Backup, найдите соответствующий код ошибки в разделе "Общие ошибки резервного копирования виртуальных машин" в этой статье.

## <a name="common-issues"></a>Распространенные проблемы

Ниже представлены распространенные проблемы, связанные с ошибками резервного копирования на виртуальных машинах Azure.

### <a name="vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension"></a>Вмресторепоинтинтерналеррор-антивирусная программа, настроенная на виртуальной машине, не разрешает выполнение расширения резервного копирования

Код ошибки: Вмресторепоинтинтерналеррор

Если во время резервного копирования в **журналах приложения Просмотр событий** отображается сообщение **Ошибка имя приложения: IaaSBcdrExtension.exe** затем подтверждается, что антивирусная программа, настроенная на виртуальной машине, не разрешает выполнение расширения резервного копирования.
Чтобы устранить эту проблему, исключите указанные ниже каталоги в конфигурации антивирусной программы и повторите операцию резервного копирования.

* `C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot`
* `C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot`

### <a name="copyingvhdsfrombackupvaulttakinglongtime---copying-backed-up-data-from-vault-timed-out"></a>CopyingVHDsFromBackUpVaultTakingLongTime — истекло время ожидания копирования зарезервированных данных из хранилища

Код ошибки: CopyingVHDsFromBackUpVaultTakingLongTime <br/>
Сообщение об ошибке: Истекло время ожидания копирования зарезервированных данных из хранилища.

Это могло произойти из-за ошибок с временным хранилищем или недостаточного количества операций ввода-вывода для передачи данных службой резервного копирования в хранилище в течение периода ожидания. Настройте резервное копирование виртуальных машин, используя следующие [рекомендации](backup-azure-vms-introduction.md#best-practices), и повторите операцию резервного копирования.

### <a name="usererrorvmnotindesirablestate---vm-is-not-in-a-state-that-allows-backups"></a>UserErrorVmNotInDesirableState — виртуальная машина не находится в состоянии, которое позволяет выполнить ее архивацию

Код ошибки: UserErrorVmNotInDesirableState <br/>
Сообщение об ошибке: Виртуальная машина не находится в состоянии, которое позволяет выполнить ее архивацию.<br/>

При операции резервного копирования произошел сбой, поскольку виртуальная машина находится в состоянии сбоя. Для успешной операции резервного копирования виртуальная машина должна быть в состоянии "Выполняется", "Остановлено" или "Остановлено (освобождено)".

* Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования.
* Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.

### <a name="usererrorfsfreezefailed---failed-to-freeze-one-or-more-mount-points-of-the-vm-to-take-a-file-system-consistent-snapshot"></a>UserErrorFsFreezeFailed — не удалось закрепить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой

Код ошибки: UserErrorFsFreezeFailed <br/>
Сообщение об ошибке: Не удалось заморозить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой.

* Отключите устройства, для которых состояние файловой системы не было очищено, с помощью команды **umount** .
* Проверьте целостность файловой системы на этих устройствах с помощью команды **fsck**.
* Снова подключите эти устройства и повторите операцию резервного копирования.</ol>

Если не удается отменить подключение устройств, можно обновить конфигурацию резервного копирования виртуальной машины, чтобы пропустить определенные точки подключения. Например, если невозможно отключить точку подключения "/mnt/Resource" и вызвать сбои резервного копирования виртуальной машины, можно обновить файлы конфигурации резервной копии виртуальной машины со ```MountsToSkip``` свойством следующим образом.

```bash
cat /var/lib/waagent/Microsoft.Azure.RecoveryServices.VMSnapshotLinux-1.0.9170.0/main/tempPlugin/vmbackup.conf[SnapshotThread]
fsfreeze: True
MountsToSkip = /mnt/resource
SafeFreezeWaitInSeconds=600
```


### <a name="extensionsnapshotfailedcom--extensioninstallationfailedcom--extensioninstallationfailedmdtc---extension-installationoperation-failed-due-to-a-com-error"></a>ExtensionSnapshotFailedCOM / ExtensionInstallationFailedCOM / ExtensionInstallationFailedMDTC — установка или работа расширения завершились сбоем из-за ошибки COM+

Код ошибки: ExtensionSnapshotFailedCOM <br/>
Сообщение об ошибке: Сбой операции создания моментального снимка из-за ошибки COM+

Код ошибки: ExtensionInstallationFailedCOM  <br/>
Сообщение об ошибке: Установка или работа расширения завершились сбоем из-за ошибки COM+

Код ошибки: ExtensionInstallationFailedMDTC <br/>
Сообщение об ошибке: Во время установки расширения произошла ошибка «Отсутствует связь COM+ с координатором распределенных транзакций». <br/>

Сбой операции резервного копирования произошел из-за проблемы со службой Windows **Системное приложение COM+** .  Проблему можно устранить следующим способом.

* Попробуйте запустить/перезапустить службу Windows **Системное приложение COM+** (в командной строке с повышенными привилегиями выполните команду **- net start COMSysApp**).
* Убедитесь, что служба **Координатор распределенных транзакций** работает как учетная запись **сетевой службы**. Если это не так, измените его так, чтобы он выполнялся как учетная запись **сетевой службы**, и перезапустите **Системное приложение COM+** .
* Если не удается перезапустить службу, переустановите **координатор распределенных транзакций** службу, выполнив следующие действия:
  * Остановите работу службы MSDTC.
  * Откройте окно командной строки (cmd).
  * Выполните команду `msdtc -uninstall`.
  * Выполните команду `msdtc -install`.
  * Запустите службу MSDTC.
* Запустите службу Windows **Системное приложение COM+** . После запуска службы **Системное приложение COM+** активируйте задание резервного копирования на портале Azure.</ol>

### <a name="extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state"></a>ExtensionFailedVssWriterInBadState — сбой операции создания моментального снимка из-за неисправного состояния модулей записи VSS.

Код ошибки: ExtensionFailedVssWriterInBadState <br/>
Сообщение об ошибке: Сбой операции создания моментального снимка из-за неисправного состояния модулей записи VSS.

Эта ошибка возникает из-за того, что модули записи VSS находятся в неправильном состоянии. Расширения Azure Backup взаимодействуют с модулями записи VSS, чтобы создавать моментальные снимки дисков. Для устранения этой проблемы выполните следующие действия:

Шаг 1. Перезапустите модули записи VSS, которые находятся в неисправном состоянии.

* В командной строке с повышенными привилегиями выполните команду ```vssadmin list writers```.
* В выходных данных содержатся все модули записи VSS и их состояние. Перезапустите каждую службу модуля записи VSS, состояние которой отличается от **[1] Стабильный**.
* Чтобы перезапустить службу, выполните следующие команды из командной строки с повышенными привилегиями: 

 ```net stop serviceName``` <br>
 ```net start serviceName```

> [!NOTE]
> Перезапуск некоторых служб может повлиять на рабочую среду. Убедитесь, что процесс утверждения выполнен, а служба перезапускается в запланированное время простоя.

Шаг 2. Если перезапуск модулей записи VSS не решил проблему, выполните следующую команду из командной строки с повышенными привилегиями (от имени администратора), чтобы предотвратить создание потоков для моментальных снимков BLOB-объектов.

```console
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v SnapshotWithoutThreads /t REG_SZ /d True /f
```

Шаг 3. Если шаги 1 и 2 не помогли устранить проблему, то причиной сбоя может быть время ожидания модулей записи VSS из-за ограниченного числа операций ввода/вывода.<br>

Для проверки перейдите в раздел ***журналы приложений системы и Просмотр событий*** и проверьте следующее сообщение об ошибке:<br>
*Истекло время ожидания поставщика теневого копирования при удержании записи на копируемый том. Возможно, это произошло из-за чрезмерной активности тома приложением или системной службой. Повторите попытку позже, когда действие на томе уменьшится.*<br>

Решение.

* Проверьте возможности распределения нагрузки между дисками виртуальных машин. Это снизит нагрузку на отдельные диски. Чтобы [проверить регулирование количества операций ввода-вывода, включите метрики диагностики на уровне хранилища](../virtual-machines/troubleshooting/performance-diagnostics.md#install-and-run-performance-diagnostics-on-your-vm).
* Измените политику резервного копирования для выполнения резервного копирования в часы пиковой нагрузки, если нагрузка на виртуальную машину находится на самом низком уровне.
* Обновите диски Azure для поддержки более высоких операций ввода-вывода. [Дополнительные сведения см. здесь](../virtual-machines/disks-types.md)

### <a name="extensionfailedvssserviceinbadstate---snapshot-operation-failed-due-to-vss-volume-shadow-copy-service-in-bad-state"></a>ExtensionFailedVssServiceInBadState — сбой операции создания моментального снимка из-за неправильного состояния VSS (службы теневого копирования томов)

Код ошибки: Екстенсионфаиледвсссервицеинбадстате <br/>
Сообщение об ошибке: операция моментального снимка завершилась сбоем из-за неправильного состояния службы VSS (теневая копия тома).

Эта ошибка возникает из-за неправильного состояния службы VSS. Расширения Azure Backup взаимодействуют со службой VSS для создания моментальных снимков дисков. Для устранения этой проблемы выполните следующие действия:

Перезапустите службу теневого копирования томов (VSS).

* Перейдите к services.msc и перезапустите "службу теневого копирования томов".<br>
или<br>
* Выполните следующие команды в командной строке с повышенными привилегиями.

 ```net stop VSS``` <br>
 ```net start VSS```

Если проблему не удалось решить, перезапустите виртуальную машину в запланированное время простоя.

### <a name="usererrorskunotavailable---vm-creation-failed-as-vm-size-selected-is-not-available"></a>Усереррорскунотаваилабле — не удалось создать виртуальную машину, так как выбранный размер виртуальной машины недоступен

Код ошибки: Усереррорскунотаваилабле сообщение об ошибке: не удалось создать виртуальную машину, так как выбранный размер виртуальной машины недоступен.

Эта ошибка возникает из-за того, что размер виртуальной машины, выбранный во время операции восстановления, имеет неподдерживаемый размер. <br>

Чтобы устранить эту проблему, используйте параметр [восстановить диски](./backup-azure-arm-restore-vms.md#restore-disks) во время операции восстановления. Используйте эти диски для создания виртуальной машины из списка [доступных размеров виртуальных машин](./backup-support-matrix-iaas.md#vm-compute-support) с помощью [командлетов PowerShell](./backup-azure-vms-automation.md#create-a-vm-from-restored-disks).

### <a name="usererrormarketplacevmnotsupported---vm-creation-failed-due-to-market-place-purchase-request-being-not-present"></a>Усереррормаркетплацевмнотсуппортед-не удалось создать виртуальную машину, так как отсутствует запрос на покупку на рынке

Код ошибки: Усереррормаркетплацевмнотсуппортед сообщение об ошибке: сбой создания виртуальной машины, так как отсутствует запрос на покупку на рынке.

Azure Backup поддерживает резервное копирование и восстановление виртуальных машин, доступных в Azure Marketplace. Эта ошибка возникает при попытке восстановить виртуальную машину (с указанным параметром плана или издателя), которая больше не доступна в Azure Marketplace. [Дополнительные сведения](/legal/marketplace/participation-policy#offering-suspension-and-removal)см. здесь.

* Чтобы устранить эту проблему, используйте параметр [восстановить диски](./backup-azure-arm-restore-vms.md#restore-disks) во время операции восстановления, а затем используйте [PowerShell](./backup-azure-vms-automation.md#create-a-vm-from-restored-disks) или командлеты [Azure CLI](./tutorial-restore-disk.md) , чтобы создать виртуальную машину с последними сведениями Marketplace, соответствующими виртуальной машине.
* Если у издателя нет сведений из Marketplace, вы можете использовать диски данных для получения данных и присоединить их к существующей виртуальной машине.

### <a name="extensionconfigparsingfailure--failure-in-parsing-the-config-for-the-backup-extension"></a>ExtensionConfigParsingFailure — сбой анализа конфигурации для расширения резервного копирования

Код ошибки: ExtensionConfigParsingFailure<br/>
Сообщение об ошибке: Сбой анализа конфигурации для расширения резервного копирования.

Эта ошибка возникает из-за изменения разрешений в каталоге **MachineKeys**: **%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**.
Выполните следующую команду и убедитесь, что разрешения для каталога **MachineKeys** по умолчанию: `icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys` .

Разрешения по умолчанию:

* все: (R,W)
* BUILTIN\Administrators: (F)

Если для каталога **MachineKeys** назначены другие разрешения, выполните следующие действия, чтобы изменить разрешения, удалить сертификат и активировать архивацию.

1. Исправьте разрешения для каталога **MachineKeys**. С помощью свойств безопасности обозревателя и дополнительных параметров безопасности в каталоге сбросьте разрешения к значениям по умолчанию. Удалите дополнительные пользовательские объекты, отличные от объектов по умолчанию, из каталога и убедитесь, что у **всех** есть доступ к таким операциям:

   * – вывод списка папок, чтение данных;
   * – чтение атрибутов;
   * – чтение дополнительных атрибутов;
   * – создание файлов, запись данных;
   * – создание папок, добавление данных;
   * – запись атрибутов;
   * – запись дополнительных атрибутов;
   * – разрешения на чтение.
2. Удалите все сертификаты с полем **Получатель сертификата**, имеющим значение классической модели развертывания или **Windows Azure CRP Certificate Generator**.

   * [Практическое руководство. Просмотр сертификатов с помощью оснастки консоли MMC](/dotnet/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in).
   * В разделе **Личное** > **Сертификаты** удалите все сертификаты с полем **Получатель сертификата**, имеющим значение **Windows Azure CRP Certificate Generator**.
3. Активируйте задание архивации виртуальной машины.

### <a name="extensionstuckindeletionstate---extension-state-is-not-supportive-to-backup-operation"></a>ExtensionStuckInDeletionState — в текущем состоянии расширение не поддерживает резервное копирование

Код ошибки: ExtensionStuckInDeletionState <br/>
Сообщение об ошибке: В текущем состоянии расширение не поддерживает резервное копирование

Операция резервного копирования завершилась сбоем из-за несогласованного состояния расширения резервного копирования. Проблему можно устранить следующим способом.

* Убедитесь, что гостевой агент установлен и отвечает на запросы.
* На портале Azure последовательно выберите **Виртуальная машина** > **Все параметры** > **Расширения**.
* Выберите расширение резервного копирования VmSnapshot или VmSnapshotLinux и нажмите кнопку **Удалить**.
* После удаления расширения попробуйте снова выполнить резервное копирование
* При выполнении последующей операции резервного копирования будет установлено новое расширение в требуемом состоянии.

### <a name="extensionfailedsnapshotlimitreachederror---snapshot-operation-failed-as-snapshot-limit-is-exceeded-for-some-of-the-disks-attached"></a>ExtensionFailedSnapshotLimitReachedError — выполнить операцию с моментальными снимками не удалось, так как превышено их ограничение для некоторых из подключенных дисков

Код ошибки: ExtensionFailedSnapshotLimitReachedError  <br/>
Сообщение об ошибке: Операция создания моментального снимка завершилась сбоем, так как превышено ограничение на количество моментальных снимков для некоторых подключенных дисков

Операция создания моментального снимка завершилась сбоем, так как превышено ограничение на количество моментальных снимков для некоторых подключенных дисков. Выполните следующие действия по устранению неполадок и повторите операцию.

* Удалите ненужные моментальные снимки BLOB-объекта диска. Будьте внимательны, чтобы не удалять большие двоичные объекты диска. Удаляются только большие двоичные объекты моментальных снимков.
* Если обратимое удаление включено на дисковых накопителях виртуальной машины, настройте обратимое удаление, чтобы существующие моментальные снимки были меньше максимально допустимого в любой момент времени.
* Если на виртуальной машине, для которой была создана резервная копия, включена служба восстановления сайтов Azure, выполните следующие действия.

  * Убедитесь, что для параметра **isanysnapshotfailed** в файле /etc/azure/vmbackup.conf задано значение false
  * Запланируйте Azure Site Recovery в другое время, чтобы не конфликтовать с операцией резервного копирования.

### <a name="extensionfailedtimeoutvmnetworkunresponsive---snapshot-operation-failed-due-to-inadequate-vm-resources"></a>ExtensionFailedTimeoutVMNetworkUnresponsive — сбой при создании моментального снимка из-за отсутствия у виртуальной машины необходимых ресурсов

Код ошибки: ExtensionFailedTimeoutVMNetworkUnresponsive<br/>
Сообщение об ошибке: Сбой при создании моментального снимка из-за отсутствия у виртуальной машины необходимых ресурсов.

Не удалось создать резервную копию виртуальной машины из-за задержки сетевых вызовов при создании моментального снимка. Чтобы устранить эту проблему, выполните шаг 1. Если проблема повторится, попробуйте выполнить шаги 2 и 3.

**Шаг 1**. Создание моментального снимка через узел

В командной строке с повышенными привилегиями (администратор) выполните следующую команду:

```console
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v SnapshotMethod /t REG_SZ /d firstHostThenGuest /f
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v CalculateSnapshotTimeFromHost /t REG_SZ /d True /f
```

Это позволит обеспечить создание моментальных снимков через ОС узла, а не гостевую ОС. Повторите резервное копирование.

**Шаг 2**. Попробуйте изменить расписание архивации на время, когда виртуальная машина меньше нагрузки (например, меньше ЦП или операций ввода-вывода в секунду).

**Шаг 3**. Попробуйте [увеличить размер виртуальной машины](../virtual-machines/windows/resize-vm.md) и повторите операцию

### <a name="320001-resourcenotfound---could-not-perform-the-operation-as-vm-no-longer-exists--400094-bcmv2vmnotfound---the-virtual-machine-doesnt-exist--an-azure-virtual-machine-wasnt-found"></a>320001, ResourceNotFound — не удалось выполнить операцию, так как виртуальная машина больше не существует или 400094, BCMV2VMNotFound — виртуальная машина не существует или виртуальная машина Azure не найдена.

Код ошибки 320001, ResourceNotFound <br/> Сообщение об ошибке Не удалось выполнить операцию, так как виртуальная машина больше не существует. <br/> <br/> Код ошибки 400094, BCMV2VMNotFound <br/> Сообщение об ошибке Виртуальная машина не существует <br/>
Виртуальная машина Azure не найдена.

Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, выполните следующие действия.

* Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**,<br>или диспетчер конфигурации служб
* Отключите защиту виртуальной машины, удаляя или не удаляя данные резервного копирования. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](backup-azure-manage-vms.md#stop-protecting-a-vm).</li></ol>

### <a name="usererrorbcmpremiumstoragequotaerror---could-not-copy-the-snapshot-of-the-virtual-machine-due-to-insufficient-free-space-in-the-storage-account"></a>Усереррорбкмпремиумсторажекуотаеррор — не удалось скопировать моментальный снимок виртуальной машины из-за нехватки свободного места в учетной записи хранения

Код ошибки UserErrorBCMPremiumStorageQuotaError<br/> Сообщение об ошибке Копирование снимка виртуальной машины завершилось сбоем из-за нехватки свободного места в учетной записи хранения

 Для резервного копирования виртуальных машин уровня "Премиум" в стеке резервных копий виртуальных машин версии 1 мы копируем моментальный снимок в учетную запись хранения. Это гарантирует, что трафик управления резервным копированием, который возникает при работе с моментальным снимком, не ограничивает число операций ввода-вывода, доступных для приложения, использующего диски уровня "Премиум". <br><br>Корпорация Майкрософт рекомендует выделять только 50 %, 17,5 ТБ, от общего объема хранилища учетной записи хранения. Затем служба Azure Backup может скопировать моментальный снимок в учетную запись хранения и перенести данные из этого скопированного расположения в учетной записи хранения в хранилище.

### <a name="380008-azurevmoffline---failed-to-install-microsoft-recovery-services-extension-as-virtual-machine--is-not-running"></a>380008, Азуревмоффлине-не удалось установить расширение служб восстановления Microsoft, так как виртуальная машина не запущена

Код ошибки 380008, AzureVmOffline <br/> Сообщение об ошибке Не удалось установить расширение служб восстановления Майкрософт, так как виртуальная машина не запущена

Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. <br> <ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флажок в конфигурации виртуальной машины установлен на правильное значение.</ol> Ознакомьтесь со сведениями об установке агента виртуальной машины и проверке правильности ее выполнения.

### <a name="extensionsnapshotbitlockererror---the-snapshot-operation-failed-with-the-volume-shadow-copy-service-vss-operation-error"></a>Екстенсионснапшотбитлоккереррор — операция создания моментального снимка завершилась сбоем с ошибкой операции служба теневого копирования томов (VSS).

Код ошибки ExtensionSnapshotBitlockerError <br/> Сообщение об ошибке: сбой операции моментального снимка с ошибкой служба теневого копирования томов (VSS) **. Этот диск заблокирован шифрование диска BitLocker. Необходимо разблокировать этот диск с помощью панели управления.**

Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS.

### <a name="vmnotindesirablestate---the-vm-isnt-in-a-state-that-allows-backups"></a>Вмнотиндесираблестате — виртуальная машина не находится в состоянии, допускающем резервное копирование.

Код ошибки VmNotInDesirableState <br/> Сообщение об ошибке  Виртуальная машина не находится в состоянии, которое позволяет выполнить резервное копирование.

* Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования.
* Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.

* На виртуальной машине отсутствует агент виртуальной машины. <br>Установите необходимые компоненты и агент виртуальной машины. Затем перезапустите операцию. | Узнайте больше об [установке агента ВМ и проверке установки агента виртуальной машины](#vm-agent).

### <a name="extensionsnapshotfailednosecurenetwork---the-snapshot-operation-failed-because-of-failure-to-create-a-secure-network-communication-channel"></a>Екстенсионснапшотфаиледносекуренетворк — операция создания моментального снимка завершилась сбоем из-за сбоя создания защищенного канала связи по сети.

Код ошибки ExtensionSnapshotFailedNoSecureNetwork <br/> Сообщение об ошибке Сбой операции создания моментального снимка из-за ошибки при создании защищенного канала связи.

* Откройте редактор реестра, запустив файл **regedit.exe** в режиме с повышенными правами.
* Определите все версии платформы .NET Framework, установленные в системе. Они находятся в иерархии раздела реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft**.
* Для каждой платформы .NET Framework в этом разделе реестра добавьте следующий раздел: <br> **SchUseStrongCrypto"=dword:00000001**. </ol>

### <a name="extensionvcredistinstallationfailure---the-snapshot-operation-failed-because-of-failure-to-install-visual-c-redistributable-for-visual-studio-2012"></a>Екстенсионвкредистинсталлатионфаилуре — сбой операции создания моментального снимка из-за сбоя установки Распространяемый компонент Visual C++ для Visual Studio 2012

Код ошибки ExtensionVCRedistInstallationFailure <br/> Сообщение об ошибке Сбой операции создания моментального снимка из-за ошибки при установке распространяемого компонента Visual C++ для Visual Studio 2012.

* Перейдите к `C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion` и установите vcredist2013_x64.<br/>Убедитесь, что установлено правильное значение раздела реестра, разрешающее установку этой службы. Для этого установите для параметра **Start** в **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver** значение **3**, а не **4**. <br><br>Если проблемы с установкой не исчезли, перезапустите службу установки, последовательно выполнив команды **MSIEXEC /UNREGISTER** и **MSIEXEC /REGISTER** в командной строке с повышенными привилегиями.
* Проверьте журнал событий, чтобы убедиться, что вы видите проблемы, связанные с доступом. Пример: *Продукт: Microsoft Visual C++ 2013 x64 Минимальная среда выполнения — 12.0.21005 — Ошибка 1401. Не удалось создать раздел: Software\Classes.  Системная ошибка 5.  Убедитесь в наличии необходимых прав доступа к разделу или обратитесь в службу поддержки.* <br><br> Убедитесь, что администратор или учетная запись пользователя имеют достаточные разрешения для обновления раздела реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Classes**. Предоставьте достаточные разрешения и перезапустите гостевой агент Windows Azure.<br><br> <li> При наличии антивирусных продуктов убедитесь, что правила исключения настроены верно и разрешают установку.

### <a name="usererrorrequestdisallowedbypolicy---an-invalid-policy-is-configured-on-the-vm-which-is-preventing-snapshot-operation"></a>UserErrorRequestDisallowedByPolicy — на виртуальной машине настроена недопустимая политика, которая препятствует созданию моментального снимка

Код ошибки  UserErrorRequestDisallowedByPolicy <BR> Сообщение об ошибке На виртуальной машине настроена недопустимая политика, которая препятствует созданию моментального снимка.

Если у вас есть политика Azure, [управляющая тегами в среде ](../governance/policy/tutorials/govern-tags.md), можно изменить политику [Запретить дефект](../governance/policy/concepts/effects.md#deny) на [Изменить эффект](../governance/policy/concepts/effects.md#modify) или вручную создать группу ресурсов согласно [схеме именования, необходимой Azure Backup](./backup-during-vm-creation.md#azure-backup-resource-group-for-virtual-machines).

## <a name="jobs"></a>Задания

| Сведения об ошибке | Обходной путь |
| --- | --- |
| Отмена не поддерживается в этом типе задания. <br>Дождитесь завершения задания. |None |
| Задание не находится в состоянии отмены. <br>Дождитесь завершения задания. <br>**или диспетчер конфигурации служб**<br> Выбранное задание не находится в состоянии отмены. <br>Дождитесь остановки задания. |Скорее всего, задание почти выполнено. Дождитесь завершения задания.|
| Резервное копирование не может отменить задание, так как оно не выполняется. <br>Отмена поддерживается только для выполняющихся заданий. Попытайтесь отменить выполняющееся задание. |Эта ошибка возникает из-за переходного состояния. Подождите минуту и повторите отмену. |
| При резервном копировании не удалось отменить задание. <br>Дождитесь завершения задания. |None |

## <a name="restore"></a>Восстановить

### <a name="disks-appear-offline-after-file-restore"></a>Диски отображаются в автономном режиме после восстановления файлов

Если после восстановления вы заметили, что диски находятся в автономном режиме, выполните следующие действия.

* Проверьте, соответствует ли компьютер, на котором выполняется сценарий, требованиям операционной системы. [Подробнее](./backup-azure-restore-files-from-vm.md#step-3-os-requirements-to-successfully-run-the-script).  
* Убедитесь, что вы не восстанавливаете тот же источник, дополнительные [сведения](./backup-azure-restore-files-from-vm.md#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).

### <a name="usererrorinstantrpnotfound---restore-failed-because-the-snapshot-of-the-vm-was-not-found"></a>Усерерроринстантрпнотфаунд — сбой восстановления, так как не найден моментальный снимок виртуальной машины

Код ошибки: Усерерроринстантрпнотфаунд <br>
Сообщение об ошибке: не удалось выполнить восстановление, так как не найден моментальный снимок виртуальной машины. Возможно, снимок был удален, проверьте.<br>

Эта ошибка возникает при попытке восстановления из точки восстановления, которая не была передана в хранилище и была удалена на этапе создания моментального снимка. 
<br>
Чтобы устранить эту проблему, попытайтесь восстановить виртуальную машину из другой точки восстановления.<br>

#### <a name="common-errors"></a>Распространенные ошибки 
| Сведения об ошибке | Обходной путь |
| --- | --- |
| Сбой восстановления из-за внутренней ошибки облака. |<ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>**$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings**.<br>Если настроен **адрес**, это означает, что настроены и параметры DNS.<br> <li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроен параметр **ReservedIP**, а существующие в ней виртуальные машины находятся в остановленном состоянии. Вы можете проверить, что облачная служба зарезервировала IP-адрес, используя следующие командлеты PowerShell: **$deploy = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName**. <br><li>Вы пытаетесь восстановить виртуальную машину в ту же облачную службу со следующими специальными конфигурациями сети: <ul><li>– виртуальные машины во внутренней и внешней конфигурации балансировщика нагрузки;<li>– виртуальные машины с несколькими зарезервированными IP-адресами; <li>– виртуальные машины с несколькими сетевыми адаптерами. </ul><li>Выберите новую облачную службу в пользовательском интерфейсе или просмотрите [рекомендации по восстановлению](backup-azure-arm-restore-vms.md#restore-vms-with-special-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Выбранное DNS-имя уже занято. <br>Укажите другое DNS-имя и повторите попытку. |Указанное здесь DNS-имя ссылается на имя облачной службы обычно с расширением **.cloudapp.net**. Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br> Эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell выполняется успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Указана неправильная конфигурация виртуальной сети. <br>Укажите другую конфигурацию виртуальной сети и повторите попытку. |None |
| Указанная облачная служба использует зарезервированный IP-адрес, который не соответствует конфигурации восстанавливаемой виртуальной машины. <br>Укажите другую облачную службу, которая не использует зарезервированный IP-адрес. Или выберите другую точку восстановления. |None |
| Облачная служба достигла ограничения на количество входных конечных точек. <br>Повторите операцию, указав другую облачную службу или используя существующую конечную точку. |None |
| Хранилище Служб восстановления и целевая учетная запись хранения находятся в двух разных регионах. <br>Убедитесь, что указанная в операции восстановления учетная запись хранения находится в том же регионе Azure, что и хранилище Служб восстановления. |None |
| Учетная запись хранения, указанная для операции восстановления, не поддерживается. <br>Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. |None |
| Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. <br>Убедитесь, что учетная записи хранения, указанная в операции восстановления, подключена к сети. |Эта ошибка может возникать из-за временной ошибки в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Достигнут предел квоты группы ресурсов. <br>Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить границы. |None |
| Выбранная подсеть не существует. <br>Выберите подсеть для проверки. |None |
| У службы Backup нет разрешения на доступ к ресурсам в вашей подписке. |Чтобы устранить эту ошибку, сначала восстановите диски, выполнив шаги, описанные в разделе [Восстановление резервных копий дисков](backup-azure-arm-restore-vms.md#restore-disks). Затем выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#restore-an-azure-vm). |

## <a name="backup-or-restore-takes-time"></a>Резервное копирование или восстановление занимает время

Если резервное копирование у вас выполняется дольше 12 часов или на восстановление данных требуется больше 6 часов, ознакомьтесь с [лучшими методиками](backup-azure-vms-introduction.md#best-practices) и [рекомендациями по производительности](backup-azure-vms-introduction.md#backup-performance).

## <a name="vm-agent"></a>Агент виртуальной машины

### <a name="set-up-the-vm-agent"></a>Настройка агента виртуальной машины

Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Но на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом.

#### <a name="windows-vms---set-up-the-agent"></a>Виртуальные машины Windows — Настройка агента

* Скачайте и установите [MSI-файл агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
* Для виртуальных машин, созданных с использованием классической модели развертывания, [обновите свойство классических виртуальных машин](../virtual-machines/troubleshooting/install-vm-agent-offline.md#use-the-provisionguestagent-property-for-classic-vms), чтобы указать, что агент установлен. Этот шаг является необязательным для виртуальных машин Azure Resource Manager.

#### <a name="linux-vms---set-up-the-agent"></a>Виртуальные машины Linux. Настройка агента

* Установите последнюю версию агента из репозитория дистрибутива. Сведения об имени пакета см. в [репозитории агента Linux](https://github.com/Azure/WALinuxAgent).
* Для виртуальных машин, созданных с использованием классической модели развертывания, [обновите свойство виртуальных машин](../virtual-machines/troubleshooting/install-vm-agent-offline.md#use-the-provisionguestagent-property-for-classic-vms) и убедитесь, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

### <a name="update-the-vm-agent"></a>Обновление агента виртуальной машины

#### <a name="windows-vms---update-the-agent"></a>Виртуальные машины Windows. обновление агента

* Чтобы обновить агент виртуальной машины, переустановите [его двоичные файлы](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Прежде чем обновлять агент, убедитесь, что не выполняются никакие операции резервного копирования.

#### <a name="linux-vms---update-the-agent"></a>Виртуальные машины Linux. обновление агента

* Чтобы обновить агент виртуальной машины Linux, следуйте инструкциям в статье [Как обновить агент Azure Linux на виртуальной машине](../virtual-machines/extensions/update-linux-agent.md?toc=/azure/virtual-machines/linux/toc.json).

    > [!NOTE]
    > Рекомендуется обновлять агент только через репозиторий дистрибутива.

    Не рекомендуется скачивать код агента с портала GitHub. Если последняя версия агента не доступна для дистрибутива, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по получению последней версии агента. Последние сведения об [агенте Windows Azure Linux](https://github.com/Azure/WALinuxAgent/releases) см. в репозитории GitHub.

### <a name="validate-vm-agent-installation"></a>Проверка установки агента виртуальной машины

Для проверки версии агента виртуальной машины на виртуальных машинах Windows выполните следующие действия.

1. Войдите в систему виртуальной машины Azure и перейдите в папку **C:\WindowsAzure\Packages**. В ней должен находиться файл **WaAppAgent.exe**.
2. Щелкните правой кнопкой мыши файл и выберите **Свойства**. Затем выберите вкладку **Сведения**. В поле **Версия продукта** должно отображаться значение 2.6.1198.718 или выше.

## <a name="troubleshoot-vm-snapshot-issues"></a>Решение проблем со снимками виртуальных машин

Архивация виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению задания резервного копирования. Сбой задачи создания снимка может быть вызван следующими условиями.

* **Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков**. По умолчанию при архивации виртуальной машины создается полная резервная копия VSS на виртуальных машинах Windows. На виртуальных машинах, где выполняется SQL Server и настроена архивация SQL Server, это может привести к задержке создания моментального снимка. Если эти задержки приводят к ошибкам резервного копирования, установите следующий ключ реестра.

   ```console
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```

* **Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола**. При использовании удаленного рабочего стола для завершении работы виртуальной машины проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды **Завершение работы** на панели мониторинга виртуальной машины.
* **Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик резервного копирования**. Задайте время резервного копирования таким образом, чтобы оно выполнялось не более, чем на четырех виртуальных машинах одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
* **Виртуальная машина использует большие ресурсы процессора или памяти**. Если виртуальная машина работает при большой загрузке памяти или процессора (более 90 %), задача создания моментального снимка помещается в очередь, задерживается. В конце концов, время ожидания истекает. В таких ситуациях попробуйте использовать архивацию по запросу.

## <a name="networking"></a>Сеть

Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если вам нужен статический частный IP-адрес, настройте его с помощью портала Azure или PowerShell. Убедитесь, что параметр DHCP для виртуальной машины включен.
Дополнительные сведения о том, как настроить статический IP-адрес с помощью PowerShell см. раздели:

* [Добавление статического внутреннего IP-адреса для существующей виртуальной машины](/powershell/module/az.network/set-aznetworkinterfaceipconfig#description)
* [Изменение метода распределения для частного IP-адреса, назначенного сетевому интерфейсу](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface)