---
title: Резервное копирование баз данных SQL Server в Azure
description: В этой статье объясняется, как создать резервную копию SQL Server в Azure. Здесь также описывается восстановление SQL Server.
ms.topic: conceptual
ms.date: 06/18/2019
ms.openlocfilehash: 510d9637031928e31abaa5f82a5bf58c6ef44719
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91316853"
---
# <a name="about-sql-server-backup-in-azure-vms"></a>Сведения о резервном копировании SQL Server на виртуальных машинах Azure

[Azure Backup](backup-overview.md) предлагает специализированное решение на основе потока для резервного копирования SQL Server запуска на виртуальных машинах Azure. Это решение соответствует преимуществам Azure Backup резервного копирования без инфраструктуры, долгосрочного хранения и централизованного управления. Кроме того, он предоставляет следующие преимущества специально для SQL Server:

1. Резервные копии с учетом рабочей нагрузки, поддерживающие все типы резервного копирования — полные, разностные и журналы.
2. 15-минутная RPO (Целевая точка восстановления) с частыми резервными копиями журналов
3. Восстановление до точки во времени до секунды
4. Резервное копирование и восстановление на уровне отдельных баз данных

Чтобы просмотреть сценарии резервного копирования и восстановления, которые поддерживаются сегодня, см. [таблицу поддержки](sql-support-matrix.md#scenario-support).

## <a name="backup-process"></a>Процесс резервного копирования

Это решение использует собственные API-интерфейсы SQL для создания резервных копий баз данных SQL.

* После того как вы укажете виртуальную машину SQL Server, которую нужно защитить, и выполните запрос баз данных на ней, служба Azure Backup установит на виртуальную машину расширение резервного копирования рабочих нагрузок с именем `AzureBackupWindowsWorkload`.
* Это расширение состоит из координатора и подключаемого модуля SQL. В то время как координатор отвечает за запуск рабочих процессов для различных операций, таких как настройка резервного копирования, резервное копирование и восстановление, подключаемый модуль отвечает за фактический поток данных.
* Чтобы иметь возможность обнаруживать базы данных на этой виртуальной машине, Azure Backup создает учетную запись `NT SERVICE\AzureWLBackupPluginSvc`. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL. Эта `NT SERVICE\AzureWLBackupPluginSvc` учетная запись является [учетной записью виртуальной службы](/windows/security/identity-protection/access-control/service-accounts#virtual-accounts)и поэтому не требует управления паролями. Azure Backup использует `NT AUTHORITY\SYSTEM` учетную запись для обнаружения или запроса базы данных, поэтому эта учетная запись должна быть общедоступным именем входа в SQL. Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [выполните эти инструкции](#set-vm-permissions).
* Когда вы запустите настройку защиты для выбранных баз данных, служба резервного копирования установит координатор с расписаниями резервного копирования и другими сведениями о политике, которые расширение кэширует локально на виртуальной машине.
* В назначенное время координатор связывается с подключаемым модулем и начинает потоковую передачу данных резервного копирования с сервера SQL с помощью VDI.  
* Подключаемый модуль отправляет данные непосредственно в хранилище служб восстановления, тем самым устраняя необходимость в промежуточном расположении. Данные зашифрованы и хранятся службой Azure Backup в учетных записях хранения.
* Когда передача данных завершается, координатор подтверждает фиксацию с помощью службы резервного копирования.

  ![Архитектура службы резервного копирования SQL](./media/backup-azure-sql-database/azure-backup-sql-overview.png)

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, проверьте следующие требования.

1. Убедитесь, что у вас есть экземпляр SQL Server, работающий в Azure. Вы можете [быстро создать экземпляр SQL Server](../azure-sql/virtual-machines/windows/sql-vm-create-portal-quickstart.md) в marketplace.
2. Ознакомьтесь с [вопросами](sql-support-matrix.md#feature-considerations-and-limitations) и [поддержкой сценариев](sql-support-matrix.md#scenario-support).
3. [Ознакомьтесь с часто задаваемыми вопросами об этом сценарии](faq-backup-sql-server.md).

## <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

  При запуске обнаружения в SQL Server Azure Backup выполнит следующие действия.

* Добавляет расширение AzureBackupWindowsWorkload.
* Чтобы обнаруживать базы данных на виртуальной машине, Azure Backup создает учетную запись NT SERVICE\AzureWLBackupPluginSvc. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL.
* Для предоставления баз данных, запущенных на виртуальной машине, Azure Backup использует учетную запись NT AUTHORITY\SYSTEM. Эта учетная запись должна быть общедоступной для входа в SQL.

Если вы не создали SQL Server виртуальную машину в Azure Marketplace или используете SQL 2008 или 2008 R2, может возникнуть ошибка **усереррорсклносисадминмембершип** .

Сведения о предоставлении разрешений в случае с **SQL 2008** и **2008 R2** , работающими в Windows 2008 R2, см. [здесь](#give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2).

Для всех остальных версий следует исправить разрешения с помощью следующих шагов.

  1. Войдите в SQL Server Management Studio (SSMS) с помощью учетной записи, имеющей разрешение sysadmin SQL Server. Если вам не требуются специальные разрешения, можно использовать проверку подлинности Windows.
  2. На сервере SQL Server последовательно откройте папки **Security (Безопасность) и Logins (Имена входа)**.

      ![Открытие папки "Безопасность/Имена для входа" для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

  3. Щелкните правой кнопкой мыши папку **имена входа** и выберите **создать имя входа**. В меню **Создание имени входа** выберите **Поиск**.

      ![Выбор "Найти" в диалоговом окне "Login - New" (Создание имени для входа)](./media/backup-azure-sql-database/new-login-search.png)

  4. Учетная запись виртуальной службы Windows **NT SERVICE\AzureWLBackupPluginSvc** была создана во время регистрации виртуальной машины и обнаружения баз данных SQL. Введите имя учетной записи, как показано в поле **Введите имя объекта**. Выберите **Проверить имена**, чтобы разрешить имя. Щелкните **ОК**.

      ![Выбор "Проверить имена" для разрешения имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

  5. Убедитесь, что в качестве **роли сервера** выбрана роль **sysadmin**. Щелкните **ОК**. Теперь должны существовать необходимые разрешения.

      ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

  6. Теперь свяжите базу данных с хранилищем Служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер, на котором произошла ошибка, и выберите **Повторно обнаружить базы данных**.

      ![Проверка наличия у сервера соответствующих разрешений](./media/backup-azure-sql-database/check-erroneous-server.png)

  7. Проверьте ход выполнения в области **Уведомления**. Когда выбранные базы данных будут найдены, появится сообщение об успешном завершении.

      ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

> [!NOTE]
> Если в среде SQL Server установлено несколько экземпляров SQL Server, то необходимо добавить разрешение sysadmin для учетной записи **NT Service\AzureWLBackupPluginSvc** для всех этих экземпляров.

### <a name="give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2"></a>Присвоение разрешений администратора SQL в SQL 2008 и SQL 2008 R2

Добавьте в экземпляр SQL Server имена входа **NT AUTHORITY\SYSTEM** и **NT Service\AzureWLBackupPluginSvc**.

1. Перейдите к экземпляру SQL Server в обозревателе объектов.
2. Перейдите в раздел "Безопасность -> Имена входа"
3. Щелкните правой кнопкой мыши имена входа и выберите *создать имя входа...*

    ![Создание имени входа с помощью SSMS](media/backup-azure-sql-database/sql-2k8-new-login-ssms.png)

4. Перейдите на вкладку "Общие" и в качестве имени входа введите **NT AUTHORITY\SYSTEM**.

    ![Имя для входа в SSMS](media/backup-azure-sql-database/sql-2k8-nt-authority-ssms.png)

5. Перейдите к *Роли сервера* и выберите такие роли, как *общедоступная* и *администратор*.

    ![Выбор ролей в SSMS](media/backup-azure-sql-database/sql-2k8-server-roles-ssms.png)

6. Перейдите в раздел *Состояние*. *Предоставить* разрешение на подключение к ядру СУБД и вход как *Включено*.

    ![Предоставление разрешений в SSMS](media/backup-azure-sql-database/sql-2k8-grant-permission-ssms.png)

7. Нажмите кнопку "ОК".
8. Чтобы добавить имя для входа NT Service\AzureWLBackupPluginSvc в экземпляр SQL Server, повторите ту же последовательность шагов (1 - 7 приведенных выше). Если имя для входа уже существует, убедитесь, что ему присвоена роль администратора сервера и в разделе состояния этому имени предоставлено разрешение на подключение к ядру СУБД и вход в качестве включено.
9. После предоставления разрешения повторно **Определите баз данных** на портале: **->** Рабочая нагрузка "инфраструктура резервного копирования хранилища" **->** на виртуальной машине Azure:

    ![Повторное обнаружение баз данных на портале Azure](media/backup-azure-sql-database/sql-rediscover-dbs.png)

Кроме этого, можно автоматизировать раздачу разрешений путем выполнения следующих команд PowerShell в режиме администратора. По умолчанию в качестве имени экземпляра устанавливается значение MSSQLSERVER. Если возникнет необходимость, то в скрипте можно изменить имя экземпляра если изменить его аргумент.

```powershell
param(
    [Parameter(Mandatory=$false)]
    [string] $InstanceName = "MSSQLSERVER"
)
if ($InstanceName -eq "MSSQLSERVER")
{
    $fullInstance = $env:COMPUTERNAME   # In case it is the default SQL Server Instance
}
else
{
    $fullInstance = $env:COMPUTERNAME + "\" + $InstanceName   # In case of named instance
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT Service\AzureWLBackupPluginSvc', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT AUTHORITY\SYSTEM', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
```

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о резервном копировании баз данных SQL Server см. в [этой статье](backup-sql-server-database-azure-vms.md).
* Дополнительные сведения о восстановлении резервных копий баз данных SQL Server см. в [этой статье](restore-sql-database-azure-vm.md).
* Дополнительные сведения об управлении резервными копиями баз данных SQL Server см. в [этой статье](manage-monitor-sql-database-backup.md).
