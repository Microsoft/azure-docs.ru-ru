---
title: Как переместить Azure Backup хранилища служб восстановления
description: Инструкции по перемещению хранилища служб восстановления между подписками Azure и группами ресурсов.
ms.topic: conceptual
ms.date: 04/08/2019
ms.custom: references_regions
ms.openlocfilehash: 4f75bec533181b29625fb0a10cc26d03f2875036
ms.sourcegitcommit: 3ea12ce4f6c142c5a1a2f04d6e329e3456d2bda5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2021
ms.locfileid: "103466377"
---
# <a name="move-a-recovery-services-vault-across-azure-subscriptions-and-resource-groups"></a>Перемещение хранилища служб восстановления между подписками Azure и группами ресурсов

В этой статье объясняется, как переместить хранилище Служб восстановления, настроенное для Azure Backup, между подписками Azure или в другую группу ресурсов в той же подписке. Для перемещения хранилища Служб восстановления можно использовать портал Azure или PowerShell.

## <a name="supported-regions"></a>Поддерживаемые регионы

Поддерживаются все общедоступные регионы и регионы независимых, кроме Франции Central, Южно-Восточная Франция, северо-восток, Центральная Германия, Северный Китай, Китай North2, Восточный Китай и Китай Восточная.

## <a name="prerequisites-for-moving-recovery-services-vault"></a>Предварительные требования для перемещения хранилища служб восстановления

- Во время перемещения хранилища между группами ресурсов исходная и Целевая группы ресурсов блокируются, предотвращая операции записи и удаления. Дополнительные сведения см. в этой [статье](../azure-resource-manager/management/move-resource-group-and-subscription.md).
- Только подписка администратора имеет разрешения на перемещение хранилища.
- Для перемещения хранилищ между подписками Целевая подписка должна находиться в том же клиенте, что и исходная подписка, и ее состояние должно быть включено. Сведения о перемещении хранилища в другой каталог Azure AD см. в статье о [переносе подписки в другой каталог](../role-based-access-control/transfer-subscription.md) и [часто задаваемые вопросы по хранилищу служб восстановления](backup-azure-backup-faq.md#recovery-services-vault).
- Вам необходимо получить разрешение на выполнение операций записи в целевой группе ресурсов.
- Перемещение хранилища изменяет только группу ресурсов. Хранилище служб восстановления будет находиться в том же расположении и не может быть изменено.
- За один раз можно переместить только одно хранилище служб восстановления на регион.
- Если виртуальная машина не перемещается в хранилище служб восстановления между подписками или в новую группу ресурсов, текущие точки восстановления виртуальной машины останутся в хранилище неизменными до истечения срока их действия.
- Независимо от того, была ли виртуальная машина перемещена с хранилищем или нет, вы в любом случае можете восстановить виртуальную машину из сохраненного журнала резервного копирования в хранилище.
- Для шифрования дисков Azure требуется, чтобы хранилище ключей и виртуальные машины находились в одном регионе Azure и подписке.
- Чтобы узнать, как переместить виртуальную машину с управляемыми дисками, обратитесь к [этой статье](../azure-resource-manager/management/move-resource-group-and-subscription.md).
- Параметры перемещения ресурсов, развернутых с помощью классической модели, зависят от того, куда вы перемещаете ресурсы: в рамках подписки или в новую подписку. Дополнительные сведения см. в этой [статье](../azure-resource-manager/management/move-resource-group-and-subscription.md).
- Политики службы Backup, определенные для хранилища, сохраняются после перемещения хранилища между подписками или в новую группу ресурсов.
- Можно переместить только хранилище, которое содержит любой из следующих типов резервных копий элементов. Все элементы резервного копирования типов, которых нет в списке ниже, должны быть остановлены, а данные будут окончательно удалены перед перемещением хранилища.
  - Виртуальные машины Azure
  - Агент Службы восстановления Microsoft Azure (MARS)
  - Сервер Microsoft Azure Backup (MABS)
  - Data Protection Manager (DPM)
- При перемещении хранилища, содержащего данные резервной копии виртуальной машины, между подписками необходимо переместить виртуальные машины в одну и ту же подписку и использовать то же имя целевой группы ресурсов виртуальной машины (как в старой подписке) для продолжения резервного копирования.

> [!NOTE]
> Перемещение хранилищ служб восстановления для Azure Backup в регионах Azure не поддерживается.<br><br>
> Если вы настроили виртуальные машины (Azure IaaS, Hyper-V, VMware) или физические компьютеры для аварийного восстановления с помощью **Azure Site Recovery**, операция перемещения будет заблокирована. Если вы хотите переместить хранилища для Azure Site Recovery, ознакомьтесь с [этой статьей](../site-recovery/move-vaults-across-regions.md) , чтобы узнать о перемещении хранилищ вручную.

## <a name="use-azure-portal-to-move-recovery-services-vault-to-different-resource-group"></a>Использование портал Azure для перемещения хранилища служб восстановления в другую группу ресурсов

Чтобы переместить хранилище служб восстановления и связанные с ним ресурсы в другую группу ресурсов, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Откройте список **Хранилища служб восстановления** и выберите хранилище, которое нужно переместить. Открытая панель мониторинга хранилища выглядит, как показано на следующем рисунке.

   ![Открыть хранилище служб восстановления](./media/backup-azure-move-recovery-services/open-recover-service-vault.png)

   Если вы не видите сведения о **Essentials** для своего хранилища, щелкните значок раскрывающегося списка. Раздел "Основное" будет развернут, и вы увидите основную информацию о хранилище.

   ![Вкладка с основными сведениями](./media/backup-azure-move-recovery-services/essentials-information-tab.png)

3. В меню Обзор хранилища выберите **изменить** рядом с **группой ресурсов**, чтобы открыть панель **Перемещение ресурсов** .

   ![Изменение группы ресурсов](./media/backup-azure-move-recovery-services/change-resource-group.png)

4. В области **Перемещение ресурсов** для выбранного хранилища рекомендуется переместить дополнительные связанные ресурсы, установив флажок, как показано на следующем рисунке.

   ![Перемещение подписки](./media/backup-azure-move-recovery-services/move-resource.png)

5. Чтобы добавить целевую группу ресурсов, в раскрывающемся списке **Группа ресурсов** выберите существующую группу ресурсов или выберите **создать новую группу** .

   ![Создание ресурса](./media/backup-azure-move-recovery-services/create-a-new-resource.png)

6. После добавления группы ресурсов убедитесь **, что средства и сценарии, связанные с перемещенными ресурсами, не будут работать, пока не обновите их для использования новых идентификаторов ресурсов** , а затем нажмите кнопку **ОК** , чтобы завершить перемещение хранилища.

   ![Сообщение с подтверждением](./media/backup-azure-move-recovery-services/confirmation-message.png)

## <a name="use-azure-portal-to-move-recovery-services-vault-to-a-different-subscription"></a>Использование портал Azure для перемещения хранилища служб восстановления в другую подписку

Для перемещения хранилища Служб восстановления и его связанных ресурсов в другую подписку выполните следующие инструкции.

1. Войдите на [портал Azure](https://portal.azure.com/).
2. Откройте список "Хранилища служб восстановления" и выберите хранилище, которое нужно переместить. Открытая панель мониторинга хранилища выглядит, как показано на следующем рисунке.

    ![Открыть хранилище служб восстановления](./media/backup-azure-move-recovery-services/open-recover-service-vault.png)

    Если вы не видите сведения о **Essentials** для своего хранилища, щелкните значок раскрывающегося списка. Раздел "Основное" будет развернут, и вы увидите основную информацию о хранилище.

    ![Вкладка с основными сведениями](./media/backup-azure-move-recovery-services/essentials-information-tab.png)

3. В меню Обзор хранилища выберите **изменить** рядом с параметром **Подписка**, чтобы открыть панель **Перемещение ресурсов** .

   ![Изменение подписки](./media/backup-azure-move-recovery-services/change-resource-subscription.png)

4. Выберите ресурсы для перемещения. На этом шаге рекомендуется применить параметр **Выбрать все**, чтобы выбрать все перечисленные дополнительные ресурсы.

   ![Перемещение ресурса](./media/backup-azure-move-recovery-services/move-resource-source-subscription.png)

5. Из раскрывающегося списка **Подписка** выберите целевую подписку, в которую следует переместить хранилище.
6. Чтобы добавить целевую группу ресурсов, в раскрывающемся списке **Группа ресурсов** выберите существующую группу ресурсов или выберите **создать новую группу** .

   ![Добавление подписки](./media/backup-azure-move-recovery-services/add-subscription.png)

7. Установите флажок **я понимаю, что средства и сценарии, связанные с перемещенными ресурсами, не будут работать, пока я не буду обновлять их с помощью параметра новые идентификаторы ресурсов** для подтверждения, а затем нажимаем кнопку **ОК**.

> [!NOTE]
> Резервное копирование между подписками (хранилище RS и защищенные виртуальные машины находятся в разных подписках) не является поддерживаемым сценарием. Кроме того, параметр избыточности хранилища из локального избыточного хранилища (LRS) в глобально избыточное хранилище (GRS) и наоборот нельзя изменить во время операции перемещения хранилища.
>
>

## <a name="use-powershell-to-move-recovery-services-vault"></a>Перемещение хранилища служб восстановления с помощью PowerShell

Чтобы переместить хранилище Служб восстановления в другую группу ресурсов, используйте командлет `Move-AzureRMResource`. Для `Move-AzureRMResource` требуется указать имя и тип ресурса. Эти данные можно получить, выполнив командлет `Get-AzureRmRecoveryServicesVault`.

```powershell
$destinationRG = "<destinationResourceGroupName>"
$vault = Get-AzureRmRecoveryServicesVault -Name <vaultname> -ResourceGroupName <vaultRGname>
Move-AzureRmResource -DestinationResourceGroupName $destinationRG -ResourceId $vault.ID
```

Чтобы переместить ресурсы в другую подписку, добавьте параметр `-DestinationSubscriptionId`.

```powershell
Move-AzureRmResource -DestinationSubscriptionId "<destinationSubscriptionID>" -DestinationResourceGroupName $destinationRG -ResourceId $vault.ID
```

После выполнения указанных выше командлетов вам будет предложено подтвердить, что вы хотите переместить указанные ресурсы. Чтобы подтвердить, введите **Y**. После успешной проверки начнется перемещение ресурса.

## <a name="use-cli-to-move-recovery-services-vault"></a>Перемещение хранилища служб восстановления с помощью интерфейса командной строки

Чтобы переместить хранилище Служб восстановления в другую группу ресурсов, используйте следующий командлет:

```azurecli
az resource move --destination-group <destinationResourceGroupName> --ids <VaultResourceID>
```

Для перемещения в новую подписку нужно указать параметр `--destination-subscription-id`.

## <a name="post-migration"></a>Действия после перемещения

1. Задайте или проверьте элементы управления доступом для групп ресурсов.  
2. После завершения перемещения необходимо снова настроить функцию создания отчетов и мониторинга резервного копирования для хранилища. Во время операции перемещения будет утеряна предыдущая конфигурация.

## <a name="move-an-azure-virtual-machine-to-a-different-recovery-service-vault"></a>Перемещение виртуальной машины Azure в другое хранилище служб восстановления. 

Если вы хотите переместить виртуальную машину Azure с включенной службой архивации Azure, то у вас есть два варианта. Они зависят от бизнес-требований:

- [Не нужно сохранять предыдущие резервные копии данных](#dont-need-to-preserve-previous-backed-up-data)
- [Необходимо сохранить предыдущие резервные копии данных](#must-preserve-previous-backed-up-data)

### <a name="dont-need-to-preserve-previous-backed-up-data"></a>Не нужно сохранять предыдущие резервные копии данных

Чтобы защитить рабочие нагрузки в новом хранилище, необходимо удалить текущую защиту и данные в старом хранилище, а также снова настроить резервное копирование.

>[!WARNING]
>Следующая операция является необратимой и не может быть отменена. Все резервные копии данных и элементы резервного копирования, связанные с защищенным сервером, будут удалены без возможности восстановления. Выполняйте дальнейшие действия с осторожностью.

**Останавливает и удаляет текущую защиту в старом хранилище:**

1. Отключите обратимое удаление в свойствах хранилища. Выполните следующие [действия](backup-azure-security-feature-cloud.md#disabling-soft-delete-using-azure-portal) , чтобы отключить обратимое удаление.

2. Отключите защиту и удалите резервные копии из текущего хранилища. В меню панели мониторинга хранилища выберите пункт **архивные элементы**. Перечисленные здесь элементы, которые необходимо переместить в новое хранилище, необходимо удалить вместе с данными резервного копирования. Узнайте, как [удалять защищенные элементы в облаке](backup-azure-delete-vault.md#delete-protected-items-in-the-cloud) и [удалять защищенные элементы локально](backup-azure-delete-vault.md#delete-protected-items-on-premises).

3. Если вы планируете переместить AFS (файловые ресурсы Azure), серверы SQL Server или SAP HANA серверы, вам также потребуется отменить их регистрацию. В меню панели мониторинга хранилища выберите пункт **инфраструктура резервного копирования**. См. раздел [Отмена регистрации SQL Server](manage-monitor-sql-database-backup.md#unregister-a-sql-server-instance), [Отмена регистрации учетной записи хранения, связанной с файловыми ресурсами Azure](manage-afs-backup.md#unregister-a-storage-account), и [Отмена регистрации экземпляра SAP HANA](sap-hana-db-manage.md#unregister-an-sap-hana-instance).

4. После удаления из старого хранилища продолжите настройку резервных копий для рабочей нагрузки в новом хранилище.

### <a name="must-preserve-previous-backed-up-data"></a>Необходимо сохранить предыдущие резервные копии данных

Если необходимо сохранить текущие защищенные данные в старом хранилище и продолжить защиту в новом хранилище, для некоторых рабочих нагрузок ограничены параметры:

- Для режима MARS можно [Отключить защиту с помощью функции "хранить данные](backup-azure-manage-mars.md#stop-protecting-files-and-folder-backup) " и зарегистрировать агент в новом хранилище.

  - Azure Backup служба продолжит хранить все существующие точки восстановления старого хранилища.
  - Необходимо заплатить, чтобы удержать точки восстановления в старом хранилище.
  - Вы сможете восстановить резервные копии данных только для точек восстановления с неистекшим сроком действия в старом хранилище.
  - В новом хранилище потребуется создать новую начальную реплику данных.

- Для виртуальной машины Azure можно [Отключить защиту с помощью сохранения данных](backup-azure-manage-vms.md#stop-protecting-a-vm) для виртуальной машины в старом хранилище, переместить виртуальную машину в другую группу ресурсов, а затем защитить виртуальную машину в новом хранилище. См. [руководство и ограничения](../azure-resource-manager/management/move-limitations/virtual-machines-move-limitations.md) для перемещения виртуальной машины в другую группу ресурсов.

  Виртуальная машина может быть защищена только в одном хранилище за раз. Однако виртуальную машину в новой группе ресурсов можно защитить в новом хранилище, так как она считается другой виртуальной машиной.

  - Azure Backup служба будет хранить точки восстановления, резервные копии которых были созданы в старом хранилище.
  - Необходимо заплатить, чтобы удержать точки восстановления в старом хранилище (Дополнительные сведения см. в [Azure Backup ценах](azure-backup-pricing.md) ).
  - При необходимости вы сможете восстановить виртуальную машину из старого хранилища.
  - Первой резервной копией в новом хранилище виртуальной машины в новом ресурсе будет Начальная реплика.

## <a name="next-steps"></a>Дальнейшие действия

Вы можете перемещать разные типы ресурсов между группами ресурсов и подписками.

Дополнительные сведения см. в статье [Перемещение ресурсов в новую группу ресурсов или подписку](../azure-resource-manager/management/move-resource-group-and-subscription.md).