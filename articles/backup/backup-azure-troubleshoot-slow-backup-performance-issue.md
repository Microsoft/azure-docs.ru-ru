---
title: Устранение неполадок, связанных с низкой производительностью резервного копирования файлов и папок
description: В этой статье представлены инструкции по устранению неполадок, которые помогут вам диагностировать причины проблем с производительностью службы архивации Azure.
ms.topic: troubleshooting
ms.date: 07/05/2019
ms.openlocfilehash: b3f2ac343ef4a703f347ec8a57f242a636bb32d2
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "88824021"
---
# <a name="troubleshoot-slow-backup-of-files-and-folders-in-azure-backup"></a>Устранение неполадок, связанных с низкой производительностью архивации файлов и папок в службе архивации Azure

В этой статье представлены инструкции по устранению неполадок, которые помогут вам диагностировать причины низкой производительности при архивации файлов и папок при использовании службы архивации Azure. Если архивация файлов выполняется с помощью агента службы архивации Azure, этот процесс может занять больше времени, чем ожидалось. Ниже приведены причины возникновения задержек.

* [Наличие узких мест производительности на компьютере, для которого выполняется резервное копирование.](#cause1)
* [На работу службы архивации Azure влияет другой процесс или антивирусная программа](#cause2)
* [Агент службы архивации запущен на виртуальной машине Azure](#cause3)  
* [Архивация большого количества файлов (нескольких миллионов)](#cause4)

Прежде чем приступить к устранению неполадок, рекомендуется скачать и установить [последнюю версию агента службы архивации Azure](https://aka.ms/azurebackup_agent). Мы периодически обновляем агент службы архивации, чтобы устранить различные проблемы, добавить новые возможности и улучшить производительность.

Кроме того, настоятельно рекомендуется изучить статью [Служба архивации Azure: часто задаваемые вопросы](backup-azure-backup-faq.md) , чтобы убедиться, что проблемы c производительностью не вызваны общими ошибками конфигурации.

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="cause-backup-job-running-in-unoptimized-mode"></a>Причина. Задание резервного копирования выполняется в неоптимизированном режиме

* Агент MARS может запустить задание резервного копирования в **оптимизированном режиме** с помощью журнала изменений USN (порядковый номер обновления) или **неоптимизированном режиме** путем проверки всего тома на наличие изменений в каталогах или файлах.
* В неоптимизированном режиме задание выполняется медленнее, так как агент должен проверить каждый файл в томе и сравнить его с метаданными, чтобы определить наличие изменений.
* Чтобы проверить режим, откройте **сведения о задании** из консоли агента MARS и проверьте, находится ли задание в состоянии **Идет передача данных (без оптимизации, может занять определенное время)** , как показано ниже.

    ![Выполнение в неоптимизированном режиме](./media/backup-azure-troubleshoot-slow-backup-performance-issue/unoptimized-mode.png)

* Выполнение задания резервного копирования в неоптимизированном режиме может быть вызвано следующими причинами:
  * Первое резервное копирование (также называемое начальной репликацией) всегда выполняется в неоптимизированном режиме.
  * Если предыдущее задание резервного копирования завершилось сбоем, следующее запланированное задание будет выполняться как неоптимизированное.

<a id="cause1"></a>

## <a name="cause-performance-bottlenecks-on-the-computer"></a>Причина. Наличие узких мест производительности на компьютере

Наличие узких мест производительности на компьютере, для которого выполняется архивация, может приводить к задержкам. Например, причиной узких мест на компьютере может быть возможность чтения с диска или записи на него либо пропускная способность, доступная для отправки данных по сети.

Windows предоставляет встроенное средство, [системный монитор](https://techcommunity.microsoft.com/t5/ask-the-performance-team/windows-performance-monitor-overview/ba-p/375481) (Perfmon), для обнаружения этих узких мест.

Ниже приведены некоторые счетчики производительности и диапазоны, которые могут оказаться полезными при обнаружении узких мест производительности для оптимизации архивации.

| Счетчик | Состояние |
| --- | --- |
| Логический диск (физический диск) — % времени простоя |<li> 100% времени бездействия в 50% Idle = исправен</br><li> 49% времени бездействия на 20% Idle = предупреждение или монитор</br><li> 19% бездействие в 0% Idle = критическое или неактивное спецификацией |
| Логический диск (физический диск) — среднее время выполнения операции чтения или записи на диске |<li> от 0,001 мс до 0,015 МС = работоспособное</br><li> 0,015 МС 0,025 МС = предупреждение или монитор</br><li> 0,026 МС или более длинный = критический или исходящий из спецификации |
| Логический диск (физический диск) — текущая длина очереди диска (для всех экземпляров) |80 запросов в течение более 6 минут |
| Память — байт в невыгружаемом пуле |<li> Менее 60% использования пула = исправен<br><li> от 61% до 80% использования пула = предупреждение или монитор</br><li> Более 80% использования пула = критическое или не из спецификации |
| Память — байт в выгружаемом пуле |<li> Менее 60% использования пула = исправен</br><li> от 61% до 80% использования пула = предупреждение или монитор</br><li> Более 80% использования пула = критическое или не из спецификации |
| Доступная память (МБ) |<li> 50% свободной памяти или больше = работоспособное состояние</br><li> 25% доступной свободной памяти = монитор</br><li>10% доступной свободной памяти = предупреждение</br><li> Доступно менее 100 МБ или 5% свободной памяти = критическое или не используемое спецификацией |
| Процессор — \% загруженности процессора (все экземпляры) |<li> Потреблено менее 60% = работоспособное</br><li> от 61% до 90% потреблено = отслеживание или предостережение</br><li> от 91% до 100% потреблено = критическое |

> [!NOTE]
> Если выяснилось, что причина в инфраструктуре, то рекомендуется регулярно выполнять дефрагментацию дисков, чтобы повысить производительность.
>
>

<a id="cause2"></a>

## <a name="cause-another-process-or-antivirus-software-interfering-with-azure-backup"></a>Причина. На работу службы Azure Backup влияет другой процесс или антивирусная программа.

Мы уже сталкивались с несколькими случаями, когда на производительность агента службы архивации Azure отрицательно влияли другие процессы, запущенные в системе Windows. Например, если для архивации данных используется как агент службы архивации Azure, так и другая программа, или если выполняется архивация файлов, заблокированных антивирусной программой. В таких ситуациях архивация может завершиться сбоем или занять больше времени, чем ожидалось.

Для решения этой проблемы рекомендуется отключить другие программы архивации и отследить время резервного копирования, выполняемого с помощью агента службы архивации Azure. Как правило, чтобы предотвратить эти конфликтные ситуации, достаточно не выполнять несколько заданий архивации одновременно.

Для антивирусных программ необходимо исключить следующие файлы и расположения:

* процесс C:\Program Files\Microsoft Azure Recovery Services Agent\bin\cbengine.exe;
* папки C:\Program Files\Microsoft Azure Recovery Services Agent\;
* вспомогательное расположение (если не используется стандартное расположение).

<a id="cause3"></a>

## <a name="cause-backup-agent-running-on-an-azure-virtual-machine"></a>Причина. Агент службы Azure Backup запущен на виртуальной машине Azure.

Если агент службы архивации запущен на виртуальной машине Azure, а не на физическом компьютере, это может привести к снижению производительности. Это ожидаемое поведение, так как максимальное количество операций ввода-вывода ограничено.  Чтобы оптимизировать производительность, рекомендуется переместить данные, для которых выполняется архивация, в службу хранилища Azure уровня "Премиум". Мы работаем над этой проблемой, и она будет устранена в следующей версии.

<a id="cause4"></a>

## <a name="cause-backing-up-a-large-number-millions-of-files"></a>Причина. Резервное копирование большого количества файлов (нескольких миллионов)

Перемещение большого объема данных занимает больше времени, чем перемещение меньшего объема данных. В некоторых случаях длительность архивации обуславливается не только объемом данных, но количеством файлов или папок. Это особенно актуально при архивации миллионов небольших файлов (размером от нескольких байтов до нескольких килобайтов).

Причина этого состоит в том, что при архивации и переносе данных в Azure одновременно выполняется каталогизация файлов. Иногда операция каталогизации может занять больше времени, чем ожидалось.

Ниже приведены признаки, которые помогут выявить узкие места и принять соответствующие меры.

* **В пользовательском интерфейсе отображается ход выполнения передачи данных**. Идет перенос данных. Возможны задержки из-за пропускной способности сети или объема данных.
* **Пользовательский интерфейс не отображает ход выполнения для обмена данными**. В этом случае необходимо открыть файлы журналов в папке C:\Program Files\Microsoft Azure Recovery Services Agent\Temp и проверить в них наличие записи FileProvider::EndData. Наличие этой записи означает, что передача данных завершена, и выполняется операция каталогизации. Не отменяйте задание архивации. Вместо этого подождите еще немного, пока не завершится операция каталогизации. Если проблема не исчезла, обратитесь в [службу поддержки Azure](https://portal.azure.com/#create/Microsoft.Support).

При попытке резервного копирования больших дисков рекомендуется использовать [Azure Data Box](./offline-backup-azure-data-box.md) для первой резервной копии (начальной репликации).  Если вы не можете использовать Data Box, то любые временные сетевые проблемы, происходящие в среде во время длительной передачи данных по сети, могут вызвать сбои резервного копирования.  Для защиты от этих сбоев можно включить несколько папок в начальную резервную копию и постепенно добавлять папки до тех пор, пока все они не будут успешно архивированы в Azure.  Последующие добавочные резервные копии будут создаваться относительно быстро.

## <a name="next-steps"></a>Дальнейшие действия

* [Часто задаваемые вопросы о резервном копировании файлов и папок](backup-azure-file-folder-backup-faq.md)
