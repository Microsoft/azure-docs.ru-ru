---
title: Сопоставление материалов для форматов модели
description: Описывает преобразование по умолчанию из форматов источника модели в объект PBR
author: jakrams
ms.author: jakras
ms.date: 02/11/2020
ms.topic: reference
ms.openlocfilehash: 8313243bf680ea1a1d63f2719b647149a04935a9
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96024050"
---
# <a name="material-mapping-for-model-formats"></a>Сопоставление материалов для форматов модели

При преобразовании исходного ресурса в [качестве модели](../how-tos/conversion/model-conversion.md)преобразователь создает [материалы](../concepts/materials.md) для каждой [сетки](../concepts/meshes.md). Способ создания материалов можно [переопределить](../how-tos/conversion/override-materials.md). Однако по умолчанию преобразование создаст [материалы PBR](../overview/features/pbr-materials.md). Так как каждый формат исходного файла, например FBX, использует собственные соглашения для определения материалов, эти соглашения должны быть сопоставлены с параметрами объекта PBR для удаленной подготовки к просмотру Azure. 

В этой статье перечислены точные сопоставления, используемые для преобразования материалов из исходных активов в материалы среды выполнения.

## <a name="gltf"></a>глтф

Почти все из спецификации Глтф 2,0 поддерживается в службе удаленной подготовки Azure, за исключением *емиссивефактор* и *емиссиветекстуре*.

Сопоставление показано в следующей таблице.

| глтф | Удаленная отрисовка Azure |
|:-------------------|:--------------------------|
|   басеколорфактор   |   албедоколор              |
|   басеколортекстуре  |   албедомап                |
|   металликфактор    |   металлическое состояние                |
|   металликтекстуре   |   металнессмап             |
|   раугхнессфактор   |   неровность                |
|   раугхнесстекстуре  |   раугхнессмап             |
|   окклусионфактор   |   перекрытия                |
|   окклусионтекстуре  |   окклусионмап             |
|   нормалтекстуре     |   нормалмап                |
|   алфакутофф       |   алфаклипсрешолд       |
|   Алфамоде. непрозрачный  |   Алфаклипенаблед = false, IsFalse = false |
|   Алфамоде. MASK    |   Алфаклипенаблед = true, IsFalse = false  |
|   Алфамоде. BLEND   |   Transparent = true     |
|   даублесидед       |   исдаублесидед            |
|   емиссивефактор    |   -                        |
|   емиссиветекстуре   |   -                        |

Каждая текстура в Глтф может иметь `texCoord` значение, которое также поддерживается в материалах для удаленной подготовки к просмотру в Azure.

### <a name="embedded-textures"></a>Внедренные текстуры

Поддерживаются текстуры, внедренные в файлы *\* . bin* или *\* . GLBA* .

### <a name="supported-gltf-extension"></a>Поддерживаемое расширение Глтф

Кроме того, в базовый набор функций Удаленная визуализация Azure поддерживает следующие расширения Глтф:

* [MSFT_packing_occlusionRoughnessMetallic](https://github.com/KhronosGroup/glTF/blob/master/extensions/2.0/Vendor/MSFT_packing_occlusionRoughnessMetallic/README.md)
* [KHR_materials_unlit](https://github.com/KhronosGroup/glTF/blob/master/extensions/2.0/Khronos/KHR_materials_unlit/README.md): соответствует [цветовым материалам](../overview/features/color-materials.md). Для *эмиссионныйных* материалов рекомендуется использовать это расширение.
* [KHR_materials_pbrSpecularGlossiness](https://github.com/KhronosGroup/glTF/blob/master/extensions/2.0/Khronos/KHR_materials_pbrSpecularGlossiness/README.md). вместо текстур с металлическими грубыми пленками можно предоставить текстуры диффузного отражения. Реализация удаленной отрисовки Azure непосредственно соответствует формулам преобразования из расширения.

## <a name="fbx"></a>FBX

Формат FBX — это закрытый источник, и FBX материалы несовместимы с материалами PBR в целом. FBX использует сложное описание поверхностей с множеством уникальных параметров и свойств, а **не все они используются конвейером удаленного рендеринга Azure**.

> [!IMPORTANT]
> Конвейер преобразования модели удаленной подготовки Azure поддерживает только **FBX 2011 и более поздние версии**.

Формат FBX определяет консервативный подход к материалам, но в официальной спецификации FBX есть только два типа:

* *Ламберта* — обычно не используется в течение некоторого времени, но по-прежнему поддерживается путем преобразования в по методу Фонга во время преобразования.
* *По методу Фонга* — почти все материалы и большинство средств для работы с содержимым используют этот тип.

Модель по методу Фонга более точна и используется в качестве *единственной* модели для FBXных материалов. Под ним будет называться *материал FBX*.

> Maya использует два пользовательских расширения для FBX, определяя пользовательские свойства для типов данных PBR и Стинграй материала. Эти сведения не включены в спецификацию FBX, поэтому сейчас служба удаленной подготовки Azure не поддерживает эту информацию.

FBX материалы используют концепцию рассеянного отражения и Спекуларлевел, поэтому для преобразования текстуры диффузии в карту албедо необходимо вычислить другие параметры, чтобы вычесть их из диффузии.

> Все цвета и текстуры в FBX находятся в пространстве sRGB (также известном как гамма-пространство), но удаленная визуализация Azure работает с линейным пространством во время визуализации и в конце фрейма преобразует все обратно в пространство sRGB. Конвейер ресурсов для удаленной отрисовки Azure преобразует все в линейное пространство, чтобы отправить его как подготовленные данные в модуль подготовки отчетов.

В этой таблице показано, как текстуры сопоставляются из FBX материалов с материалами для удаленной подготовки к просмотру Azure. Некоторые из них не используются напрямую, но в сочетании с другими текстурами, участвующими в формулах (например, текстурной текстуры):

| FBX | Удаленная отрисовка Azure |
|:-----|:----|
| амбиентколор | Перекрытия Map   |
| диффусеколор | *используется для Албедо, металла* |
| транспарентколор | *используется для альфа-канала Албедо* |
| транспаренцифактор | *используется для альфа-канала Албедо* |
| Непрозрачность | *используется для альфа-канала Албедо* |
| спекуларколор | *используется для Албедо, Металлности, неровности* |
| спекуларфактор| *используется для Албедо, Металлности, неровности* |
| шининессекспонент | *используется для Албедо, Металлности, неровности* |
| нормалмап | нормалмап |
| Смена | *преобразовано в Нормалмап* |
| емиссивеколор | - |
| емиссивефактор | - |
| рефлектионколор | - |
| дисплацементколор | - |

Приведенное выше сопоставление является наиболее сложной частью преобразования материалов из-за многих предположений, которые необходимо внести. Мы обсудим эти предположения ниже.

Некоторые определения используются ниже:

* `Specular` =  `SpecularColor` * `SpecularFactor`
* `SpecularIntensity` = `Specular`. Red ∗ 0,2125 +  `Specular` . Зеленый ∗ 0,7154 + `Specular` . Синий ∗ 0,0721
* `DiffuseBrightness` = 0,299 * `Diffuse` . Красный<sup>2</sup> + 0,587 * `Diffuse` . Зеленый<sup>2</sup> + 0,114 * `Diffuse` . Синий<sup>2</sup>
* `SpecularBrightness` = 0,299 * `Specular` . Красный<sup>2</sup> + 0,587 * `Specular` . Зеленый<sup>2</sup> + 0,114 * `Specular` . Синий<sup>2</sup>
* `SpecularStrength` = Max ( `Specular` . Красный, `Specular` . Зеленый, `Specular` . Выделен

Формула Спекуларинтенсити извлекается [отсюда](https://en.wikipedia.org/wiki/Luma_(video)).
Формула яркости описана в этой [спецификации](http://www.itu.int/dms_pubrec/itu-r/rec/bt/R-REC-BT.601-7-201103-I!!PDF-E.pdf).

### <a name="roughness"></a>Неровность

`Roughness` вычисляется из `Specular` и `ShininessExponent` используется [Эта формула](https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf). Формула является приближением к приблизительным показателям от экспоненты по методу Фонга.

```cpp
Roughness = sqrt(2 / (ShininessExponent * SpecularIntensity + 2))
```

### <a name="metalness"></a>Металлическое состояние

`Metalness` вычисляется из `Diffuse` и `Specular` использует эту [формулу из спецификации глтф](https://github.com/bghgary/glTF/blob/gh-pages/convert-between-workflows-bjs/js/babylon.pbrUtilities.js).

Идея состоит в том, что мы решаем уравнение: AX<sup>2</sup> + BX + C = 0.
По сути, зоны с электрическими областями отражены вокруг 4% света, а остальные — рассеянными. Металлические поверхности не имеют освещения, но все это отраженным способом.
Эта формула имеет несколько недостатков, так как не существует способа различать поверхности глянцевого пластика и глянцевого металла. Мы предполагаем, что в большинстве случаев у поверхности есть свойства «металлик», и, следовательно, глянцевые пластиковые поверхности и резинки могут выглядеть не так, как ожидалось.

```cpp
dielectricSpecularReflectance = 0.04
oneMinusSpecularStrength = 1 - SpecularStrength

A = dielectricSpecularReflectance
B = (DiffuseBrightness * (oneMinusSpecularStrength / (1 - A)) + SpecularBrightness) - 2 * A
C = A - SpecularBrightness
squareRoot = sqrt(max(0.0, B * B - 4 * A * C))
value = (-B + squareRoot) / (2 * A)
Metalness = clamp(value, 0.0, 1.0);
```

### <a name="albedo"></a>албедо

`Albedo` вычисляются из `Diffuse` , `Specular` и `Metalness` .

Как описано в разделе «металлическая нагрузка», зоны с электрическими выводятся вокруг 4% от светлого.  
Идея заключается в линейной интерполяции между `Dielectric` и `Metal` цветами с использованием `Metalness` значения в качестве фактора. Если это так `0.0` , то в зависимости от отражения он будет либо темным цветом (при высоком отражении), либо рассеянием не изменится (если отражений не существует). Если металлическая величина является большим значением, рассеянный цвет исчезает в пользу отражения цвета.

```cpp
dielectricSpecularReflectance = 0.04
oneMinusSpecularStrength = 1 - SpecularStrength

dielectricColor = diffuseColor * (oneMinusSpecularStrength / (1.0f - dielectricSpecularReflectance) / max(1e-4, 1.0 - metalness))
metalColor = (Specular - dielectricSpecularReflectance * (1.0 - metalness)) * (1.0 / max(1e-4, metalness))
albedoRawColor = lerpColors(dielectricColor, metalColor, metalness * metalness)
AlbedoRGB = clamp(albedoRawColor, 0.0, 1.0);
```

`AlbedoRGB` вычисляется по приведенной выше формуле, но альфа-канал требует дополнительных вычислений. Формат FBX является неясным относительно прозрачности и имеет множество способов его определения. Различные средства для работы с содержимым используют различные методы. Идея заключается в том, чтобы объединить их в одну формулу. Однако некоторые активы неправильно отображаются как прозрачные, если они не создаются обычным образом.

Это вычисление производится на основе `TransparentColor` , `TransparencyFactor` , `Opacity` :

Если `Opacity` определен, используйте его напрямую: `AlbedoAlpha`  =  `Opacity` else.  
Если `TransparencyColor` определен, то `AlbedoAlpha` = 1,0-(( `TransparentColor` . Red + `TransparentColor` . Зеленый + `TransparentColor` . Blue)/3,0) else  
Если значение `TransparencyFactor` равно, то `AlbedoAlpha` = 1,0- `TransparencyFactor`

Окончательный `Albedo` цвет имеет четыре канала, объединяя `AlbedoRGB` с `AlbedoAlpha` .

### <a name="summary"></a>Итоги

В итоге `Albedo` это будет очень близко к исходному `Diffuse` , если `Specular` находится рядом с нулем. В противном случае поверхность будет выглядеть как металлическая поверхность и теряет рассеянный цвет. Поверхность будет выглядеть более безупречной и отражающей, если `ShininessExponent` она достаточно велика и `Specular` является яркой. В противном случае поверхность будет выглядеть приблизительно и едва отражать среду.

### <a name="known-issues"></a>Известные проблемы

* Текущая формула не подходит для простой цветовой геометрии. Если `Specular` достаточно яркое, все геометрические поверхности становятся отражающими металлических поверхностей без какого-либо цвета. Чтобы решить эту проблему, необходимо уменьшить значение до `Specular` 30% от исходного или использовать параметр преобразования [фбксассумеметаллик](../how-tos/conversion/configure-model-conversion.md#converting-from-older-fbx-formats-with-a-phong-material-model).
* Материалы по PBR недавно были добавлены `Maya` в `3DS Max` средства и для создания содержимого. Они используют настраиваемые определяемые пользователем свойства черного прямоугольника для передачи его в FBX. Удаленная визуализация Azure не считывает эти дополнительные свойства, поскольку они не документированы и формат закрыт-Source.

## <a name="next-steps"></a>Дальнейшие действия

* [Преобразование модели](../how-tos/conversion/model-conversion.md)
* [Переопределение материалов во время преобразования модели](../how-tos/conversion/override-materials.md)
