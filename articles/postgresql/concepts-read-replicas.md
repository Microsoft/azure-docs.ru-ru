---
title: Чтение реплик — база данных Azure для PostgreSQL — один сервер
description: В этой статье описывается функция чтения реплики в базе данных Azure для PostgreSQL-Single Server.
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 11/05/2020
ms.openlocfilehash: dc19b95e891235ac35c703adef50a23a9f70fbdb
ms.sourcegitcommit: 0830e02635d2f240aae2667b947487db01f5fdef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/21/2020
ms.locfileid: "97706802"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>Чтение реплик в базе данных Azure для PostgreSQL — один сервер

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для PostgreSQL" на сервер только для чтения. Реплики обновляются **асинхронно** с помощью встроенной технологии физической репликации ядра PostgreSQL. Можно выполнить репликацию с сервера источника до пяти реплик.

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для PostgreSQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о создании реплик и управлении ими см. [здесь](howto-read-replicas-portal.md).

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения
Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения могут быть изолированы от реплик, тогда как рабочие нагрузки записи могут быть направлены к первичному. Реплики чтения также можно развернуть в другом регионе. в случае аварийного восстановления их можно повысить до сервера, предназначенного для чтения и записи.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Поскольку реплики доступны только для чтения, они не уменьшают нагрузку на основной ресурс напрямую.

### <a name="considerations"></a>Рекомендации
Эта функция предназначена для сценариев, в которых запаздывание приемлемо и предназначено для разгрузки запросов. Он не предназначен для сценариев синхронной репликации, в которых данные реплики должны быть обновлены. Между базой данных-источником и репликой возникает измеряемая задержка. Это может быть в минутах или даже в часах в зависимости от рабочей нагрузки и задержки между первичной и репликой. Данные в реплике в конечном итоге согласовываются с данными на первичном. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка. 

> [!NOTE]
> Для большинства рабочих нагрузок реплики чтения предлагают обновления практически в реальном времени от основного. Однако при наличии устойчивых основных рабочих нагрузок с большим количеством операций записи задержка репликации может продолжать расти и никогда не сможет быть перехватываться с базой данных-источником. Это также может увеличить использование хранилища на основном сайте, так как файлы WAL не удаляются до тех пор, пока они не будут получены в реплике. Если такая ситуация сохраняется, удаление и повторное создание реплики чтения после завершения рабочих нагрузок с большим объемом операций ввода-вывода приводят к работоспособности реплики в нормальном состоянии с учетом запаздывания.
> Асинхронные реплики чтения не подходят для таких интенсивных рабочих нагрузок записи. При оценке реплик чтения для приложения Отслеживайте задержку в реплике для полного цикла рабочей нагрузки приложения по его пиковому и непиковому времени, чтобы получить доступ к возможной задержке и ожидаемому RTO/RPO в различных точках цикла рабочей нагрузки.
> 
## <a name="cross-region-replication"></a>Репликация между регионами
Реплику чтения можно создать в другом регионе на сервере-источнике. Репликация между регионами полезна для таких сценариев, как планирование аварийного восстановления или перенос данных ближе к пользователям.

>[!NOTE]
> Серверы уровня Basic поддерживают только репликацию одного региона.

Сервер-источник можно использовать в любом [регионе базы данных Azure для PostgreSQL](https://azure.microsoft.com/global-infrastructure/services/?products=postgresql). Сервер-источник может иметь реплику в связанном регионе или в регионах универсальной реплики. На рисунке ниже показано, какие регионы реплик доступны в зависимости от основного региона.

[:::image type="content" source="media/concepts-read-replica/read-replica-regions.png" alt-text="Чтение регионов реплики":::](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>Универсальные регионы реплики
Вы всегда можете создать реплику чтения в любом из следующих регионов, независимо от того, где находится основной сервер. Это регионы универсальной реплики:

Восточная Австралия, Юго-Восточная Австралия, Южная Бразилия, Центральная Канада, Восточная Канада, Центральная часть США, наВосточная Азия, восток США, Восточная часть US 2, Юго-Восточная Япония, Западная Япония, Центральная Корея, Южная Европа, Юго-Центральный западная часть Соединенного Королевства южная часть Соединенного Королевства регион США, северо-центральная часть США, Юго-Запад США, "Западная часть США"

### <a name="paired-regions"></a>Пары регионов
В дополнение к регионам универсальной реплики можно создать реплику чтения в парном регионе Azure сервера-источника. Если вы не знаете, какой регион является парным, изучите [эту статью](../best-practices-availability-paired-regions.md).

Если вы настраиваете репликацию между регионами в рамках планирования аварийного восстановления, мы рекомендуем создавать реплику именно в парном регионе, а не в одном из других. Для парных регионов не допускаются одновременные обновления, отслеживаются приоритеты по физической изоляции и месту расположения данных.  

Существуют ограничения, которые следует учитывать: 

* Доступность по регионам. база данных Azure для PostgreSQL доступна в центральном центре Франции, Северной и Германии. Но недоступны регионы, которые являются для них парными.
    
* Однонаправленные пары. Некоторые регионы Azure считаются парными только в одном направлении. В число этих регионов входит Западная Индия, Южная Бразилия. 
   Это означает, что сервер-источник в Западной Индии может создать реплику в Южной Индии. Однако сервер-источник в Южной Индии не может создать реплику в Западной Индии. Это связано с тем, что для региона "Западная Индия" дополнительным регионом является "Южная Индия", но для региона "Южная Индия" дополнительный регион отличается от региона "Западная Индия".


## <a name="create-a-replica"></a>Создание реплики
При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для PostgreSQL". Новый сервер заполняется данными, которые были на сервере-источнике. Время создания зависит от объема данных в первичной и времени, прошедших с момента последней еженедельной полной архивации. Время может варьироваться от нескольких минут до нескольких часов.

Для каждой реплики включается [автоматическое увеличение](concepts-pricing-tiers.md#storage-auto-grow) хранилища. Функция автоматического увеличения позволяет реплике хранить данные, реплицированные на нее, и предотвращать перерыв в репликации из-за ошибок, вызванных нехваткой хранилища.

Реплика чтения использует физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

Если исходный сервер PostgreSQL шифруется с помощью управляемых клиентом ключей, дополнительные рекомендации см. в [документации](concepts-data-encryption-postgresql.md) .

## <a name="connect-to-a-replica"></a>Подключение к реплике
При создании реплики они не наследуют правила брандмауэра или конечную точку службы виртуальной сети сервера-источника. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует учетную запись администратора от сервера источника. Все учетные записи пользователей на сервере источника реплицируются в реплики чтения. Подключиться к реплике чтения можно только с помощью учетных записей пользователей, доступных на сервере-источнике.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для PostgreSQL". Для сервера с именем **Моя реплика** и именем администратора **MyAdmin** можно подключиться к реплике с помощью psql:

```bash
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации
База данных Azure для PostgreSQL предоставляет две метрики для мониторинга репликации. Две метрики являются **максимальным запаздывание между репликами** и **задержкой реплики**. Сведения о том, как просмотреть эти метрики, см. в разделе **мониторинг реплики** [статьи инструкции по чтению реплики](howto-read-replicas-portal.md).

Метрика " **Максимальная задержка между репликами** " показывает задержку в байтах между первичной и задержкой репликой. Эта метрика применима и доступна только на основном сервере и будет доступна только в том случае, если хотя бы одна реплика чтения подключена к первичной, а первичная — в режиме потоковой репликации. Сведения о отставании не показывают подробности, когда реплика находится в процессе перехвата с первичным журналом с использованием архивных журналов первичной репликации в режиме доставки файлов.

Метрика **запаздывания реплики** показывает время, прошедшее с момента последнего воспроизведения транзакции. Если на основном сервере нет транзакций, метрика отражает эту временную задержку. Эта метрика применима и доступна только для серверов реплик. Запаздывание реплики вычисляется из `pg_stat_wal_receiver` представления:

```SQL
SELECT EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

Настройте отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, запросите первичный сервер непосредственно для получения задержки репликации в байтах во всех репликах.

> [!NOTE]
> При перезапуске сервера-источника или реплики чтения время, необходимое для перезапуска и настройки, отражается в метрике задержки реплики.

## <a name="stop-replication--promote-replica"></a>Завершение репликации или повышения уровня реплики
Вы можете в любое время предотвратить репликацию между базой данных-источником и репликой. Действие при остановке приводит к перезапуску реплики и порождает реплику как отдельный изолированный сервер, доступный для чтения и записи. Данные на отдельном сервере — это данные, которые были доступны на сервере реплики во время остановки репликации. Все последующие обновления на первичном сайте не распространяются на реплику. Однако сервер реплики может иметь накопленные журналы, которые еще не применены. В рамках процесса перезапуска реплика применяет все ожидающие журналы перед принятием клиентских подключений.  

### <a name="considerations"></a>Рекомендации
- Перед остановкой репликации на реплике чтения проверьте задержку репликации, чтобы убедиться, что реплика содержит все необходимые данные. 
- Так как реплика чтения должна применить все ожидающие журналы, прежде чем можно будет сделать автономный сервер, RTO может быть выше для записи высоких рабочих нагрузок, когда происходит репликация, так как в реплике может воздержаться значительная задержка. Обратите внимание на это при планировании продвижения реплики.
- Сервер повторной реплики невозможно сделать репликой еще раз.
- Если реплика является первичным сервером, то невозможно установить репликацию на старый сервер-источник. Если вы хотите вернуться к старому основному региону, можно либо установить новый сервер реплики с новым именем (или) удалить старую основную реплику, а затем создать ее, используя старое основное имя.
- Если у вас есть несколько реплик чтения, и если один из них является основным сервером, другие серверы реплик по-прежнему будут подключены к старому основному серверу. Возможно, потребуется повторно создать реплики на новом повышенном сервере.

При отмене репликации реплика теряет все ссылки на предыдущие первичные и другие реплики.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).

## <a name="failover-to-replica"></a>Отработка отказа в реплику

В случае сбоя сервера-источника **он автоматически не** отключается к реплике чтения. 

Так как репликация является асинхронной, между базой данных-источником и репликой может быть значительного запаздывания. На величину запаздывания влияет ряд факторов, таких как тип рабочей нагрузки, выполняемой на сервере-источнике, и задержка между сервером-источником и репликой. В типичных случаях с номинальной рабочей нагрузкой записи ожидается задержка реплики от нескольких секунд до нескольких минут. Однако в случаях, когда первичная Рабочая нагрузка работает очень интенсивно, а реплика достаточно быстро перехватываться, задержка может быть значительно выше. Можно отвести отслеживание задержки репликации для каждой реплики с помощью *задержки реплики* метрики. Эта метрика показывает время, прошедшее с последней воспроизводимой транзакции в реплике. Рекомендуется вычислить среднюю задержку, просматривая задержку реплики в течение определенного периода времени. Вы можете установить оповещение о задержке реплики, чтобы при выходе за пределы ожидаемого диапазона вы будете уведомлены о необходимости выполнить действие.

> [!Tip]
> Если выполняется отработка отказа в реплике, задержка во время десвязи реплики с базой данных-источником будет указывать на количество потерянных.

После того как вы решили выполнить отработку отказа в реплику, 

1. Останавливает репликацию в реплику<br/>
   Этот шаг необходим для того, чтобы сервер реплики стал автономным сервером и мог принимать записи. В рамках этого процесса сервер реплики будет перезапущен и будет десвязываться с основным сервером. После запуска процесса "отключить репликацию" серверный процесс обычно занимает несколько минут, чтобы применить любые непримененные журналы, а также открыть базу данных в качестве сервера, доступного для чтения и записи. Сведения о влиянии этого действия см. в разделе " [Завершение репликации](#stop-replication--promote-replica) " этой статьи.
    
2. Наведите приложение на реплику (бывшая)<br/>
   Каждый сервер имеет уникальную строку подключения. Обновите строку подключения приложения, чтобы она указывала на (бывшая) реплику, а не на основную.
    
После успешной обработки операций чтения и записи приложение отработки отказа завершено. Время простоя, которое будет зависеть от работы приложения, зависит от того, обнаруживается ошибка и выполняются шаги 1 и 2, описанные выше.

### <a name="disaster-recovery"></a>Аварийное восстановление

При возникновении серьезных аварийных событий, таких как доступность уровня зоны доступности или региональных сбоев, можно выполнить аварийное восстановление, добавив реплику чтения. На портале пользовательского интерфейса можно переходить к серверу реплики чтения. Затем перейдите на вкладку Репликация и можно будет прерывать реплику так, чтобы она была независимым сервером. Кроме того, можно использовать [Azure CLI](/cli/azure/postgres/server/replica#az_postgres_server_replica_stop) для завершения и повышения уровня сервера реплики.

## <a name="considerations"></a>Рекомендации

В этом разделе приведены рекомендации по использованию компонента "Реплика чтения".

### <a name="prerequisites"></a>Предварительные требования
Считывание реплик и [логического декодирования](concepts-logical.md) зависит от postgres журнала упреждающего записи (WAL) для получения сведений. Для этих двух функций требуется разный уровень ведения журнала от postgres. Для логического декодирования требуется более высокий уровень ведения журнала, чем считывание реплик.

Чтобы настроить правильный уровень ведения журнала, используйте параметр поддержки репликации Azure. Поддержка репликации в Azure имеет три параметра:

* **Off** — накладывает наименьшую информацию в Wal. Этот параметр недоступен на большинстве серверов базы данных Azure для PostgreSQL.  
* **Реплика** — более подробная, чем **Off**. Это минимальный уровень ведения журнала, необходимый для работы [реплик чтения](concepts-read-replicas.md) . Этот параметр используется по умолчанию на большинстве серверов.
* **Логический** — более подробный, чем **реплика**. Это минимальный уровень ведения журнала для работы логического декодирования. Реплики чтения также работают с этим параметром.


### <a name="new-replicas"></a>Новые реплики
Реплики чтения создаются как новые серверы службы "База данных Azure для PostgreSQL". Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики
Реплика создается с использованием тех же параметров вычислений и хранилища, что и у первичного. После создания реплики можно изменить несколько параметров, включая период хранения резервных копий и хранилища.

Правила брандмауэра, правила виртуальной сети и параметры параметров не наследуются от сервера-источника к реплике при создании или последующей реплике.

### <a name="scaling"></a>Масштабирование
Масштабирование виртуальных ядер или между общего назначения и оптимизированной для памяти:
* PostgreSQL требует, `max_connections` чтобы параметр на вторичном сервере был [больше или равен значению в первичной](https://www.postgresql.org/docs/current/hot-standby.html)реплике, иначе вторичный сервер не запустится.
* В базе данных Azure для PostgreSQL максимально допустимое количество подключений для каждого сервера зафиксировано для расчетного номера SKU, так как соединения занимают память. Вы можете узнать больше о [сопоставлении между max_connections и номерами SKU](concepts-limits.md).
* **Увеличение** масштаба: сначала увеличьте масштаб вычислений реплики, а затем — на основной. Этот порядок предотвратит нарушение `max_connections` требований.
* **Уменьшение масштаба**: сначала выполните масштабирование основного вычислений, а затем выполните масштабирование для реплики. Если вы попытаетесь масштабировать реплику ниже основной, произойдет ошибка, так как это нарушает `max_connections` требование.

Масштабирование хранилища:
* Для всех реплик включено автоматическое увеличение хранилища, чтобы предотвратить возникновение проблем репликации из полной реплики хранилища. Этот параметр нельзя отключить.
* Можно также вручную масштабировать хранилище, как это делается на любом другом сервере.


### <a name="basic-tier"></a>Уровень Basic
Серверы уровня Basic поддерживают только репликацию одного региона.

### <a name="max_prepared_transactions"></a>max_prepared_transactions
[PostgreSQL требует](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS) , `max_prepared_transactions` чтобы значение параметра в реплике чтения было больше или равно первичному значению; в противном случае реплика не будет запущена. Если вы хотите изменить `max_prepared_transactions` источник, сначала измените его на репликах.

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы останавливаете репликацию между сервером-источником и репликой чтения, реплика перезапускается для применения изменений. Остановленная реплика становится отдельным сервером, который принимает операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-primary-and-standalone-servers"></a>Удаленные основные и автономные серверы
При удалении сервера-источника все его реплики чтения становятся автономными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения см. в статье [Создание реплик чтения и управление ими с помощью портала Azure](howto-read-replicas-portal.md).
* Узнайте, как [создавать реплики чтения и управлять ими в Azure CLI и REST API](howto-read-replicas-cli.md).