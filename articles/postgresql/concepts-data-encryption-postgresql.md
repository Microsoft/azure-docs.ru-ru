---
title: Шифрование данных с помощью управляемых клиентом ключей для отдельного сервера базы данных Azure для PostgreSQL
description: Шифрование данных с помощью управляемых клиентом ключей для отдельного сервера базы данных Azure для PostgreSQL позволяет создавать свой собственный ключ (BYOK) для защиты неактивных данных. Он также позволяет организациям реализовать разделение обязанностей в управлении ключами и данными.
author: mksuni
ms.author: sumuth
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/13/2020
ms.openlocfilehash: 66faa2b3e6d24c264e2fe26ab42eeaffd48384f6
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101732842"
---
# <a name="azure-database-for-postgresql-single-server-data-encryption-with-a-customer-managed-key"></a>Шифрование данных с помощью управляемых клиентом ключей для отдельного сервера базы данных Azure для PostgreSQL

Azure PostgreSQL использует [Шифрование службы хранилища Azure](../storage/common/storage-service-encryption.md) для шифрования неактивных данных по умолчанию с помощью ключей, управляемых корпорацией Майкрософт. Для пользователей Azure PostgreSQL это очень похоже на прозрачное шифрование данных (TDE) в других базах данных, таких как SQL Server. Многим организациям требуется полный контроль над доступом к данным с помощью управляемого клиентом ключа. Шифрование данных с помощью управляемых пользователем ключей для отдельного сервера базы данных Azure для PostgreSQL позволяет создавать свой собственный ключ (BYOK) для защиты неактивных данных. Он также позволяет организациям реализовать разделение обязанностей в управлении ключами и данными. При шифровании, управляемом пользователем, вы несете ответственность за полное управление жизненным циклом ключа, разрешения на использование ключа и за аудит операций с ключами.

Шифрование данных с помощью управляемых клиентом ключей для отдельного сервера базы данных Azure для PostgreSQL задано на уровне сервера. На определенном сервере шифрование ключа шифрования данных (DEK), используемого службой, выполняется с помощью управляемого клиентом ключа, называемого ключом шифрования ключей (KEK). KEK — это асимметричный ключ, хранящийся в принадлежащем клиенту и управляемом им экземпляре [Azure Key Vault](../key-vault/general/secure-your-key-vault.md). Подробное описание ключа шифрования ключей (KEK) и ключа шифрования данных (DEK) приводится далее в этой статье.

Key Vault — это облачная внешняя система управления ключами. Она обладает высокой доступностью и является масштабируемым надежным хранилищем для криптографических ключей RSA, которое при необходимости поддерживается проверенными аппаратными модулями безопасности (HSM) FIPS 140-2 уровня 2. Эта система запрещает прямой доступ к хранящемуся ключу, но предоставляет авторизованным сущностям службы шифрования и расшифровки. Key Vault может создать ключ, импортировать его или [передать с локального устройства HSM](../key-vault/keys/hsm-protected-keys.md).

> [!NOTE]
> Эта функция доступна во всех регионах Azure, где отдельный сервер базы данных Azure для PostgreSQL поддерживает ценовые категории "Общего назначения" и "Оптимизировано для операций в памяти". Другие ограничения см. в разделе об [ограничениях](concepts-data-encryption-postgresql.md#limitations) .

## <a name="benefits"></a>Преимущества

Шифрование данных с помощью ключей, управляемых клиентом, для сервера базы данных Azure для PostgreSQL предоставляет следующие преимущества.

* Полный контроль доступа к данным с возможностью удалить ключ и сделать базу данных недоступной 
*    Полный контроль жизненного цикла ключей, включая смену ключей в соответствии с корпоративными политиками
*    Централизованное управление ключами и их организация в Azure Key Vault
*    Возможность разделения обязанностей между специалистами по обеспечению безопасности, администраторами баз данных и системными администраторами

## <a name="terminology-and-description"></a>Терминология и описание

**Ключ шифрования данных (DEK)** : симметричный ключ AES256 для шифрования раздела или блока данных. Шифрование каждого блока данных другим ключом создает дополнительные сложности для выполнения атак в отношении зашифрованных данных. Доступ к DEK требуется поставщику ресурсов или экземпляру приложения, выполняющему шифрование или расшифровку определенного блока. Когда DEK заменяется новым ключом, повторного шифрования этим ключом требуют только данные в его связанном блоке.

**Ключ шифрования ключей (KEK)** : ключ шифрования, используемый для шифрования ключей DEK. Ключ KEK, который всегда остается в Key Vault, позволяет шифровать и контролировать сами ключи DEK. Сущность, у которой есть доступ к ключу KEK, может отличаться от сущности, требующей ключа DEK. Так как KEK требуется для расшифровки ключей DEK, его можно фактически рассматривать как единую точку, с помощью которой можно удалить ключи DEK (непосредственно удалив KEK).

Ключи DEK, зашифрованные с помощью ключей KEK, хранятся отдельно. Расшифровать ключи DEK может только сущность с доступом к ключу KEK. Дополнительные сведения см. в статье [Шифрование неактивных данных](../security/fundamentals/encryption-atrest.md).

## <a name="how-data-encryption-with-a-customer-managed-key-work"></a>Шифрование данных с помощью управляемого клиентом ключа

:::image type="content" source="media/concepts-data-access-and-security-data-encryption/postgresql-data-encryption-overview.png" alt-text="Схема, на которой показан обзор подхода &quot;Создание собственных ключей&quot;":::

Чтобы сервер PostgreSQL мог использовать управляемые клиентом и хранящиеся в Key Vault ключи для шифрования ключа DEK, администратор Key Vault предоставляет следующие права доступа.

* **get**. Для получения общедоступной части и свойств ключа в хранилище ключей.
* **wrapKey**. Для шифрования ключа DEK. Зашифрованный DEK хранится в базе данных Azure для PostgreSQL.
* **unwrapKey**. Для расшифровки ключа DEK. Службе "база данных Azure для PostgreSQL" требуется Расшифрованная DEK для шифрования и расшифровки данных

Администратор хранилища ключей может также [включить ведение журнала событий аудита Key Vault](../azure-monitor/insights/key-vault-insights-overview.md), чтобы их можно было проверить позже.

Если сервер настроен для использования управляемого клиентом ключа, хранящегося в хранилище ключей, он отправляет ключ DEK в хранилище ключей для шифрования. Key Vault возвращает зашифрованный ключ DEK, который сохраняется в базе данных пользователя. Аналогично при необходимости сервер отправляет защищенный ключ DEK в хранилище ключей для расшифровки. Если включено ведение журнала, аудиторы могут использовать Azure Monitor для просмотра журналов событий аудита Key Vault.

## <a name="requirements-for-configuring-data-encryption-for-azure-database-for-postgresql-single-server"></a>Требования к настройке шифрования данных для отдельного сервера базы данных Azure для PostgreSQL

Ниже приведены требования к настройке Key Vault.

* Key Vault и отдельный сервер базы данных Azure для PostgreSQL должны принадлежать одному клиенту Azure Active Directory (Azure AD). Взаимодействие между хранилищем ключей и сервером, размещенными в разных клиентах, не поддерживается. Чтобы переместить Key Vault ресурс, необходимо перенастроить шифрование данных.
* Хранилище ключей должно иметь значение 90 дней в днях, в течение которого будут храниться удаленные хранилища. Если существующее хранилище ключей настроено с меньшим числом, необходимо создать новое хранилище ключей, так как оно не будет изменено после создания.
* В хранилище ключей следует включить функцию обратимого удаления, чтобы избежать потери данных в случае непреднамеренного удаления ключа (или Key Vault). Ресурсы с обратимым удалением хранятся 90 дней, в течение которых их можно восстановить или удалить. С действиями "Восстановить" и "Удалить" связаны отдельные разрешения в политике доступа хранилища ключей. Функция обратимого удаления отключена по умолчанию, но ее можно включить с помощью PowerShell или Azure CLI (обратите внимание, что ее нельзя включить на портале Azure). 
* Включение защиты от очистки для принудительного применения обязательного срока хранения для удаленных хранилищ и объектов хранилища
* Предоставьте отдельному серверу базы данных Azure для PostgreSQL доступ к хранилищу ключей с разрешениями get, wrapKey и unwrapKey, используя его уникальное управляемое удостоверение. В портал Azure уникальное удостоверение службы создается автоматически при включении шифрования данных на одном сервере PostgreSQL. Подробные пошаговые инструкции по использованию портала для настройки шифрования данных см. в [этой статье](howto-data-encryption-portal.md).

Ниже приведены требования к настройке ключа, управляемого клиентом.

* Управляемый клиентом ключ, используемый для шифрования ключа DEK, может быть только асимметричным 2048-битным ключом RSA.
* Дата активации ключа (если задана) должна быть датой и временем в прошлом. Дата истечения срока действия (если задана) должна быть датой и временем в будущем.
* Ключ должен находиться в состоянии *Включено*.
* Если вы [импортируете существующий ключ](/rest/api/keyvault/ImportKey/ImportKey) в хранилище ключей, убедитесь, что он предоставлен в поддерживаемых форматах файлов ( `.pfx` , `.byok` , `.backup` ).

## <a name="recommendations"></a>Рекомендации

Ниже приведены рекомендации по настройке Key Vault при использовании шифрования данных с помощью ключа, управляемого клиентом.

* Установите блокировку ресурсов в Key Vault, чтобы управлять правами на удаление этого критически важного ресурса и предотвратить случайное или несанкционированное удаление.
* Включите функции аудита и отчетности для всех ключей шифрования. Key Vault предоставляет журналы, которые можно легко передать в любые средства управления информационной безопасностью и событиями безопасности. Например, они уже интегрированы в службу Azure Monitor Log Analytics.
* Убедитесь, что Key Vault и отдельный сервер базы данных Azure для PostgreSQL находятся в одном регионе, чтобы обеспечить быстрый доступ к операциям упаковки или распаковки ключа DEK.
* Сделайте Azure KeyVault доступным только для **частной конечной точки и ряда определенных сетей** и используйте для защиты ресурсов только *доверенные службы Майкрософт*.

    :::image type="content" source="media/concepts-data-access-and-security-data-encryption/keyvault-trusted-service.png" alt-text="trusted-service-with-AKV":::

Ниже приведены рекомендации по настройке ключа, управляемого клиентом.

* Храните копию управляемого клиентом ключа в надежном месте или передайте ее в службу депонирования.

* Если ключ создается в Key Vault, создайте резервную копию ключа перед его первым использованием. Резервную копию можно восстановить только в Key Vault. Дополнительные сведения о команде резервного копирования см. в статье [Backup-AzKeyVaultKey](/powershell/module/az.keyVault/backup-azkeyVaultkey).

## <a name="inaccessible-customer-managed-key-condition"></a>Условие отсутствия доступа к ключу, управляемому клиентом

Когда шифрование данных в Key Vault настраивается с помощью ключа, управляемого клиентом, то, чтобы сервер оставался в режиме "в сети", ему требуется постоянный доступ к этому ключу. Если сервер теряет доступ к управляемому клиентом ключу в Key Vault, он начинает отклонять все подключения в течение 10 минут. Сервер выдает соответствующее сообщение об ошибке, и его состояние изменяется на *Недоступен*. Ниже приведены некоторые причины перехода сервера в это состояние.

* Если для отдельного сервера базы данных Azure для PostgreSQL с включенным шифрованием данных создается сервер восстановления на определенный момент времени, этот новый сервер будет находиться в состоянии *Недоступен*. Состояние сервера можно исправить на [портале Azure](howto-data-encryption-portal.md#using-data-encryption-for-restore-or-replica-servers) или с помощью [CLI](howto-data-encryption-cli.md#using-data-encryption-for-restore-or-replica-servers).
* Если для отдельного сервера базы данных Azure для PostgreSQL с включенным шифрованием данных создается реплика чтения, сервер реплики будет находиться в состоянии *Недоступен*. Состояние сервера можно исправить на [портале Azure](howto-data-encryption-portal.md#using-data-encryption-for-restore-or-replica-servers) или с помощью [CLI](howto-data-encryption-cli.md#using-data-encryption-for-restore-or-replica-servers).
* При удалении KeyVault отдельный сервер базы данных Azure для PostgreSQL не сможет получать доступ к ключу и перейдет в состояние *Недоступен*. Чтобы перевести сервер в состояние *Доступен*, следует восстановить [Key Vault](../key-vault/general/key-vault-recovery.md) и повторно проверить шифрование данных.
* При удалении ключа из KeyVault отдельный сервер базы данных Azure для PostgreSQL не сможет получать доступ к ключу и перейдет в состояние *Недоступен*. Чтобы перевести сервер в состояние *Доступен*, следует восстановить [ключ](../key-vault/general/key-vault-recovery.md) и повторно проверить шифрование данных.
* Если срок действия ключа, хранящегося в Azure KeyVault, истекает, ключ становится недействительным, а отдельный сервер базы данных Azure для PostgreSQL перейдет в состояние *Недоступен*. Чтобы перевести сервер в состояние *Доступен*, продлите срок действия ключа с помощью [CLI](/cli/azure/keyvault/key#az-keyvault-key-set-attributes), а затем повторно проверьте шифрование данных.

### <a name="accidental-key-access-revocation-from-key-vault"></a>Непреднамеренный отзыв доступа к ключу из Key Vault

Может случиться так, что пользователь с достаточными правами доступа к Key Vault случайно отключает доступ сервера к ключу в результате выполнения следующих действий:

* отзыв разрешений get, wrapKey и unwrapKey для хранилища ключей с сервера;
* удаление ключа;
* удаление хранилища ключей;
* изменение правил брандмауэра хранилища ключей;

* удаление управляемого удостоверения сервера в Azure AD.

## <a name="monitor-the-customer-managed-key-in-key-vault"></a>Мониторинг управляемого клиентом ключа в Key Vault

Чтобы отслеживать состояние базы данных и активировать оповещения в случае потери доступа к средству защиты прозрачного шифрования данных, настройте следующие функции и компоненты Azure.

* [Работоспособность ресурсов Azure](../service-health/resource-health-overview.md). Недоступная база данных, которая потеряла доступ к ключу клиента, отображается как недоступная после отклонения первого подключения к базе данных.
* [Журнал действий](../service-health/alerts-activity-log-service-notifications-portal.md). В случае сбоя доступа к ключу клиента в управляемом клиентом Key Vault в журнал действий добавляются записи. Если для таких событий создать правила генерации оповещений, можно восстанавливать доступ максимально быстро.

* [Группы действий](../azure-monitor/alerts/action-groups.md). Определите эти группы для отправки уведомлений и оповещений в соответствии с вашими предпочтениями.

## <a name="restore-and-replicate-with-a-customers-managed-key-in-key-vault"></a>Восстановление и репликация с помощью управляемого клиентом ключа в Key Vault

После шифрования отдельного сервера базы данных Azure для PostgreSQL с помощью управляемого ключа клиента, хранящегося в Key Vault, все создаваемые копии сервера также шифруются. Новую копию можно создать с помощью операции локального восстановления или геовосстановления либо с помощью реплик чтения. Копию можно изменить в соответствии с новым управляемым клиентом ключом, используемым для шифрования. При изменении ключа, управляемого клиентом, старые резервные копии сервера начинают использовать последний ключ.

Чтобы избежать проблем при настройке шифрования данных, управляемого клиентом, во время восстановления или создания реплики чтения, важно выполнить следующие действия на основном и восстановленном серверах/репликах.

* Запустите процесс восстановления или чтения реплики из основной базы данных Azure для PostgreSQL одного сервера.
* Оставьте созданный сервер (восстановленный сервер или сервер-реплику) в недоступном состоянии, так как его уникальному удостоверению еще не предоставлены разрешения для Key Vault.
* На восстановленном сервере или сервере-реплике повторно проверьте ключ, управляемый клиентом, в параметрах шифрования данных. Это гарантирует, что созданному серверу предоставлены разрешения на упаковку и распаковку ключа, хранящегося в Key Vault.

## <a name="limitations"></a>Ограничения

Для базы данных Azure для PostgreSQL поддержка шифрования неактивных данных с помощью управляемого ключа клиентов (CMK) имеет несколько ограничений.

* Поддержка этой функции ограничена **общего назначения** и **оптимизированными для памяти** ценовыми категориями.
* Эта функция поддерживается только для регионов и серверов с поддержкой хранилища объемом до 16 ТБ. Список регионов Azure, поддерживающих хранилище вплоть до 16TB, см. в разделе о хранилище документации [здесь](concepts-pricing-tiers.md#storage) .

    > [!NOTE]
    > - Все новые серверы PostgreSQL, созданные в перечисленных выше регионах **, поддерживают шифрование** с помощью ключей клиента. Сервер, восстановленный на момент времени (PITR) или реплика чтения, не будет указывать на то, что в теории они являются "новыми".
    > - Чтобы проверить, поддерживает ли подготовленный сервер 16TB, перейдите в колонку ценовая категория на портале и просмотрите максимальный размер хранилища, поддерживаемый подготовленным сервером. Если вы можете переместить ползунок вверх до 4 ТБ, сервер может не поддерживать шифрование с помощью управляемых клиентом ключей. Тем не менее данные шифруются с помощью управляемых службой ключей в любое время. AskAzureDBforPostgreSQL@service.microsoft.comЕсли у вас возникнут вопросы, свяжитесь с вами.

* Шифрование поддерживается только при использовании криптографического ключа RSA 2048.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [настроить шифрование данных с помощью управляемого клиентом ключа для отдельного сервера базы данных Azure для PostgreSQL с помощью портала Azure](howto-data-encryption-portal.md).
