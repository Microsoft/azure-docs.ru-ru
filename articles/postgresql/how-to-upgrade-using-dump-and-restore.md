---
title: Обновление с помощью дампа и восстановления — база данных Azure для PostgreSQL — один сервер
description: Описывает методы обновления в автономном режиме с помощью дампа и восстановления баз данных для перехода на более позднюю версию базы данных Azure для PostgreSQL-Single Server.
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: how-to
ms.date: 11/10/2020
ms.openlocfilehash: 42bbe1c9f4056ae0dae0ccd59b452db90a7c63c5
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96493667"
---
# <a name="upgrade-your-postgresql-database-using-dump-and-restore"></a>Обновление базы данных PostgreSQL с помощью дампа и восстановления

Сервер PostgreSQL, развернутый в базе данных Azure для PostgreSQL-Single Server, можно обновить, переполнив базы данных на более высокий сервер основной версии, используя следующие методы.
* **Автономный** метод с использованием [pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) PostgreSQL и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html) , который вызывает время простоя для переноса данных. В этом документе рассматривается этот метод обновления и миграции.
* Метод **Online** с использованием [Database Migration Service](../dms/tutorial-azure-postgresql-to-azure-postgresql-online-portal.md) (DMS). Этот метод обеспечивает сокращение времени простоя и поддерживает синхронизацию целевой базы данных с источником, после чего вы можете выбрать время отсечения. Однако существует несколько предварительных условий и ограничений для использования DMS. Дополнительные сведения см. в [документации по DMS](../dms/tutorial-azure-postgresql-to-azure-postgresql-online-portal.md). 

 В следующей таблице приведены некоторые рекомендации, основанные на размерах и сценариях баз данных.

| **База данных или сценарий** | **Дамп/восстановление (вне сети)** | **DMS (в сети)** |
| ------ | :------: | :-----: |
| У вас небольшая база данных, которая может позволить себе просто обновить  | X | |
| Небольшие базы данных (< 10 ГБ)  | X | X | 
| Малый средний баз данных (10 ГБ – 100 ГБ) | X | X |
| Большие базы данных (> 100 ГБ) |  | X |
| Может позволить себе просто выполнить обновление (независимо от размера базы данных) | X |  |
| Можно ли обращаться к [необходимым компонентам](../dms/tutorial-azure-postgresql-to-azure-postgresql-online-portal.md#prerequisites)DMS, включая перезагрузку? |  | X |
| Можно ли избежать означающего и незанесенных в журнал таблиц во время процесса обновления? | |  X |

Это руководство содержит несколько методов автономной миграции и примеры, демонстрирующие, как можно выполнить миграцию с исходного сервера на целевой сервер, на котором работает более поздняя версия PostgreSQL.

> [!NOTE]
> PostgreSQL дамп и восстановление можно выполнять различными способами. Вы можете выполнить миграцию с помощью одного из методов, приведенных в этом пошаговом окне, или выбрать другие способы в соответствии с вашими потребностями. Подробный синтаксис дампа и восстановления с дополнительными параметрами см. в статьях [pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html). 


## <a name="prerequisites-for-using-dump-and-restore-with-azure-database-for-postgresql"></a>Необходимые условия для использования дампа и восстановления в базе данных Azure для PostgreSQL
 
Для пошагового руководства вам потребуется:

- **Исходная** база данных PostgreSQL с кодом 9,5, 9,6 или 10, которую требуется обновить.
- **Целевой** сервер базы данных PostgreSQL с требуемым основным номером версии [Azure для сервера PostgreSQL](quickstart-create-server-database-portal.md). 
- Клиентская система PostgreSQL для выполнения команд dump и RESTORE.
  - Это может быть клиент Linux или Windows с PostgreSQL, на котором установлены [pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html) программ командной строки. 
  - Кроме того, можно использовать [Azure Cloud Shell](https://shell.azure.com) или, щелкнув Azure Cloud Shell в строке меню в правом верхнем углу [портал Azure](https://portal.azure.com). `az login`Перед выполнением команд dump и RESTORE потребуется выполнить вход в учетную запись.
- Клиент PostgreSQL лучше всего работает в том же регионе, что и исходный и целевой серверы. 


## <a name="additional-details-and-considerations"></a>Дополнительные сведения и рекомендации
- Строку подключения к исходным и целевым базам данных можно найти, щелкнув "строки подключения" на портале. 
- Возможно, на сервере выполняется несколько баз данных. Список баз данных можно найти, подключившись к исходному серверу и запустив `\l` .
- Создайте соответствующие базы данных на целевом сервере базы данных.
- Можно пропустить обновление `azure_maintenance` или базы данных шаблонов.
- Ознакомьтесь с приведенными выше таблицами, чтобы определить, какая база данных подходит для этого режима миграции.
- Если вы хотите использовать Azure Cloud Shell, обратите внимание, что время ожидания сеанса истекло через 20 минут. Если размер базы данных составляет < 10 ГБ, возможно, вы сможете завершить обновление без истечения времени ожидания сеанса. В противном случае может возникнуть необходимость в открытом сеансе другими способами, например нажатием клавиши <Enter> один раз в 10-15 минут. 


## <a name="example-database-used-in-this-guide"></a>Пример базы данных, используемый в этом пошаговом руководству

В этом разделе приведены примеры с использованием следующих исходных и целевых серверов и имен баз данных.

 | **Описание** | **Значение** |
 | ------- | ------- |
 | Исходный сервер (v 9,5) | pg-95.postgres.database.azure.com |
 | База данных-источник | bench5gb |
 | Размер базы данных источника | 5 ГБ |
 | Имя пользователя источника | pg@pg-95 |
 | Целевой сервер (версии 11) | pg-11.postgres.database.azure.com |
 | Целевая база данных | bench5gb |
 | Имя целевого пользователя | pg@pg-11 |

## <a name="upgrade-your-databases-using-offline-migration-methods"></a>Обновление баз данных с помощью автономных методов миграции
Вы можете использовать один из методов, описанных в этом разделе, для своих обновлений. При выполнении задач можно использовать следующие советы.

- Если вы используете один и тот же пароль для исходной и целевой баз данных, можно задать `PGPASSWORD=yourPassword` переменную среды.  После этого вам не нужно указывать пароль при каждом выполнении команд, таких как PSQL, pg_dump и pg_restore.  Аналогичным образом можно настроить дополнительные переменные `PGUSER` , например и `PGSSLMODE` другие. см. раздел [PostgreSQL Environment Variables](https://www.postgresql.org/docs/11/libpq-envars.html).
  
- Если серверу PostgreSQL требуются подключения TLS/SSL (по умолчанию в базе данных Azure для серверов PostgreSQL), задайте переменную среды, `PGSSLMODE=require` чтобы pg_restore средство подключается к TLS. Без TLS ошибка может быть прочитана  `FATAL:  SSL connection is required. Please specify SSL options and retry.`

- В командной строке Windows выполните команду `SET PGSSLMODE=require` перед выполнением команды pg_restore. В Linux или Bash выполните команду `export PGSSLMODE=require` перед выполнением команды pg_restore.

### <a name="method-1-migrate-using-dump-file"></a>Метод 1. Миграция с помощью файла дампа

Этот метод состоит из двух шагов. Сначала нужно создать дамп с исходного сервера. Вторым шагом является восстановление файла дампа на целевом сервере. Дополнительные сведения см. в документации по [миграции с помощью дампа и восстановления](howto-migrate-using-dump-and-restore.md) . Это рекомендуемый способ, если у вас есть большие базы данных, и в клиентской системе достаточно места для хранения файла дампа.

### <a name="method-2-migrate-using-streaming-the-dump-data-to-the-target-database"></a>Метод 2. Миграция с помощью потоковой передачи данных дампа в целевую базу данных

Если у вас нет клиента PostgreSQL или вы хотите использовать Azure Cloud Shell, то можете использовать этот метод. Дамп базы данных передается непосредственно на целевой сервер базы данных и не сохраняет дамп в клиенте. Таким образом, его можно использовать с клиентом с ограниченным хранилищем, и даже можно запускать из Azure Cloud Shell. 

1. Убедитесь, что база данных существует на целевом сервере с помощью `\l` команды. Если база данных не существует, создайте ее.
   ```azurecli-interactive
    psql "host=myTargetServer port=5432 dbname=postgres user=myUser password=###### sslmode=mySSLmode"
    ```
    ```SQL
    postgres> \l   
    postgres> create database myTargetDB;
   ```

2. Запустите дамп и восстановите его как одну командную строку с помощью канала. 
    ```azurecli-interactive
    pg_dump -Fc -v --mySourceServer --port=5432 --username=myUser --dbname=mySourceDB | pg_restore -v --no-owner --host=myTargetServer --port=5432 --username=myUser --dbname=myTargetDB
    ```

    Например,

    ```azurecli-interactive
    pg_dump -Fc -v --host=pg-95.postgres.database.azure.com --port=5432 --username=pg@pg-95 --dbname=bench5gb | pg_restore -v --no-owner --host=pg-11.postgres.database.azure.com --port=5432 --username=pg@pg-11 --dbname=bench5gb
    ```  
3. После завершения процесса обновления (миграции) можно протестировать приложение на целевом сервере. 
4. Повторите эту процедуру для всех баз данных на сервере.

 Например, в следующей таблице показано время, затраченное на миграцию с помощью метода потокового дампа. Образец данных заполняется с помощью [пгбенч](https://www.postgresql.org/docs/10/pgbench.html). Так как база данных может иметь разное количество объектов разного размера, чем пгбенч созданные таблицы и индексы, настоятельно рекомендуется протестировать дамп и восстановить базу данных, чтобы понять фактическое время, необходимое для обновления базы данных. 

| **Размер баз данных** | **Затраченное время** | 
| ----- | ------ |
| 1 ГБ  | 1-2 минут |
| 5 ГБ | 8-10 минут |
| 10 ГБ | 15-20 минут |
| 50 Гб | 1 – 1,5 часа |
| 100 ГБ | 2,5 – 3 часа|
   
### <a name="method-3-migrate-using-parallel-dump-and-restore"></a>Способ 3. Миграция с помощью параллельного дампа и восстановления 

Этот метод можно рассматривать, если в базе данных имеется несколько больших таблиц, и необходимо параллелизации процесса дампа и восстановления для этой базы данных. Кроме того, в клиентской системе достаточно места для размещения резервных дампов. Этот параллельный процесс дампа и восстановления сокращает потребление времени для завершения всей миграции. Например, база данных пгбенч размером 50 ГБ, которая заняла 1 – 1,5 часа для переноса, была выполнена с помощью метода 1 и 2 заняла менее 30 минут с помощью этого метода.

1. Для каждой базы данных на исходном сервере создайте соответствующую базу данных на целевом сервере.

   ```bash
    psql "host=myTargetServer port=5432 dbname=postgres user=myuser password=###### sslmode=mySSLmode"
    postgresl> create database myDB;
   ```
   Например,
    ```bash
    psql "host=pg-11.postgres.database.azure.com port=5432 dbname=postgres user=pg@pg-11 password=###### sslmode=require"

    postgres> create database bench5gb;
    postgres> \q
    ```

2. Выполните команду pg_dump в формате каталога с числом заданий = 4 (число таблиц в базе данных). С более крупным уровнем вычислений и с большим количеством таблиц можно увеличить его до большего числа. Это pg_dump создаст каталог для хранения сжатых файлов для каждого задания.

    ```bash
    pg_dump -Fd -v --host=sourceServer --port=5432 --username=myUser --dbname=mySourceDB -j 4 -f myDumpDirectory
    ```
    Например,
    ```bash
    pg_dump -Fd -v --host=pg-95.postgres.database.azure.com --port=5432 --username=pg@pg-95 --dbname=bench5gb -j 4 -f dump.dir
    ```

3. Затем восстановите резервную копию на целевом сервере.
    ```bash
    $ pg_restore -v --no-owner --host=myTargetServer --port=5432 --username=myUser --dbname=myTargetDB -j 4 myDumpDir
    ```
    Например,
    ```bash
    $ pg_restore -v --no-owner --host=pg-11.postgres.database.azure.com --port=5432 --username=pg@pg-11 --dbname=bench5gb -j 4 dump.dir
    ```

> [!TIP]
> Описанный в этом документе процесс также можно использовать для обновления сервера базы данных Azure для PostgreSQL, который находится на этапе предварительной версии. Основное отличие заключается в том, что строка подключения для гибкого целевого сервера не имеет `@dbName` .  Например, если имя пользователя — `pg` , то имя пользователя одиночного сервера в строке подключения будет иметь значение `pg@pg-95` , а при использовании гибкого сервера можно просто использовать `pg` .

## <a name="next-steps"></a>Дальнейшие действия

- После завершения работы с целевой базой данных можно удалить старый сервер базы данных. 
- Если вы хотите использовать ту же конечную точку базы данных, что и исходный сервер, то после удаления старого сервера базы данных-источника можно создать реплику чтения с прежним именем сервера базы данных. После установки стабильного состояния можно отключить реплику, которая сделает сервер реплики независимым сервером. Дополнительные сведения см. в разделе [репликация](./concepts-read-replicas.md) .
- Не забудьте проверить и протестировать эти команды в тестовой среде, прежде чем использовать их в рабочей среде.