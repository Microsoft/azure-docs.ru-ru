---
title: Обзор обеспечения высокой доступности с избыточностью зоны с помощью базы данных Azure для PostgreSQL — гибкого сервера (Предварительная версия)
description: Узнайте о концепциях обеспечения высокой доступности с избыточностью зоны с помощью базы данных Azure для PostgreSQL-гибкого сервера
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: c0d9b6042ae695caa73d926653f237b756bf4971
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94366729"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>Основные понятия высокого уровня доступности в базе данных Azure для PostgreSQL-гибкого сервера

> [!IMPORTANT]
> Гибкий сервер Базы данных Azure для PostgreSQL предоставляется в режиме предварительной версии

База данных Azure для PostgreSQL — гибкий сервер обеспечивает настройку высокого уровня доступности с возможностью автоматического перехода на другой ресурс с помощью серверного развертывания с **избыточностью зоны** . При развертывании в избыточной между зонами конфигурации гибкий сервер автоматически подготавливает ожидающую реплику в другой зоне доступности и управляет ею. С помощью PostgreSQL Streaming Replication данные реплицируются на резервный сервер-реплику в **синхронном** режиме. 

Конфигурация, избыточная в рамках зоны, включает автоматическую отработку отказа с нулевой потерей данных во время запланированных событий, таких как операция масштабируемого масштабирования, инициированная пользователем, а также во время незапланированных событий, таких как ошибки оборудования и программного обеспечения, сбои сети и сбои зоны доступности. 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="высокий уровень доступности избыточности в зонах"::: 

## <a name="zone-redundant-high-availability-architecture"></a>Архитектура высокого уровня доступности, избыточная в зонах

Вы можете выбрать регион и зону доступности для развертывания сервера базы данных-источника. Сервер ожидающей реплики подготавливается в другой зоне доступности с той же конфигурацией, что и сервер-источник (включая уровень и объем вычислительных ресурсов, размер хранилища и конфигурацию сети). Журналы транзакций реплицируются в синхронном режиме в резервную реплику с помощью PostgreSQL Streaming Replication. Автоматические резервные копии выполняются периодически с основного сервера базы данных, а журналы транзакций постоянно архивируются в хранилище резервных копий из резервной реплики. 

Работоспособность конфигурации высокой доступности постоянно отслеживается и сообщается на портале. Ниже перечислены состояния высокой доступности, избыточные в зоне.

| **Состояние** | **Описание** |
| ------- | ------ |
| <b> Инициализации | В процессе создания нового резервного сервера |
| <b> Репликация данных | После создания резервного режима он будет перехватываться с основным. |
| <b> Работоспособное | Репликация находится в стабильном состоянии и работоспособна. |
| <b> Отработка отказа | Сервер базы данных находится в процессе отработки отказа в ждущий режим. |
| <b> Удаление режима ожидания | В процессе удаления резервного сервера. | 
| <b> Не включено | Высокий уровень доступности с избыточностью зоны не включен.  |

## <a name="steady-state-operations"></a>Операции с постоянным состоянием

Клиентские приложения PostgreSQL подключены к основному серверу, используя имя сервера базы данных. Чтение приложений осуществляется непосредственно с сервера-источника, а фиксации и записи подтверждаются только после того, как данные будут сохранены как на сервере-источнике, так и в резервной реплике. В связи с этим дополнительным требованием приема-передачи приложения могут задействовать повышенную задержку для операций записи и фиксаций. Вы можете отслеживать работоспособность высокого уровня доступности на портале.

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="высокий уровень доступности с избыточностью зоны — устойчивое состояние"::: 

1. Клиенты подключаются к гибкому серверу и выполняют операции записи.
2. Изменения реплицируются на резервный сайт.
3. Первичный получает подтверждение.
4. Подтверждаются операции записи и фиксации.

## <a name="failover-process---planned-downtimes"></a>Отказоустойчивые процессы — запланированные простои

Запланированные события простоя включают запланированные периодические обновления программного обеспечения Azure и дополнительные обновления версий. При настройке в режиме высокой доступности эти операции сначала применяются к резервной реплике, а приложения продолжают получать доступ к основному серверу. После обновления резервной реплики соединения с сервером-источником останавливаются, и активируется отработка отказа, которая активирует резервную реплику в качестве первичной с тем же именем сервера базы данных. Клиентским приложениям потребуется повторно подключиться с тем же именем сервера базы данных к новому основному серверу и возобновить работу своих операций. Новый резервный сервер будет установлен в той же зоне, что и старая база данных-источник. 

Для других инициированных пользователем операций, таких как масштабирование или масштабирование хранилища, изменения применяются в режиме ожидания, а затем в первичной. В настоящее время подключения не отправляются в ждущий режим, поэтому при выполнении операции на сервере-источнике происходит простоя.

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>Сокращение запланированного простоя с помощью окна управляемого обслуживания

 Вы можете запланировать действия по обслуживанию, инициированные Azure, выбрав 30-минутное окно в день вашего предпочтения, где ожидаемые действия с базами данных будут ненизкими. В этом окне произойдет задача обслуживания Azure, например обновление исправлений или дополнительных версий.  Для гибких серверов, настроенных с высокой доступностью, эти действия по обслуживанию выполняются сначала на резервной реплике, а затем активируются. Затем приложения повторно подключаются к новому основному серверу и возобновляют свои операции во время подготовки нового резерва.

## <a name="failover-process---unplanned-downtimes"></a>Процесс отработки отказа — незапланированные простои

Незапланированные сбои включают в себя ошибки программного обеспечения или компоненты инфраструктуры, влияющие на доступность базы данных. В случае недоступности сервера, обнаруженной системой мониторинга, репликация в резервную реплику является критической, а резервная реплика активируется как сервер базы данных-источника. Клиенты могут повторно подключиться к серверу базы данных с помощью той же строки подключения и возобновить работу своих операций. Общее время отработки отказа должно принимать 60-120S. Однако в зависимости от активности на сервере базы данных — в момент отработки отказа, например больших транзакций и времени восстановления, отработка отказа может занять больше длительности.

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="высокий уровень доступности с избыточностью зоны — отработка отказа"::: 

1. Сервер базы данных-источника не работает, и клиенты теряют подключение к базе данных. 
2. Резервный сервер активируется в качестве нового сервера-источника. Клиент подключается к новому основному серверу, используя ту же строку подключения. Наличие клиентского приложения в той же зоне, что и основной сервер базы данных, сокращает задержку и повышает производительность.
3. Резервный сервер устанавливается в той же зоне, что и старый сервер-источник, и инициируется репликация потоковой передачи. 
4. После установки репликации стабильного состояния клиентское приложение фиксирует и записывается после сохранения данных на обоих сайтах.

## <a name="point-in-time-restore"></a>Восстановление на момент времени 

Гибкие серверы, настроенные с высокой доступностью, реплицируют данные в режиме реального времени на резервный сервер, чтобы обеспечить актуальность. Любые ошибки пользователей на сервере-источнике, такие как случайное удаление таблицы или неверного обновления данных, точно реплицируются в резервную реплику. Поэтому нельзя использовать режим standby для восстановления после таких логических ошибок. Для восстановления после таких ошибок необходимо выполнить восстановление на момент времени из резервных копий.  Используя гибкие возможности восстановления на момент времени, можно восстановить до момента возникновения ошибки. Для баз данных, настроенных с высоким уровнем доступности, новый сервер базы данных будет восстановлен как гибкий сервер одной зоны с именем, предоставленным пользователем. Затем можно экспортировать объект с сервера базы данных и импортировать его на сервер рабочей базы данных. Аналогично, если вы хотите клонировать сервер базы данных для целей тестирования и разработки или хотите восстановить его для любых других целей, можно выполнить восстановление на момент времени.

## <a name="zone-redundant-high-availability---features"></a>Высокий уровень доступности с избыточностью зоны — функции

-   Резервная реплика будет развернута в точно такой же конфигурации виртуальной машины, как и сервер-источник, включая виртуальных ядер, хранилище, сетевые параметры (VNET, Firewall) и т. д.

-   Возможность добавления высокого уровня доступности для существующего сервера базы данных.

-   Возможность удаления резервной реплики путем отключения высокого уровня доступности.

-   Возможность выбора зоны доступности для сервера базы данных — источника.

-   Возможность остановить, запустить и перезапустить серверы основного и резервного баз данных.

-   Автоматические резервные копии выполняются с сервера базы данных-источника и хранятся в хранилище, избыточном в виде зоны.

-   Клиенты всегда подключаются к основному серверу базы данных.

-   Возможность перезапуска сервера для сбора любых изменений статических параметров сервера.
  
-   Периодические действия по обслуживанию, такие как промежуточные обновления версий, происходят в режиме ожидания, а для сокращения времени простоя выполняется отработка отказа службы.  

## <a name="zone-redundant-high-availability---limitations"></a>Высокий уровень доступности с избыточностью зоны

-   Высокий уровень доступности не поддерживается для уровня вычислений с возможностью разбивки на группы.
-   Высокий уровень доступности поддерживается только в регионах, где доступны несколько зон.
-   Из-за синхронной репликации в другую зону доступности приложения могут столкнуться с повышенной задержкой записи и фиксации.

-   Резервную реплику нельзя использовать для запросов на чтение.

-   В зависимости от рабочей нагрузки и активности на основном сервере процесс отработки отказа может занять больше 120 секунд.

-   Перезапуск сервера базы данных источника также перезапускает резервную реплику. 

-   Настройка дополнительных реплик чтения не поддерживается.

-   Настройка задач управления, инициированных клиентом, не может быть запланирована в окне управляемого обслуживания.

-   Запланированные события, такие как масштабирование вычислительных ресурсов и хранилища, сначала происходят в режиме ожидания, а затем на сервере-источнике. Сервер не выполняет отработку отказа для этих запланированных операций. 

-  Если логическая декодирование или логическая репликация настроена с помощью гибкого сервера с высоким уровнем доступности, то в случае отработки отказа на резервный сервер, логические слоты репликации не копируются на резервный сервер.  

## <a name="next-steps"></a>Дальнейшие действия

-   Сведения о [непрерывности бизнес-процессов](./concepts-business-continuity.md)
-   Узнайте, как [управлять высокой доступностью](./how-to-manage-high-availability-portal.md)
-   Сведения о [резервном копировании и восстановлении](./concepts-backup-restore.md)