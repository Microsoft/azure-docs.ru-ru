---
title: Резервное копирование и восстановление в базе данных Azure для PostgreSQL — гибкого сервера
description: Сведения о концепциях резервного копирования и восстановления с помощью базы данных Azure для PostgreSQL-гибкого сервера
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: d0e79e42c7c004638336ada23de663bbe74b7e48
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92532651"
---
# <a name="backup-and-restore-in-azure-database-for-postgresql---flexible-server"></a>Резервное копирование и восстановление в базе данных Azure для PostgreSQL — гибкого сервера

> [!IMPORTANT]
> Гибкий сервер Базы данных Azure для PostgreSQL предоставляется в режиме предварительной версии

Резервные копии образуют важный компонент стратегии обеспечения непрерывности бизнес-процессов. Они помогают защитить данные от случайного повреждения или удаления. База данных Azure для PostgreSQL — гибкий сервер автоматически создает резервную копию сервера и оставляет резервные копии в течение 35 дней. При восстановлении можно указать дату и время, в которые требуется выполнить восстановление в течение срока хранения. Общее время восстановления и восстановления зависит от размера файлов базы данных и объема операций восстановления, которые необходимо выполнить. 

### <a name="backup-process-in-flexible-server"></a>Процесс резервного копирования на гибком сервере
Первое резервное копирование моментального снимка планируется сразу после создания гибкого сервера. Затем выполняется ежедневное резервное копирование моментальных снимков файлов данных. Резервные копии хранятся в зоне, избыточном в пределах региона. Журналы транзакций («упреждающее протоколирование» — WAL) также архивируются непрерывно, чтобы можно было выполнить восстановление до последней зафиксированной транзакции. При помощи этих резервных копий данных и журналов вы можете восстановить сервер до любой точки во времени в пределах заданного срока хранения резервных копий. Все резервные копии шифруются с помощью 256-битового шифрования AES.

Если база данных настроена с высоким уровнем доступности, то ежедневные моментальные снимки выполняются из основной реплики, а непрерывные резервные копии журналов выполняются из резервного.

> [!IMPORTANT]
>Резервные копии на остановленных серверах не выполняются. Однако резервные копии возобновляются, когда база данных либо автоматически запускается через 7 дней, либо запускается пользователем.

Резервные копии можно использовать только для операций восстановления на гибком сервере. Если вы хотите экспортировать или импортировать данные на гибкий сервер, используйте методологию [дампа и восстановления](../howto-migrate-using-dump-and-restore.md) .


### <a name="backup-retention"></a>Хранение архивных копий

Резервные копии сохраняются на основе параметра срок хранения резервной копии для сервера. Можно выбрать срок хранения в диапазоне от 7 до 35 дней. Срок хранения по умолчанию составляет семь дней. Вы можете задать срок хранения во время создания сервера или обновить его позже. Резервные копии сохраняются даже для остановленных серверов.

Срок хранения резервной копии регулирует время, в течение которого можно получить восстановление до точки во времени, так как оно \' основано на доступных резервных копиях. Срок хранения резервной копии можно также рассматривать как окно восстановления с точки зрения восстановления. Все резервные копии, необходимые для выполнения восстановления на определенный момент времени в течение срока хранения резервной копии, сохраняются в хранилище резервных копий. Например, если срок хранения резервной копии равен семи дням, окно восстановления будет считаться за последние семь дней. В этом сценарии сохраняются все данные и журналы, необходимые для восстановления сервера за последние семь дней. 


### <a name="backup-storage-cost"></a>Стоимость хранилищ резервных копий

Гибкий сервер предоставляет до 100% подготовленного хранилища сервера в качестве хранилища резервных копий без дополнительных затрат. За любое дополнительное используемое хранилище резервных копий начислено за ГБ в месяц. Например, если вы подготовили сервер с 250 гиб хранилища, то у вас есть 250 гиб емкости хранилища резервных копий без дополнительной платы. Если ежедневное резервное копирование составляет 25 гиб, вы можете использовать бесплатную резервную копию в течение 10 дней. Использование хранилища резервных копий, превышающее 250 гиб, будет взиматься согласно [модели ценообразования](https://azure.microsoft.com/pricing/details/postgresql/).

Для отслеживания потребляемого сервером пространства в хранилище резервных копий, можно использовать метрику [Используемое хранилище резервных копий](../concepts-monitoring.md) на портале Azure. Эта метрика представляет собой суммарную емкость хранилища, используемую для хранения всех резервных копий баз данных и журналов на основе периода хранения резервных копий, заданного для сервера.  Высокая активность транзакций на сервере может привести к увеличению использования хранилища резервных копий, независимо от общего размера базы данных.

Основным способом управления затратами на хранение резервных копий является установка соответствующего срока хранения резервных копий и выбор правильных параметров избыточности резервных копий в соответствии с необходимыми целями восстановления.

> [!IMPORTANT]
> Геоизбыточные резервные копии в настоящее время не поддерживаются гибким сервером.

## <a name="point-in-time-restore-overview"></a>Обзор восстановления на момент времени

В гибком сервере выполнение восстановления на момент времени создает новый сервер из гибких \' резервных копий сервера в том же регионе, что и исходный сервер. Он создается с конфигурацией исходного сервера для ценовой категории, поколением вычислений, количеством виртуальных ядер, размером хранилища, сроком хранения резервной копии и параметром избыточности резервного копирования. Кроме того, теги и параметры, такие как параметры виртуальной сети и брандмауэра, унаследуются от исходного сервера. 

 > [!IMPORTANT]
> При восстановлении гибкого сервера, настроенного с повышенным уровнем доступности с избыточностью зоны, восстановленный сервер будет настроен без высокой доступности и в том же регионе, что и основной сервер. 

 ### <a name="restore-process"></a>Процесс восстановления

Файлы физической базы данных сначала восстанавливаются из резервных копий моментальных снимков в расположение данных сервера. Будет автоматически выбрана и восстановлена соответствующая резервная копия, которая была сделана раньше требуемой точки во времени. Затем процесс восстановления инициируется с помощью файлов WAL, чтобы перевести базу данных в целостное состояние. 

 Например, пусть мы предполагаем, что резервные копии выполняются в 11 вечера каждую ночь. Если точка восстановления находится на 15 августа 2020 в 10:00 AM, то восстанавливается ежедневное резервное копирование 14 августа 2020. База данных будет восстановлена до 10:00 25 августа 2020 с использованием резервной копии журналов транзакций между 24 августа 11 вечера до 25 августа 10:00. 

 Инструкции по восстановлению сервера базы данных см. в [этой статье](./how-to-restore-server-portal.md) .

> [!IMPORTANT]
> Операции восстановления на гибком сервере создают новый сервер базы данных и не перезаписывают существующий сервер базы данных.

Восстановление до точки во времени подходит для большинства сценариев. Например, если пользователь случайно удалил данные, важные таблицы или базы данных либо если приложение в результате ошибки случайно перезаписало правильные данные неправильными. Вы сможете выполнить восстановление до последней транзакции из-за непрерывного резервного копирования журналов транзакций.

Можно выбрать между самой ранней точкой восстановления и пользовательской точкой восстановления.

-   **Самая ранняя точка восстановления**: в зависимости от срока хранения он будет самым ранним моментом, который можно восстановить. На портале будет выбрана самая старая длительность архивации. Это полезно, если вы хотите исследовать или протестировать запуск этого момента времени.

-   **Пользовательская точка восстановления**. Этот параметр позволяет выбрать любой момент времени в течение срока хранения, определенного для этого гибкого сервера. По умолчанию последняя дата в формате UTC выбирается Автовыбор и полезна, если требуется восстановить последнюю зафиксированную транзакцию для целей тестирования. При необходимости можно выбрать другие дни и время. 

Предполагаемое время восстановления зависит от нескольких факторов, включая размер базы данных, объем обрабатываемых журналов транзакций, пропускную способность сети и общее количество баз данных, восстанавливаемых в одном и том же регионе. Общее время восстановления обычно занимает от нескольких минут до нескольких часов.


> [!IMPORTANT]
> Удаленные серверы **нельзя** восстановить. Если вы удалите сервер, все связанные с ним базы данных также будут удалены без возможности восстановления. Чтобы защитить ресурсы сервера после развертывания от случайного удаления или внесения непредвиденных изменений, администраторы могут использовать [блокировки управления](../../azure-resource-manager/management/lock-resources.md).

## <a name="perform-post-restore-tasks"></a>Задачи после восстановления

После восстановления базы данных можно выполнить следующие задачи, чтобы сделать резервную копию и запуск пользователей и приложений:

-   Если новый сервер предназначен для замены исходного сервера, перенаправьте клиенты и клиентские приложения на новый сервер.

-   Чтобы пользователи могли подключаться, убедитесь, что установлены соответствующие правила брандмауэра на уровне сервера и виртуальной сети. Эти правила не копируются с исходного сервера.
  
-   При необходимости можно масштабировать вычисленные при восстановлении сервера.

-   Убедитесь, что имеются соответствующие имена входа и разрешения уровня базы данных.

-   Настройте оповещения соответствующим образом.
  
-  Если вы восстановили базу данных, настроенную с высокой доступностью, и хотите настроить для восстановленного сервера высокий уровень доступности, можно выполнить [действия](./how-to-manage-high-availability-portal.md).


## <a name="next-steps"></a>Дальнейшие действия

-   Сведения о [непрерывности бизнес-процессов](./concepts-business-continuity.md)
-   Сведения о [высокой доступности с избыточностью зоны](./concepts-high-availability.md)
-   Узнайте [, как восстановить](./how-to-restore-server-portal.md)