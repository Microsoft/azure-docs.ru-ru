---
title: Резервное копирование и восстановление — Azure PowerShell база данных Azure для PostgreSQL
description: Узнайте, как выполнить резервное копирование и восстановление сервера в базе данных Azure для PostgreSQL с помощью Azure PowerShell.
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.devlang: azurepowershell
ms.topic: how-to
ms.date: 06/08/2020
ms.custom: devx-track-azurepowershell
ms.openlocfilehash: 63fffb5998b0b6a245db3f1c8fcf16f2d576936e
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92489767"
---
# <a name="how-to-back-up-and-restore-an-azure-database-for-postgresql-server-using-powershell"></a>Как создать резервную копию сервера Базы данных Azure для PostgreSQL и восстановить сервер с помощью PowerShell

Периодически создается резервная копия базы данных Azure для серверов PostgreSQL, чтобы включить функции восстановления. С помощью этой функции можно восстановить сервер и все его базы данных до более ранней точки во времени на новом сервере.

## <a name="prerequisites"></a>Предварительные условия

Вот что вам нужно, чтобы выполнить инструкции, приведенные в этом руководстве:

- [Модуль AZ PowerShell](/powershell/azure/install-az-ps) , установленный локально или [Azure Cloud Shell](https://shell.azure.com/) в браузере
- [Сервер базы данных Azure для PostgreSQL](quickstart-create-postgresql-server-database-using-azure-powershell.md)

> [!IMPORTANT]
> Так как модуль Az.PostgreSql PowerShell предоставляется в режиме предварительной версии, его нужно установить отдельно от модуля Az с помощью команды `Install-Module -Name Az.PostgreSql -AllowPrerelease`.
> Как только модуль Az.PostgreSql PowerShell станет общедоступным, он будет включен в один из будущих выпусков Az PowerShell и встроен в Azure Cloud Shell.

Если вы решили использовать PowerShell локально, подключитесь к учетной записи Azure с помощью командлета [Connect-азаккаунт](/powershell/module/az.accounts/connect-azaccount) .

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="set-backup-configuration"></a>Настройка конфигурации резервного копирования

При создании сервера можно выбрать между настройками сервера для локально избыточных или географически избыточных резервных копий.

> [!NOTE]
> После создания сервера тип избыточности, географически избыточный и локально избыточный, нельзя изменить.

При создании сервера с помощью `New-AzPostgreSqlServer` команды параметр **жеоредундантбаккуп** определяет параметр избыточности резервной копии. Если этот **флажок установлен**, выполняются геоизбыточные резервные копии. Или, если **отключено**, будут выполняться локально избыточные резервные копии.

Срок хранения резервной копии задается параметром **баккупретентиондай** .

Дополнительные сведения об установке этих значений во время создания сервера см. в статье [Создание сервера базы данных Azure для PostgreSQL с помощью PowerShell](quickstart-create-postgresql-server-database-using-azure-powershell.md).

Вот как можно изменить срок хранения резервной копии сервера.

```azurepowershell-interactive
Update-AzPostgreSqlServer -Name mydemoserver -ResourceGroupName myresourcegroup -BackupRetentionDay 10
```

В указанном выше примере период хранения резервных копий mydemoserver изменен на 10 дней.

Срок хранения резервной копии зависит от того, насколько может быть получено восстановление на момент времени, так как оно основано на доступных резервных копиях. Восстановление до точки во времени описано в следующем разделе.

## <a name="server-point-in-time-restore"></a>Восстановление сервера до точки во времени

Вы можете восстановить сервер до предыдущей точки во времени. Восстановленные данные копируются на новый сервер, а исходный сервер остается неизменным. Например, если таблица была случайно удалена, ее можно восстановить на момент сразу перед удалением. Затем вы можете извлечь отсутствующие таблицы и данные из восстановленной копии сервера.

Чтобы восстановить сервер, используйте командлет PowerShell `Restore-AzPostgreSqlServer`.

### <a name="run-the-restore-command"></a>Выполнение команды restore

Чтобы восстановить сервер, выполните следующий пример в PowerShell.

```azurepowershell-interactive
$restorePointInTime = (Get-Date).AddMinutes(-10)
Get-AzPostgreSqlServer -Name mydemoserver -ResourceGroupName myresourcegroup |
  Restore-AzPostgreSqlServer -Name mydemoserver-restored -ResourceGroupName myresourcegroup -RestorePointInTime $restorePointInTime -UsePointInTimeRestore
```

Набор параметров **поинтинтимересторе** `Restore-AzPostgreSqlServer` командлета требует наличия следующих параметров:

| Параметр | Рекомендуемое значение | Описание  |
| --- | --- | --- |
| ResourceGroupName |  myresourcegroup |  Группа ресурсов, в которой находится исходный сервер.  |
| Имя | mydemoserver-restored | Имя нового сервера, созданного командой restore. |
| ресторепоинтинтиме | 2020-03-13T13:59:00Z | Выберите точку во времени для восстановления. Значения даты и времени должны находиться в пределах срока хранения резервной копии исходного сервера. Используйте формат даты и времени ISO8601. Например, можно использовать собственный местный часовой пояс, например **2020-03-13T05:59:00-08:00**. Можно также использовать формат UTC Zulu, например **2018-03-13T13:59:00Z**. |
| усепоинтинтимересторе | `<SwitchParameter>` | Используйте режим "на момент времени" для восстановления. |

При восстановлении сервера до более ранней точки во времени будет создан новый сервер. Исходный сервер и его базы данных, начиная с указанного момента во времени, копируются на новый сервер.

Значения расположения и ценовой категории для восстановленного сервера совпадают со значениями исходного сервера.

После завершения восстановления найдите новый сервер, чтобы убедиться, что данные были восстановлены, как и ожидалось. Имя и пароль администратора сервера для входа на него будут теми же, что и для исходного сервера в момент, когда было запущен процесс восстановления. Пароль можно изменить на странице **Обзор** для нового сервера.

На новом сервере, созданном во время восстановления, нет конечных точек службы виртуальной сети, которые настроены на исходном сервере. Для нового сервера правила нужно настроить отдельно. Правила брандмауэра восстанавливаются с исходного сервера.

## <a name="geo-restore"></a>Геовосстановление

Если вы настроили сервер для географически избыточных резервных копий, можно создать новый сервер из резервной копии существующего сервера. Его можно создать в любом регионе, где доступна службы "База данных Azure для PostgreSQL".

Чтобы создать сервер с помощью геоизбыточной резервной копии, используйте `Restore-AzPostgreSqlServer` команду с параметром **усежеоресторе** .

> [!NOTE]
> Сразу после создания сервер может быть еще не готов к географическому восстановлению. Заполнение метаданных может занять несколько часов.

Чтобы выполнить геовосстановление сервера, выполните следующий пример из PowerShell:

```azurepowershell-interactive
Get-AzPostgreSqlServer -Name mydemoserver -ResourceGroupName myresourcegroup |
  Restore-AzPostgreSqlServer -Name mydemoserver-georestored -ResourceGroupName myresourcegroup -Location eastus -Sku GP_Gen5_8 -UseGeoRestore
```

В этом примере создается новый сервер с именем **mydemoserver-геовосстановление** в регионе Восточная часть США, принадлежащий **myresourcegroup**. Это сервер общего назначения 5-го поколения с 8 виртуальными ядрами. Сервер создается из геоизбыточной резервной копии **mydemoserver**, также в группе ресурсов **myresourcegroup**.

Чтобы создать новый сервер в другой группе ресурсов с существующего сервера, укажите имя новой группы ресурсов с помощью параметра **ResourceGroupName** , как показано в следующем примере:

```azurepowershell-interactive
Get-AzPostgreSqlServer -Name mydemoserver -ResourceGroupName myresourcegroup |
  Restore-AzPostgreSqlServer -Name mydemoserver-georestored -ResourceGroupName newresourcegroup -Location eastus -Sku GP_Gen5_8 -UseGeoRestore
```

Набор параметров **геовосстановления** для `Restore-AzPostgreSqlServer` командлета требует наличия следующих параметров:

| Параметр | Рекомендуемое значение | Описание  |
| --- | --- | --- |
|ResourceGroupName | myresourcegroup | Имя группы ресурсов, к которой принадлежит новый сервер.|
|Имя | mydemoserver-georestored | Имя нового сервера. |
|Расположение | eastus | Расположение нового сервера. |
|усежеоресторе | `<SwitchParameter>` | Используйте географический режим для восстановления. |

При создании нового сервера с помощью географического восстановления он наследует тот же размер хранилища и ценовую категорию, что и исходный сервер, если не указан параметр **SKU** .

После завершения восстановления найдите новый сервер, чтобы убедиться, что данные были восстановлены, как и ожидалось. Имя и пароль администратора сервера для входа на него будут теми же, что и для исходного сервера в момент, когда было запущен процесс восстановления. Пароль можно изменить на странице **Обзор** для нового сервера.

На новом сервере, созданном во время восстановления, нет конечных точек службы виртуальной сети, которые настроены на исходном сервере. Эти правила должны быть настроены отдельно для этого нового сервера. Правила брандмауэра восстанавливаются с исходного сервера.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Создание строки подключения базы данных Azure для PostgreSQL с помощью PowerShell](howto-connection-string-powershell.md)