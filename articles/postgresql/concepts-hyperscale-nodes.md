---
title: Узлы — масштабирование (Цитус) — база данных Azure для PostgreSQL
description: Сведения о типах узлов и таблиц в группе серверов в базе данных Azure для PostgreSQL.
author: jonels-msft
ms.author: jonels
ms.service: postgresql
ms.subservice: hyperscale-citus
ms.topic: conceptual
ms.date: 07/28/2019
ms.openlocfilehash: b3eda2c8de8319552f32938f20ff98af0e0a49fc
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91314833"
---
# <a name="nodes-and-tables-in-azure-database-for-postgresql--hyperscale-citus"></a>Узлы и таблицы в базе данных Azure для PostgreSQL — масштабирование (Цитус)

## <a name="nodes"></a>Узлы

Тип размещения Scale Цитус позволяет серверам базы данных Azure для PostgreSQL (называемым узлами) координировать друг друга в архитектуре "Shared Nothing". Узлы в группе серверов совместно хранят больше данных и используют больше ядер ЦП, чем можно было бы на одном сервере. Архитектура также позволяет масштабировать базу данных, добавляя дополнительные узлы к группе серверов.

### <a name="coordinator-and-workers"></a>Координатор и рабочие роли

Каждая группа серверов имеет узел координатора и несколько рабочих ролей. Приложения отправляют свои запросы на узел координатора, который передает их соответствующим рабочим процессам и накапливает их результаты. Приложения не могут напрямую подключаться к рабочим процессам.

Масштабирование (Цитус) позволяет администратору базы данных *распространять* таблицы, сохраняя разные строки на разных рабочих узлах. Распределенные таблицы являются ключевыми для производительности Цитус. Невозможность распределения таблиц оставляет их полностью на узле координатора и не может воспользоваться преимуществами параллелизма между компьютерами.

Для каждого запроса в распределенных таблицах координатор либо направляет его в один рабочий узел, либо параллелизуются его в несколько в зависимости от того, находятся ли необходимые данные на одном узле или нескольких. Координатор решает, что делать с помощью таблиц метаданных консалтинга. Эти таблицы следят за DNS-именами и работоспособностью рабочих узлов, а также распределением данных между узлами.

## <a name="table-types"></a>Типы таблиц

Существует три типа таблиц в группе серверов Цитус, каждая из которых хранится на узлах по-разному и используется для разных целей.

### <a name="type-1-distributed-tables"></a>Тип 1: распределенные таблицы

Первый и наиболее распространенный тип — это распределенные таблицы. Они выглядят как обычные таблицы для инструкций SQL, но они горизонтально секционированы между рабочими узлами. Это означает, что строки таблицы хранятся на разных узлах в таблицах фрагментов, называемых сегментами.

В процессе масштабирования (Цитус) выполняется не только SQL, но и инструкции DDL в кластере.
Изменение схемы распределенной таблицы каскадом для обновления всех сегментов таблицы между рабочими процессами.

#### <a name="distribution-column"></a>Столбец распределения

Функция "масштабирование" (Цитус) использует алгоритм сегментирования для назначения строк сегментам. Присваивание выполняется детерминированно на основе значения столбца таблицы, называемого столбцом распределения. Администратор кластера должен назначить этот столбец при распространении таблицы.
Правильный вариант важен для производительности и функциональности.

### <a name="type-2-reference-tables"></a>Тип 2: ссылочные таблицы

Ссылочная таблица — это тип распределенной таблицы, все содержимое которого Concentrated в один сегмент. Сегмент реплицируется на каждом рабочем процессе. Запросы к любой рабочей роли могут обращаться к справочным сведениям локально, не требуя от сети дополнительных расходов на запрос строк из другого узла. Ссылочные таблицы не имеют столбца распределения, поскольку нет необходимости различать отдельные сегменты в строке.

Ссылочные таблицы обычно невелики и используются для хранения данных, относящихся к запросам, выполняемым на любом рабочем узле. Примером являются перечислимые значения, такие как состояния заказов или категории продуктов.

### <a name="type-3-local-tables"></a>Тип 3: локальные таблицы

При использовании масштабирования (Цитус) узел координатора, к которому выполняется подключение, является обычной базой данных PostgreSQL. Вы можете создать обычные таблицы в координаторе и отказаться от их сегментирования.

Хорошим кандидатом для локальных таблиц являются небольшие административные таблицы, которые не участвуют в запросах JOIN. Примером является таблица Users для входа и проверки подлинности приложения.

## <a name="shards"></a>Сегментов

В предыдущем разделе описано, как распределенные таблицы хранятся в качестве сегментов на рабочих узлах. В этом разделе рассматриваются дополнительные технические подробности.

`pg_dist_shard`Таблица метаданных в координаторе содержит по одной строке для каждого сегмента распределенной таблицы в системе. Строка соответствует ИДЕНТИФИКАТОРу сегмента с диапазоном целых чисел в пространстве хэша (шардминвалуе, шардмаксвалуе).

```sql
SELECT * from pg_dist_shard;
 logicalrelid  | shardid | shardstorage | shardminvalue | shardmaxvalue
---------------+---------+--------------+---------------+---------------
 github_events |  102026 | t            | 268435456     | 402653183
 github_events |  102027 | t            | 402653184     | 536870911
 github_events |  102028 | t            | 536870912     | 671088639
 github_events |  102029 | t            | 671088640     | 805306367
 (4 rows)
```

Если узел координатор хочет определить, какой сегмент содержит строку `github_events` , он хэширует значение столбца распределения в строке. Затем узел проверяет, какой \' диапазон сегментов содержит хэшированное значение. Диапазоны определяются таким образом, чтобы изображение хэш-функции было несвязанным объединением.

### <a name="shard-placements"></a>Размещения сегментов

Предположим, что сегмент 102027 связан с рассматриваемой строкой. Строка считывается или записывается в таблицу, которая называется `github_events_102027` одним из рабочих ролей. Какой работник? Это полностью определено таблицами метаданных. Сопоставление сегмента и рабочей роли называется размещением сегментов.

Узел координатор переписывает запросы в фрагменты, которые ссылаются на конкретные таблицы, например `github_events_102027` , и выполняет эти фрагменты на соответствующих рабочих процессах. Ниже приведен пример запроса, выполняемого в фоновом режиме для поиска узла с ИДЕНТИФИКАТОРом сегмента 102027.

```sql
SELECT
    shardid,
    node.nodename,
    node.nodeport
FROM pg_dist_placement placement
JOIN pg_dist_node node
  ON placement.groupid = node.groupid
 AND node.noderole = 'primary'::noderole
WHERE shardid = 102027;
```

```output
┌─────────┬───────────┬──────────┐
│ shardid │ nodename  │ nodeport │
├─────────┼───────────┼──────────┤
│  102027 │ localhost │     5433 │
└─────────┴───────────┴──────────┘
```

## <a name="next-steps"></a>Дальнейшие действия

- [Определение типа приложения](concepts-hyperscale-app-type.md) для подготовки к моделированию данных
