---
title: Правила виртуальной сети — база данных Azure для PostgreSQL — один сервер
description: Узнайте, как использовать конечные точки службы виртуальной сети для подключения к базе данных Azure для PostgreSQL-Single Server.
author: niklarin
ms.author: nlarin
ms.service: postgresql
ms.topic: conceptual
ms.date: 07/17/2020
ms.openlocfilehash: b875936e13edfe0eff12f253836b093796951308
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98876332"
---
# <a name="use-virtual-network-service-endpoints-and-rules-for-azure-database-for-postgresql---single-server"></a>Использование конечных точек службы и правил виртуальной сети для базы данных Azure для PostgreSQL — один сервер

*Правила виртуальной сети* — это одна из функций безопасности брандмауэра, которая определяет, будет ли сервер базы данных Azure для PostgreSQL принимать подключения, отправляемые из определенных подсетей в виртуальные сети. В этой статье объясняется, почему правила виртуальной сети иногда являются лучшим вариантом для защиты подключений к серверу Базы данных Azure для PostgreSQL.

Чтобы создать правило виртуальной сети, требуется [виртуальная сеть][vm-virtual-network-overview] и [конечная точка службы для виртуальной сети][vm-virtual-network-service-endpoints-overview-649d], используемая для ссылки. На следующем рисунке показано, как конечная точка службы для виртуальной сети работает с Базой данных Azure для PostgreSQL.

:::image type="content" source="media/concepts-data-access-and-security-vnet/vnet-concept.png" alt-text="Пример того, как работает конечная точка службы виртуальной сети":::

> [!NOTE]
> Эта функция доступна во всех облаках общедоступного облака Azure, где База данных Azure для PostgreSQL развернута для серверов общего назначения и оптимизирована для операций в памяти.
> В случае пиринга между виртуальными сетями, если трафик проходит через общий шлюз виртуальной сети с конечными точками и должен попадать в кэширующий узел, создайте правило ACL или виртуальной сети, чтобы разрешить виртуальным машинам Azure в шлюзе виртуальной сети доступ к Базе данных Azure для сервера PostgreSQL.

Можно также использовать [частную ссылку](concepts-data-access-and-security-private-link.md) для подключений. Частная ссылка предоставляет частный IP-адрес в виртуальной сети для сервера базы данных Azure для PostgreSQL.

<a name="anch-terminology-and-description-82f"></a>
## <a name="terminology-and-description"></a>Терминология и описание

**Виртуальная сеть**. С подпиской Azure могут быть связаны виртуальные сети.

**Подсеть**. Виртуальная сеть содержит **подсети**. Все виртуальные машины Azure в виртуальной сети назначаются в подсеть. Подсеть может содержать несколько виртуальных машин и (или) других расчетных узлов. Вычислительные узлы, которые находятся вне вашей виртуальной сети, не имеют доступа к ней, если только не настроить систему безопасности таким образом, чтобы предоставить им доступ.

**Конечная точка службы для виртуальной сети.** [Конечная точка службы для виртуальной сети][vm-virtual-network-service-endpoints-overview-649d] — это подсеть, значения свойств которой включают в себя одно формальное имя типа службы Azure или несколько. В этой статье мы рассмотрим тип **Microsoft.Sql**, который относится к службе Azure, которая называется Базой данных SQL. Этот тег службы также применяется к службам "База данных Azure для PostgreSQL" и "База данных Azure для MySQL". Важно отметить, что при применении тега службы **Microsoft. SQL** к конечной точке службы виртуальной сети будет настраиваться трафик конечной точки службы для служб базы данных Azure: база данных SQL, Azure синапсе Analytics, база данных Azure для PostgreSQL и серверы базы данных Azure для MySQL в подсети. 

**Правило виртуальной сети**. Правило виртуальной сети для сервера базы данных Azure для PostgreSQL — это подсеть, которая указана в списке управления доступом (ACL) сервера Базы данных Azure для PostgreSQL. Для включения в ACL для сервера базы данных Azure для PostgreSQL подсеть должна содержать имя типа **Microsoft.Sql**.

Правило виртуальной сети предписывает серверу Базы данных Azure для PostgreSQL принимать подключения от всех узлов, находящихся в подсети.

<a name="anch-details-about-vnet-rules-38q"></a>

## <a name="benefits-of-a-virtual-network-rule"></a>Преимущества правила виртуальной сети

Пока вы не выполните действия, виртуальные машины в подсетях не смогут взаимодействовать с сервером базы данных Azure для PostgreSQL. Создание правила виртуальной сети — это единственное действие, которое устанавливает подключение. Чтобы обосновать выбор подхода на основе правил виртуальной сети, требуется сравнить преимущества и недостатки этого подхода с конкурирующими функциями безопасности, предоставляемыми брандмауэром.

### <a name="allow-access-to-azure-services"></a>Разрешение доступа службам Azure

На панели безопасности подключения есть кнопка **Вкл./Выкл.** с надписью **Разрешить доступ к службам Azure**. Значение **ON** (Вкл.) разрешает подключение со всех IP-адресов Azure и из всех подсетей Azure. Эти Azure IP-адреса и подсети могут принадлежать не вам. Возможно, значение **Вкл.** делает вашу систему более открытой, чем требуется для Базы данных Azure для PostgreSQL. Правила виртуальной сети обеспечивают более детализированный контроль.

### <a name="ip-rules"></a>Правила фильтрации IP-адресов

Брандмауэр Базы данных Azure для PostgreSQL позволяет указать диапазоны IP-адресов, подключения с которых принимаются Базой данных Azure для PostgreSQL. Эта методика хорошо подходит для постоянных IP-адресов, которые находятся за пределами частной сети Azure. Однако за пределами частной сети Azure используется множество *динамических* IP-адресов. Динамические IP-адреса могут изменяться, например при перезапуске виртуальной машины. Было бы неразумно указывать динамический IP-адрес в правиле брандмауэра в рабочей среде.

Можно сохранить выбранный IP-адрес, присвоив виртуальной машине *статический* IP-адрес. Дополнительные сведения см. в разделе [Настройка частных IP-адресов для виртуальной машины с помощью портала Azure][vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w].

Однако применение статических IP-адресов может усложнить управление и создать дополнительные расходы при увеличении масштаба среды. Правила виртуальной сети проще устанавливать и контролировать.


<a name="anch-details-about-vnet-rules-38q"></a>

## <a name="details-about-virtual-network-rules"></a>Сведения о правилах виртуальной сети

В этом разделе приводятся некоторые сведения о правилах виртуальной сети.

### <a name="only-one-geographic-region"></a>Только один географический регион

Каждая конечная точка службы для виртуальной сети может использоваться только в одном регионе Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах.

Любое правило виртуальной сети ограничена регионом, в котором используется базовая конечная точка.

### <a name="server-level-not-database-level"></a>На уровне сервера, а не базы данных

Каждое правило виртуальной сети применяется ко всему серверу Базы данных Azure для PostgreSQL, не только к одной конкретной базе данных на сервере. Другими словами, правило виртуальной сети применяется на уровне сервера,а не на уровне базы данных.

#### <a name="security-administration-roles"></a>Роли администратора безопасности

Роли безопасности для администрирования конечных точек служб для виртуальной сети разделены. Требуется действие каждой из следующих ролей:

- **администратор сети:** &nbsp; включение конечной точки;
- **администратор базы данных:** &nbsp; обновление списка управления доступом (ACL) для добавления данной подсети на сервер Базы данных Azure для PostgreSQL.

*Альтернатива Azure RBAC:*

Роли администратора сети и администратора базы данных имеют больше возможностей, чем требуется для управления правилами виртуальной сети. На самом деле для этого требуется только часть их возможностей.

Вы можете использовать [Управление доступом на основе ролей Azure (Azure RBAC)][rbac-what-is-813s] в Azure, чтобы создать одну настраиваемую роль, имеющую только необходимое подмножество возможностей. Вместо администратора сети или администратора базы данных можно использовать пользовательскую роль. При добавлении пользователя в пользовательскую роль контактная зона снижает уровень безопасности, а не добавляет пользователя к двум другим основным ролям администратора.

> [!NOTE]
> Иногда База данных Azure для PostgreSQL и подсеть виртуальной сети относятся к разным подпискам. В этих случаях необходимо обеспечить следующую конфигурацию:
> - Обе подписки должны быть в одном клиенте Azure Active Directory.
> - Пользователь должен иметь необходимые разрешения для запуска операций, например для включения конечных точек службы или добавления подсети виртуальной сети к заданному серверу.
> - Убедитесь, что у обеих подписок есть зарегистрированный поставщик ресурсов **Microsoft. SQL** и **Microsoft. дбфорпостгрескл** . Дополнительные сведения см. в разделе [resource-manager-registration][resource-manager-portal]

## <a name="limitations"></a>Ограничения

Для Базы данных Azure для PostgreSQL правила виртуальной сети имеют следующие ограничения:

- Веб-приложения можно сопоставить с частным IP-адресом в виртуальной сети или подсети. Даже если конечные точки службы включены в определенной виртуальной сети или подсети, при подключении из веб-приложения к серверу в качестве источника будет использоваться открытый IP-адрес Azure, виртуальная сеть или подсеть. Чтобы обеспечить подключение из веб-приложения к серверу, на котором установлены правила брандмауэра виртуальной сети, включите параметр Разрешить службам Azure доступ к серверу на сервере.

- В брандмауэре для Базы данных Azure для PostgreSQL каждое правило виртуальной сети ссылается на подсеть. Все такие упомянутые подсети должны размещаться в том же географическом регионе, где размещена База данных Azure для PostgreSQL.

- Каждый сервер Базы данных Azure для PostgreSQL может использовать до 128 записей ACL для любой заданной виртуальной сети.

- Правила виртуальной сети применяются только к виртуальным сетям Azure Resource Manager, но не к сетям на основе [классической модели развертывания][arm-deployment-model-568f].

- Включение конечных точек службы виртуальной сети в базу данных Azure для PostgreSQL с помощью тега службы **Microsoft. SQL** также позволяет использовать конечные точки для всех служб базы данных Azure: база данных Azure для MySQL, база данных Azure для PostgreSQL, база данных SQL Azure и аналитика синапсе Azure.

- Поддержка конечных точек службы виртуальной сети предназначена только для серверов общего назначения и серверов, оптимизированных для операций в памяти.

- Если **Microsoft. SQL** включен в подсети, это означает, что для подключения нужно использовать только правила виртуальной сети. [Правила брандмауэра, не связанные с виртуальной](concepts-firewall-rules.md) сетью, для ресурсов в этой подсети не будут работать.

- К приведенным ниже элементам сети применяются диапазоны IP-адресов в брандмауэре, а правила виртуальной сети — нет:
    - [виртуальная частная сеть (VPN) типа "сеть — сеть"][vpn-gateway-indexmd-608y].
    - Локальная среда с помощью [ExpressRoute][expressroute-indexmd-744v]

## <a name="expressroute"></a>ExpressRoute

Если сеть подключена к сети Azure с использованием [ExpressRoute][expressroute-indexmd-744v], то для каждого канала настроены два общедоступных IP-адреса в Microsoft Edge. Эти два IP-адреса используются для подключения к службам Майкрософт, таким как служба хранилища Azure, с помощью общедоступного пиринга Azure.

Чтобы разрешить взаимодействие канала с Базой данных Azure для PostgreSQL, необходимо создать правила IP-сети для общедоступных IP-адресов каналов. Чтобы найти общедоступные IP-адреса канала ExpressRoute, отправьте запрос по ExpressRoute в службу поддержки через портал Azure.

## <a name="adding-a-vnet-firewall-rule-to-your-server-without-turning-on-vnet-service-endpoints"></a>Добавление правила брандмауэра виртуальной сети на сервер без включения конечных точек службы виртуальной сети

Просто Настройка правила брандмауэра виртуальной сети не помогает защитить сервер в виртуальной сети. Для безопасности нужно **включить** конечные точки службы виртуальной сети. При **включении** конечных точек службы подсеть виртуальной сети будет простаивать, пока не будет выполнен переход из состояния **Выкл.** в состояние **Вкл.** Это особенно верно в случае с большими виртуальными сетями. С помощью параметра **IgnoreMissingServiceEndpoint** можно уменьшить или исключить время простоя во время перехода.

Задать параметр **IgnoreMissingServiceEndpoint** можно с помощью Azure CLI или портала.

## <a name="related-articles"></a>Связанные статьи
- [Виртуальные сети Azure][vm-virtual-network-overview]
- [Конечные точки службы виртуальной сети Azure][vm-virtual-network-service-endpoints-overview-649d]

## <a name="next-steps"></a>Дальнейшие действия
Статьи о создании правил виртуальной сети см. по следующим ссылкам:
- [Create and manage Azure Database for PostgreSQL VNet service endpoints and VNet rules by using the Azure portal](howto-manage-vnet-using-portal.md) (Создание конечных точек службы виртуальной сети Базы данных Azure для PostgreSQL и правил виртуальной сети с использованием портала Azure)
- [Create and manage Azure Database for PostgreSQL VNet service endpoints using Azure CLI](howto-manage-vnet-using-cli.md) (Создание конечных точек службы виртуальной сети Базы данных Azure для PostgreSQL и правил виртуальной сети с использованием интерфейса командной строки Azure)


<!-- Link references, to text, Within this same GitHub repo. -->
[arm-deployment-model-568f]: ../azure-resource-manager/management/deployment-models.md

[vm-virtual-network-overview]: ../virtual-network/virtual-networks-overview.md

[vm-virtual-network-service-endpoints-overview-649d]: ../virtual-network/virtual-network-service-endpoints-overview.md

[vm-configure-private-ip-addresses-for-a-virtual-machine-using-the-azure-portal-321w]: ../virtual-network/virtual-networks-static-private-ip-arm-pportal.md

[rbac-what-is-813s]: ../role-based-access-control/overview.md

[vpn-gateway-indexmd-608y]: ../vpn-gateway/index.yml

[expressroute-indexmd-744v]: ../expressroute/index.yml

[resource-manager-portal]: ../azure-resource-manager/management/resource-providers-and-types.md
