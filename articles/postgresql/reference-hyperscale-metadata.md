---
title: Системные таблицы — масштабирование (Цитус) — база данных Azure для PostgreSQL
description: Метаданные для выполнения распределенных запросов
author: jonels-msft
ms.author: jonels
ms.service: postgresql
ms.subservice: hyperscale-citus
ms.topic: reference
ms.date: 08/10/2020
ms.openlocfilehash: 74403365fe48584fa5d1db0e349c9dfc3772d874
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97652862"
---
# <a name="system-tables-and-views"></a>Системные таблицы и представления

Масштабирование (Цитус) создает и поддерживает специальные таблицы, содержащие сведения о распределенных данных в группе серверов. Узел координатора обращается к этим таблицам при планировании выполнения запросов между рабочими узлами.

## <a name="coordinator-metadata"></a>Метаданные координатора

Масштабирование (Цитус) делит каждую распределенную таблицу на несколько логических сегментов на основе столбца распределения. Затем координатор обслуживает таблицы метаданных для сбора статистики и сведений о работоспособности и расположении этих сегментов.

В этом разделе мы рассмотрим каждую из этих таблиц метаданных и их схему.
Вы можете просматривать и запрашивать эти таблицы с помощью SQL после входа в узел координатора.

> [!NOTE]
>
> Группы серверов масштаба (Цитус), работающие под управлением старых версий подсистемы Цитус, могут не предлагать все перечисленные ниже таблицы.

### <a name="partition-table"></a>Таблица секционирования

В таблице «PG \_ расп \_ Partition» хранятся метаданные о том, какие таблицы в базе данных распределяются. Для каждой распределенной таблицы также хранятся сведения о методе распределения и подробные сведения о столбце распределения.

| Имя         | Type     | Описание                                                                                                                                                                                                                                           |
|--------------|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| логикалрелид | регкласс | Распределенная таблица, которой соответствует эта строка. Это значение ссылается на столбец релфиленоде в таблице системного каталога pg_class.                                                                                                                   |
| партмесод   | char     | Метод, используемый для секционирования и распространения. Значения этого столбца, соответствующие разным методам распределения, добавляются: "a", хэш: "h", ссылочная таблица: "n"                                                                          |
| парткэй      | текст     | Подробные сведения о столбце распределения, включая номер столбца, тип и другие релевантные сведения.                                                                                                                                      |
| колокатионид | Целое число  | Группа совместного размещения, к которой принадлежит эта таблица. Таблицы в одной группе позволяют использовать совместно расположенные объединения и распределенные свертки между другими оптимизациями. Это значение ссылается на столбец колокатионид в таблице pg_dist_colocation.                      |
| репмодел     | char     | Метод, используемый для репликации данных. Значения этого столбца, соответствующие разным методам репликации: Цитус репликация на основе инструкций: "c", PostgreSQL Streaming Replication: ", двухфазной фиксация (для ссылочных таблиц): 't" |

```
SELECT * from pg_dist_partition;
 logicalrelid  | partmethod |                                                        partkey                                                         | colocationid | repmodel 
---------------+------------+------------------------------------------------------------------------------------------------------------------------+--------------+----------
 github_events | h          | {VAR :varno 1 :varattno 4 :vartype 20 :vartypmod -1 :varcollid 0 :varlevelsup 0 :varnoold 1 :varoattno 4 :location -1} |            2 | c
 (1 row)
```

### <a name="shard-table"></a>Таблица сегментов

В \_ \_ таблице сегмента PG расп хранятся метаданные об отдельных сегментах таблицы. Pg_dist_shard содержит сведения о том, к каким сегментам распределенных таблиц относятся данные, и статистику по столбцу распределения для сегментов.
Для добавления распределенных таблиц эти статистические данные соответствуют минимальным и максимальным значениям столбца распределения. Для распределенных хэш-таблиц они являются диапазонами хэш-токенов, назначенными этому сегменту. Эти статистические данные используются для удаления несвязанных сегментов во время запросов SELECT.

| Имя          | Type     | Описание                                                                                                                                                                                  |
|---------------|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| логикалрелид  | регкласс | Распределенная таблица, которой соответствует эта строка. Это значение ссылается на столбец релфиленоде в таблице системного каталога pg_class.                                                          |
| шардид       | BIGINT   | Глобальный уникальный идентификатор, назначенный этому сегменту.                                                                                                                                           |
| шардстораже  | char     | Тип хранилища, используемого для этого сегмента. В таблице ниже описаны различные типы хранилищ.                                                                                               |
| шардминвалуе | текст     | Для добавления распределенных таблиц — минимальное значение столбца распределения в этом сегменте (включительно). Для хэш-распределенных таблиц значение минимального хэш-токена назначается этому сегменту (включающему). |
| шардмаксвалуе | текст     | Для добавления распределенных таблиц — максимальное значение столбца распределения в этом сегменте (включительно). Для хэш-распределенных таблиц максимальное значение хэш-токена, назначенное этому сегменту (включающее). |

```
SELECT * from pg_dist_shard;
 logicalrelid  | shardid | shardstorage | shardminvalue | shardmaxvalue 
---------------+---------+--------------+---------------+---------------
 github_events |  102026 | t            | 268435456     | 402653183
 github_events |  102027 | t            | 402653184     | 536870911
 github_events |  102028 | t            | 536870912     | 671088639
 github_events |  102029 | t            | 671088640     | 805306367
 (4 rows)
```

#### <a name="shard-storage-types"></a>Типы хранилища сегментов

Столбец шардстораже в сегменте PG \_ расп \_ указывает тип хранилища, используемого для сегмента. Ниже приведен краткий обзор различных типов хранилищ сегментов и их представлений.

| Тип хранения | Значение шардстораже | Описание                                                                        |
|--------------|--------------------|------------------------------------------------------------------------------------|
| TABLE        | е                | Указывает, что сегмент хранит данные, принадлежащие к обычной распределенной таблице.         |
| ОДИН     | ц                | Указывает, что сегмент хранит данные по столбцам. (Используется распределенными cstore_fdw таблицами) |
| FOREIGN      | ж                | Указывает, что сегмент хранит внешние данные. (Используется распределенными file_fdw таблицами)    |

### <a name="shard-placement-table"></a>Таблица размещения сегментов

\_Таблица размещения PGD расп \_ отслеживает расположение реплик сегментов на рабочих узлах. Каждая реплика сегмента, назначенного определенному узлу, называется размещением сегментов. В этой таблице хранятся сведения о работоспособности и расположении каждого размещения сегментов.

| Имя        | Type   | Описание                                                                                                                               |
|-------------|--------|-------------------------------------------------------------------------------------------------------------------------------------------|
| шардид     | BIGINT | Идентификатор сегмента, связанный с этим размещением. Это значение ссылается на столбец шардид в таблице pg_dist_shard каталога.             |
| шардстате  | INT    | Описывает состояние этого размещения. В разделе ниже рассматриваются различные состояния сегментов.                                         |
| шардленгс | BIGINT | Для добавления распределенных таблиц — размер размещения сегментов на рабочем узле в байтах. Для хэш-распределенных таблиц нулевое значение.            |
| плацементид | BIGINT | Уникальный автоматически сформированный идентификатор для каждого отдельного размещения.                                                                           |
| groupid     | INT    | Обозначает группу из одного основного сервера и нуль или более серверов-получателей при использовании модели репликации потоковой передачи. |

```
SELECT * from pg_dist_placement;
  shardid | shardstate | shardlength | placementid | groupid
 ---------+------------+-------------+-------------+---------
   102008 |          1 |           0 |           1 |       1
   102008 |          1 |           0 |           2 |       2
   102009 |          1 |           0 |           3 |       2
   102009 |          1 |           0 |           4 |       3
   102010 |          1 |           0 |           5 |       3
   102010 |          1 |           0 |           6 |       4
   102011 |          1 |           0 |           7 |       4
```

#### <a name="shard-placement-states"></a>Состояния размещения сегментов

Функция "масштабирование" (Цитус) управляет работоспособностью сегментов на основе каждого размещения. Если размещение помещает систему в непротиворечивое состояние, Цитус автоматически помечает его как недоступный. Состояние размещения записывается в таблицу pg_dist_shard_placement в столбце шардстате. Ниже приведен краткий обзор различных состояний размещения сегментов.

| Имя состояния | Значение шардстате | Описание                                                                                                                                                                                                                                                                                                                                                                                                                         |
|------------|------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ЗАВЕРШЕНА  | 1                | Состояние новых сегментов создается в. Размещения сегментов в этом состоянии считаются актуальными и используются при планировании и выполнении запросов.                                                                                                                                                                                                                                                                                 |
| INACTIVE   | 3                | Размещения сегментов в этом состоянии считаются неактивными из-за отсутствия синхронизации с другими репликами того же сегмента. Состояние может возникать при сбое операций добавления, изменения (вставки, обновления, удаления) или операции DDL для этого размещения. Планировщик запросов будет игнорировать размещения в этом состоянии во время планирования и выполнения. Пользователи могут синхронизировать данные в этих сегментах с конечной репликой в качестве фонового действия. |
| TO_DELETE  | 4                | Если Цитус пытается удалить размещение сегмента в ответ на вызов master_apply_delete_command и завершается ошибкой, размещение перемещается в это состояние. Затем пользователи могут удалить эти сегменты в качестве последующих фоновых действий.                                                                                                                                                                                                              |

### <a name="worker-node-table"></a>Таблица рабочих узлов

Таблица PG \_ расп \_ node содержит сведения о рабочих узлах в кластере.

| Имя             | Type    | Описание                                                                                                                                                                                |
|------------------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| nodeId           | INT     | Автоматически сформированный идентификатор для отдельного узла.                                                                                                                                          |
| groupid          | INT     | Идентификатор, используемый для обозначения группы из одного сервера-источника и нуль или более серверов-получателей, если используется модель потоковой репликации. По умолчанию он совпадает с NodeId.         |
| nodeName         | текст    | Имя узла или IP-адрес рабочего узла PostgreSQL.                                                                                                                                     |
| нодепорт         | INT     | Номер порта, на котором прослушивается рабочий узел PostgreSQL.                                                                                                                              |
| нодеракк         | текст    | Используемых Сведения о размещении в стойке для рабочего узла.                                                                                                                                 |
| хасметадата      | Логическое | Зарезервировано для внутреннего использования.                                                                                                                                                                 |
| IsActive         | Логическое | Является ли узел активным принятием размещений сегментов.                                                                                                                                     |
| нодероле         | текст    | Является ли узел первичным или вторичным                                                                                                                                                 |
| нодеклустер      | текст    | Имя кластера, содержащего этот узел                                                                                                                                               |
| шаулдхавешардс | Логическое | Если значение равно false, сегменты будут перемещены из узла (в стоке) при повторном распределении, а сегменты из новых распределенных таблиц не будут помещены на узел, если они не расположены вместе с сегментами. |

```
SELECT * from pg_dist_node;
 nodeid | groupid | nodename  | nodeport | noderack | hasmetadata | isactive | noderole | nodecluster | shouldhaveshards
--------+---------+-----------+----------+----------+-------------+----------+----------+-------------+------------------
      1 |       1 | localhost |    12345 | default  | f           | t        | primary  | default     | t
      2 |       2 | localhost |    12346 | default  | f           | t        | primary  | default     | t
      3 |       3 | localhost |    12347 | default  | f           | t        | primary  | default     | t
(3 rows)
```

### <a name="distributed-object-table"></a>Таблица распределенных объектов

\_ \_ Таблица объектов citus.PG расп содержит список объектов, таких как типы и функции, которые были созданы на узле координатора и распространяются на рабочие узлы. Когда администратор добавляет в кластер новые рабочие узлы, Цитус автоматически создает копии распределенных объектов на новых узлах (в правильном порядке для удовлетворения зависимостей объектов).

| Имя                        | Type    | Описание                                          |
|-----------------------------|---------|------------------------------------------------------|
| classid                     | oid     | Класс распределенного объекта                      |
| objid                       | oid     | Идентификатор объекта распределенного объекта                  |
| обжсубид                    | Целое число | Подтип объекта для распределенного объекта, например аттнум |
| тип                        | текст    | Часть стабильного адреса, используемого во время обновления PG   |
| object_names                | Text []  | Часть стабильного адреса, используемого во время обновления PG   |
| object_args                 | Text []  | Часть стабильного адреса, используемого во время обновления PG   |
| distribution_argument_index | Целое число | Допускается только для распределенных функций и процедур      |
| колокатионид                | Целое число | Допускается только для распределенных функций и процедур      |

\"Стабильные адреса \" однозначно идентифицируют объекты независимо от конкретного сервера. Функция масштабирования (Цитус) отслеживает объекты во время обновления PostgreSQL, используя стабильные адреса, созданные с помощью функции [ \_ \_ \_ \_ Address ()](https://www.postgresql.org/docs/current/functions-info.html#FUNCTIONS-INFO-OBJECT-TABLE) .

Ниже приведен \' пример `create_distributed_function()` добавления записей в `citus.pg_dist_object` таблицу.

```psql
CREATE TYPE stoplight AS enum ('green', 'yellow', 'red');

CREATE OR REPLACE FUNCTION intersection()
RETURNS stoplight AS $$
DECLARE
        color stoplight;
BEGIN
        SELECT *
          FROM unnest(enum_range(NULL::stoplight)) INTO color
         ORDER BY random() LIMIT 1;
        RETURN color;
END;
$$ LANGUAGE plpgsql VOLATILE;

SELECT create_distributed_function('intersection()');

-- will have two rows, one for the TYPE and one for the FUNCTION
TABLE citus.pg_dist_object;
```

```
-[ RECORD 1 ]---------------+------
classid                     | 1247
objid                       | 16780
objsubid                    | 0
type                        |
object_names                |
object_args                 |
distribution_argument_index |
colocationid                |
-[ RECORD 2 ]---------------+------
classid                     | 1255
objid                       | 16788
objsubid                    | 0
type                        |
object_names                |
object_args                 |
distribution_argument_index |
colocationid                |
```

### <a name="colocation-group-table"></a>Таблица групп совместного размещения

Таблица по \_ \_ совместному расположению PG расп содержит сведения о том, какие сегменты таблиц \' должны размещаться вместе или [соразмещены](concepts-hyperscale-colocation.md).
Если две таблицы находятся в одной и той же группе совместного размещения, то масштабирование (Цитус) обеспечивает размещение сегментов с одинаковыми значениями секций на одних и тех же рабочих узлах.
Совместное размещение позволяет оптимизировать соединение, определенные распределенные свертки и поддержку внешних ключей. Совместное расположение сегментов выводится при условии, что количество сегментов, факторы репликации и типы столбцов секционирования соответствуют двум таблицам. Однако при создании распределенной таблицы можно указать пользовательскую группу совместного размещения, если это необходимо.

| Имя                   | Type | Описание                                                                   |
|------------------------|------|-------------------------------------------------------------------------------|
| колокатионид           | INT  | Уникальный идентификатор группы совместного размещения, которой соответствует эта строка.          |
| шардкаунт             | INT  | Число сегментов для всех таблиц в этой группе совместного размещения                          |
| репликатионфактор      | INT  | Коэффициент репликации для всех таблиц в этой группе совместного размещения.                  |
| дистрибутионколумнтипе | oid  | Тип столбца распределения для всех таблиц в этой группе совместного размещения. |

```
SELECT * from pg_dist_colocation;
  colocationid | shardcount | replicationfactor | distributioncolumntype 
 --------------+------------+-------------------+------------------------
             2 |         32 |                 2 |                     20
  (1 row)
```

### <a name="rebalancer-strategy-table"></a>Таблица стратегии перебалансировки

В этой таблице определяются стратегии, которые [rebalance_table_shards](reference-hyperscale-functions.md#rebalance_table_shards) могут использовать для определения места перемещения сегментов.

| Имя                           | Type    | Описание                                                                                                                                       |
|--------------------------------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| default_strategy               | Логическое | Следует ли rebalance_table_shards по умолчанию выбирать эту стратегию. Использовать citus_set_default_rebalance_strategy для обновления этого столбца             |
| shard_cost_function            | регпрок | Идентификатор для функции затрат, который должен принимать шардид как bigint и возвращать его понятие стоимости, как тип Real                                |
| node_capacity_function         | регпрок | Идентификатор для функции Capacity, который должен принимать NodeId как int и возвращать его понятие о емкости узла как вещественного типа                          |
| shard_allowed_on_node_function | регпрок | Идентификатор для функции, заданной шардид bigint и нодеидарг int, возвращает логическое значение, определяющее, может ли Цитус хранить сегмент на узле. |
| default_threshold              | float4  | Пороговое значение для определения того, что узел слишком полон или слишком пуст, что определяет, когда rebalance_table_shards должен попытаться переместить сегменты                    |
| minimum_threshold              | float4  | Мера предосторожности, чтобы предотвратить слишком низкое значение аргумента порогового значения rebalance_table_shards ()                                                  |

В таблице ниже прилагается установка Цитус (масштабирование).

```postgresql
SELECT * FROM pg_dist_rebalance_strategy;
```

```
-[ RECORD 1 ]-------------------+-----------------------------------
Name                            | by_shard_count
default_strategy                | true
shard_cost_function             | citus_shard_cost_1
node_capacity_function          | citus_node_capacity_1
shard_allowed_on_node_function  | citus_shard_allowed_on_node_true
default_threshold               | 0
minimum_threshold               | 0
-[ RECORD 2 ]-------------------+-----------------------------------
Name                            | by_disk_size
default_strategy                | false
shard_cost_function             | citus_shard_cost_by_disk_size
node_capacity_function          | citus_node_capacity_1
shard_allowed_on_node_function  | citus_shard_allowed_on_node_true
default_threshold               | 0.1
minimum_threshold               | 0.01
```

Стратегия по умолчанию, `by_shard_count` ,, назначает каждому сегменту одинаковые затраты. Его действие — выровнять число сегментов между узлами. Другая предопределенная стратегия, `by_disk_size` ,,, назначает затраты каждому сегменту, соответствующей размеру диска в байтах, а также о сегментах, совместно расположенных вместе с ним. Размер диска вычисляется с помощью `pg_total_relation_size` , поэтому он включает индексы. Эта стратегия пытается получить то же дисковое пространство на каждом узле. Обратите внимание на пороговое значение 0,1 — это предотвращает ненужные перемещения сегментов, вызванные незначительными различиями в пространстве на диске.

#### <a name="creating-custom-rebalancer-strategies"></a>Создание пользовательских стратегий пересчета

Ниже приведены примеры функций, которые можно использовать в новых стратегиях подсистемы балансировки сегментов и зарегистрированы в [pg_dist_rebalance_strategy](reference-hyperscale-metadata.md?#rebalancer-strategy-table) с помощью функции [citus_add_rebalance_strategy](reference-hyperscale-functions.md#citus_add_rebalance_strategy) .

-   Задание исключения емкости узла по шаблону имени узла:

    ```postgresql
    CREATE FUNCTION v2_node_double_capacity(nodeidarg int)
        RETURNS boolean AS $$
        SELECT
            (CASE WHEN nodename LIKE '%.v2.worker.citusdata.com' THEN 2 ELSE 1 END)
        FROM pg_dist_node where nodeid = nodeidarg
        $$ LANGUAGE sql;
    ```

-   Повторная балансировка по числу запросов, которые поступают в сегмент, измеряемый [citus_stat_statements](reference-hyperscale-metadata.md#query-statistics-table):

    ```postgresql
    -- example of shard_cost_function

    CREATE FUNCTION cost_of_shard_by_number_of_queries(shardid bigint)
        RETURNS real AS $$
        SELECT coalesce(sum(calls)::real, 0.001) as shard_total_queries
        FROM citus_stat_statements
        WHERE partition_key is not null
            AND get_shard_id_for_distribution_column('tab', partition_key) = shardid;
    $$ LANGUAGE sql;
    ```

-   Изоляция определенного сегмента (10000) на узле (адрес \' 10.0.0.1 \' ):

    ```postgresql
    -- example of shard_allowed_on_node_function

    CREATE FUNCTION isolate_shard_10000_on_10_0_0_1(shardid bigint, nodeidarg int)
        RETURNS boolean AS $$
        SELECT
            (CASE WHEN nodename = '10.0.0.1' THEN shardid = 10000 ELSE shardid != 10000 END)
        FROM pg_dist_node where nodeid = nodeidarg
        $$ LANGUAGE sql;

    -- The next two definitions are recommended in combination with the above function.
    -- This way the average utilization of nodes is not impacted by the isolated shard.
    CREATE FUNCTION no_capacity_for_10_0_0_1(nodeidarg int)
        RETURNS real AS $$
        SELECT
            (CASE WHEN nodename = '10.0.0.1' THEN 0 ELSE 1 END)::real
        FROM pg_dist_node where nodeid = nodeidarg
        $$ LANGUAGE sql;
    CREATE FUNCTION no_cost_for_10000(shardid bigint)
        RETURNS real AS $$
        SELECT
            (CASE WHEN shardid = 10000 THEN 0 ELSE 1 END)::real
        $$ LANGUAGE sql;
    ```

### <a name="query-statistics-table"></a>Таблица статистики запросов

Масштабирование (Цитус) обеспечивает `citus_stat_statements` статистику выполнения запросов и для кого. Он \' аналогичен (и может быть соединен с) представлением [ \_ \_ инструкции PG stat](https://www.postgresql.org/docs/current/static/pgstatstatements.html) в PostgreSQL, которое отслеживает статистику скорости запросов.

Это представление может отслеживать запросы к исходным клиентам в приложении с несколькими клиентами, что помогает решить, когда следует выполнять изоляцию клиента.

| Имя          | Type   | Описание                                                                      |
|---------------|--------|----------------------------------------------------------------------------------|
| QueryId       | BIGINT | Идентификатор (подходит для pg_stat_statements соединений)                                   |
| userid        | oid    | пользователь, запустивший запрос                                                           |
| dbid          | oid    | экземпляр базы данных координатора                                                 |
| query         | текст   | Строка анонимного запроса                                                          |
| исполнителя      | текст   | Используется исполнитель Цитус: адаптивное, в режиме реального времени, на уровне задач, маршрутизаторе или INSERT — SELECT. |
| partition_key | текст   | значение столбца распределения в запросах, выполненных маршрутизатором, иначе — NULL               |
| calls         | BIGINT | Сколько раз был выполнен запрос                                                |

```sql
-- create and populate distributed table
create table foo ( id int );
select create_distributed_table('foo', 'id');
insert into foo select generate_series(1,100);

-- enable stats
-- pg_stat_statements must be in shared_preload libraries
create extension pg_stat_statements;

select count(*) from foo;
select * from foo where id = 42;

select * from citus_stat_statements;
```

Результат:

```
-[ RECORD 1 ]-+----------------------------------------------
queryid       | -909556869173432820
userid        | 10
dbid          | 13340
query         | insert into foo select generate_series($1,$2)
executor      | insert-select
partition_key |
calls         | 1
-[ RECORD 2 ]-+----------------------------------------------
queryid       | 3919808845681956665
userid        | 10
dbid          | 13340
query         | select count(*) from foo;
executor      | adaptive
partition_key |
calls         | 1
-[ RECORD 3 ]-+----------------------------------------------
queryid       | 5351346905785208738
userid        | 10
dbid          | 13340
query         | select * from foo where id = $1
executor      | adaptive
partition_key | 42
calls         | 1
```

Предупреждения:

-   Данные статистики не реплицируются, и выиграет \' сбои базы данных или отработку отказа
-   Отслеживает ограниченное количество запросов, заданное параметром `pg_stat_statements.max` Гук (по умолчанию — 5000)
-   Чтобы усечь таблицу, используйте `citus_stat_statements_reset()` функцию

### <a name="distributed-query-activity"></a>Действие распределенного запроса

Масштабирование (Цитус) предоставляет специальные представления для наблюдения за запросами и блокировками в кластере, включая запросы, предназначенные для каждого сегмента, которые используются внутри для построения результатов распределенных запросов.

-   **\_ \_ \_ действие stat Цитус расп**: показывает распределенные запросы, выполняемые на всех узлах. Надмножество `pg_stat_activity` , доступный для использования везде, где находится Последнее.
-   **Цитусная \_ \_ \_ Операция статистики рабочего процесса**: показывает запросы от рабочих ролей, включая запросы фрагментов к отдельным сегментам.
-   **\_ \_ ожиданий блокировок Цитус**: заблокированные запросы в кластере.

Первые два представления включают все столбцы [ \_ \_ операции PG stat](https://www.postgresql.org/docs/current/static/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW) , а также узел узла или порт рабочей роли, которая инициировала запрос, а также узел или порт узла координатора кластера.

Например, рассмотрите возможность подсчета строк в распределенной таблице:

```postgresql
-- run from worker on localhost:9701

SELECT count(*) FROM users_table;
```

Можно увидеть, что запрос отображается в `citus_dist_stat_activity` :

```postgresql
SELECT * FROM citus_dist_stat_activity;

-[ RECORD 1 ]----------+----------------------------------
query_hostname         | localhost
query_hostport         | 9701
master_query_host_name | localhost
master_query_host_port | 9701
transaction_number     | 1
transaction_stamp      | 2018-10-05 13:27:20.691907+03
datid                  | 12630
datname                | postgres
pid                    | 23723
usesysid               | 10
usename                | citus
application\_name      | psql
client\_addr           | 
client\_hostname       | 
client\_port           | -1
backend\_start         | 2018-10-05 13:27:14.419905+03
xact\_start            | 2018-10-05 13:27:16.362887+03
query\_start           | 2018-10-05 13:27:20.682452+03
state\_change          | 2018-10-05 13:27:20.896546+03
wait\_event_type       | Client
wait\_event            | ClientRead
state                  | idle in transaction
backend\_xid           | 
backend\_xmin          | 
query                  | SELECT count(*) FROM users_table;
backend\_type          | client backend
```

Для этого запроса требуются сведения из всех сегментов. Некоторые сведения находятся в сегменте `users_table_102038` , который хранится в `localhost:9700` . Можно увидеть запрос к сегменту, `citus_worker_stat_activity` просмотрев представление:

```postgresql
SELECT * FROM citus_worker_stat_activity;

-[ RECORD 1 ]----------+-----------------------------------------------------------------------------------------
query_hostname         | localhost
query_hostport         | 9700
master_query_host_name | localhost
master_query_host_port | 9701
transaction_number     | 1
transaction_stamp      | 2018-10-05 13:27:20.691907+03
datid                  | 12630
datname                | postgres
pid                    | 23781
usesysid               | 10
usename                | citus
application\_name      | citus
client\_addr           | ::1
client\_hostname       | 
client\_port           | 51773
backend\_start         | 2018-10-05 13:27:20.75839+03
xact\_start            | 2018-10-05 13:27:20.84112+03
query\_start           | 2018-10-05 13:27:20.867446+03
state\_change          | 2018-10-05 13:27:20.869889+03
wait\_event_type       | Client
wait\_event            | ClientRead
state                  | idle in transaction
backend\_xid           | 
backend\_xmin          | 
query                  | COPY (SELECT count(*) AS count FROM users_table_102038 users_table WHERE true) TO STDOUT
backend\_type          | client backend
```

В `query` поле отображаются данные, которые копируются из сегмента для подсчета.

> [!NOTE]
> Если запрос маршрутизатора (например, один клиент в приложении с несколькими клиентами), выберите
> * ИЗ таблицы, где tenant_id = X ") выполняется без блока транзакции, тогда столбцы" \_ имя узла главного запроса " \_ \_ и" \_ порт узла главного запроса " \_ \_ будут иметь значение NULL в \_ операции stat Цитус рабочего процесса \_ \_ .

Чтобы увидеть `citus_lock_waits` , как работает, можно создать ситуацию блокировки вручную. Сначала мы \' настроили тестовую таблицу из координатора:

```postgresql
CREATE TABLE numbers AS
  SELECT i, 0 AS j FROM generate_series(1,10) AS i;
SELECT create_distributed_table('numbers', 'i');
```

Затем, используя два сеанса в координаторе, можно выполнить следующую последовательность инструкций:

```postgresql
-- session 1                           -- session 2
-------------------------------------  -------------------------------------
BEGIN;
UPDATE numbers SET j = 2 WHERE i = 1;
                                       BEGIN;
                                       UPDATE numbers SET j = 3 WHERE i = 1;
                                       -- (this blocks)
```

`citus_lock_waits`Представление показывает ситуацию.

```postgresql
SELECT * FROM citus_lock_waits;

-[ RECORD 1 ]-------------------------+----------------------------------------
waiting_pid                           | 88624
blocking_pid                          | 88615
blocked_statement                     | UPDATE numbers SET j = 3 WHERE i = 1;
current_statement_in_blocking_process | UPDATE numbers SET j = 2 WHERE i = 1;
waiting_node_id                       | 0
blocking_node_id                      | 0
waiting_node_name                     | coordinator_host
blocking_node_name                    | coordinator_host
waiting_node_port                     | 5432
blocking_node_port                    | 5432
```

В этом примере запросы исходят от координатора, но в представлении также могут перечисляться блокировки между запросами, выполняемыми рабочими процессами (например, с помощью Цитус) MX.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о том, как некоторые [функции масштабирования (Цитус)](reference-hyperscale-functions.md) меняют системные таблицы
* Ознакомьтесь с основными понятиями [узлов и таблиц](concepts-hyperscale-nodes.md) .
