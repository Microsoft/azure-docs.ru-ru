---
title: Правила брандмауэра — база данных Azure для PostgreSQL — один сервер
description: В этой статье описывается, как использовать правила брандмауэра для подключения к базе данных Azure для PostgreSQL-Single Server.
author: sunilagarwal
ms.author: sunila
ms.service: postgresql
ms.topic: conceptual
ms.date: 07/17/2020
ms.openlocfilehash: ba353cf41cf3876a681f8f18d4121401260ff4ff
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98877176"
---
# <a name="firewall-rules-in-azure-database-for-postgresql---single-server"></a>Правила брандмауэра в базе данных Azure для PostgreSQL — один сервер
Сервер базы данных Azure для PostgreSQL защищен по умолчанию, предотвращая доступ к серверу базы данных, пока вы не укажете IP-узлам, которым разрешен доступ к нему. Брандмауэр предоставляет доступ к серверу на основе исходного IP-адреса каждого запроса.
Для настройки брандмауэра можно создать правила брандмауэра, которые указывают диапазон допустимых IP-адресов. Правила брандмауэра можно создавать на уровне сервера.

**Правила брандмауэра:** эти правила разрешают клиентам доступ ко всему серверу базы данных Azure для PostgreSQL, то есть ко всем базам данных на одном логическом сервере. Правила брандмауэра уровня сервера можно настроить на портале Azure или с помощью команд Azure CLI. Для создания правил брандмауэра уровня сервера необходимо быть владельцем или участником подписки.

## <a name="firewall-overview"></a>Общие сведения о брандмауэре
По умолчанию весь доступ к серверу базы данных Azure для PostgreSQL блокируется брандмауэром. Для доступа к серверу с другого компьютера, клиента или приложения необходимо указать одно или несколько правил брандмауэра на уровне сервера, чтобы разрешить доступ к серверу. Используйте правила брандмауэра, чтобы указать разрешенные диапазоны общедоступных IP-адресов. Правила брандмауэра не повлияют на доступ к самому веб-сайту портала Azure.
Попытки подключения из Интернета и Azure должны сначала пройти через брандмауэр, прежде чем они смогут связаться с базой данных PostgreSQL, как показано на следующей схеме:

:::image type="content" source="media/concepts-firewall-rules/1-firewall-concept.png" alt-text="Пример рабочего потока брандмауэра":::

## <a name="connecting-from-the-internet"></a>Подключение через Интернет
Правила брандмауэра уровня сервера применяются ко всем базам данных на одном и том же сервере базы данных Azure для PostgreSQL. Если исходный IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня сервера, соединение предоставляется в противном случае. Например, если приложение подключается с помощью драйвера JDBC для PostgreSQL, то при попытке подключения может возникать эта ошибка, когда брандмауэр блокирует подключение:
> java.util.concurrent.ExecutionException: java.lang.RuntimeException: org.postgresql.util.PSQLException: FATAL: no pg\_hba.conf entry for host "123.45.67.890", user "adminuser", database "postgresql", SSL

## <a name="connecting-from-azure"></a>Подключение из Azure
Рекомендуется найти исходящий IP-адрес любого приложения или службы и явно разрешить доступ к этим отдельным IP-адресам или диапазонам. Например, можно найти исходящий IP-адрес службы приложений Azure или использовать общедоступный IP, привязанный к виртуальной машине или другому ресурсу (Дополнительные сведения о подключении к частным конечным точкам службы с помощью частных IP-адресов виртуальной машины см. ниже). 

Если фиксированный исходящий IP-адрес недоступен для службы Azure, можно рассмотреть возможность включения подключений из всех IP-адресов центра обработки данных Azure. Этот параметр можно включить из портал Azure, задав для параметра **Разрешить доступ к службам Azure** значение **вкл** . в области **Безопасность подключения** и нажав **сохранить**. В Azure CLI параметр правила брандмауэра с начальным и конечным адресом, равным 0.0.0.0, эквивалентен. Если попытки подключения отклонены правилами брандмауэра, она не достигнет сервера базы данных Azure для PostgreSQL.

> [!IMPORTANT]
> Параметр **Разрешить доступ к службам Azure** позволяет настроить брандмауэр для разрешения всех подключений из Azure, включая подключения из подписок других клиентов. При выборе этого параметра убедитесь, что используемое имя для входа и разрешения пользователя предоставляют доступ только авторизованным пользователям.
> 

:::image type="content" source="media/concepts-firewall-rules/allow-azure-services.png" alt-text="Настройка разрешения доступа к службам Azure на портале":::

## <a name="connecting-from-a-vnet"></a>Подключение из виртуальной сети
Чтобы безопасно подключиться к серверу базы данных Azure для PostgreSQL из виртуальной сети, рассмотрите возможность использования [конечных точек службы виртуальной сети](./concepts-data-access-and-security-vnet.md). 

## <a name="programmatically-managing-firewall-rules"></a>Программное управление правилами брандмауэра
Помимо портала Azure правилами брандмауэра можно управлять программно с помощью Azure CLI.
Ознакомьтесь также со статьей [Создание правил брандмауэра базы данных Azure для PostgreSQL и управление ими с помощью Azure CLI](howto-manage-firewall-using-cli.md).

## <a name="troubleshooting-firewall-issues"></a>Устранение проблем с брандмауэром
Если доступ к службе сервера базы данных Microsoft Azure для PostgreSQL не работает должным образом, необходимо учитывать следующее:

* **Изменения в списке разрешенных адресов еще не вступили в силу.** До вступления в силу изменений конфигурации брандмауэра сервера базы данных Azure для PostgreSQL может присутствовать задержка до пяти минут.

* **Имя для входа не авторизовано, или использован неправильный пароль.** Если имя для входа не имеет разрешений на сервере базы данных Azure для PostgreSQL или введен неправильный пароль, то подключение к серверу базы данных Azure для PostgreSQL отклоняется. Создание параметра брандмауэра только предоставляет клиентам возможность подключения к серверу. Каждый клиент должен предоставить необходимые учетные данные безопасности.

   Например, при использовании клиента JDBC может возникать следующая ошибка:
   > java.util.concurrent.ExecutionException: java.lang.RuntimeException: org.postgresql.util.PSQLException: FATAL: password authentication failed for user "yourusername"

* **Динамический IP-адрес:** при наличии подключения к Интернету с динамическим предоставлением IP-адресов и возникновении проблем с прохождением через брандмауэр попробуйте одно из описанных ниже решений.

   * Попросите поставщика услуг Интернета (ISP) назначить диапазон IP-адресов тем клиентским компьютерам, с которых осуществляется доступ к серверу базы данных Azure для PostgreSQL, а затем добавьте диапазон IP-адресов в качестве правила брандмауэра.

   * Получите статические IP-адреса для клиентских компьютеров, а затем добавьте статические IP-адреса как правила брандмауэра.

* **IP-адрес сервера выглядит как общедоступный:** Подключения к серверу базы данных Azure для PostgreSQL направляются через общедоступный шлюз Azure. Однако фактический IP-адрес сервера защищен брандмауэром. Дополнительные сведения см. в статье об [архитектуре подключения](concepts-connectivity-architecture.md).

* **Не удается подключиться из ресурса Azure с разрешенным IP-адресом:** Проверьте, включена ли конечная точка службы **Microsoft. SQL** для подсети, из которой вы подключаетесь. Если **Microsoft. SQL** включен, то это означает, что для этой подсети нужно использовать только [правила конечной точки службы VNet](concepts-data-access-and-security-vnet.md) .

   Например, если вы подключаетесь из виртуальной машины Azure в подсети с включенным **Microsoft. SQL** , но не имеет соответствующего правила виртуальной сети, может появиться следующее сообщение об ошибке:  `FATAL: Client from Azure Virtual Networks is not allowed to access the server`

* **Правило брандмауэра недоступно для формата IPv6:** Правила брандмауэра должны иметь формат IPv4. Если указать правила брандмауэра в формате IPv6, отобразится ошибка проверки.


## <a name="next-steps"></a>Дальнейшие действия
* [Создание правил брандмауэра базы данных Azure для PostgreSQL и управление ими с помощью портала Azure](howto-manage-firewall-using-portal.md)
* [Создание правил брандмауэра базы данных Azure для PostgreSQL и управление ими с помощью Azure CLI](howto-manage-firewall-using-cli.md)
* [Конечные точки службы виртуальной сети в базе данных Azure для PostgreSQL](./concepts-data-access-and-security-vnet.md)
