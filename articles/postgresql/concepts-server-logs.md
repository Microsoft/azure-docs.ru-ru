---
title: Журналы — база данных Azure для PostgreSQL — один сервер
description: Описание конфигурации ведения журнала, хранилища и анализа в базе данных Azure для PostgreSQL — Single Server
author: lfittl-msft
ms.author: lufittl
ms.service: postgresql
ms.topic: conceptual
ms.date: 06/25/2020
ms.openlocfilehash: 621d5a6a91a8c22c52e6febc7c2638571f5bf113
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100595809"
---
# <a name="logs-in-azure-database-for-postgresql---single-server"></a>Журналы в базе данных Azure для PostgreSQL — один сервер

База данных Azure для PostgreSQL позволяет настраивать и получать доступ к стандартным журналам postgres. Журналы могут использоваться для обнаружения, устранения и исправления ошибок конфигурации и неоптимальной производительности. Сведения о ведении журнала, которые можно настроить и получить доступ, включают ошибки, сведения о запросах, записи автоочистки, подключения и контрольные точки. (Доступ к журналам транзакций недоступен).

Ведение журнала аудита предоставляется через расширение postgres, пгаудит. Дополнительные сведения см. в статье [Основные понятия аудита](concepts-audit.md) .


## <a name="configure-logging"></a>Настройка журнала 
Вы можете настроить стандартное ведение журнала Postgres на сервере с помощью параметров сервера ведения журнала. На каждом сервере базы данных Azure для PostgreSQL `log_checkpoints` и `log_connections` включены по умолчанию. Чтобы ведение журнала соответствовало вашим требования, можно изменить дополнительные параметры. 

:::image type="content" source="./media/concepts-server-logs/log-parameters.png" alt-text="База данных Azure для PostgreSQL. Параметры ведения журнала":::

Дополнительные сведения о параметрах журнала postgres см. в разделах о [времени](https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHEN) и [журналах](https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT) документации по postgres. Большинство, но не все параметры ведения журнала postgres доступны для настройки в базе данных Azure для PostgreSQL.

Чтобы узнать, как настроить параметры в базе данных Azure для PostgreSQL, см. [документацию по порталу](howto-configure-server-parameters-using-portal.md) или [документации по CLI](howto-configure-server-parameters-using-cli.md). 

> [!NOTE]
> Настройка большого объема журналов, например ведение журнала инструкций, может значительно увеличить производительность. 

## <a name="access-log-files"></a>Файлы Access. log
Формат журнала по умолчанию в базе данных Azure для PostgreSQL —. log. Пример строки из этого журнала выглядит следующим образом:

```
2019-10-14 17:00:03 UTC-5d773cc3.3c-LOG: connection received: host=101.0.0.6 port=34331 pid=16216
```

База данных Azure для PostgreSQL предоставляет краткосрочное место хранения для файлов журнала. Новый файл начинается каждые 1 час или 100 МБ, в зависимости от того, что происходит первым. Журналы добавляются к текущему файлу по мере их выпуска из postgres.  

Для этого краткосрочного хранилища журналов можно задать срок хранения с помощью `log_retention_period` параметра. Значению по умолчанию соответствует три дня, а максимальному значению семь. Краткосрочное расположение хранилища может содержать до 1 ГБ файлов журнала. Через 1 ГБ старые файлы, независимо от срока хранения, будут удалены, чтобы освободить место для новых журналов. 

Для долгосрочного хранения журналов и анализа журналов можно скачать файлы журнала и переместить их в службу стороннего производителя. Файлы можно загрузить с помощью [портал Azure](howto-configure-server-logs-in-portal.md) [Azure CLI](howto-configure-server-logs-using-cli.md). Кроме того, можно настроить Azure Monitor параметры диагностики, которые автоматически создают журналы (в формате JSON) в долгосрочные расположения. Дополнительные сведения об этом параметре см. в разделе ниже. 

Вы можете отключить создание файлов журнала, установив для параметра значение `logging_collector` Off. Если вы используете Azure Monitor параметры диагностики, рекомендуется отключить создание файла журнала. Такая конфигурация снизит влияние дополнительного ведения журнала на производительность.

## <a name="resource-logs"></a>Журналы ресурсов

База данных Azure для PostgreSQL интегрирована с параметрами диагностики Azure Monitor. Параметры диагностики позволяют отправлять журналы postgres в формате JSON, чтобы Azure Monitor журналы для аналитики и оповещений, концентраторов событий для потоковой передачи и службу хранилища Azure для архивации. 

> [!IMPORTANT]
> Эта диагностическая функция для журналов сервера доступна только в общего назначения и оптимизированных для памяти [ценовых категориях](concepts-pricing-tiers.md).


### <a name="configure-diagnostic-settings"></a>Настройка параметров диагностики

Вы можете включить параметры диагностики для сервера Postgres с помощью портал Azure, CLI, REST API и PowerShell. Категория журнала для выбора — **постгрескллогс**. (Существуют и другие журналы, которые можно настроить при использовании [хранилища запросов](concepts-query-store.md).)

Чтобы включить журналы ресурсов с помощью портал Azure:

   1. На портале выберите *параметры диагностики* в меню навигации сервера postgres.
   2. Выберите *Добавить параметр диагностики*.
   3. Назовите этот параметр. 
   4. Выберите предпочитаемую конечную точку (учетную запись хранения, концентратор событий, log Analytics). 
   5. Выберите тип журнала **постгрескллогс**.
   7. Сохраните вашу настройку.

Чтобы включить журналы ресурсов с помощью PowerShell, CLI или REST API, см. статью [параметры диагностики](../azure-monitor/essentials/diagnostic-settings.md) .

### <a name="access-resource-logs"></a>Доступ к журналам ресурсов

Способ доступа к журналам зависит от выбранной конечной точки. Сведения о службе хранилища Azure см. в статье [учетная запись хранения журналов](../azure-monitor/essentials/resource-logs.md#send-to-azure-storage) . Сведения о концентраторах событий см. в статье [Streaming Azure Logs](../azure-monitor/essentials/resource-logs.md#send-to-azure-event-hubs) .

Для журналов Azure Monitor журналы отправляются в выбранную рабочую область. Журналы postgres используют режим сбора **AzureDiagnostics** , поэтому их можно запрашивать из таблицы AzureDiagnostics. Поля в таблице описаны ниже. Дополнительные сведения о запросах и предупреждениях см. в статье о [запросах Azure Monitor журналов](../azure-monitor/logs/log-query-overview.md) .

Ниже приведены запросы, которые можно попытаться приступить к работе. Можно настроить оповещения на основе запросов.

Поиск всех журналов postgres для определенного сервера за последний день
```
AzureDiagnostics
| where LogicalServerName_s == "myservername"
| where Category == "PostgreSQLLogs"
| where TimeGenerated > ago(1d) 
```

Поиск всех попыток подключения, отличных от localhost
```
AzureDiagnostics
| where Message contains "connection received" and Message !contains "host=127.0.0.1"
| where Category == "PostgreSQLLogs" and TimeGenerated > ago(6h)
```
В приведенном выше запросе отобразятся результаты за последние 6 часов для любого журнала postgres сервера в этой рабочей области.

### <a name="log-format"></a>Формат журнала

В следующей таблице описаны поля для типа **постгрескллогс** . Порядок появления выбранных полей зависит от выбранной конечной точки вывода. 

|**Поле** | **Описание** |
|---|---|
| TenantId | Идентификатор клиента |
| SourceSystem | `Azure` |
| TimeGenerated [UTC] | Метка времени, когда журнал был записан в формате UTC |
| Type | Тип журнала Всегда `AzureDiagnostics`. |
| SubscriptionId | Идентификатор GUID для подписки, принадлежащей серверу |
| ResourceGroup | Имя группы ресурсов, принадлежащей серверу |
| ResourceProvider | Имя поставщика ресурсов. Всегда `MICROSOFT.DBFORPOSTGRESQL`. |
| ResourceType | `Servers` |
| ResourceId | Универсальный код ресурса (URI) |
| Ресурс | Имя сервера |
| Категория | `PostgreSQLLogs` |
| OperationName | `LogEvent` |
| errorLevel | Уровень ведения журнала, например: LOG, ERROR, NOTICE |
| Сообщение | Первичное сообщение журнала | 
| Домен | Версия сервера, например: postgres 10 |
| Подробный сведения | Второстепенное сообщение журнала (если применимо) |
| ColumnName | Имя столбца (если применимо) |
| SchemaName | Имя схемы (если применимо) |
| DatatypeName | Имя типа данных (если применимо) |
| LogicalServerName | Имя сервера | 
| _ResourceId | Универсальный код ресурса (URI) |
| Prefix | Префикс строки журнала |


## <a name="next-steps"></a>Дальнейшие шаги
- Дополнительные сведения о доступе к журналам см. в статье [Настройка журналов сервера и получение к ним доступа с помощью портала Azure](howto-configure-server-logs-in-portal.md) или [Настройка журналов сервера и получение к ним доступа с помощью Azure CLI](howto-configure-server-logs-using-cli.md).
- Дополнительные сведения о [ценах на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/).
- Дополнительные сведения о [журналах аудита](concepts-audit.md)