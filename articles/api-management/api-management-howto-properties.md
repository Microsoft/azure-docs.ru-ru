---
title: Использование именованных значений в политиках Управления API Azure
description: Сведения об использования именованных значений в политиках Управления API Azure. Именованные значения могут содержать литеральные строки, выражения политики и секреты, хранящиеся в Azure Key Vault.
services: api-management
documentationcenter: ''
author: vladvino
ms.service: api-management
ms.topic: article
ms.date: 02/09/2021
ms.author: apimpm
ms.openlocfilehash: 2bc9b1c5724fa7bab1fdf5ac9332d87ba03a6d11
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100545825"
---
# <a name="use-named-values-in-azure-api-management-policies"></a>Использование именованных значений в политиках управления API Azure

[Политики управления API](api-management-howto-policies.md) — это мощная возможность системы, позволяющая издателю изменять поведение API через конфигурацию. Политика — это коллекция правил, которые выполняются последовательно над запросом или ответом API. Для создания правил политики можно использовать литеральные текстовые значения, выражения политики и именованные значения.

*Именованные значения* являются глобальной коллекцией пар "имя-значение" в каждом экземпляре управления API. В коллекции не налагаются ограничения по числу элементов. Именованные значения можно использовать для управления постоянными строковыми значениями и секретами во всех конфигурациях и политиках API. 

:::image type="content" source="media/api-management-howto-properties/named-values.png" alt-text="Именованные значения в портал Azure":::

## <a name="value-types"></a>Типы значений

|Type  |Описание  |
|---------|---------|
|Plain     |  Литеральная строка или выражение политики     |
|Секрет     |   Литеральная строка или выражение политики, зашифрованные службой управления API      |
|[Хранилище ключей](#key-vault-secrets)     |  Идентификатор секрета, хранящегося в хранилище ключей Azure.      |

Обычные значения или секреты могут содержать [выражения политики](./api-management-policy-expressions.md). Например, выражение `@(DateTime.Now.ToString())` возвращает строку, содержащую текущую дату и время.

Дополнительные сведения об атрибутах именованного значения см. в [справочнике](/rest/api/apimanagement/2020-06-01-preview/namedvalue/createorupdate)по управлению API REST API.

## <a name="key-vault-secrets"></a>Секреты хранилища ключей

Секретные значения могут храниться либо в виде зашифрованных строк в управлении API (пользовательские секреты), либо при помощи ссылок на секреты в [Azure Key Vault](../key-vault/general/overview.md). 

Рекомендуется использовать секреты хранилища ключей, так как это помогает улучшить безопасность управления API:

* Секреты, хранящиеся в хранилищах ключей, можно повторно использовать в разных службах.
* К секретам можно применять политики детализированного [доступа](../key-vault/general/secure-your-key-vault.md#data-plane-and-access-policies)
* Секреты, обновленные в хранилище ключей, автоматически поворачиваются в управлении API. После обновления в хранилище ключей именованное значение в управлении API обновляется в течение 4 часов. Можно также вручную обновить секрет с помощью портал Azure или REST API управления.

### <a name="prerequisites-for-key-vault-integration"></a>Необходимые условия для интеграции хранилища ключей

1. Инструкции по созданию хранилища ключей см. в разделе [Краткое руководство. Создание хранилища ключей с помощью портал Azure](../key-vault/general/quick-create-portal.md).
1. Включите назначенное системой или назначенное пользователем [управляемое удостоверение](api-management-howto-use-managed-service-identity.md) в экземпляре управления API.
1. Назначьте управляемому удостоверению [политику доступа к хранилищу ключей](../key-vault/general/assign-access-policy-portal.md) с разрешениями на получение и перечисление секретов из хранилища. Чтобы добавить политику, выполните следующие действия.
    1. На портале перейдите к своему хранилищу ключей.
    1. Выберите **параметры > политики доступа > + добавить политику доступа**.
    1. Выберите **разрешения секрета**, а затем выберите **получить** и **вывести список**.
    1. В поле **Выбор субъекта** выберите имя ресурса управляемого удостоверения. Если вы используете назначенное системой удостоверение, участником является имя экземпляра управления API.
1. Создайте или импортируйте секретный код для хранилища ключей. См. раздел [Краткое руководство. Установка и извлечение секрета из Azure Key Vault с помощью портал Azure](../key-vault/secrets/quick-create-portal.md).

Чтобы использовать секрет хранилища ключей, [добавьте или измените именованное значение](#add-or-edit-a-named-value)и укажите тип **хранилища ключей**. Выберите секрет из хранилища ключей.

[!INCLUDE [api-management-key-vault-network](../../includes/api-management-key-vault-network.md)]

## <a name="add-or-edit-a-named-value"></a>Добавление или изменение именованного значения

### <a name="add-a-key-vault-secret"></a>Добавление секрета хранилища ключей

См. [Предварительные требования для интеграции хранилища ключей](#prerequisites-for-key-vault-integration).

> [!CAUTION]
> При использовании секрета хранилища ключей в управлении API следует избегать удаления секрета, хранилища ключей или управляемого удостоверения, используемого для доступа к хранилищу ключей.

1. Перейдите к экземпляру Управления API на [портале Azure](https://portal.azure.com).
1. В разделе **интерфейсы API** выберите **именованные значения**  >  **+ Добавить**.
1. Введите идентификатор **имени** и введите **Отображаемое имя** , используемое для ссылки на свойство в политиках.
1. В списке **тип значения** выберите **хранилище ключей**.
1. Введите идентификатор секрета хранилища ключей (без версии) или нажмите кнопку **выбрать** , чтобы выбрать секрет из хранилища ключей.
    > [!IMPORTANT]
    > Если вы вводите идентификатор секрета в хранилище ключей самостоятельно, убедитесь, что у него нет сведений о версии. В противном случае секрет не будет автоматически переключаться в Управление API после обновления в хранилище ключей.
1. В списке **удостоверение клиента** выберите назначенное системой или существующее управляемое удостоверение, назначенное пользователем. Узнайте, как [добавлять или изменять управляемые удостоверения в службе управления API](api-management-howto-use-managed-service-identity.md).
    > [!NOTE]
    > Удостоверению требуются разрешения на получение и вывод списка секретов из хранилища ключей. Если вы еще не настроили доступ к хранилищу ключей, в службе управления API появится запрос, чтобы он мог автоматически настроить удостоверение с необходимыми разрешениями.
1. Добавьте один или несколько необязательных тегов, чтобы помочь упорядочить именованные значения, а затем **Сохраните**.
1. Нажмите кнопку **создания**.

    :::image type="content" source="media/api-management-howto-properties/add-property.png" alt-text="Добавить значение секрета хранилища ключей":::

### <a name="add-a-plain-or-secret-value"></a>Добавление обычного или секретного значения

### <a name="portal"></a>[Портал](#tab/azure-portal)

1. Перейдите к экземпляру Управления API на [портале Azure](https://portal.azure.com).
1. В разделе **интерфейсы API** выберите **именованные значения**  >  **+ Добавить**.
1. Введите идентификатор **имени** и введите **Отображаемое имя** , используемое для ссылки на свойство в политиках.
1. В списке **тип значения** выберите **обычный** или **секрет**.
1. В списке **значение** введите строку или выражение политики.
1. Добавьте один или несколько необязательных тегов, чтобы помочь упорядочить именованные значения, а затем **Сохраните**.
1. Нажмите кнопку **создания**.

После создания именованного значения его можно изменить, выбрав имя. При изменении отображаемого имени все политики, ссылающиеся на это именованное значение, автоматически обновляются для использования нового отображаемого имени.

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы начать работу с Azure CLI:

[!INCLUDE [azure-cli-prepare-your-environment-no-header.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

Чтобы добавить именованное значение, используйте команду [AZ apim NV Create](/cli/azure/apim/nv#az_apim_nv_create) :

```azurecli
az apim nv create --resource-group apim-hello-word-resource-group \
    --display-name "named_value_01" --named-value-id named_value_01 \
    --secret true --service-name apim-hello-world --value test
```

После создания именованного значения его можно обновить с помощью команды [AZ apim NV Update](/cli/azure/apim/nv#az_apim_nv_update) . Чтобы просмотреть все именованные значения, выполните команду [AZ apim NV List](/cli/azure/apim/nv#az_apim_nv_list) :

```azurecli
az apim nv list --resource-group apim-hello-word-resource-group \
    --service-name apim-hello-world --output table
```

Чтобы просмотреть сведения об именованном значении, созданном для этого примера, выполните команду [AZ apim NV Показать](/cli/azure/apim/nv#az_apim_nv_show) :

```azurecli
az apim nv show --resource-group apim-hello-word-resource-group \
    --service-name apim-hello-world --named-value-id named_value_01
```

Этот пример является секретным значением. Предыдущая команда не возвращает значение. Чтобы просмотреть это значение, выполните команду [AZ apim NV Показать-Secret](/cli/azure/apim/nv#az_apim_nv_show_secret) :

```azurecli
az apim nv show-secret --resource-group apim-hello-word-resource-group \
    --service-name apim-hello-world --named-value-id named_value_01
```

Чтобы удалить именованное значение, используйте команду [AZ apim NV Delete](/cli/azure/apim/nv#az_apim_nv_delete) :

```azurecli
az apim nv delete --resource-group apim-hello-word-resource-group \
    --service-name apim-hello-world --named-value-id named_value_01
```

---

## <a name="use-a-named-value"></a>Использовать именованное значение

В примерах в этом разделе используются именованные значения, приведенные в следующей таблице.

| Имя               | Значение                      | Секрет | 
|--------------------|----------------------------|--------|---------|
| ContosoHeader      | `TrackingId`                 | Неверно  | 
| ContosoHeaderValue | ••••••••••••••••••••••     | True   | 
| ExpressionProperty | `@(DateTime.Now.ToString())` | Неверно  | 

Чтобы использовать именованное значение в политике, поместите его отображаемое имя внутри двойной пары фигурных скобок `{{ContosoHeader}}` , как показано в следующем примере:

```xml
<set-header name="{{ContosoHeader}}" exists-action="override">
  <value>{{ContosoHeaderValue}}</value>
</set-header>
```

В этом примере `ContosoHeader` используется как имя заголовка в политике `set-header`, а `ContosoHeaderValue` — в качестве значения этого заголовка. При оценке этой политики во время запроса или ответа к шлюзу Управления API `{{ContosoHeader}}` и `{{ContosoHeaderValue}}` заменяются соответствующими значениями.

Именованные значения можно использовать как полные значения атрибутов или элементов, как показано в предыдущем примере. Также их можно вставлять в литеральное текстовое выражение или комбинировать с частью этого выражения, как показано в следующем примере:  

```xml
<set-header name = "CustomHeader{{ContosoHeader}}" ...>
```

Кроме того, именованные значения могут содержать выражения политики. В следующем примере `ExpressionProperty` используется выражение.

```xml
<set-header name="CustomHeader" exists-action="override">
    <value>{{ExpressionProperty}}</value>
</set-header>
```

При оценке этой политики `{{ExpressionProperty}}` заменяется на ее значение, `@(DateTime.Now.ToString())` . Поскольку значение является выражением политики, выражение проходит оценку и политика продолжает выполнение.

Это можно проверить на портал Azure или на [портале разработчика](api-management-howto-developer-portal.md) , вызвав операцию с политикой с именованными значениями в области. В следующем примере вызывается операция с двумя политиками `set-header` с именованными значениями из предыдущего примера. Обратите внимание, что ответ содержит два пользовательских заголовка, которые были настроены с помощью политик с именованными значениями.

:::image type="content" source="media/api-management-howto-properties/api-management-send-results.png" alt-text="Тестовый ответ API":::

Если взглянуть на [трассировку](api-management-howto-api-inspector.md) исходящего API для вызова, включающего два предыдущих примера политик с именованными значениями, можно увидеть две `set-header` политики с вставленными именованными значениями, а также вычисление выражения политики для именованного значения, содержащего выражение политики.

:::image type="content" source="media/api-management-howto-properties/api-management-api-inspector-trace.png" alt-text="Трассировка с помощью инспектора API":::

> [!CAUTION]
> Если политика ссылается на секрет в Azure Key Vault, значение из хранилища ключей будет отображаться для пользователей, имеющих доступ к подпискам, для которых включена [Трассировка запросов API](api-management-howto-api-inspector.md).

Хотя именованные значения могут содержать выражения политики, они не могут содержать другие именованные значения. Если в качестве значения используется текст, содержащий ссылку на именованное значение (например, `Text: {{MyProperty}}`), эта ссылка не будет разрешена и заменена.

## <a name="delete-a-named-value"></a>Удаление именованного значения

Чтобы удалить именованное значение, выберите его и в контекстном меню (**...**) выберите **Удалить** .

> [!IMPORTANT]
> Если именованное значение ссылается на какие-либо политики управления API, его нельзя удалить, пока не будет удалено именованное значение из всех политик, которые ее используют.

## <a name="next-steps"></a>Дальнейшие действия

-   Узнайте больше о работе с политиками
    -   [Политики в управлении API](api-management-howto-policies.md)
    -   [Справочник по политикам](./api-management-policies.md)
    -   [Выражения политики](./api-management-policy-expressions.md)

[api-management-send-results]: ./media/api-management-howto-properties/api-management-send-results.png

