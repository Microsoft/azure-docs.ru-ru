---
title: Как использовать управление API Azure с виртуальными сетями
description: Узнайте, как настроить подключение к виртуальной сети в управлении API Azure и обращаться к веб-службам через него.
services: api-management
documentationcenter: ''
author: vladvino
manager: erikre
editor: ''
ms.service: api-management
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 12/10/2020
ms.author: apimpm
ms.custom: references_regions
ms.openlocfilehash: c63b71ad00a5621babe07597720a1e9ea87f1e4a
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99260254"
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a>Как использовать управление API Azure с виртуальными сетями
Виртуальные сети Azure позволяют размещать любые ресурсы Azure в сети, недоступной из Интернета, доступом к которой управляете вы сами. Эти сети можно подключать к локальным сетям с помощью различных технологий VPN. Начать изучение виртуальных сетей Azure лучше всего со статьи [Что такое виртуальная сеть Azure?](../virtual-network/virtual-networks-overview.md).

Службу управления API Azure можно развернуть в пределах виртуальной сети, обеспечив доступ к серверным службам в этой сети. Портал разработчика и шлюз API можно настроить для предоставления доступа как из Интернета, так и только в пределах виртуальной сети.

> [!NOTE]
> URL-адрес документа импорта API должен размещаться по общедоступному адресу в Интернете.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

[!INCLUDE [premium-dev.md](../../includes/api-management-availability-premium-dev.md)]

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо следующее.

+ Активная подписка Azure.

    [!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

+ Экземпляр APIM. Дополнительные сведения см. в статье о [создании экземпляра управления API Azure](get-started-create-service-instance.md).

## <a name="enable-vnet-connection"></a><a name="enable-vpn"> </a>Активация подключения к виртуальной сети

### <a name="enable-vnet-connectivity-using-the-azure-portal"></a>Активация возможности подключения к виртуальной сети с помощью портала Azure

1. Перейдите на [портал Azure](https://portal.azure.com), чтобы найти экземпляр Управления API. Найдите и выберите **Службы управления API**.

2. Выберите экземпляр Управления API.

3. Щелкните **Виртуальная сеть**.
4. Настройте развертывание экземпляра управления API внутри виртуальной сети.

    :::image type="content" source="media/api-management-using-with-vnet/api-management-menu-vnet.png" alt-text="Выберите Виртуальная сеть в портал Azure.":::
    
5. Выберите нужный тип доступа.

    * **Off**: Это значение по умолчанию. Служба управления API не развернута в виртуальной сети.

    * **Внешние**. Шлюз Управления API и портал разработчика доступны из общедоступного Интернета через внешнюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

        ![Общедоступный пиринг][api-management-vnet-public]

    * **Внутренние**. Шлюз Управления API и портал разработчика доступны только из виртуальной сети через внутреннюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

        ![Частный пиринг][api-management-vnet-private]

6. Если выбрано **Внешняя** или **Внутренняя**, будет показан список всех регионов, где предоставляется служба управления API. Выберите значение в столбце **Расположение**, а затем выберите значения в столбцах **Виртуальная сеть** и **Подсеть**. Список виртуальных сетей заполнен классическими виртуальными сетями и виртуальными сетями Resource Manager, имеющимися в подписках Azure, которые настроены в настраиваемом регионе.

    > [!IMPORTANT]
    > При развертывании экземпляра службы управления API Azure в виртуальной сети Resource Manager служба должна находиться в выделенной подсети, в которой нет других ресурсов, кроме экземпляров управления API Azure. Если попытаться развернуть экземпляр управления API Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, это приведет к сбою.

    Затем выберите **Применить**. Страница **Виртуальная сеть** экземпляра Управления API будет обновлена с учетом новых выбранных виртуальной сети и подсети.

    :::image type="content" source="media/api-management-using-with-vnet/api-management-using-vnet-select.png" alt-text="Параметры виртуальной сети на портале.":::

7. На верхней панели навигации щелкните **Сохранить**, а затем выберите **Применить конфигурацию сети**.

> [!NOTE]
> Виртуальный IP-адрес экземпляра управления API будет изменяться при каждом включении или отключении виртуальной сети.
> Кроме того, виртуальный IP-адрес будет изменяться при перемещении службы управления API из **внешней** во **внутреннюю** сеть или наоборот.
>

> [!IMPORTANT]
> Если удалить службу управления API из виртуальной сети или изменить виртуальную сеть, в которой она развернута, ранее использовавшаяся виртуальная сеть может быть заблокирована максимум на шесть часов. В этот период вы не сможете удалить виртуальную сеть или развернуть в ней новый ресурс. Такая ситуация возникает у клиентов, использующих API версии 2018-01-01 и более ранние. Для клиентов, использующих API версии 2019-01-01 и более поздние версии, виртуальная сеть освобождается сразу после удаления связанной службы управления API.

## <a name="deploy-api-management-into-external-vnet"></a><a name="deploy-apim-external-vnet"> </a>Развертывание управления API во внешней виртуальной сети

[![Развертывание в Azure](../media/template-deployments/deploy-to-azure.svg)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F201-api-management-create-with-external-vnet%2Fazuredeploy.json)

* **Создание службы управления API в виртуальной сети**. Чтобы создать службу управления API Azure в виртуальной сети, используйте командлет [New-AzApiManagement](/powershell/module/az.apimanagement/new-azapimanagement).

* **Развертывание существующей службы управления API в виртуальной сети**. Чтобы переместить существующую службу управления API Azure внутри виртуальной сети, используйте командлет [Update-AzApiManagementRegion](/powershell/module/az.apimanagement/update-azapimanagementregion).

## <a name="connect-to-a-web-service-hosted-within-a-virtual-network"></a><a name="connect-vnet"> </a>Подключение к веб-службе, размещенной в виртуальной сети
После подключения службы управления API к виртуальной сети обращение к размещенным в ней внутренним службам ничем не будет отличаться от обращения к общедоступным службам. Просто введите локальный IP-адрес или имя узла (если для виртуальной сети настроен DNS-сервер) веб-службы в поле **URL-адрес веб-службы** при создании нового API или редактировании существующего.

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <a name="common-network-configuration-issues"></a><a name="network-configuration-issues"> </a>Распространенные проблемы с конфигурацией сети
Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.

* **Настройка пользовательского DNS-сервера**. Служба управления API зависит от нескольких служб Azure. Если служба управления API размещается в виртуальной сети, в которой используется пользовательский DNS-сервер, она должна разрешить имена узлов этих служб Azure. Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера. Для справки ниже приведена таблица портов, а также другие требования к сети.

> [!IMPORTANT]
> Если вы планируете использовать настраиваемые DNS-серверы для виртуальной сети, настройте их **перед** развертыванием службы управления API в этой сети. В противном случае службу управления API необходимо обновлять каждый раз при изменении DNS-серверов с помощью [операции применения конфигурации сети](/rest/api/apimanagement/2019-12-01/apimanagementservice/applynetworkconfigurationupdates).

* **Порты, необходимые для управления API**. Входящим и исходящим трафиком в подсети, в которой развернута служба управления API, можно управлять с помощью [группы безопасности сети][Network Security Group]. Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной. Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.

<a name="required-ports"> </a> При размещении экземпляра Управления API в виртуальной сети используются порты, указанные в следующей таблице.

| Исходные и конечные порты | Направление          | Транспортный протокол |   [Теги служб](../virtual-network/network-security-groups-overview.md#service-tags) <br> Ресурс и назначение   | Назначение (\*)                                                 | Тип виртуальной сети |
|------------------------------|--------------------|--------------------|---------------------------------------|-------------------------------------------------------------|----------------------|
| * / [80], 443                  | Входящий трафик            | TCP                | INTERNET — VIRTUAL_NETWORK            | Подключения клиентов к службе управления API                      | External             |
| * / 3443                     | Входящий трафик            | TCP                | ApiManagement / VIRTUAL_NETWORK       | Конечная точка управления для портала Azure и PowerShell         | Внешний и внутренний  |
| * / 443                  | Исходящие           | TCP                | VIRTUAL_NETWORK / Storage             | **Зависимость от службы хранилища Azure**                             | Внешний и внутренний  |
| * / 443                  | Исходящие           | TCP                | VIRTUAL_NETWORK / AzureActiveDirectory | [Azure Active Directory](api-management-howto-aad.md) и зависимость Azure KeyVault                  | Внешний и внутренний  |
| * / 1433                     | Исходящие           | TCP                | VIRTUAL_NETWORK / SQL                 | **Доступ к конечным точкам службы SQL Azure**                           | Внешний и внутренний  |
| * / 443                     | Исходящие           | TCP                | VIRTUAL_NETWORK/AzureKeyVault                 | **Доступ к Azure KeyVault**                           | Внешний и внутренний  |
| * / 5671, 5672, 443          | Исходящие           | TCP                | VIRTUAL_NETWORK / EventHub            | Зависимость для [политики ведения журнала Центра событий](api-management-howto-log-event-hubs.md) и агента мониторинга | Внешний и внутренний  |
| * / 445                      | Исходящие           | TCP                | VIRTUAL_NETWORK / Storage             | Зависимость от общей папки Azure для [GIT](api-management-configuration-repository-git.md)                      | Внешний и внутренний  |
| */443, 12000                     | Исходящие           | TCP                | VIRTUAL_NETWORK / AzureCloud            | Расширение работоспособности и мониторинга         | Внешний и внутренний  |
| */1886, 443                     | Исходящие           | TCP                | VIRTUAL_NETWORK / AzureMonitor         | Публикация [журналов диагностики и метрик](api-management-howto-use-azure-monitor.md), [работоспособность ресурсов](../service-health/resource-health-overview.md) и [Application Insights](api-management-howto-app-insights.md)                   | Внешний и внутренний  |
| */25, 587, 25028                       | Исходящие           | TCP                | VIRTUAL_NETWORK — INTERNET            | Подключение к SMTP-ретранслятору для отправки сообщений электронной почты                    | Внешний и внутренний  |
| * / 6381 - 6383              | Входящий и исходящий | TCP                | VIRTUAL_NETWORK — VIRTUAL_NETWORK     | Доступ к службе Redis для политик [кэша](api-management-caching-policies.md) между компьютерами         | Внешний и внутренний  |
| */4290              | Входящий и исходящий | UDP                | VIRTUAL_NETWORK — VIRTUAL_NETWORK     | Счетчики синхронизации для политик [ограничения скорости](api-management-access-restriction-policies.md#LimitCallRateByKey) между компьютерами         | Внешний и внутренний  |
| * / *                        | Входящий трафик            | TCP                | AZURE_LOAD_BALANCER / VIRTUAL_NETWORK | Подсистема балансировки нагрузки инфраструктуры Azure                          | Внешний и внутренний  |

>[!IMPORTANT]
> Порты, для которых *назначение* выделено **полужирным**, требуются для успешного развертывания службы управления API. Тем не менее, блокировка других портов приведет к **ухудшению** возможности использования и **мониторинга работающей службы и предоставлению подтвержденного соглашения об уровне обслуживания**.

+ **Функциональность TLS.** Чтобы разрешить создание и проверку цепочки сертификатов TLS/SSL, службе управления API требуется исходящее сетевое подключение к узлам ocsp.msocsp.com, mscrl.microsoft.com и crl.microsoft.com. Эта зависимость не является обязательной, если любой сертификат, передаваемый в службу управления API, содержит полную цепочку до корневого ЦС.

+ **Доступ к DNS.** Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами. Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой размещена служба управления API.

+ **Наблюдение за работоспособностью и метриками.** Исходящее сетевое подключение к конечным точкам мониторинга Azure, которое разрешается в следующих доменах. Как показано в таблице, эти URL-адреса представлены в теге службы AzureMonitor для использования с группами безопасности сети.

    | Среда Azure | Конечные точки                                                                                                                                                                                                                                                                                                                                                              |
    |-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Azure Public      | <ul><li>gcs.prod.monitoring.core.windows.net (**новое**)</li><li>prod.warmpath.msftcloudes.com (**не рекомендуется**)</li><li>global.prod.microsoftmetrics.com (**новое**)</li><li>global.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2.prod.microsoftmetrics.com (**новое**)</li><li>shoebox2.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2-red.prod.microsoftmetrics.com</li><li>shoebox2-black.prod.microsoftmetrics.com</li><li>shoebox2-red.shoebox2.metrics.nsatc.net</li><li>shoebox2-black.shoebox2.metrics.nsatc.net</li><li>prod3.prod.microsoftmetrics.com (**новое**)</li><li>prod3.metrics.nsatc.net (**не рекомендуется**)</li><li>prod3-black.prod.microsoftmetrics.com (**новое**)</li><li>prod3-black.prod3.metrics.nsatc.net (**не рекомендуется**)</li><li>prod3-red.prod.microsoftmetrics.com (**новое**)</li><li>prod3-red.prod3.metrics.nsatc.net (**не рекомендуется**)</li><li>gcs.prod.warm.ingestion.monitoring.azure.com</li></ul> |
    | Azure для государственных организаций  | <ul><li>fairfax.warmpath.usgovcloudapi.net;</li><li>global.prod.microsoftmetrics.com (**новое**)</li><li>global.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2.prod.microsoftmetrics.com (**новое**)</li><li>shoebox2.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2-red.prod.microsoftmetrics.com</li><li>shoebox2-black.prod.microsoftmetrics.com</li><li>shoebox2-red.shoebox2.metrics.nsatc.net</li><li>shoebox2-black.shoebox2.metrics.nsatc.net</li><li>prod3.prod.microsoftmetrics.com (**новое**)</li><li>prod3.metrics.nsatc.net (**не рекомендуется**)</li><li>prod3-black.prod.microsoftmetrics.com</li><li>prod3-red.prod.microsoftmetrics.com</li><li>prod5.prod.microsoftmetrics.com</li><li>prod5-black.prod.microsoftmetrics.com</li><li>prod5-red.prod.microsoftmetrics.com</li><li>gcs.prod.warm.ingestion.monitoring.azure.us</li></ul>                                                                                                                                                                                                                                                |
    | Azure China 21Vianet     | <ul><li>mooncake.warmpath.chinacloudapi.cn;</li><li>global.prod.microsoftmetrics.com (**новое**)</li><li>global.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2.prod.microsoftmetrics.com (**новое**)</li><li>shoebox2.metrics.nsatc.net (**не рекомендуется**)</li><li>shoebox2-red.prod.microsoftmetrics.com</li><li>shoebox2-black.prod.microsoftmetrics.com</li><li>shoebox2-red.shoebox2.metrics.nsatc.net</li><li>shoebox2-black.shoebox2.metrics.nsatc.net</li><li>prod3.prod.microsoftmetrics.com (**новое**)</li><li>prod3.metrics.nsatc.net (**не рекомендуется**)</li><li>prod3-black.prod.microsoftmetrics.com</li><li>prod3-red.prod.microsoftmetrics.com</li><li>prod5.prod.microsoftmetrics.com</li><li>prod5-black.prod.microsoftmetrics.com</li><li>prod5-red.prod.microsoftmetrics.com</li><li>gcs.prod.warm.ingestion.monitoring.azure.cn</li></ul>                                                                                                                                                                                                                                                |

  >[!IMPORTANT]
  > Изменение указанных выше кластеров с зоной DNS **.nsatc.net** на **.microsoftmetrics.com** является по большей части изменением DNS. IP-адрес кластера не изменится.

+ **Теги региональной службы.** Правила групп безопасности сети, разрешающие исходящие подключения к тегам служб хранилища, SQL и Центров событий, могут использовать региональные версии этих тегов, соответствующие региону, где находится экземпляр Управления API (например, Storage.WestUS для экземпляра Управления API в регионе "Западная часть США"). В развертываниях с несколькими регионами группа безопасности сети должна разрешать трафик в теги службы для этого региона и основного региона.

    > [!IMPORTANT]
    > Чтобы включить публикацию [портала разработчика](api-management-howto-developer-portal.md) для экземпляра службы управления API в виртуальной сети, убедитесь, что вы также разрешите исходящие подключения к хранилищу BLOB-объектов в регионе "Западная часть США". Например, используйте тег службы **Storage. WestUS** в правиле NSG. Подключение к хранилищу BLOB-объектов в регионе "Западная часть США" в настоящее время требуется для публикации портала разработчика для любого экземпляра службы управления API.

+ **Службы SMTP-ретрансляции.** Исходящее сетевое подключение для ретрансляции SMTP, которое разрешается в узле `smtpi-co1.msn.com`, `smtpi-ch1.msn.com`, `smtpi-db3.msn.com`, `smtpi-sin.msn.com` и `ies.global.microsoft.com`.

+ **CAPTCHA на портале разработчика**. Исходящее сетевое подключение для CAPTCHA на портале разработчика, которое разрешается в узле `client.hip.live.com` и `partner.hip.live.com`.

+ **Портал Azure Diagnostics.** Включает поток журналов диагностики на портале Azure при использовании расширения управления API внутри виртуальной сети; требуется исходящий доступ к `dc.services.visualstudio.com` на порте 443. Это помогает в устранении неполадок, которые могут возникнуть при использовании расширения.

+ **Azure Load Balancer**. Разрешение входящего запроса из тега службы `AZURE_LOAD_BALANCER` не является требованием для номера SKU `Developer`, так как за ним развертывается только одна единица вычислений. Но входящие запросы с адреса [168.63.129.16](../virtual-network/what-is-ip-address-168-63-129-16.md) становятся критически важными при масштабировании до более высокого номера SKU, например `Premium`, как так сбой проверки работоспособности из Load Balancer не позволяет выполнить развертывание.

+ **Application Insights**. Если в службе управления API включена функция мониторинга [Application Insights Azure](api-management-howto-app-insights.md) , необходимо разрешить исходящее подключение к [конечной точке телеметрии](../azure-monitor/app/ip-addresses.md#outgoing-ports) из виртуальной сети. 

+ **Принудительное туннелирование трафика в локальный брандмауэр с помощью Express Route или сетевого виртуального устройства.** Стандартная конфигурация клиента заключается в определении собственного маршрута по умолчанию (0.0.0.0/0), когда весь трафик из делегированной подсети Управления API принудительно проходит через локальный брандмауэр или виртуальное сетевое устройство. Этот поток трафика неизменно прерывает подключение к службе управления API Azure, так как исходящий трафик или блокируется локально, или преобразуется с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure. Для решения проблемы требуется выполнить несколько приведенных ниже действий.

  * Включите конечные точки службы в подсети, в которой развернута служба управления API. Необходимо включить [конечные точки службы][ServiceEndpoints] для Azure SQL, службы хранилища Azure, Центра событий Azure и служебной шины Azure. Включение конечных точек для этих служб непосредственно из делегированной подсети Управления API позволяет использовать магистральную сеть Microsoft Azure с оптимальной маршрутизацией трафика службы. Если вы используете конечные точки службы с принудительным туннелированием Управления API, трафик указанных выше служб Azure не туннелируется принудительно. Принудительно туннелируется другой трафик зависимостей службы управления API, и он не может быть утерян, иначе служба управления API будет работать неправильно.
    
  * Весь трафик уровня управления из Интернета в конечную точку управления службы управления API направляется через конкретный набор входящих IP-адресов, размещенных в службе управления API. При принудительном туннелировании трафика ответы не будут симметрично сопоставляться с этими входящими исходными IP-адресами. Чтобы преодолеть это ограничение, необходимо добавить следующие определяемые пользователем маршруты ([UDR][UDRs]) для направления трафика обратно в Azure, задав "Интернет" в качестве назначения для этих маршрутов. Набор входящих IP-адресов для трафика уровня управления приведен в [этом разделе](#control-plane-ips).

  * Для других зависимостей службы управления API с принудительным туннелированием должен существовать определенный способ разрешения имени узла и доступа к конечной точке. К ним относятся
      - Наблюдение за работоспособностью и метриками
      - Диагностика на портале Azure
      - Ретрансляция SMTP
      - CAPTCHA на портале разработчика

## <a name="troubleshooting"></a><a name="troubleshooting"> </a>Устранение неполадок
* **Начальная настройка.** Если первоначальное развертывание службы управления API в подсети завершится неудачно, попробуйте сначала развернуть виртуальную машину в той же подсети. Следующий удаленный рабочий стол в виртуальной машине и проверьте наличие подключения к одному из ресурсов, приведенных ниже в подписке Azure.
    * Большой двоичный объект хранилища Azure
    * База данных SQL Azure
    * Таблица хранилища Azure

  > [!IMPORTANT]
  > Проверив подключение, обязательно удалите все ресурсы, развернутые в подсети, прежде чем развертывать в этой подсети службу управления API.

* **Проверьте состояние сетевого подключения**. После развертывания службы управления API в подсети используйте портал, чтобы проверить подключение экземпляра к зависимостям, таким как служба хранилища Azure. На портале в меню слева в разделе **развертывание и инфраструктура** выберите **состояние сетевого подключения**.

   :::image type="content" source="media/api-management-using-with-vnet/verify-network-connectivity-status.png" alt-text="Проверка состояния сетевого подключения на портале":::

    * Выберите **требуется** для проверки подключения к необходимым службам Azure для управления API. Сбой указывает, что экземпляру не удается выполнить основные операции для управления API.
    * Выберите **необязательно** , чтобы проверить подключение к дополнительным службам. Любой сбой означает, что определенные функции не будут работать (например, SMTP). Сбой может привести к снижению способности использовать и отслеживать экземпляр управления API и предоставлять зафиксированное соглашение об уровне обслуживания.

Чтобы устранить проблемы с подключением, ознакомьтесь с [общими проблемами сетевой конфигурации](#network-configuration-issues) и исправьте необходимые параметры сети.

* **Добавочные операции обновления.** При внесении изменений в сеть воспользуйтесь [API состояния сети](/rest/api/apimanagement/2019-12-01/networkstatus), чтобы проверить, не утратила ли служба управления API доступ к каким-либо критически важным ресурсам, от которых она зависит. Состояние подключения должно обновляться каждые 15 минут.

* **Ссылки для перехода на ресурсы.** При развертывании в подсеть виртуальной сети, созданной с помощью модели Resource Manager, API управления резервирует эту подсеть, создавая ссылку для перехода на ресурс. Если эта подсеть уже содержит ресурс другого поставщика, развертывание **завершится ошибкой**. Аналогично, если вы перемещаете службу управления API в другую подсеть или удаляете ее, мы удаляем соответствующую ссылку для перехода на ресурс.

## <a name="subnet-size-requirement"></a><a name="subnet-size"> </a>Требования к размеру подсети
Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр службы управления API в подсети использует два IP-адреса на единицу SKU уровня "Премиум" или один IP-адрес на SKU уровня "Разработка". Каждый экземпляр резервирует дополнительный IP-адрес для внешней подсистемы балансировки нагрузки. При развертывании во внутренней виртуальной сети требуется дополнительный IP-адрес для внутренней подсистемы балансировки нагрузки.

Согласно приведенным выше расчетам минимальный размер подсети, в которой можно развернуть службу управления API, — /29. При таком размере предоставляется три рабочих IP-адреса.

Каждой дополнительной единице масштабирования Управления API требуется еще два IP-адреса.

## <a name="routing"></a><a name="routing"> </a> Маршрутизация
+ Чтобы обеспечить доступ ко всем конечным точкам службы, резервируется общедоступный IP-адрес для подсистемы балансировки нагрузки.
+ Для доступа к ресурсам в пределах виртуальной сети используется выделенный IP-адрес из диапазона подсети, а за пределами этой сети — общедоступный виртуальный IP-адрес.
+ Общедоступный IP-адрес для балансировки нагрузки можно узнать в колонке "Обзор и основные сведения" на портале Azure.

## <a name="limitations"></a><a name="limitations"> </a> Ограничения
* Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.
* Эта подсеть и служба управления API должны находиться в одной подписке.
* Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.
* Если служба управления API развернута в нескольких регионах в режиме внутренней виртуальной сети, пользователи должны самостоятельно настроить балансировку нагрузки, так как они отвечают за маршрутизацию.
* Подключение от ресурса, находящегося в пиринговой виртуальной сети в другом регионе, к службе управления API во внутреннем режиме невозможно из-за ограничений платформы. Дополнительные сведения см. в разделе [Требования и ограничения](../virtual-network/virtual-network-manage-peering.md#requirements-and-constraints).

## <a name="control-plane-ip-addresses"></a><a name="control-plane-ips"> </a> IP-адреса уровня управления

IP-адреса разделены **средой Azure**. При разрешении IP-адреса входящих запросов, помеченных как **глобальные** , должны быть разрешены вместе с IP-адресом конкретного **региона** .

| **Среда Azure**|   **Регион**|  **IP-адрес**|
|-----------------|-------------------------|---------------|
| Azure Public| Центрально-южная часть США (глобально)| 104.214.19.224|
| Azure Public| Центрально-северная часть США (глобально)| 52.162.110.80|
| Azure Public| центрально-западная часть США| 52.253.135.58|
| Azure Public| Республика Корея, центральный регион| 40.82.157.167|
| Azure Public| западная часть Соединенного Королевства| 51.137.136.0|
| Azure Public| Западная Япония| 40.81.185.8.|
| Azure Public| Центрально-северная часть США| 40.81.47.216|
| Azure Public| южная часть Соединенного Королевства| 51.145.56.125|
| Azure Public| Западная Индия| 40.81.89.24|
| Azure Public| Восточная часть США| 52.224.186.99|
| Azure Public| Западная Европа| 51.145.179.78.|
| Azure Public| Восточная Япония| 52.140.238.179.|
| Azure Public| Центральная Франция| 40.66.60.111|
| Azure Public| Восточная Канада| 52.139.80.117|
| Azure Public| Северная часть ОАЭ;| 20.46.144.85|
| Azure Public| Южная Бразилия| 191.233.24.179|
| Azure Public| Юго-Восточная Бразилия| 191.232.18.181|
| Azure Public| Юго-Восточная Азия| 40.90.185.46|
| Azure Public| Северная часть ЮАР;| 102.133.130.197|
| Azure Public| Центральная Канада| 52.139.20.34|
| Azure Public| Республика Корея, южный регион| 40.80.232.185|
| Azure Public| Центральная Индия| 13.71.49.1|
| Azure Public| западная часть США| 13.64.39.16|
| Azure Public| Юго-Восточная часть Австралии| 20.40.160.107|
| Azure Public| Центральная Австралия| 20.37.52.67|
| Azure Public| Южная Индия| 20.44.33.246|
| Azure Public| Центральная часть США| 13.86.102.66|
| Azure Public| Восточная Австралия| 20.40.125.155|
| Azure Public| западная часть США 2| 51.143.127.203|
| Azure Public| Восточная часть США 2 (EUAP)| 52.253.229.253|
| Azure Public| Центральная часть США (EUAP)| 52.253.159.160|
| Azure Public| Центрально-южная часть США| 20.188.77.119|
| Azure Public| восточная часть США 2| 20.44.72.3|
| Azure Public| Северная Европа| 52.142.95.35|
| Azure Public| Восточная Азия| 52.139.152.27|
| Azure Public| Южная Франция| 20.39.80.2|
| Azure Public| Западная Швейцария| 51.107.96.8|
| Azure Public| Центральная Австралия 2| 20.39.99.81|
| Azure Public| Центральная часть ОАЭ.| 20.37.81.41|
| Azure Public| Северная Швейцария| 51.107.0.91|
| Azure Public| Западная часть ЮАР| 102.133.0.79|
| Azure Public| Центрально-Западная Германия| 51.116.96.0|
| Azure Public| Северная Германия| 51.116.0.0|
| Azure Public| Восточная Норвегия;| 51.120.2.185|
| Azure Public| Западная Норвегия| 51.120.130.134|
| Azure China 21Vianet| Северный Китай (глобально)| 139.217.51.16|
| Azure China 21Vianet| Восточный Китай (глобально)| 139.217.171.176|
| Azure China 21Vianet| Северный Китай| 40.125.137.220|
| Azure China 21Vianet| Восточный Китай| 40.126.120.30|
| Azure China 21Vianet| Северный Китай 2| 40.73.41.178|
| Azure China 21Vianet| Восточный Китай 2| 40.73.104.4|
| Azure для государственных организаций| USGov (Вирджиния) (глобально)| 52.127.42.160|
| Azure для государственных организаций| USGov (Техас) (глобально)| 52.127.34.192|
| Azure для государственных организаций| USGov (Вирджиния)| 52.227.222.92|
| Azure для государственных организаций| USGov Iowa| 13.73.72.21|
| Azure для государственных организаций| USGov (Аризона)| 52.244.32.39|
| Azure для государственных организаций| USGov (Техас)| 52.243.154.118|
| Azure для государственных организаций| Центральная часть США (DoD)| 52.182.32.132|
| Azure для государственных организаций| Восточная часть США (DoD)| 52.181.32.192|

## <a name="related-content"></a><a name="related-content"> </a>См. также
* [Подключение типа "сеть — сеть" и многосайтовое подключение (через VPN-туннель IPsec/IKE)](../vpn-gateway/design.md#s2smulti)
* [Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [Как использовать инспектор API для трассировки вызовов в службе управления API Azure](api-management-howto-api-inspector.md)
* [Виртуальная сеть: часто задаваемые вопросы](../virtual-network/virtual-networks-faq.md)
* [Теги служб](../virtual-network/network-security-groups-overview.md#service-tags)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-internal.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-external.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/network-security-groups-overview.md
[ServiceEndpoints]: ../virtual-network/virtual-network-service-endpoints-overview.md
[ServiceTags]: ../virtual-network/network-security-groups-overview.md#service-tags
