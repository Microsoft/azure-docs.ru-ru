---
title: Устранение неполадок времени ожидания ответа клиента и ошибок в службе управления API
description: Устранение периодических ошибок подключения и связанных проблем задержки в управлении API
author: vladvino
ms.topic: troubleshooting
ms.date: 12/04/2020
ms.author: apimpm
ms.service: api-management
ms.openlocfilehash: 6cace4a02c8d45cacbbc34e9778b5c4a78ada27f
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100576525"
---
# <a name="troubleshooting-client-response-timeouts-and-errors-with-api-management"></a>Устранение неполадок времени ожидания ответа клиента и ошибок в службе управления API

Эта статья поможет вам устранить временные ошибки подключения и связанные с задержкой проблемы в [службе управления API Azure](./api-management-key-concepts.md). В частности, в этой статье приводятся сведения и устранение неполадок для нехватки портов преобразования сети исходного адреса (SNAT). Если вам нужна дополнительная помощь, обратитесь к экспертам по Azure в службе [поддержки сообщества Azure](https://azure.microsoft.com/support/community/) или отправьте запрос в службу поддержки с помощью [службы поддержки Azure](https://azure.microsoft.com/support/options/).

## <a name="symptoms"></a>Симптомы

Клиентские приложения, вызывающие интерфейсы API через службу управления API (APIM), могут демонстрировать одну или несколько из следующих симптомов:

* Периодические ошибки HTTP 500
* Сообщения об ошибках времени ожидания

Эти симптомы являются экземплярами `BackendConnectionFailure` в [журналах Azure Monitor ресурсов](../azure-monitor/essentials/resource-logs.md).

## <a name="cause"></a>Причина

Такая ситуация часто возникает из-за ограничений портов преобразования сетевых адресов (SNAT) в службе APIM.

Когда клиент вызывает один из интерфейсов API APIM, служба управления API Azure открывает порт SNAT для доступа к API серверной части. Как обсуждалось в разделе [Исходящие подключения в Azure](../load-balancer/load-balancer-outbound-connections.md), Azure использует преобразование адресов исходной сети (SNAT) и Load Balancer (не предоставляется клиентам) для обмена данными с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, а также конечных точек, внутренних для Azure, которые не используют [конечные точки службы виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md). Эта ситуация применима только к серверным интерфейсам API, доступным на общедоступных IP-адресах.

Каждому экземпляру службы управления API изначально присвоено предварительно выделенное количество портов SNAT. Этот предел влияет на открытие соединений с одним и тем же сочетанием узла и порта. Порты SNAT используются при многократных вызовах с одним и тем же сочетанием адреса и порта. После освобождения порта SNAT порт будет доступен для повторного использования по мере необходимости. Балансировщик сетевой нагрузки Azure освобождает порты SNAT от закрытых подключений только после ожидания в течение четырех минут.

Быстрое выполнение клиентских запросов к интерфейсам API может привести к исчерпанию предварительно выделенной квоты портов SNAT, если эти порты не закрыты и перезапускаются достаточно быстро, так как служба APIM не сможет своевременно обрабатывать запросы клиентов.

## <a name="mitigations-and-solutions"></a>Устранение рисков и решения

Чтобы решить проблему нехватки портов SNAT, сначала необходимо диагностировать и оптимизировать производительность серверных служб.

Общие стратегии по устранению нехватки портов SNAT обсуждаются в [статье Устранение сбоев исходящих подключений](../load-balancer/troubleshoot-outbound-connection.md) из *Azure Load Balancerной* документации. Следующие стратегии применимы к управлению API.

### <a name="scale-your-apim-instance"></a>Масштабирование экземпляра APIM

Каждому экземпляру управления API выделяется несколько портов SNAT на основе единиц APIM. Чтобы выделить дополнительные порты SNAT, можно масштабировать экземпляр управления API с дополнительными единицами. Дополнительные сведения см. в статье [масштабирование службы управления API](upgrade-and-scale.md#scale-your-api-management-service) .

> [!NOTE]
> Использование портов SNAT сейчас недоступно в качестве метрики для автомасштабирования единиц управления API.

### <a name="use-multiple-ips-for-your-backend-urls"></a>Использовать несколько IP-адресов для серверных URL

Каждое подключение из экземпляра APIM к тому же IP-адресу назначения и порту назначения внутренней службы будет использовать порт SNAT, чтобы поддерживать отдельный поток трафика. Без различных портов SNAT для возврата трафика из фоновой службы APIM не сможет разделить один ответ от другого.

Так как порты SNAT можно использовать повторно, если конечный IP-адрес или порт назначения отличаются, другой способ избежать нехватки портов SNAT — использовать несколько IP-адресов для URL серверной службы.

Дополнительные сведения см. в разделе [исходящий прокси-Azure Load Balancer](../load-balancer/load-balancer-outbound-connections.md).

### <a name="place-your-apim-and-backend-service-in-the-same-vnet"></a>Размещение APIM и внутренней службы в одной виртуальной сети

Если API серверной части размещен в службе Azure, которая поддерживает *конечные точки службы* , такие как служба приложений, можно избежать проблем нехватки портов SNAT, разместив экземпляр APIM и серверную службу в одной виртуальной сети и предоставив ее через [конечные точки службы](../virtual-network/virtual-network-service-endpoints-overview.md) или [частные конечные точки](../private-link/private-endpoint-overview.md). Если вы используете общую виртуальную сеть и конечные точки службы в подсети интеграции, исходящий трафик от вашего экземпляра APIM к этим службам обходит Интернет, тем самым избегая ограничений портов SNAT. Аналогично, если вы используете конечную точку виртуальной сети и закрытой конечной точки, у вас не будет каких-либо исходящих проблем с портами SNAT.

Дополнительные сведения см. [в статьях Использование управления API Azure с виртуальными сетями](api-management-using-with-vnet.md) и [Интеграция службы приложений с виртуальной сетью Azure](../app-service/web-sites-integrate-with-vnet.md).

### <a name="place-your-apim-in-a-virtual-network-and-route-outbound-calls-to-azure-firewall"></a>Размещение APIM в виртуальной сети и Маршрутизация исходящих вызовов в брандмауэр Azure

Подобно размещению APIM и серверных служб в виртуальной сети, вы можете использовать брандмауэр Azure в сети с вашей службой APIM, а затем направить исходящие вызовы APIM в брандмауэр Azure. Между APIM и брандмауэром Azure (который находится в одной виртуальной сети) порты SNAT не требуются. Для подключений SNAT к серверным службам брандмауэр Azure имеет 64 000 доступных портов, намного больший объем, чем выделено экземплярам APIM.

Дополнительные сведения см. в документации по [брандмауэру Azure](../firewall/overview.md) .

### <a name="consider-response-caching-and-other-backend-performance-tuning"></a>Рассмотрите возможность кэширования ответов и другой настройки производительности серверной части

Еще одним возможным снижением рисков является повышение времени обработки серверных интерфейсов API. Одним из способов этого является настройка некоторых API с кэшированием ответов для сокращения задержки между клиентскими приложениями, вызывающими API-интерфейс, и внутренней нагрузкой APIM.

Дополнительные сведения см. в статье [Добавление кэширования для повышения производительности в службе управления API Azure](api-management-howto-cache.md).

### <a name="consider-implementing-access-restriction-policies"></a>Рассмотрите возможность реализации политик ограничения доступа

Если это имеет смысл для вашего бизнес-сценария, можно реализовать политики ограничения доступа для продукта управления API. Например, `rate-limit-by-key` политику можно использовать для предотвращения пиков использования API для каждого ключа, ограничивая частоту вызовов за указанный период времени.

Дополнительные сведения см. в разделе [политики ограничения доступа для управления API](api-management-access-restriction-policies.md) .

## <a name="see-also"></a>См. также

* [Azure Load Balancer: Устранение сбоев исходящих подключений](../load-balancer/troubleshoot-outbound-connection.md)
* [Служба приложений Azure: Устранение неполадок с периодическими исходящими ошибками подключения](../app-service/troubleshoot-intermittent-outbound-connection-errors.md)
