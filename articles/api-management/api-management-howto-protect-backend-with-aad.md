---
title: Защита серверной части API в службе управления API с помощью OAuth 2,0 и Azure AD
titleSuffix: Azure API Management
description: Узнайте, как защитить доступ к серверной части веб-API в службе управления API Azure с помощью авторизации пользователя OAuth 2,0 и Azure Active Directory
services: api-management
author: miaojiang
ms.service: api-management
ms.topic: article
ms.date: 09/23/2020
ms.author: apimpm
ms.custom: contperf-fy21q1
ms.openlocfilehash: face4beab450e92be76b2bb90e45625e025de6ee
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97027923"
---
# <a name="protect-a-web-api-backend-in-azure-api-management-by-using-oauth-20-authorization-with-azure-ad"></a>Защита серверной части веб-API в службе управления API Azure с помощью авторизации OAuth 2,0 в Azure AD 

В этом руководство показано, как настроить экземпляр службы [управления API Azure](api-management-key-concepts.md) для защиты API с помощью [протокола OAuth 2,0 с Azure Active Directory (Azure AD)](../active-directory/develop/active-directory-v2-protocols.md). 

> [!NOTE]
> Эта функция доступна на уровнях **Developer**, **Basic**, **Standard** и **Premium** интерфейса управления API.

## <a name="prerequisites"></a>Предварительные условия

Чтобы выполнить шаги в этой статье, необходимо иметь следующее:

- Экземпляр управления API.
- Публикуемый API, использующий экземпляр управления API (APIM).
- клиент Azure AD;

## <a name="overview"></a>Обзор

Ниже приведен краткий обзор шагов.

1. Регистрация приложения (серверного приложения) в Azure Active Directory для представления API.
1. Регистрация другого приложения (клиентского приложения) в Azure Active Directory для представления клиентского приложения, которое будет вызывать API.
1. Предоставление разрешения в Azure Active Directory, чтобы разрешить клиентскому приложению вызывать серверное.
1. Настройте консоль разработчика для вызова API с помощью авторизации пользователя OAuth 2,0.
1. Добавление политики **validate-jwt** для проверки токена OAuth для каждого входящего запроса.

## <a name="register-an-application-in-azure-ad-to-represent-the-api"></a>Регистрация приложения в Azure Active Directory для представления API

Чтобы защитить API с помощью Azure AD, сначала необходимо зарегистрировать в Azure AD приложение, которое представляет API. В следующих шагах для регистрации приложения используется портал Azure. Дополнительные сведения о регистрации приложений см. в разделе [Краткое руководство. Настройка приложения для предоставления доступа к веб-API](../active-directory/develop/quickstart-configure-app-expose-web-apis.md).

1. Перейдите в [портал Azure](https://portal.azure.com) , чтобы зарегистрировать приложение. Найдите и выберите **Регистрация приложений**.

1. Выберите **Новая регистрация**. 

1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:

   - В разделе **имя** введите понятное имя приложения, которое будет отображаться для пользователей приложения, например *серверное приложение*. 
   - В разделе **Поддерживаемые типы учетных записей** выберите вариант, который подходит для вашего сценария. 

1. Оставьте пустым раздел **URI перенаправления** .

1. Выберите **Зарегистрировать**, чтобы создать приложение. 

1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже.

1. Выберите **предоставить API** и задайте **URI идентификатора приложения** со значением по умолчанию. Запишите это значение для дальнейшего использования.

1. Нажмите кнопку **Добавить область** , чтобы открыть страницу **Добавление области** . Затем создайте новую область, которая поддерживается API (например, `Files.Read` ).

1. Нажмите кнопку **Добавить область** , чтобы создать область. Повторите этот шаг, чтобы добавить все области, поддерживаемые API.

1. При создании областей запишите их, чтобы использовать на последующем шаге. 

## <a name="register-another-application-in-azure-ad-to-represent-a-client-application"></a>Регистрация другого приложения в Azure Active Directory для представления клиентского приложения

Каждое клиентское приложение, вызывающее API, должно быть зарегистрировано в Azure AD как приложение. В этом примере клиентское приложение является **консолью разработчика** на портале РАЗРАБОТЧИКА управления API. 

Чтобы зарегистрировать другое приложение в Azure AD для представления консоли разработчика, сделайте следующее:

1. Перейдите в [портал Azure](https://portal.azure.com) , чтобы зарегистрировать приложение.

1. Найдите и выберите **Регистрация приложений**.

1. Выберите **Новая регистрация**.

1. После появления страницы **Регистрация приложения** введите сведения о регистрации приложения:

   - В разделе **имя** введите понятное имя приложения, которое будет отображаться для пользователей приложения, например *клиент-приложение*. 
   - В разделе **Поддерживаемые типы учетных записей** выберите **учетные записи в любом каталоге организации (любой каталог Azure AD — клиент)**. 

1. В разделе **URI перенаправления** выберите `Web` и оставьте поле URL-адрес пустым для Now.

1. Выберите **Зарегистрировать**, чтобы создать приложение. 

1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже.

1. Создайте секрет клиента для этого приложения, который будет использоваться на последующем шаге.

   1. В списке страниц клиентского приложения выберите **сертификаты & секреты** и щелкните **новый секрет клиента**.

   1. В разделе **Добавление секрета клиента** введите **Описание**. Выберите время истечения срока действия ключа и нажмите кнопку **Добавить**.

При создании секрета Запомните значение ключа, которое будет использоваться на последующем шаге. 

## <a name="grant-permissions-in-azure-ad"></a>Предоставление разрешений в AAD

Теперь, когда вы зарегистрировали два приложения для представления API и консоли разработчика, предоставьте разрешения, позволяющие клиентскому приложению вызывать серверное приложение.  

1. Перейдите в [портал Azure](https://portal.azure.com) , чтобы предоставить разрешения для клиентского приложения. Найдите и выберите **Регистрация приложений**.

1. Выберите свое клиентское приложение. Затем в списке страниц приложения выберите **разрешения API**.

1. Выберите **Добавить разрешение**.

1. В разделе **Выбор API** выберите **Мои API**, а затем найдите и выберите серверное приложение.

1. В разделе **делегированные разрешения** выберите соответствующие разрешения для серверного приложения, а затем щелкните **Добавить разрешения**.

1. При необходимости на странице **разрешения API** выберите **предоставить согласие администратора для \<your-tenant-name>** предоставления согласия от имени всех пользователей в этом каталоге. 

## <a name="enable-oauth-20-user-authorization-in-the-developer-console"></a>Включение авторизации пользователей по протоколу OAuth 2.0 в консоли разработчика

На данный момент мы создали приложения в Azure Active Directory и предоставили соответствующие разрешения, позволяющие клиентскому приложению вызывать серверное. 

В этом примере консоль разработчика является клиентским приложением. В следующих шагах описано включение авторизации пользователя по протоколу OAuth 2.0 в консоли разработчика. 

1. В портал Azure перейдите к экземпляру управления API.

1. Выберите **OAuth 2,0**  >  **добавить**.

1. Укажите **отображаемое имя** и **описание**.

1. В поле **URL-адрес страницы регистрации клиента** введите значение заполнителя, например `http://localhost` . **URL-адрес страницы регистрации клиента** указывает на страницу, которую пользователи могут использовать для создания и настройки собственных учетных записей для поставщиков OAuth 2,0, которые поддерживают это. В этом примере пользователи не создают и не настраивают собственные учетные записи, поэтому используется заполнитель.

1. Выберите **Код авторизации** для **типов предоставления авторизации**.

1. Затем укажите **URL-адрес конечной точки авторизации** и **URL-адрес конечной точки маркера**. Эти значения можно извлечь на странице **конечных точек** в клиенте Azure Active Directory. Снова перейдите на страницу **Регистрация приложений** и выберите **Конечные точки**.


1. Скопируйте значение **конечной точки авторизации OAuth 2.0** и вставьте его в текстовое поле **URL-адрес конечной точки авторизации**. Выберите **POST** в разделе метод запроса авторизации.

1. Скопируйте значение **конечной точки маркера OAuth 2.0** и вставьте его в текстовое поле **URL-адрес конечной точки маркера**. 

   >[!IMPORTANT]
   > Используйте конечные точки **v1** или **v2** . Однако в зависимости от выбранной версии приведенный ниже шаг будет другим. Рекомендуется использовать конечные точки версии 2. 

1. При использовании конечных точек **v1** добавьте параметр Body с именем **Resource**. В качестве значения этого параметра используйте **идентификатор приложения** серверного приложения. 

1. Если используются конечные точки **версии 2** , используйте область, созданную для внутреннего приложения, в поле **область по умолчанию** . Также убедитесь, что для свойства задано значение [`accessTokenAcceptedVersion`](../active-directory/develop/reference-app-manifest.md#accesstokenacceptedversion-attribute) `2` в [манифесте приложения](../active-directory/develop/reference-app-manifest.md).

1. Затем укажите учетные данные клиента. Это должны быть учетные данные клиентского приложения.

1. В качестве **идентификатора клиента** используйте **идентификатор приложения** клиентского приложения.

1. Для **секрета клиента** используйте ранее созданный для клиентского приложения ключ. 

1. Далее в качестве типа предоставления кода авторизации указан **redirect_url**. Запишите этот URL-адрес.

1. Нажмите кнопку **создания**.

1. Вернитесь к регистрации клиентского приложения в Azure Active Directory и выберите **Проверка подлинности**.

1. В разделе **конфигурации платформы** щелкните **Добавить платформу** и выберите тип **веб**, вставьте **redirect_url** в разделе **URI перенаправления**, а затем нажмите кнопку **настроить** , чтобы сохранить.

Теперь, когда сервер авторизации OAuth 2.0 настроен, консоль разработчика должна получать маркеры доступа от Azure Active Directory. 

Следующим шагом является включение авторизации пользователей по протоколу OAuth 2.0 для API, чтобы консоль разработчика получала маркер доступа от имени пользователя перед вызовом API.

1. Перейдите к экземпляру службы управления API и выберите раздел **API**.

1. Выберите API, который нужно защитить. Например, `Echo API`.

1. Перейдите в меню **Параметры**.

1. В разделе **безопасности** выберите **OAuth 2.0**, а также настроенный ранее сервер OAuth 2.0. 

1. Щелкните **Сохранить**.

## <a name="successfully-call-the-api-from-the-developer-portal"></a>Удачный вызов API с портала разработчика

> [!NOTE]
> Этот раздел не относится к ценовой категории **Потребление**, которая не поддерживает портал разработчика.

Теперь, когда авторизация пользователя OAuth 2,0 включена в API, консоль разработчика получает маркер доступа от имени пользователя перед вызовом API.

1. Перейдите к любой операции в API на портале разработчика и выберите **попробовать**. Откроется консоль разработчика.

1. Обратите внимание на новый элемент в разделе **авторизация** , соответствующий только что добавленному серверу авторизации.

1. Выберите **Код авторизации** в раскрывающемся списке авторизации, после чего будет предложено войти в клиент Azure Active Directory. Если вы уже вошли с помощью учетной записи, запрос на ввод учетных данных не появится.

1. После успешного входа в систему заголовок `Authorization` будет добавлен в запрос с маркером доступа из Azure Active Directory. Ниже приведен пример маркера (в кодировке Base64).

   ```
   Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IlNTUWRoSTFjS3ZoUUVEU0p4RTJnR1lzNDBRMCIsImtpZCI6IlNTUWRoSTFjS3ZoUUVEU0p4RTJnR1lzNDBRMCJ9.eyJhdWQiOiIxYzg2ZWVmNC1jMjZkLTRiNGUtODEzNy0wYjBiZTEyM2NhMGMiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC80NDc4ODkyMC05Yjk3LTRmOGItODIwYS0yMTFiMTMzZDk1MzgvIiwiaWF0IjoxNTIxMTUyNjMzLCJuYmYiOjE1MjExNTI2MzMsImV4cCI6MTUyMTE1NjUzMywiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhHQUFBQUptVzkzTFd6dVArcGF4ZzJPeGE1cGp2V1NXV1ZSVnd1ZXZ5QU5yMlNkc0tkQmFWNnNjcHZsbUpmT1dDOThscUJJMDhXdlB6cDdlenpJdzJLai9MdWdXWWdydHhkM1lmaDlYSGpXeFVaWk9JPSIsImFtciI6WyJyc2EiXSwiYXBwaWQiOiJhYTY5ODM1OC0yMWEzLTRhYTQtYjI3OC1mMzI2NTMzMDUzZTkiLCJhcHBpZGFjciI6IjEiLCJlbWFpbCI6Im1pamlhbmdAbWljcm9zb2Z0LmNvbSIsImZhbWlseV9uYW1lIjoiSmlhbmciLCJnaXZlbl9uYW1lIjoiTWlhbyIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzcyZjk4OGJmLTg2ZjEtNDFhZi05MWFiLTJkN2NkMDExZGI0Ny8iLCJpcGFkZHIiOiIxMzEuMTA3LjE3NC4xNDAiLCJuYW1lIjoiTWlhbyBKaWFuZyIsIm9pZCI6IjhiMTU4ZDEwLWVmZGItNDUxMS1iOTQzLTczOWZkYjMxNzAyZSIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInN1YiI6IkFGaWtvWFk1TEV1LTNkbk1pa3Z3MUJzQUx4SGIybV9IaVJjaHVfSEM1aGciLCJ0aWQiOiI0NDc4ODkyMC05Yjk3LTRmOGItODIwYS0yMTFiMTMzZDk1MzgiLCJ1bmlxdWVfbmFtZSI6Im1pamlhbmdAbWljcm9zb2Z0LmNvbSIsInV0aSI6ImFQaTJxOVZ6ODBXdHNsYjRBMzBCQUEiLCJ2ZXIiOiIxLjAifQ.agGfaegYRnGj6DM_-N_eYulnQdXHhrsus45QDuApirETDR2P2aMRxRioOCR2YVwn8pmpQ1LoAhddcYMWisrw_qhaQr0AYsDPWRtJ6x0hDk5teUgbix3gazb7F-TVcC1gXpc9y7j77Ujxcq9z0r5lF65Y9bpNSefn9Te6GZYG7BgKEixqC4W6LqjtcjuOuW-ouy6LSSox71Fj4Ni3zkGfxX1T_jiOvQTd6BBltSrShDm0bTMefoyX8oqfMEA2ziKjwvBFrOjO0uK4rJLgLYH4qvkR0bdF9etdstqKMo5gecarWHNzWi_tghQu9aE3Z3EZdYNI_ZGM-Bbe3pkCfvEOyA
   ```

1. Нажмите кнопку **Отправить** , чтобы успешно вызвать API.

## <a name="configure-a-jwt-validation-policy-to-pre-authorize-requests"></a>Настройка политики проверки JWT для запросов предварительной авторизации

На этом этапе, когда пользователь пытается выполнить вызов из консоли разработчика, ему предлагается выполнить вход. Консоль разработчика получает маркер доступа от имени пользователя и включает маркер в запрос, отправленный в API.

Но что делать, если кто-то вызывает API без маркера или с недопустимым токеном? Например, попробуйте вызвать API без `Authorization` заголовка, вызов по-прежнему будет проходить через. Причина в том, что на этом этапе экземпляр службы управления API не проверяет маркер доступа. Он просто передает заголовок `Authorization` в API серверной части.

Используйте политику [проверки JWT](./api-management-access-restriction-policies.md#ValidateJWT) для предварительной авторизации запросов в управлении API, проверив маркеры доступа каждого входящего запроса. Если у запроса нет допустимого маркера, управление API блокирует его. Например, добавьте следующую политику в `<inbound>` раздел политика `Echo API` . Она проверяет наличие утверждения "Аудитория" в маркере доступа и возвращает сообщение об ошибке, если маркер является недопустимым. Сведения о настройке политик см. в статье [How to set or edit Azure API Management policies](./set-edit-policies.md) (Как настроить или изменить политики в службе управления API Azure).


```xml
<validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized. Access token is missing or invalid.">
    <openid-config url="https://login.microsoftonline.com/{aad-tenant}/.well-known/openid-configuration" />
    <required-claims>
        <claim name="aud">
            <value>{Application ID of backend-app}</value>
        </claim>
    </required-claims>
</validate-jwt>
```

> [!NOTE]
> Этот `openid-config` URL-адрес соответствует конечной точке v1. Для `openid-config` конечной точки версии 2 Используйте следующий URL-адрес:
>
> `https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`.

## <a name="build-an-application-to-call-the-api"></a>Создание приложения для вызова API

В этом руководстве мы использовали консоль разработчика в APIM как пример клиентского приложения для вызова `Echo API`, защищенного OAuth 2.0. Чтобы узнать больше о том, как создать приложение и реализовать OAuth 2.0, изучите [примеры кода Azure Active Directory](../active-directory/develop/sample-v2-code.md).

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше об [Azure Active Directory и OAuth 2.0](../active-directory/develop/authentication-vs-authorization.md).
- См. другие [видео](https://azure.microsoft.com/documentation/videos/index/?services=api-management) об управлении API.
- Другие способы защиты внутренней серверной службы см. в разделе [Взаимная проверка подлинности на основе сертификата](./api-management-howto-mutual-certificates.md).
- [Создайте экземпляр службы управления API](./get-started-create-service-instance.md).
- [Импорт и публикация первого API](./import-and-publish.md)
