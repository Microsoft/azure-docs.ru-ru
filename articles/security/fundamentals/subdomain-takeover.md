---
title: Запретить поддомену такеоверс с записями псевдонимов Azure DNS и проверкой пользовательского домена службы приложений Azure
description: Узнайте, как избежать распространенных угроз с высокой серьезностью поддоменных перенаправление
services: security
author: memildin
manager: rkarlin
ms.assetid: ''
ms.service: security
ms.subservice: security-fundamentals
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/04/2021
ms.author: memildin
ms.openlocfilehash: c3a821156074727d02ab36cf88f3e998756b8cc4
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100389456"
---
# <a name="prevent-dangling-dns-entries-and-avoid-subdomain-takeover"></a>Предотвращение висячих записей DNS и избежание поддоменного перенаправление

В этой статье описывается распространенная угроза безопасности поддоменных перенаправление и действия, которые можно предпринять для устранения проблемы.


## <a name="what-is-a-subdomain-takeover"></a>Что такое поддомен перенаправление?

Такеоверс поддоменов — это распространенная угроза высокой серьезности для организаций, которые регулярно создают и удаляют множество ресурсов. Дочерний домен перенаправление может возникать, если имеется [запись DNS](../../dns/dns-zones-records.md#dns-records) , указывающая на отозванный ресурс Azure. Такие записи DNS называются недействительными. Записи CNAME особенно уязвимы перед этой угрозой. Перенаправление поддомена позволяет вредоносным субъектам перенаправлять трафик, предназначенный для домена организации, на сайт, выполняющий вредоносные действия.

Распространенный сценарий для поддомена перенаправление:

1. **СОЗДАТЬ**

    1. Вы подготавливаете ресурс Azure с полным доменным именем (FQDN) `app-contogreat-dev-001.azurewebsites.net` .

    1. Вы назначаете запись CNAME в зоне DNS с поддоменом `greatapp.contoso.com` , который направляет трафик в ресурс Azure.

1. **ОТЗЫВ**

    1. Ресурс Azure будет отозван или удален после того, как он больше не нужен. 
    
        На этом этапе запись CNAME `greatapp.contoso.com` *должна* быть удалена из зоны DNS. Если запись CNAME не удаляется, она объявляется как активный домен, но не направляет трафик в активный ресурс Azure. Это определение «висячих» записей DNS.

    1. Висячий поддомен `greatapp.contoso.com` теперь уязвим и может быть переназначен другому ресурсу подписки Azure.

1. **ПЕРЕНАПРАВЛЕНИЕ**

    1. Используя часто доступные методы и средства, субъект угрозы обнаруживает висячий поддомен.  

    1. Субъект угрозы подготавливает ресурс Azure с тем же полным доменным именем ранее управляемого ресурса. В этом примере — `app-contogreat-dev-001.azurewebsites.net`.

    1. Трафик, отправляемый в поддомен, `greatapp.contoso.com` теперь направляется в ресурс вредоносного субъекта, где они управляют содержимым.



![Дочерний домен перенаправление от отозванного веб-сайта](./media/subdomain-takeover/subdomain-takeover.png)



## <a name="the-risks-of-subdomain-takeover"></a>Риски поддомена перенаправление

Если запись DNS указывает на недоступный ресурс, сама запись должна быть удалена из зоны DNS. Если он не был удален, это запись «висячий DNS» и создает возможность для поддомена перенаправление.

Висячие записи DNS позволяют субъектам-угрозам управлять связанным DNS-именем для размещения вредоносного веб-сайта или службы. Вредоносные страницы и службы в поддомене организации могут привести к следующим результатам:

- **Утрата контроля за содержимым поддоменом** — отрицательное воздействие Организации на невозможность защитить ее содержимое, а также ущерб торговой марки и потери доверия.

- Файл cookie, который получается **от неподозрительных посетителей** . обычно веб-приложениям предоставляется доступ к файлам cookie сеанса в поддоменах (*. contoso.com), поэтому к ним могут обращаться все поддомены. Актеры угроз могут использовать поддомен перенаправление для создания подлинной страницы, обманным путем, чтобы пользователи могли посетить эту страницу и собирать свои файлы cookie (даже безопасные файлы cookie). Распространенное заблуждение заключается в том, что использование SSL-сертификатов защищает сайт и файлы cookie пользователей от перенаправление. Однако субъект угрозы может использовать захваченный поддомен для применения и получения действительного SSL-сертификата. Действительные SSL-сертификаты предоставляют им доступ к защищенным файлам cookie и могут дополнительно повысить воспринимаемую законность вредоносного сайта.

- **Фишинговые кампании** . подлинные поддомены могут использоваться в phishing-кампаниях. Это справедливо для вредоносных веб-узлов и записей MX, которые позволяют субъекту угрозы получать сообщения электронной почты, адресованные законному поддомену известной торговой марки.

- **Дополнительные риски** — вредоносные веб-сайты могут быть использованы для передачи другим классическим атакам, таким как XSS, CSRF, обход CORS и т. д.



## <a name="identify-dangling-dns-entries"></a>Обнаружение висячих DNS-записей

Чтобы найти в Организации записи DNS, которые могут быть висячими, используйте средства PowerShell, размещенные в GitHub, с помощью Microsoft ["Get-данглингднсрекордс"](https://aka.ms/DanglingDNSDomains).

Это средство помогает клиентам Azure получить список всех доменов с записью CNAME, связанной с существующим ресурсом Azure, созданным в своих подписках или клиентах.

Если ваши записи CNAME находятся в других службах DNS и указывают на ресурсы Azure, укажите записи CNAME в входном файле средства.

Это средство поддерживает ресурсы Azure, перечисленные в следующей таблице. Средство извлекает или принимает в качестве входных данных все записи CNAME клиента.


| Служба                   | Type                                        | фкднпроперти                               | Пример                         |
|---------------------------|---------------------------------------------|--------------------------------------------|---------------------------------|
| Azure Front Door          | microsoft.network/frontdoors                | Properties. cName                           | `abc.azurefd.net`               |
| хранилище BLOB-объектов Azure        | microsoft.storage/storageaccounts           | Properties. первичных. BLOB           | `abc. blob.core.windows.net`    |
| Azure CDN                 | microsoft.cdn/profiles/endpoints            | Свойства. имя узла                        | `abc.azureedge.net`             |
| Общедоступные IP-адреса       | microsoft.network/publicipaddresses         | Properties. dnsSettings. FQDN                | `abc.EastUs.cloudapp.azure.com` |
| Azure Traffic Manager     | microsoft.network/trafficmanagerprofiles    | Properties. dnsConfig. FQDN                  | `abc.trafficmanager.net`        |
| Экземпляр контейнера Azure  | microsoft.containerinstance/containergroups | Properties. ipAddress. FQDN                  | `abc.EastUs.azurecontainer.io`  |
| Служба "Управление API Azure"      | microsoft.apimanagement/service             | Properties. Хостнамеконфигуратионс. имя_узла | `abc.azure-api.net`             |
| Служба приложений Azure         | microsoft.web/sites                         | Properties. параметром DefaultHostName                 | `abc.azurewebsites.net`         |
| Служба приложений Azure — слоты | microsoft.web/sites/slots                   | Properties. параметром DefaultHostName                 | `abc-def.azurewebsites.net`     |



### <a name="prerequisites"></a>Предварительные условия

Запустите запрос от имени пользователя, который:

- как минимум доступ на уровне чтения к подпискам Azure
- доступ для чтения к графу ресурсов Azure

Если вы являетесь глобальным администратором клиента организации, вы можете повысить свою учетную запись, чтобы получить доступ ко всем подпискам вашей организации, используя рекомендации в статье [повышение уровня доступа для управления всеми подписками и группами управления Azure](../../role-based-access-control/elevate-access-global-admin.md).


> [!TIP]
> В графе ресурсов Azure есть ограничения на регулирование и разбиение на страницы, которые следует учитывать при наличии крупной среды Azure. 
> 
> Дополнительные [сведения о работе с большими наборами данных ресурсов Azure](../../governance/resource-graph/concepts/work-with-data.md).
> 
> Для предотвращения этих ограничений средство использует пакетирование подписок.

### <a name="run-the-script"></a>Выполнение скрипта

Дополнительные сведения о скрипте PowerShell **Get-DanglingDnsRecords.ps1** и его загрузке с сайта GitHub: https://aka.ms/Get-DanglingDnsRecords .

## <a name="remediate-dangling-dns-entries"></a>Исправление висячих записей DNS 

Изучите зоны DNS и найдите записи CNAME, которые были приостановлены или были сделаны. Если поддомены могут быть висячими или перезаписаны, удалите уязвимые поддомены и снизите риски, выполнив следующие действия.

1. Из зоны DNS удалите все записи CNAME, которые указывают на полные доменные имена ресурсов, которые больше не подготавливаются.

1. Чтобы разрешить маршрутизацию трафика к ресурсам в элементе управления, подготавливает дополнительные ресурсы с полным доменным имен, указанным в записях CNAME для висячих поддоменов.

1. Проверьте код приложения на наличие ссылок на конкретные поддомены и обновите неправильные или устаревшие ссылки на поддомены.

1. Выясните, произошли ли какие либо компромиссы, и примите меры в отношении процедур реагирования на инциденты вашей организации. Советы и рекомендации по исследованию этой проблемы можно найти ниже.

    Если логика приложения так, что секреты, такие как учетные данные OAuth, были отправлены в висячий поддомен, или конфиденциальные данные были отправлены в висячие поддомены, эти данные могли быть предоставлены третьим сторонам.

1. Узнайте, почему запись CNAME не была удалена из зоны DNS при отмене подготовки ресурса, и выполните действия по обеспечению обновления записей DNS при отмене подготовки ресурсов Azure в будущем.


## <a name="prevent-dangling-dns-entries"></a>Запретить висячие записи DNS

Обеспечение того, что в организации реализованы процессы для предотвращения висячих DNS-записей, а результирующий такеоверс поддомена является важной частью программы безопасности.

Некоторые службы Azure предлагают функции, которые помогут в создании предупредительных мер и подробно описаны ниже. Другие методы для предотвращения этой проблемы должны быть установлены с помощью рекомендаций Организации или стандартных операционных процедур.

### <a name="enable-azure-defender-for-app-service"></a>Включение защитника Azure для службы приложений

Интегрированная облачная платформа защиты рабочих нагрузок центра безопасности Azure (КВПП), защитник Azure, предлагает ряд планов для защиты ресурсов и рабочих нагрузок Azure, гибридных и нескольких облаков.

**Защитник Azure для плана службы приложений** включает в себя висячий поиск DNS. Если этот план включен, вы получите оповещения системы безопасности при списании веб-сайта службы приложений, но не удаляйте его личный домен из регистратора DNS.

Защита DNS в защитнике Azure доступна, если домены управляются Azure DNS или внешним регистратором домена и применяются к службе приложений в Windows и Linux.

Дополнительные сведения об этом и других преимуществах этого плана защитника Azure см. в статье Общие сведения о [защитнике Azure для службы приложений](../../security-center/defender-for-app-service-introduction.md).

### <a name="use-azure-dns-alias-records"></a>Использование записей псевдонимов Azure DNS

[Записи псевдонимов](../../dns/dns-alias.md#scenarios) Azure DNS могут предотвратить висячие ссылки, связывая жизненный цикл записи DNS с ресурсом Azure. Например, рассмотрим запись DNS, которая является псевдонимом и указывает на общедоступный IP-адрес или профиль диспетчера трафика. Если удалить эти базовые ресурсы, запись псевдонима DNS станет пустым набором записей. Он больше не ссылается на удаленный ресурс. Важно отметить, что существует ряд ограничений, которые можно защищать с помощью записей псевдонимов. Сейчас список ограничен:

- Azure Front Door
- Профили диспетчера трафика
- Конечные точки сети доставки содержимого Azure (CDN)
- Общедоступные IP-адреса.

Несмотря на использование ограниченных предложений служб, мы рекомендуем использовать записи псевдонимов для защиты от перенаправление поддоменов везде, где это возможно.

Дополнительные [сведения о возможностях записей псевдонимов Azure DNS](../../dns/dns-alias.md#capabilities).



### <a name="use-azure-app-services-custom-domain-verification"></a>Использовать проверку пользовательского домена службы приложений Azure

При создании записей DNS для службы приложений Azure создайте АСУиД. поддомен Запись типа TXT с ИДЕНТИФИКАТОРом проверки домена. Если такая запись типа TXT существует, никакая другая подписка Azure не может проверить личный домен, который перестоит. 

Эти записи не запрещают пользователям создавать службу приложений Azure с тем же именем, что и запись CNAME. Без возможности доказательства владельца имени домена субъекты угроз не могут получить трафик или управлять содержимым.

Дополнительные [сведения о сопоставлении существующего настраиваемого DNS-имени с службой приложений Azure](../../app-service/app-service-web-tutorial-custom-domain.md).



### <a name="build-and-automate-processes-to-mitigate-the-threat"></a>Создание и автоматизация процессов для устранения угрозы

Часто разработчики и группы операций могут запускать процессы очистки, чтобы избежать висячих угроз DNS. Приведенные ниже рекомендации помогут вашей организации избежать низкий от этой угрозы. 

- **Создание процедур для предотвращения:**

    - Обучить разработчикам приложений возможность перенаправлять адреса при удалении ресурсов.

    - Вставьте "удалить запись DNS" в списке обязательных проверок при списании службы.

    - Разместите [блокировки удаления](../../azure-resource-manager/management/lock-resources.md) для всех ресурсов, имеющих пользовательскую запись DNS. Блокировка удаления служит индикатором того, что сопоставление должно быть удалено до отмены наполнения ресурса. Такие меры могут работать только вместе с внутренними программами для образования.

- **Создание процедур для обнаружения:**

    - Регулярно просматривайте свои записи DNS, чтобы убедиться, что поддомены сопоставлены с ресурсами Azure, которые:

        - Существует. запросите зоны DNS для ресурсов, указывающих на поддомены Azure, такие как *. azurewebsites.net или *. cloudapp.azure.com (см. [список ссылок на домены Azure](azure-domains.md)).
        - Вы сами подтверждаете, что являетесь владельцем всех ресурсов, на которые нацелены поддомены DNS.

    - Настройте каталог услуг конечных точек полного доменного имени (FQDN) Azure и владельцев приложений. Чтобы создать каталог услуг, выполните следующий скрипт запроса графа ресурсов Azure. Этот сценарий проецирует сведения о конечной точке FQDN ресурсов, к которым у вас есть доступ, и выводит их в CSV-файл. Если у вас есть доступ ко всем подпискам для клиента, сценарий учитывает все эти подписки, как показано в следующем примере скрипта. Чтобы ограничить результаты конкретным набором подписок, измените скрипт, как показано ниже.


- **Создание процедур для исправления:**
    - При обнаружении висячих DNS-записей команде необходимо выяснить, не произошло ли нарушение безопасности.
    - Выясните, почему адрес не был перенаправлен при списании ресурса.
    - Удалите запись DNS, если она больше не используется, или укажите правильный ресурс Azure (FQDN), принадлежащий вашей организации.
 

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о связанных службах и функциях Azure, которые можно использовать для защиты от перенаправление поддоменов, см. на следующих страницах.

- [Включение защитника Azure для службы приложений](../../security-center/defender-for-app-service-introduction.md) — получение оповещений при обнаружении ВИСЯЧИХ DNS-записей

- [Предотвращение висячих записей DNS с Azure DNS](../../dns/dns-alias.md#prevent-dangling-dns-records)

- [Использовать идентификатор проверки домена при добавлении пользовательских доменов в службе приложений Azure](../../app-service/app-service-web-tutorial-custom-domain.md#get-a-domain-verification-id)

- [Краткое руководство. Выполните первый запрос графика ресурсов с помощью Azure PowerShell](../../governance/resource-graph/first-query-powershell.md)
