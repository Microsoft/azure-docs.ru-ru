---
title: Использование Azure CDN с CORS | Документация Майкрософт
description: Сведения об использовании сети доставки содержимого (CDN) Azure с общим доступом к ресурсам независимо от источника (CORS).
services: cdn
documentationcenter: ''
author: zhangmanling
manager: erikre
editor: ''
ms.assetid: 86740a96-4269-4060-aba3-a69f00e6f14e
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 01/23/2017
ms.author: mazha
ms.openlocfilehash: f7edf790e526329dd285d03a31137a26220e52ee
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96018653"
---
# <a name="using-azure-cdn-with-cors"></a>Использование Azure CDN с CORS
## <a name="what-is-cors"></a>Что такое CORS?
CORS (общий доступ к ресурсам независимо от источника) — функция HTTP, которая позволяет веб-приложению, работающему в одном домене, обращаться к ресурсам другого домена. Чтобы снизить вероятность атак с использованием межузловых сценариев, все современные веб-браузеры реализуют ограничение безопасности, известное как [политика одного источника](https://www.w3.org/Security/wiki/Same_Origin_Policy).  Это ограничение не позволяет веб-страницы вызывать интерфейсы API в другом домене.  CORS позволяет одному источнику (исходному домену) безопасно вызывать интерфейсы API в другом источнике.

## <a name="how-it-works"></a>Принцип работы
Существует два типа запросов CORS, *простые запросы* и *сложные запросы*.

### <a name="for-simple-requests"></a>Простые запросы

1. Браузер отправляет запрос CORS с дополнительным заголовком HTTP-запроса **Origin**. Значение этого заголовка является источником, обслужившим родительскую страницу, который определяется как сочетание *протокола,* *домена* и *порта*.  Когда страница из HTTPS \: //www.contoso.com пытается получить доступ к данным пользователя в источнике Fabrikam.com, в Fabrikam.com будет отправлен следующий заголовок запроса:

   `Origin: https://www.contoso.com`

2. Сервер может отправить в ответ следующее:

   * Ответ с заголовком **Access-Control-Allow-Origin**, который указывает, какие исходные сайты разрешены. Пример:

     `Access-Control-Allow-Origin: https://www.contoso.com`

   * Код ошибки HTTP (например, 403), если сервер запрещает запрос независимо от источника после проверки заголовка Origin.

   * Заголовок **Access-Control-Allow-Origin** с подстановочным знаком, который разрешает все источники:

     `Access-Control-Allow-Origin: *`

### <a name="for-complex-requests"></a>Сложные запросы

Сложный запрос — это запрос CORS, для выполнения которого браузер должен отправить *предварительный запрос* (т. е. выполнить предварительную проверку) перед отправкой самого запроса CORS. Предварительный запрос запрашивает у сервера разрешения на выполнение исходного запроса CORS. Он представляет собой запрос `OPTIONS` к тому же URL-адресу.

> [!TIP]
> Дополнительные сведения о процедурах CORS и типичных проблемах доступны в [руководстве по CORS для REST API](https://www.moesif.com/blog/technical/cors/Authoritative-Guide-to-CORS-Cross-Origin-Resource-Sharing-for-REST-APIs/).
>
>

## <a name="wildcard-or-single-origin-scenarios"></a>Подстановочный знак или сценарии с одним источником
CORS в Azure CDN будет работать автоматически без дополнительной настройки, если в заголовке **Access-Control-Allow-Origin** указан подстановочный знак (*) или один источник.  В этом случае CDN кэширует первый ответ, и в последующих запросах будет использоваться тот же заголовок.

Если запросы в CDN отправлены до настройки CORS на вашем источнике, потребуется очистить содержимое конечной точки, чтобы перезагрузить содержимое с заголовком **Access-Control-Allow-Origin**.

## <a name="multiple-origin-scenarios"></a>Сценарии с несколькими источниками
Если необходимо разрешить для CORS определенный набор источников, задача несколько усложняется. Проблема возникает, когда CDN кэширует заголовок **Access-Control-Allow-Origin** для первого источника CORS.  При последующем запросе от другого источника CORS сеть CDN отправит кэшированный заголовок **Access-Control-Allow-Origin**, который не будет соответствовать заголовку другого источника.  Исправить это можно несколькими способами.

### <a name="azure-cdn-standard-profiles"></a>Профили Azure CDN уровня "Стандартный"
В Azure CDN Standard от Майкрософт можно создать правило в [обработчике стандартных правил](cdn-standard-rules-engine-reference.md) , чтобы проверить заголовок **источника** в запросе. Если это допустимый источник, то правило установит в качестве заголовка **Access-Control-Allow-Origin** нужное значение. В этом случае заголовок **Access-Control-Allow-Origin** от сервера-источника файла игнорируется, а обработчик правил CDN полностью управляет разрешенными источниками CORS.

![Пример правил с обработчиком стандартных правил](./media/cdn-cors/cdn-standard-cors.png)

> [!TIP]
> К правилу можно добавить дополнительные действия для изменения дополнительных заголовков ответа, таких как **Access-Control-Allow-Methods**.
> 

В **Azure CDN Standard от Akamai** единственным механизмом, позволяющим использовать несколько источников без использования шаблона, является [кэширование строк запроса](cdn-query-string.md). Включите параметр строки запроса для конечной точки CDN, а затем используйте уникальную строку для запросов от каждого разрешенного домена. В результате CDN будет кэшировать отдельный объект для каждой уникальной строки запроса. Однако этот подход не является идеальным, так как он приведет к появлению нескольких копий одного файла в кэше CDN.  

### <a name="azure-cdn-premium-from-verizon"></a>Azure CDN уровня "Премиум" от Verizon
С помощью обработчика правил Verizon Premium необходимо [создать правило](./cdn-verizon-premium-rules-engine.md) для проверки заголовка **источника** в запросе.  Если это допустимый источник, то ваше правило установит заголовок **Access-Control-Allow-Origin** в соответствии с источником, указанным в запросе.  Если источник, указанный в заголовке **источника** , не разрешен, то в правиле должен быть пропущен заголовок **Access-Control-Allow-Origin** , который приведет к отклонению запроса браузером. 

Существует два способа сделать это с помощью обработчика правил Premium. В обоих случаях заголовок **Access-Control-Allow-Origin** из файла сервера-источника игнорируется, и разрешенными источниками CORS управляет только обработчик правил CDN.

#### <a name="one-regular-expression-with-all-valid-origins"></a>Одно регулярное выражение со всеми допустимыми источниками
В этом случае создается регулярное выражение, которое включает все источники, которые вы хотите разрешить: 

```http
https?:\/\/(www\.contoso\.com|contoso\.com|www\.microsoft\.com|microsoft.com\.com)$
```

> [!TIP]
> В **Azure CDN уровня "Премиум" от Verizon** в качестве основного механизма регулярных выражений используются [совместимые с Perl регулярные выражения](https://pcre.org/).  Для проверки регулярного выражения можно использовать такие ресурсы, как [Regular Expressions 101](https://regex101.com/).  Обратите внимание, что символ "/" в регулярных выражениях является допустимым и экранировать его необязательно. Однако его все же рекомендуется экранировать, и некоторые средства проверки регулярных выражений ожидают, что он будет экранирован.
> 
> 

Если регулярное выражение соответствует запросу, то правило заменит заголовок **Access-Control-Allow-Origin** источника (если он есть) на источник, который отправил запрос.  Также можно добавить дополнительные заголовки CORS, например **Access-Control-Allow-Methods**.

![Пример правил с регулярным выражением](./media/cdn-cors/cdn-cors-regex.png)

#### <a name="request-header-rule-for-each-origin"></a>Правило заголовка запроса для каждого источника.
Вместо регулярных выражений можно создать отдельное правило для каждого источника, который вы хотите разрешить, с помощью **условия соответствия** [подстановочного знака в заголовке запроса](/previous-versions/azure/mt757336(v=azure.100)#match-conditions). Как и регулярное выражение, заголовки CORS задаются только обработчиком правил. 

![Пример правил без регулярного выражения](./media/cdn-cors/cdn-cors-no-regex.png)

> [!TIP]
> В примере выше подстановочный знак * означает, что обработчик правил будет проверять на соответствие как HTTP-, так и HTTPS-запросы.
> 
>