---
title: Как выполняется кэширование | Документация Майкрософт
description: Кэширование — это процесс сохранения данных локально, который позволяет быстрее получить к ним доступ при будущих запросах.
services: cdn
documentationcenter: ''
author: asudbring
manager: danielgi
editor: ''
ms.assetid: ''
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/30/2018
ms.author: allensu
ms.openlocfilehash: a226682c2580a871e1b2fc4db71f369f3bcc3abb
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "96010169"
---
# <a name="how-caching-works"></a>Как выполняется кэширование

Эта статья содержит обзор общих понятий кэширования и сведения о том, как [сеть доставки содержимого (CDN) Azure](cdn-overview.md) использует кэширование для улучшения производительности. Дополнительные сведения о том, как настроить поведение кэширования на конечной точке CDN, см. в статье [об управлении поведением кэширования Azure CDN с помощью правил кэширования](cdn-caching-rules.md) и статье [об управлении поведением кэширования Azure CDN с помощью строк запроса](cdn-query-string.md).

## <a name="introduction-to-caching"></a>Общие сведения о кэшировании

Кэширование — это процесс сохранения данных локально, который позволяет быстрее получить к ним доступ при будущих запросах. В самом распространенном типе кэширования, кэшировании веб-браузера, веб-браузер хранит копии статических данных на локальном жестком диске. Используя кеширование, веб-браузер может избежать многократных циклов приема-передачи на сервер и вместо этого получать доступ к тем же данным локально, что экономит время и ресурсы. Кэширование хорошо подходит для локального управления небольшим объемом статических данных, таких как статические изображения, файлы CSS и JavaScript.

Аналогичным образом, кеширование используется CDN на пограничных серверах, близких к пользователю, чтобы избежать запросов, возвращающихся в исходное состояние и сокращающих задержки пользователей. В отличие от кеша веб-браузера, который используется только для одного пользователя, CDN имеет общий кэш. В общем кэше CDN файл, запрашиваемый одним пользователем, может быть доступен позже другим пользователям, что значительно уменьшает количество запросов на сервер-источник.

Динамические ресурсы, которые часто меняются или уникальны для отдельного пользователя, не могут быть кэшированы. Однако эти типы ресурсов могут использовать преимущества оптимизации динамического ускорения сайтов (DSA) в Azure CDN для повышения производительности.

Кэширование может происходить на нескольких уровнях между сервером-источником и пользователем:

- веб-сервер: использует общий кэш (для нескольких пользователей);
- сеть доставки содержимого: использует общий кэш (для нескольких пользователей);
- поставщик интернет-услуг (ISP): использует общий кэш (для нескольких пользователей);
- веб-браузер: использует частный кэш (для одного пользователя).

Каждый кэш обычно самостоятельно управляет обновлением ресурса и выполняет проверку, если файл устарел. Такое поведение определено в спецификации кэширования HTTP [RFC 7234](https://tools.ietf.org/html/rfc7234).

### <a name="resource-freshness"></a>Актуальность ресурса

Так как кешированный ресурс может быть устаревшим (по сравнению с имеющимся ресурсом на сервере-источнике), важно, чтобы любой механизм кеширования управлял обновлением содержимого. Чтобы сэкономить время и пропускную способность, кешированный ресурс не сравнивается с версией на сервере-источнике каждый раз, когда к нему обращаются. Вместо этого, пока кэшированный ресурс считается актуальным, предполагается, что он является самой последней версией и отправляется непосредственно клиенту. Кэшированный ресурс считается актуальным, когда его возраст меньше возраста или периода, определенного параметром кэша. Например, когда браузер перезагружает веб-страницу, он проверяет актуальность каждого кэшированного ресурса на вашем жестком диске и загружает его. Если ресурс не актуален (устаревший), с сервера скачивается обновленная копия.

### <a name="validation"></a>Проверка

Если ресурс считается устаревшим, серверу-источнику предлагается проверить его, то есть определить, все ли данные в кэше соответствуют тому, что находится на сервере-источнике. Если файл был изменен на сервере-источнике, кэш обновляет его версию ресурса. В противном случае, если ресурс актуальный, данные доставляются непосредственно из кэша, без изначальной проверки.

### <a name="cdn-caching"></a>Кэширование CDN

Кэширование является неотъемлемой частью того, как CDN работает, чтобы ускорить доставку и уменьшить нагрузку на источник статических ресурсов, таких как изображения, шрифты и видео. В кэшировании CDN статические ресурсы выборочно хранятся на стратегически размещенных серверах, которые являются более локальными для пользователя и обладают следующими преимуществами:

- Так как большинство веб-трафика является статическим (например, изображения, шрифты и видео), кэширование CDN уменьшает задержку в сети, перемещая содержимое ближе к пользователю, тем самым уменьшая расстояние перемещения данных.

- Уменьшая нагрузку на CDN, кэширование может снизить сетевой трафик и нагрузку на сервер-источник. Это уменьшает затраты и требования к ресурсам приложения даже при наличии большого числа пользователей.

Подобно тому, как кэширование реализуется в веб-браузере, вы можете управлять выполнением кэширования в CDN, отправляя заголовки директив кэша. Заголовки директив кэша — это заголовки HTTP, которые обычно добавляются на сервер-источник. Несмотря на то, что большинство из этих заголовков изначально были разработаны для кэширования в клиентских браузерах, теперь они также используются промежуточными кэшами, такими как CDN. 

Для определения актуальности кэша можно использовать два заголовка: `Cache-Control` и `Expires`. `Cache-Control` — более поздний и имеет приоритет над `Expires`, если они оба существуют. Для проверки также используются два вида заголовков (которые называются проверяющими элементами управления): `ETag` и `Last-Modified`. `ETag` — более поздний и имеет приоритет над `Last-Modified`, если они оба определены.  

## <a name="cache-directive-headers"></a>Заголовки директив кэша

> [!IMPORTANT]
> По умолчанию конечная точка Azure CDN, оптимизированная для DSA, игнорирует заголовки директив кэша и обходит кэширование. Для профилей **Azure CDN уровня "Стандартный" от Verizon** и **Azure CDN уровня "Стандартный" от Akamai** можно настроить способ обработки этих заголовков конечной точкой Azure CDN, воспользовавшись [правилами кэширования CDN](cdn-caching-rules.md) для включения кэширования. Только для профилей **Azure CDN уровня "Премиум" от Verizon** для включения кэширования используется [обработчик правил](./cdn-verizon-premium-rules-engine.md).

Azure CDN поддерживает следующие заголовки директив кэша HTTP, которые определяют длительность кэширования и совместное использование кэша.

**Cache-Control:**
- Представлен в HTTP 1.1, чтобы дать веб-издателям больше возможностей управления своим содержимым и устранить ограничения заголовка `Expires`.
- Переопределяет заголовок `Expires`, если определен этот заголовок и заголовок `Cache-Control`.
- Если `Cache-Control` указан в HTTP-запросе от клиента к POP сети CDN, все профили Azure CDN по умолчанию игнорируют его.
- При использовании в HTTP-ответе от клиента к POP CDN:
     - **Azure CDN уровня "Стандартный" или "Премиум" от Verizon** и **Azure CDN уровня "Стандартный" от Microsoft** поддерживают все директивы `Cache-Control`.
     - **Azure CDN уровня "Стандартный" от Akamai** поддерживает перечисленные ниже директивы `Cache-Control` и игнорирует все остальные.
         - `max-age`. Содержимое может храниться в кэше в течение указанного количества секунд. Например, `Cache-Control: max-age=5`. Эта директива задает максимальное время, в течение которого содержимое будет считаться актуальным.
         - `no-cache`. Кэширует содержимое, но проверяет содержимое каждый раз перед его доставкой из кэша. Эквивалент `Cache-Control: max-age=0`.
         - `no-store`. Никогда не кэширует содержимое. Удалите контент, если он был ранее сохранен.

**Expires:**
- Устаревший заголовок, представленный в HTTP 1.0. Поддерживается для обеспечения обратной совместимости.
- Использует дату окончания срока действия со вторым уровнем точности. 
- Аналогично `Cache-Control: max-age`.
- Используется, если `Cache-Control` нет.

**Pragma:**
   - По умолчанию не учитывается Azure CDN.
   - Устаревший заголовок, представленный в HTTP 1.0. Поддерживается для обеспечения обратной совместимости.
   - Используется в качестве заголовка запроса клиента со следующей директивой: `no-cache`. Эта директива предписывает серверу предоставить новую версию ресурса.
   - `Pragma: no-cache` равно `Cache-Control: no-cache`.

## <a name="validators"></a>Проверяющие элементы управления

При необходимости обновления кэша проверяющие элементы управления кэша HTTP используются для сравнения кэшированной версии файла с версией на сервере-источнике. **Azure CDN уровня "Стандартный" или "Премиум" от Verizon** по умолчанию поддерживает проверяющие элементы управления `ETag` и `Last-Modified`, а **Azure CDN уровня "Стандартный" от Майкрософт** и **Azure CDN уровня "Стандартный" от Akamai** по умолчанию поддерживают только `Last-Modified`.

**ETag:**
- **Azure CDN уровня "Стандартный" или "Премиум" от Verizon** по умолчанию поддерживает `ETag`, а **Azure CDN уровня "Стандартный" от Майкрософт** и **Azure CDN уровня "Стандартный" от Akamai** — не поддерживают.
- `ETag` определяет уникальную строку для каждого файла и версии файла. Например, `ETag: "17f0ddd99ed5bbe4edffdd6496d7131f"`.
- Впервые появился в HTTP 1.1 и является более поздним, чем `Last-Modified`. Полезен, когда трудно определить дату последнего изменения.
- Поддерживает как строгую проверку, так и слабую проверку, однако Azure CDN поддерживает только строгую проверку. При строгой проверке два представления ресурсов должны полностью совпадать. 
- Кэш проверяет файл, который использует `ETag`, отправляя заголовок `If-None-Match` с одним или несколькими проверяющими элементами управления `ETag` в запросе. Например, `If-None-Match: "17f0ddd99ed5bbe4edffdd6496d7131f"`. Если версия сервера совпадает с проверяющим элементом управления `ETag` в списке, будет отправлен код состояния 304 (не изменено) в ответе. Если версия отличается, сервер отвечает кодом состояния 200 (OK) и обновленным ресурсом.

**Last-Modified:**
- Только для профилей **Azure CDN уровня "Стандартный" или "Премиум" от Verizon**. Если `ETag` не является частью ответа HTTP, используется `Last-Modified`. 
- Указывает дату и время, которую сервер-источник определил как время последнего изменения ресурса. Например, `Last-Modified: Thu, 19 Oct 2017 09:28:00 GMT`.
- Кэш проверяет файл с помощью `Last-Modified` путем отправки заголовка `If-Modified-Since` с датой и временем в запросе. Исходный сервер сравнивает эту дату с заголовком `Last-Modified` последнего ресурса. Если ресурс не был изменен после указанного времени, сервер возвращает в своем ответе код состояния 304 (не изменено). Если ресурс был изменен, сервер возвращает код состояния 200 (OK) и обновленный ресурс.

## <a name="determining-which-files-can-be-cached"></a>Определение файлов для кэширования

Не все ресурсы могут кэшироваться. В следующей таблице показано, какие ресурсы можно кэшировать, исходя из типа ответа HTTP. Ресурсы, поставляемые с ответами HTTP, которые не соответствуют всем этим условиям, невозможно кэшировать. Только для профилей **Azure CDN уровня "Премиум" от Verizon** можно использовать обработчик правил для настройки некоторых из этих условий.

|                       | Azure CDN от Майкрософт          | Azure CDN от Verizon | Azure CDN от Akamai        |
|-----------------------|-----------------------------------|------------------------|------------------------------|
| **Коды состояния HTTP** | 200, 203, 206, 300, 301, 410, 416 | 200                    | 200, 203, 300, 301, 302, 401 |
| **Методы HTTP**      | GET, HEAD                         | GET                    | GET                          |
| **Ограничения размера файла**  | 300 ГБ                            | 300 ГБ                 | – Оптимизация общей веб-доставки: 1,8 ГБ<br />– Оптимизация потоковой передачи мультимедиа: 1,8 ГБ<br />– Оптимизация больших файлов: 150 ГБ |

Чтобы в профиле **Azure CDN уровня "Стандартный" от Майкрософт** кэширование работало для ресурса, сервер-источник должен поддерживать все HTTP-запросы HEAD и GET, а значения content-length для этого ресурса должны быть одинаковы в HTTP-ответах HEAD и GET. Чтобы выполнять запросы HEAD, сервер-источник должен поддерживать запрос HEAD и возвращать те же заголовки, что и в ответ на запрос GET.

## <a name="default-caching-behavior"></a>Поведение кэширования по умолчанию

В следующей таблице описано поведение кэширования по умолчанию для продуктов Azure CDN и их оптимизация.

|    | Майкрософт: общая веб-доставка | Verizon: общая веб-доставка | Verizon: DSA | Akamai: общая веб-доставка | Akamai: DSA | Akamai: скачивание больших файлов | Akamai: общая потоковая передача или потоковая передача видео по запросу |
|------------------------|--------|-------|------|--------|------|-------|--------|
| **Учет источника**       | Да    | Да   | Нет   | Да    | Нет   | Да   | Да    |
| **Длительность кэширования CDN** | 2 дня |7 дней | Нет | 7 дней | Нет | 1 день | Год |

**Учет источника.** Указывает, следует ли учитывать поддерживаемые заголовки директив кеша, если они есть в ответе HTTP сервера-источника.

**Длительность кэширования CDN.** Указывает количество времени, в течение которого кэшируется ресурс в Azure CDN. Однако, если **источник учитывается**, а ответ HTTP сервера-источника включает заголовок директив кэша `Expires` или `Cache-Control: max-age`, Azure CDN использует значение продолжительности, указанное в заголовке. 

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о настройке и переопределении поведения по умолчанию в CDN с помощью правил кэширования см. в [этой статье](cdn-caching-rules.md). 
- Дополнительные сведения об использовании строк запросов для управления поведением кэширования см. в статье [Управление режимом кэширования в сети доставки содержимого Azure с помощью строк запросов](cdn-query-string.md).