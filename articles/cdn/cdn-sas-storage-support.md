---
title: Использование Azure CDN с SAS | Документация Майкрософт
description: Azure CDN поддерживает использование подписанных URL-адресов (SAS) для предоставления ограниченного доступа к частным контейнерам хранилища.
services: cdn
documentationcenter: ''
author: asudbring
manager: danielgi
editor: ''
ms.assetid: ''
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 06/21/2018
ms.author: allensu
ms.openlocfilehash: ccf55e0e3986de8afe23cb646d4df743b576900c
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101725328"
---
# <a name="using-azure-cdn-with-sas"></a>Использование Azure CDN с SAS

При настройке учетной записи хранения для кэширования содержимого сети доставки содержимого (CDN) Azure по умолчанию любой пользователь, знающий URL-адреса контейнеров хранилища, может получить доступ к переданным вами файлам. Чтобы защитить файлы в своей учетной записи хранения, можно изменить параметры доступа к контейнерам хранилища, сделав их частными, а не общедоступными. Однако в этом случае никто не сможет получить доступ к вашим файлам. 

Если вы хотите предоставить ограниченный доступ к частным контейнерам хранилища, то можете использовать функцию подписанных URL-адресов (SAS) учетной записи хранения Azure. SAS — это URI, который предоставляет ограниченные права доступа к ресурсам хранилища Azure, не отображая ключ вашей учетной записи. Вы можете предоставить SAS клиентам, которым вы не доверяете ключ учетной записи хранения, но которым вы хотите делегировать доступ к определенным ресурсам учетной записи. Распределяя URI подписи общего доступа к этим клиентам, вы предоставляете им доступ к ресурсу в течение определенного периода времени.
 
SAS дает возможность определить различные параметры доступа к большому двоичному объекту, такие как время запуска и срок действия, разрешения (на чтение и запись) и диапазоны IP-адресов. В этой статье описывается использование SAS вместе с Azure CDN. Дополнительные сведения о SAS, включая данные о его создании и настройке параметров, см. в статье [Использование подписанных URL-адресов (SAS)](../storage/common/storage-sas-overview.md).

## <a name="setting-up-azure-cdn-to-work-with-storage-sas"></a>Настройка Azure CDN для работы с SAS хранилища
Для использования SAS с Azure CDN рекомендуются следующие три варианта. Предполагается, что вы уже создали рабочий SAS (см. предварительные требования). 
 
### <a name="prerequisites"></a>Предварительные требования
Для начала создайте учетную запись хранения, а затем создайте SAS для ресурса. Вы можете создать два типа подписанных URL-адресов: SAS службы или учетной записи. Дополнительные сведения см. в разделе [Типы подписанных URL-адресов](../storage/common/storage-sas-overview.md#types-of-shared-access-signatures).

После создания маркера SAS можно обращаться к файлу в хранилище BLOB-объектов, добавляя `?sv=<SAS token>` в URL-адрес. Этот URL-адрес имеет следующий формат. 

`https://<account name>.blob.core.windows.net/<container>/<file>?sv=<SAS token>`
 
Пример:
 ```
https://democdnstorage1.blob.core.windows.net/container1/demo.jpg?sv=2017-07-29&ss=b&srt=co&sp=r&se=2038-01-02T21:30:49Z&st=2018-01-02T13:30:49Z&spr=https&sig=QehoetQFWUEd1lhU5iOMGrHBmE727xYAbKJl5ohSiWI%3D
```

Дополнительные сведения о параметрах см. в разделах [Сведения о параметрах SAS](#sas-parameter-considerations) и [Параметры подписанного URL-адреса](../storage/common/storage-sas-overview.md#how-a-shared-access-signature-works).

![Параметры SAS CDN](./media/cdn-sas-storage-support/cdn-sas-settings.png)

### <a name="option-1-using-sas-with-pass-through-to-blob-storage-from-azure-cdn"></a>Вариант 1. Использование SAS с передачей в хранилище BLOB-объектов из Azure CDN

Этот вариант является самым простым и использует только один маркер SAS, который передается из Azure CDN на сервер-источник.
 
1. Выберите конечную точку, щелкните **Правила кеширования**, затем выберите **Кэшировать каждый уникальный URL-адрес** из списка **Query string caching** (Кэширование строк запросов).

    ![Правила кэширования CDN](./media/cdn-sas-storage-support/cdn-caching-rules.png)

2. После настройки SAS в учетной записи хранения для доступа к файлу необходимо указывать маркер SAS в URL-адресах CDN и сервера-источника. 
   
   Итоговый URL-адрес конечной точки CDN имеет следующий формат: `https://<endpoint hostname>.azureedge.net/<container>/<file>?sv=<SAS token>`.

   Пример:   
   ```
   https://demoendpoint.azureedge.net/container1/demo.jpg/?sv=2017-07-29&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
   
3. Точная настройка длительности кэширования выполняется либо с помощью правил кеширования, либо путем добавления заголовков `Cache-Control` на сервер-источник. Так как Azure CDN рассматривает маркер SAS как обычную строку запроса, необходимо настроить длительность кэширования, которая истекает при истечении срока действия SAS или раньше. В противном случае, если файл кэшируется дольше, чем активен SAS, файл может остаться доступным с сервера-источника Azure CDN по истечении срока действия SAS. В этом случае, если вы хотите сделать кэшированный файл недоступным, выполните операцию очистки кэша в файле. Сведения о настройке длительности кэширования для Azure CDN см. в статье [Управление поведением кэширования сети доставки содержимого Azure с помощью правил кэширования](cdn-caching-rules.md).

### <a name="option-2-hidden-cdn-sas-token-using-a-rewrite-rule"></a>Вариант 2. Скрытый маркер безопасности SAS CDN с использованием правила переопределения
 
Этот параметр доступен только для профилей **Azure CDN уровня "Премиум" от Verizon**. Этот параметр позволяет защитить хранилище больших двоичных объектов на сервере-источнике. Его можно использовать, если вам не нужны определенные ограничения доступа к файлу, но вы хотите, чтобы пользователи не могли напрямую обращаться к источнику хранения, чтобы улучшить время разгрузки Azure CDN. Маркер SAS, который неизвестен пользователю, является обязательным для всех операций доступа к файлам в указанном контейнере сервера-источника. Но этот маркер SAS не нужен для конечной точки CDN благодаря настроенному правилу переопределения URL-адреса.
 
1. Используйте [обработчик правил](./cdn-verizon-premium-rules-engine.md) для создания правила переопределения URL-адресов. Распространение новых правил может длиться до 4 часов.

   ![Кнопка управления CDN](./media/cdn-sas-storage-support/cdn-manage-btn.png)

   ![Кнопка обработчика правил Azure CDN](./media/cdn-sas-storage-support/cdn-rules-engine-btn.png)

   Ниже приведен пример правила переопределения URL-адресов, в котором используется шаблон регулярного выражения с группой записи и конечной точкой *sasstoragedemo*.
   
   Источник:   
   `(container1/.*)`


   Назначение:   
   ```
   $1?sv=2017-07-29&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
   ![Правило переопределения URL-адресов CDN — слева](./media/cdn-sas-storage-support/cdn-url-rewrite-rule.png)
   ![Правило переопределения URL-адресов CDN — справа](./media/cdn-sas-storage-support/cdn-url-rewrite-rule-option-4.png)

2. После того, как новое правило станет активным, к файлам в указанном контейнере конечной точки CDN сможет получить доступ любой желающий, даже без маркера SAS в URL-адресе. Используется следующий формат: `https://<endpoint hostname>.azureedge.net/<container>/<file>`.
 
   Пример:   
   `https://sasstoragedemo.azureedge.net/container1/demo.jpg`
       

3. Точная настройка длительности кэширования выполняется либо с помощью правил кеширования, либо путем добавления заголовков `Cache-Control` на сервер-источник. Так как Azure CDN рассматривает маркер SAS как обычную строку запроса, необходимо настроить длительность кэширования, которая истекает при истечении срока действия SAS или раньше. В противном случае, если файл кэшируется дольше, чем активен SAS, он может быть доступен из конечной точки Azure CDN по истечении срока действия SAS. В этом случае, если вы хотите сделать кэшированный файл недоступным, выполните операцию очистки кэша в файле. Сведения о настройке длительности кэширования для Azure CDN см. в статье [Управление поведением кэширования сети доставки содержимого Azure с помощью правил кэширования](cdn-caching-rules.md).

### <a name="option-3-using-cdn-security-token-authentication-with-a-rewrite-rule"></a>Способ 3. Использование проверки подлинности маркера безопасности CDN с правилом подстановки

Для использования аутентификации на основе маркера безопасности Azure CDN требуется профиль **Azure CDN уровня "Премиум" от Verizon**. Этот вариант является наиболее безопасным и настраиваемым. Клиентский доступ основан на параметрах безопасности, установленных для маркера безопасности. После того, как вы создадите и настроите маркер безопасности, он станет обязательным для всех URL-адресов конечных точек CDN. Но этот маркер SAS не нужен для конечной точки CDN благодаря настроенному правилу переопределения URL-адреса. Если маркер SAS позже станет недействительным, Azure CDN не сможет повторно проверять содержимое, полученное от сервера-источника.

1. [Создайте маркер безопасности Azure CDN](./cdn-token-auth.md#setting-up-token-authentication) и активируйте его, используя обработчик правил для конечной точки CDN и путь, с помощью которого пользователи смогут получить доступ к файлу.

   URL-адрес конечной точки с маркером безопасности имеет следующий формат:   
   `https://<endpoint hostname>.azureedge.net/<container>/<file>?<security_token>`
 
   Пример:   
   ```
   https://sasstoragedemo.azureedge.net/container1/demo.jpg?a4fbc3710fd3449a7c99986bkquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
       
   Параметры аутентификации на основе маркера безопасности отличаются от параметров маркера SAS. Если вы решите использовать срок действия при создании маркера безопасности, установите для него то же значение, что и для срока действия маркера SAS. Это обеспечит прогнозируемость срока окончания действия. 
 
2. Используйте [обработчик правил](./cdn-verizon-premium-rules-engine.md), чтобы создать правило переопределения URL-адресов и разрешить доступ с маркером SAS ко всем большим двоичным объектам в контейнере. Распространение новых правил может длиться до 4 часов.

   Ниже приведен пример правила переопределения URL-адресов, в котором используется шаблон регулярного выражения с группой записи и конечной точкой *sasstoragedemo*.
   
   Источник:   
   `(container1/.*)`
   
   Назначение:   
   ```
   $1&sv=2017-07-29&ss=b&srt=c&sp=r&se=2027-12-19T17:35:58Z&st=2017-12-19T09:35:58Z&spr=https&sig=kquaXsAuCLXomN7R00b8CYM13UpDbAHcsRfGOW3Du1M%3D
   ```
   ![Правило переопределения URL-адресов CDN — слева](./media/cdn-sas-storage-support/cdn-url-rewrite-rule.png)
   ![Правило переопределения URL-адресов CDN — справа](./media/cdn-sas-storage-support/cdn-url-rewrite-rule-option-4.png)

3. При обновлении SAS не забудьте обновить и правило переопределения URL-адресов, указав новый маркер SAS. 

## <a name="sas-parameter-considerations"></a>Рекомендации по настройке параметров SAS

Так как параметры SAS не отображаются в Azure CDN, Azure CDN не может изменить свой режим доставки на их основе. Определенные ограничения параметров применяются только к запросам, которые Azure CDN отправляет на сервер-источник, а не к запросам клиента к Azure CDN. Это различие следует учитывать при настройке параметров SAS. Если необходимы эти дополнительные возможности и вы используете [вариант 3](#option-3-using-cdn-security-token-authentication-with-a-rewrite-rule), установите соответствующие ограничения в маркере безопасности Azure CDN.

| Имя параметра SAS | Описание |
| --- | --- |
| Запуск | Время, когда Azure CDN сможет обращаться к файлу большого двоичного объекта. Из-за разницы в показаниях часов (когда сигнал времени поступает в разное время для различных компонентов) установите время на 15 минут раньше, если вы хотите, чтобы ресурс был доступен немедленно. |
| Конец | Время, после которого Azure CDN больше не сможет обращаться к файлу большого двоичного объекта. Ранее кэшированные файлы в Azure CDN по-прежнему будут доступны. Чтобы управлять временем окончания срока действия файла, установите соответствующее время для маркера безопасности Azure CDN либо очистите ресурс. |
| Разрешенные IP-адреса | Необязательный параметр. Если вы используете **Azure CDN от Verizon**, примените параметр диапазонов, указанных на странице [Azure CDN from Verizon Edge Server IP Ranges](./cdn-pop-list-api.md) (Диапазоны IP-адресов пограничного сервера Azure CDN от Verizon). Если вы используете **Azure CDN от Akamai**, нельзя задать параметр диапазонов IP-адресов, так как они не являются статичными.|
| Разрешенные протоколы | Протоколы, разрешенные для запроса, сделанного с помощью SAS учетной записи. Рекомендуется использовать параметр HTTPS.|

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о SAS доступны в следующих статьях:
- [Использование подписанных URL-адресов (SAS)](../storage/common/storage-sas-overview.md)
- [Подписанные URL-адреса. Часть 2: Создание и использование подписанного URL-адреса с помощью хранилища BLOB-объектов](../storage/common/storage-sas-overview.md)

Дополнительные сведения о настройке аутентификации на основе маркеров см. в разделе [Защита ресурсов сети доставки содержимого Azure с помощью аутентификации на основе маркеров](./cdn-token-auth.md).