---
title: Переменные HTTP для обработчика правил Azure CDN | Документация Майкрософт
description: Сведения о переменных HTTP, которые позволяют получать метаданные HTTP-запроса и ответа для некоторых функций обработчика правил. Используйте метаданные для изменения запроса или ответа.
services: cdn
documentationcenter: ''
author: asudbring
manager: danielgi
editor: ''
ms.assetid: ''
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/09/2018
ms.author: allensu
ms.openlocfilehash: a2d9fc98ba6f514afbd88e543a859a69e0fc6c6b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "88192675"
---
# <a name="http-variables-for-azure-cdn-rules-engine"></a>Переменные HTTP для обработчика правил Azure CDN
Переменные HTTP предоставляют средство, с помощью которого можно получить метаданные запросов и ответов HTTP. Эти метаданные можно использовать, чтобы динамически изменить запрос или ответ. Использование переменных HTTP ограничивается следующими функциями обработчика правил:

- [Перезапись ключа кэша](https://docs.vdms.com/cdn/Content/HRE/F/Cache-Key-Rewrite.htm)
- [Заголовок запроса Modify Client](https://docs.vdms.com/cdn/Content/HRE/F/Modify-Client-Request-Header.htm)
- [Заголовок ответа Modify Client](https://docs.vdms.com/cdn/Content/HRE/F/Modify-Client-Response-Header.htm)
- [Перенаправление URL-адреса](https://docs.vdms.com/cdn/Content/HRE/F/URL-Redirect.htm)
- [Переопределение URL-адреса](https://docs.vdms.com/cdn/Content/HRE/F/URL-Rewrite.htm)

## <a name="definitions"></a>Определения
В следующей таблице описываются поддерживаемые переменные HTTP. Если метаданные геообъекта (например, почтовый индекс) недоступны для конкретного запроса, возвращается пустое значение.


| Имя | Переменная | Описание | Образец значения |
| ---- | -------- | ----------- | ------------ |
| ASN (инициатор запроса) | %{geo_asnum} | Указывает номер AS инициатора запроса. <br /><br />**Нерекомендуемая:** %{virt_dst_asnum}. <br />Эта переменная является нерекомендуемой. Вместо нее используется %{geo_asnum}. Несмотря на то что правило, которое использует эту нерекомендуемую переменную, будет продолжать работать, необходимо изменить его так, чтобы использовалась новая переменная. | AS15133 |
| Город (инициатор запроса) | %{geo_city} | Указывает город инициатора запроса. | Лос-Анджелес |
| Континент (инициатор запроса) | %{geo_continent} | Указывает континент инициатора запроса в виде сокращения. <br />Допустимые значения: <br />AF: Африка<br />AS: Азия<br />EU: Европа<br />NA: Северная Америка<br />OC: Океания<br />SA: Южная Америка<br /><br />**Нерекомендуемая:** %{virt_dst_continent}. <br />Эта переменная является нерекомендуемой. Вместо нее используется %{geo_continent}. <br />Несмотря на то что правило, которое использует эту нерекомендуемую переменную, будет продолжать работать, необходимо изменить его так, чтобы использовалась новая переменная.| Недоступно |
| Значение файла cookie | %{cookie_Cookie} | Возвращает значение, соответствующее ключу cookie, определенному в термине Cookie. | Пример использования: <br />%{cookie__utma}<br /><br />Пример значения:<br />111662281.2.10.1222100123 |
| Страна или регион (инициатор запроса) | %{geo_country} | Указывает страну или регион происхождения инициатора запроса с помощью кода страны или региона. <br />**Нерекомендуемая:** %{virt_dst_country}. <br /><br />Эта переменная является нерекомендуемой. Вместо нее используется %{geo_country}. Несмотря на то что правило, которое использует эту нерекомендуемую переменную, будет продолжать работать, необходимо изменить его так, чтобы использовалась новая переменная. | США |
| Назначенная рыночная сфера (инициатор запроса) | %{geo_dma_code} |Указывает медийный рынок инициатора запроса с помощью кода региона. <br /><br />Это поле применимо только для запросов, исходящих из США.| 745 |
| Метод HTTP-запроса | %{request_method} | Указывает метод HTTP-запроса. | GET |
| Код состояния HTTP | %{status} | Указывает код состояния HTTP для ответа. | 200 |
| IP-адрес (инициатор запроса) | %{virt_dst_addr} | Указывает IP-адрес инициатора запроса. | 192.168.1.1 |
| Широта (инициатор запроса) | %{geo_latitude} | Указывает широту инициатора запроса. | 34,0995 |
| Долгота (инициатор запроса) | %{geo_longitude} | Указывает долготу инициатора запроса. | −118,4143 |
| Агломерация, статистическая область (инициатор запроса) | %{geo_metro_code} | Указывает агломерацию инициатора запроса. <br /><br />Это поле применимо только для запросов, исходящих из США.<br />| 745 |
| Порт (инициатор запроса) | %{virt_dst_port} | Указывает временный порт инициатора запроса. | 55885 |
| Почтовый индекс (инициатор запроса) | %{geo_postal_code} | Указывает почтовый индекс инициатора запроса. | 90210 |
| Найдена строка запроса | %{is_args} | Значение этой переменной зависит от того, содержит ли запрос строку запроса.<br /><br />— строка запроса найдена: ?<br />— нет строки запроса: NULL | ? |
| Найден параметр строки запроса | %{is_amp} | Значение этой переменной зависит от того, содержит ли запрос как минимум один параметр строки запроса.<br /><br />— найден параметр: &<br />— нет параметров: NULL | & |
| Значение параметра строки запроса | %{arg_&lt;parameter&gt;} | Возвращает значение, соответствующее параметру строки запроса, определенному в термине &lt;parameter&gt;. | Пример использования: <br />%{arg_language}<br /><br />Пример параметра строки запроса: <br />?language=en<br /><br />Пример значения: en |
| Значение строки запроса | %{query_string} | Указывает целое значение строки запроса, определенное в URL-адресе запроса. |key1=val1&key2=val2&key3=val3 |
| Домен источника ссылки | %{referring_domain} | Указывает домен, определенный в заголовке запроса источника ссылки. | <www.google.com> |
| Регион (инициатор запроса) | %{geo_region} | Указывает регион инициатора запроса (например, область или край) с помощью буквенно-цифрового сокращения. | CA |
| Значение заголовка запроса | %{http_RequestHeader} | Возвращает значение, соответствующее заголовку запроса, определенному в термине RequestHeader. <br /><br />Если имя заголовка запроса содержит дефис (например, User-Agent), замените его символом подчеркивания (например, User_Agent).| Пример использования: %{http_Connection}<br /><br />Пример значения: Keep-Alive | 
| Узел запроса | %{host} | Указывает узел, определенный в URL-адресе запроса. | <www.mydomain.com> |
| Протокол запроса | %{request_protocol} | Указывает протокол запроса. | HTTP/1.1 |
| Схема запроса | %{scheme} | Указывает схему запроса. |http |
| URI запроса (относительное значение) | %{request_uri} | Указывает относительный путь, включая строку запроса, определенную в URI запроса. | /marketing/foo.js?loggedin=true |
| URI запроса (относительное значение без строки запроса) | %{uri} | Указывает относительный путь к запрошенному содержимому. <br /><br/>Основные сведения<br />— Этот относительный путь не содержит строку запроса.<br />— Этот относительный путь отражает перезаписывания URL-адреса. URL-адрес будет перезаписан при следующих условиях:<br />  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;— Функция переопределения URL-адреса. Эта функция перезаписывает относительный путь, определенный в URI запроса.<br />    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;— URL-адрес пограничной записи CNAME. Запрос этого типа перезаписывается в соответствующий URL-адрес CDN. |/800001/corigin/rewrittendir/foo.js |
| URI запроса | %{request} | Описывает запрос. <br />Синтаксис: &lt;метод HTTP&gt; &lt;относительный путь&gt; &lt;протокол HTTP&gt; | GET /marketing/foo.js?loggedin=true HTTP/1.1 |
| Значение заголовка ответа | %{resp_&lt;ResponseHeader&gt;} | Возвращает значение, соответствующее заголовку ответа, определенному в термине &lt;ResponseHeader&gt;. <br /><br />Если имя заголовка ответа содержит дефис (например, User-Agent), замените его символом подчеркивания (например, User_Agent). | Пример использования: %{resp_Content_Length}<br /><br />Пример значения: 100 |

## <a name="usage"></a>Использование
В следующей таблице описывается правильный синтаксис для указания переменной HTTP.


| Синтаксис | Пример | Описание |
| ------ | -------- | ---------- |
| %{&lt;HTTPVariable&gt;} | %{host} | Используйте следующий синтаксис для получения всего значения, соответствующего указанной переменной &lt;HTTPVariable&gt;. |
| %{&lt;HTTPVariableDelimiter&gt;} | %{host,} | Используйте следующий синтаксис для установки регистра всего значения, соответствующего указанной переменной &lt;HTTPVariableDelimiter&gt;. |
| %{&lt;HTTPVariableDelimiterExpression&gt;} | %{host/=^www\.([^\.]+)\.([^\.:]+)/cdn.$2.$3:80} | Используйте регулярное выражение для параметра &lt;HTTPVariableDelimiterExpression&gt;, чтобы заменить, удалить или обработать значение переменной HTTP. |

Имена переменных HTTP поддерживают только алфавитные символы и символы подчеркивания. Преобразуйте неподдерживаемые символы в символы подчеркивания.

## <a name="delimiter-reference"></a>Справочные материалы по разделителю
Разделитель можно указать после переменной HTTP, чтобы достичь следующего:

- Преобразовать значение, связанное с переменной.

     Пример Полностью преобразовать значение в нижний регистр.

- Удалить значение, связанное с переменной.

- Обработать значение, связанное с переменной.

     Пример Изменить значение, связанное с переменной HTTP, с помощью регулярных выражений.

Разделители описаны в следующей таблице.

| Разделитель | Описание |
| --------- | ----------- |
| := | Указывает, что значение по умолчанию будет назначено переменной, если к ней применим один из следующих вариантов: <br />— он отсутствует; <br />— ему задано значение NULL. |
| :+ | Указывает, что значение по умолчанию будет назначено переменной, если для нее уже назначено значение. |
| : | Указывает, что подстрока значения, назначенного переменной, будет развернута. |
| # | Указывает, что шаблон, указанный после этого разделителя, необходимо удалить, если он находится в начале значения, связанного с переменной. |
| % | Указывает, что шаблон, указанный после этого разделителя, необходимо удалить, если он находится в конце значения, связанного с переменной. <br />Это определение применимо, только если в качестве разделителя используется символ %. |
| / | Разделяет переменную HTTP или шаблон. |
| // | Находит и заменяет все экземпляры указанного шаблона. |
| /= | Найти, скопировать и перезаписать все вхождения указанного шаблона. |
| , | Преобразовывает значение, связанное с переменной HTTP, в нижний регистр. |
| ^ | Преобразовывает значение, связанное с переменной HTTP, в верхний регистр. |
| ,, | Преобразовывает все экземпляры указанного символа в значение, связанное с переменной HTTP, в нижний регистр. |
| ^^ | Преобразовывает все экземпляры указанного символа в значение, связанное с переменной HTTP, в верхний регистр. |

## <a name="exceptions"></a>Исключения
В следующей таблице описаны условия, при которых указанный текст не рассматривается как переменная HTTP.

| Условие | Описание | Пример |
| --------- | ----------- | --------|
| Экранирование символа % | Символ процента можно экранировать с использованием обратной косой черты. <br />Пример значения справа будет рассматриваться как литеральное значение, а не как переменная HTTP.| \%{host} |
| Неизвестные переменные | Для неизвестных переменных всегда возвращается пустая строка. | %{unknown_variable} |
| Недопустимые символы или синтаксис | Переменные, содержащие недопустимые символы или синтаксис, обрабатываются как литеральные значения. <br /><br />Пример №1. Указанное значение содержит недопустимый символ (например, -). <br /><br />Пример №2. Указанное значение содержит две пары фигурных скобок. <br /><br />Пример №3. В указанном значении недостает закрывающей фигурной скобки.<br /> | Пример №1. %{resp_user-agent} <br /><br />Пример №2. %{{host}} <br /><br />Пример №3. %{host |
| Отсутствует имя переменной | Если переменная указана, всегда возвращается значение NULL. | %{} |
| Символы в конце | Символы, которые находятся за переменной, обрабатываются как литеральные значения. <br />Пример значения справа содержит в конце фигурную скобку, которая будет рассматриваться как литеральное значение. | %{host}} |

## <a name="setting-default-header-values"></a>Установка значений заголовков по умолчанию
Заголовку может быть назначено значение по умолчанию при соблюдении любого из следующих условий:
- отсутствует или не задан;
- задано значение NULL.

В следующей таблице описывается, как определить значение по умолчанию.

| Условие | Синтаксис | Пример | Описание |
| --------- | ------ | --------| ----------- |
| Задайте для заголовка значение по умолчанию при соблюдении любого из следующих условий: <br /><br />— заголовок отсутствует; <br /><br />— для заголовка задано значение NULL.| %{Variable:=Value} | %{http_referrer:=unspecified} | Для заголовка источника ссылки будет задано значение *не указано*, только если он отсутствует или для него задано значение NULL. Если он задан, никаких действий не требуется. |
| Задайте для заголовка значение по умолчанию, если он отсутствует. | %{Variable=Value} | %{http_referrer=unspecified} | Для заголовка источника ссылки будет задано значение *не указано*, только если он отсутствует. Если он задан, никаких действий не требуется. |
| Задайте для заголовка значение по умолчанию, если следующие условия не соблюдены: <br /><br />— он отсутствует;<br /><br /> — ему задано значение NULL. | %{Variable:+Value} | %{http_referrer:+unspecified} | Для заголовка источника ссылки будет задано значение *не указано*, только если ему назначено значение. Если он отсутствует или ему задано значение NULL, никаких действий выполнять не требуется. |

## <a name="manipulating-variables"></a>Работа с переменными
Переменные можно обрабатывать следующими способами:

- расширение подстрок;
- удаление шаблонов.

### <a name="substring-expansion"></a>Расширение подстрок
По умолчанию переменная будет расширяться до своего полного значения. Используйте следующий синтаксис, чтобы только расширить подстроку значения переменной.

`%<Variable>:<Offset>:<Length>}`

Основные сведения

- Значение, назначенное термину Offset, определяет начальный символ подстроки.

     - Положительное значение: начальный символ подстроки вычисляется на основе первого символа в строке.
     - Ноль: начальный символ подстроки является первым символом в строке.
     - Если задано отрицательное значение, начальный символ подстроки вычисляется на основе последнего символа в строке.

- Длина подстроки определяется термином *Length*:

     - Опущено: если не указать термин Length, подстрока будет содержать все символы между начальным символом и концом строки.
     - Положительное значение: определяет длину подстроки от начального символа вправо.
     - Если задано отрицательное значение, определяет длину подстроки с начального символа влево.

#### <a name="example"></a>Пример

В следующем примере используется следующий пример URL-адреса запроса:

https:\//cdn.mydomain.com/folder/marketing/myconsultant/proposal.html

Следующая строка демонстрирует различные способы обработки переменных:

https:\//www%{http_host:3}/mobile/%{request_uri:7:10}/%{request_uri:-5:-8}.htm

На основании примера URL-адреса запроса обработка приведенной выше переменной выдаст следующее значение:

https:\//www.mydomain.com/mobile/marketing/proposal.htm


### <a name="pattern-removal"></a>Удаление шаблона
Текст, соответствующий определенному шаблону, можно удалить из начала или конца значения переменной.

| Синтаксис | Действие |
| ------ | ------ |
| %{Variable#Pattern} | Удалите текст, если указанный шаблон находится в начале значения переменной. |
| %{Variable%Pattern} | Удалите текст, если указанный шаблон находится в конце значения переменной. |

#### <a name="example"></a>Пример

В этом примере сценария переменной *request_uri* присваивается значение:

`/800001/myorigin/marketing/product.html?language=en-US`

В следующей таблице показано, как работает этот синтаксис.

| Пример синтаксиса | Результаты | Описание |
| ------------- | ------- | --- |
| %{request_uri#/800001}/customerorigin | /customerorigin/myorigin/marketing/product.html?language=en-US | Так как переменная начинается с шаблона, он был заменен. |
| %{request_uri%html}htm | /800001/myorigin/marketing/product.html?language=en-US | Так как переменная не заканчивается шаблоном, изменения не вносились.|

### <a name="find-and-replace"></a>Поиск и замена
В следующей таблице описан синтаксис поиска и замены.

| Синтаксис | Действие |
| ------ | ------ |
| %{Variable/Find/Replace} | Найти и заменить первое вхождение указанного шаблона. |
| %{Variable//Find/Replace} | Найти и заменить все вхождения указанного шаблона. |
| %{Variable^} |Полностью преобразовать значение в верхний регистр. |
| %{Variable^Find} | Преобразовать первое вхождение указанного шаблона в верхний регистр. |
| %{Variable,} | Полностью преобразовать значение в нижний регистр. |
| %{Variable,Find} | Преобразовать первое вхождение указанного шаблона в нижний регистр. |

### <a name="find-and-rewrite"></a>Поиск и перезапись
В качестве разновидности поиска и замены при перезаписи используйте текст, который соответствует указанному шаблону. В следующей таблице описан синтаксис поиска и перезаписи.

| Синтаксис | Действие |
| ------ | ------ |
| %{Variable/=Find/Rewrite} | Найти, скопировать и перезаписать все вхождения указанного шаблона. |
| %{Variable/^Find/Rewrite} | Найти, скопировать и перезаписать указанный шаблон, если он находится в начале переменной. |
| %{Variable/$Find/Rewrite} | Найти, скопировать и перезаписать указанный шаблон, если он находится в конце переменной. |
| %{Variable/Find} | Найти и удалить все вхождения указанного шаблона. |

Основные сведения

- Разверните текст, соответствующий указанному шаблону, указав знак доллара и целое число (например, $1).

- Можно указать несколько шаблонов. Порядок, в котором указан шаблон, определяет целое число, которое будет ему назначено. В следующем примере первый шаблон соответствует "www.", второй шаблон — домену второго уровня, а третий шаблон — домену верхнего уровня:

    `%{host/=^www\.([^\.]+)\.([^\.:]+)/cdn.$2.$3:80}`

- Перезаписанное значение может включать любое сочетание текста и этих заполнителей.

    В предыдущем примере имя узла переписано как `cdn.$2.$3:80` (например, cdn.mydomain.com:80).

- Регистр заполнителя шаблона (например, $1) можно изменить с помощью следующих флагов:
     - U: верхний регистр расширенного значения.

         Пример синтаксиса:

         `%{host/=^www\.([^\.]+)\.([^\.:]+)/cdn.$U2.$3:80}`

     - L: нижний регистр расширенного значения.

         Пример синтаксиса:

         `%{host/=^www\.([^\.]+)\.([^\.:]+)/cdn.$L2.$3:80}`

- Перед шаблоном должен быть указан оператор. Указанный оператор определяет поведение захвата шаблона:

     - `=`: указывает, что все вхождения указанного шаблона должны быть захвачены и перезаписаны.
     - `^`: указывает, что будет захватываться только текст, который начинается с указанного шаблона.
     - `$`: указывает, что будет захватываться только текст, который заканчивается указанным шаблоном.
 
- Если не указать значение */Rewrite*, текст, который соответствует шаблону, будет удален.


